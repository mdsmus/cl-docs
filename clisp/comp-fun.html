<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>37.3. The structure of compiled functions</title><link rel="stylesheet" href="impnotes.css" type="text/css" /><link rev="made" href="mailto:clisp-list@lists.sourceforge.net" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot_7566" /><link rel="start" href="index.html" title="Implementation Notes for GNU CLISP" /><link rel="up" href="bytecode.html" title="Chapter 37. The CLISP bytecode specification" /><link rel="prev" href="vm.html" title="37.2. The virtual machine" /><link rel="next" href="instr-struct.html" title="37.4. The general structure of the instructions" /><link rel="copyright" href="legalese.html" title="Legal Status of the CLISP Implementation Notes" /><meta name="date" content="'generated: 2008-07-02 11:52:30-04:00'" /><link rel="author" title="Authors" href="index.html#authors" /><link rel="contents" title="Table of Contents" href="index.html" /><link rel="glossary" href="glossary.html" /><link rel="help" href="faq.html#faq-help" title="How do I ask for help?" /><link rel="home" title="Home" href="http://clisp.cons.org" /><link rel="index" href="idx.html" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">37.3. The structure of compiled functions</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="vm.html">Prev</a> </td><th width="60%" align="center">Chapter 37. The <span class="command"><strong>CLISP</strong></span> bytecode specification</th><td width="20%" align="right"> <a accesskey="n" href="instr-struct.html">Next</a></td></tr></table><hr /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="comp-fun"></a>37.3. The structure of compiled functions</h2></div></div></div><p>A compiled function consists of two objects: The function itself,
containing the references to all <a class="ulink" href="http://clisp.cons.org" target="_top"><span class="command"><strong>CLISP</strong></span></a> objects needed for the bytecode,
and a byte vector containing only immediate data, including the bytecode
proper.</p><p>Typically, the byte vector is about twice as large as the function
vector.  The separation thus helps the garbage collector (since the byte
vector does not need to be scanned for pointers).</p><p>A function looks like this
 (cf. the <a class="ulink" href="http://c-faq.com/" target="_top"><span class="command"><strong>C</strong></span></a> type <span class="type">Cclosure</span>):
</p><div class="variablelist"><dl><dt><a id="func-name"></a><span class="term">name</span></dt><dd>This is the name of the function, normally a symbol
   or a list of the form <code class="code">(<a class="ulink" href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><code class="function">SETF</code></a> <em class="replaceable"><code>symbol</code></em>)</code>.
   It is used for printing the function and for error messages.
   This field is immutable.</dd><dt><a id="func-codevec"></a><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">codevec</code></a></span></dt><dd>This is the byte-code vector, a <span class="type"><code class="literal">(<a class="ulink" href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><code class="classname">VECTOR</code></a> (<a class="ulink" href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><code class="classname">UNSIGNED-BYTE</code></a> 8))</code></span>.
    This field is immutable.</dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">consts</code></a>[]</span></dt><dd>The remaining fields in the function object are
   references to other <a class="ulink" href="http://clisp.cons.org" target="_top"><span class="command"><strong>CLISP</strong></span></a> objects.  These references are immutable,
   which is why they are called “<span class="quote">constants</span>”.
   (The referenced <a class="ulink" href="http://clisp.cons.org" target="_top"><span class="command"><strong>CLISP</strong></span></a> objects can be mutable objects,
    such as <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/syscla_cons.html" target="_top"><code class="classname">CONS</code></a>es or <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><code class="classname">VECTOR</code></a>s, however.)
 </dd></dl></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">The Exception to the Immutability Rule</h3><p>When a generic function's dispatch code is installed, the <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">codevec</code></a>
  and <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">consts</code></a> fields are destructively modified.</p></div><p>Some of the <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">consts</code></a> can play special roles.
 A function looks like this, in more detail:
</p><div class="variablelist"><dl><dt><span class="term">name</span></dt><dd>see <a class="xref" href="comp-fun.html#func-name">name</a>.
 </dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">codevec</code></a></span></dt><dd>see <a class="xref" href="comp-fun.html#func-codevec"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">codevec</code></a></a>.
 </dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">venv-const</code></a>*</span></dt><dd>At most one object, representing the closed-up
   variables, representing the variables of the <a class="clhs" href="http://www.lisp.org/HyperSpec/Body/sec_3-1-1-3.html">lexical environment</a> in
   which this function was defined.  It is a <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/typ_simple-vector.html" target="_top"><code class="classname">SIMPLE-VECTOR</code></a>, which
   looks like this: <span class="data"><code class="literal">#(<em class="replaceable"><code>next</code></em>
   <em class="replaceable"><code>value<sub>1</sub></code></em> ...
   <em class="replaceable"><code>value<sub>n</sub></code></em>)</code></span>
   where <em class="replaceable"><code>value<sub>1</sub></code></em>, ...,
   <em class="replaceable"><code>value<sub>n</sub></code></em>
   are the values of the closed-up variables,
   and <em class="replaceable"><code>next</code></em> is either <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><code class="constant">NIL</code></a> or a <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/typ_simple-vector.html" target="_top"><code class="classname">SIMPLE-VECTOR</code></a> having the same
   structure.</dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">block-const</code></a>*</span></dt><dd>Objects representing closed-up <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_block.html" target="_top"><code class="function">BLOCK</code></a> tags,
   representing the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_block.html" target="_top"><code class="function">BLOCK</code></a> tags of the <a class="clhs" href="http://www.lisp.org/HyperSpec/Body/sec_3-1-1-3.html">lexical environment</a> in which
   this function was defined.  Each is a <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/syscla_cons.html" target="_top"><code class="classname">CONS</code></a> containing in the
   <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/acc_carcm_cdr_darcm_cddddr.html" target="_top"><code class="function">CDR</code></a> part: either a frame pointer to the block frame, or <span class="data"><code class="literal">#&lt;DISABLED&gt;</code></span>.
   The <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/acc_carcm_cdr_darcm_cddddr.html" target="_top"><code class="function">CAR</code></a> is the block's name, for error messages only.
  </dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">tagbody-const</code></a>*</span></dt><dd>Objects representing closed-up <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_tagbody.html" target="_top"><code class="function">TAGBODY</code></a> tags,
   representing the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_tagbody.html" target="_top"><code class="function">TAGBODY</code></a> tags of the <a class="clhs" href="http://www.lisp.org/HyperSpec/Body/sec_3-1-1-3.html">lexical environment</a> in which
   this function was defined.  Each is a <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/syscla_cons.html" target="_top"><code class="classname">CONS</code></a> containing in the
   <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/acc_carcm_cdr_darcm_cddddr.html" target="_top"><code class="function">CDR</code></a> part: either a frame pointer to the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_tagbody.html" target="_top"><code class="function">TAGBODY</code></a> frame, or
   <span class="data"><code class="literal">#&lt;DISABLED&gt;</code></span> if the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_tagbody.html" target="_top"><code class="function">TAGBODY</code></a> has already been left.  The <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/acc_carcm_cdr_darcm_cddddr.html" target="_top"><code class="function">CAR</code></a> is a
   <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/typ_simple-vector.html" target="_top"><code class="classname">SIMPLE-VECTOR</code></a> containing the names of the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_tagbody.html" target="_top"><code class="function">TAGBODY</code></a> tags,
   for error messages only.</dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">keyword-const</code></a>*</span></dt><dd>If the function was defined with a <a class="link" href="lalist.html" title="3.4. Lambda Lists">lambda list</a>
   containing <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;KEY</code></a>, here come the symbols ("keywords"), in their
   correct order.  They are used by the interpreter during function call.
  </dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">other-const</code></a>*</span></dt><dd>Other objects needed by the function's bytecode.
  </dd></dl></div><p>
</p><p>If <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">venv-const</code></a>, <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">block-const</code></a>, <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">tagbody-const</code></a> are all absent,
the function is called <span class="emphasis"><em>autonomous</em></span>.
This is the case if the function does not refer to lexical variables,
blocks or tags defined in compile code outside of the function.
In particular, it is the case if the function is defined in a null
<a class="clhs" href="http://www.lisp.org/HyperSpec/Body/sec_3-1-1-3.html">lexical environment</a>.</p><p>If some <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">venv-const</code></a>, <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">block-const</code></a>, or <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">tagbody-const</code></a> are
present, the function (a “<span class="quote">closure</span>”) is created at runtime.
The compiler only generates a prototype, containing <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><code class="constant">NIL</code></a> values
instead of each <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">venv-const</code></a>, <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">block-const</code></a>, <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">tagbody-const</code></a>.
At runtime, a function is created by copying this prototype and
replacing the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><code class="constant">NIL</code></a> values by the definitive ones.</p><p>The list <span class="data"><code class="literal">(<a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">keyword-const</code></a>*
<a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">other-const</code></a>*)</code></span> normally does not contain duplicates, because
the compiler removes duplicates when possible.  (Duplicates can occur
nevertheless, through the use of <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/speope_load-time-value.html" target="_top"><code class="function">LOAD-TIME-VALUE</code></a>.)</p><p>The <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">codevec</code></a> looks like this
 (cf. the <a class="ulink" href="http://c-faq.com/" target="_top"><span class="command"><strong>C</strong></span></a> type <span class="type">Codevec</span>):
</p><div class="variablelist"><dl><dt><span class="term"><code class="literal">spdepth_1</code> (2 bytes)</span></dt><dd>The 1st part of the maximal <a href="vm.html" class="olink"><code class="literal">SP</code></a> depth.
 </dd><dt><span class="term"><code class="literal">spdepth_jmpbufsize</code> (2 bytes)</span></dt><dd>The <a class="link" href="vm.html" title="37.2. The virtual machine"><code class="varname">jmpbufsize</code></a> part of the maximal <a href="vm.html" class="olink"><code class="literal">SP</code></a> depth.
    The maximal <a href="vm.html" class="olink"><code class="literal">SP</code></a> depth (precomputed by the compiler) is given by
    <code class="literal">spdepth_1 + spdepth_jmpbufsize * <a class="link" href="vm.html" title="37.2. The virtual machine"><code class="varname">jmpbufsize</code></a></code>.
 </dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">numreq</code></a> (2 bytes)</span></dt><dd>Number of required parameters.
 </dd><dt><span class="term"><code class="literal">numopt</code> (2 bytes)</span></dt><dd>Number of optional parameters.
 </dd><dt><span class="term"><a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">flags</code></a> (1 byte)</span></dt><dd><div class="variablelist"><dl><dt><span class="term">bit 0</span></dt><dd>set if the function has the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;REST</code></a> parameter
    </dd><dt><span class="term">bit 7</span></dt><dd>set if the function has <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;KEY</code></a> parameters
    </dd><dt><span class="term">bit 6</span></dt><dd>set if the function has <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;ALLOW-OTHER-KEYS</code></a>
    </dd><dt><span class="term">bit 4</span></dt><dd>set if the function is a generic function
    </dd><dt><span class="term">bit 3</span></dt><dd>set if the function is a generic function and its
       effective method shall be returned (instead of being executed)
    </dd><dt><span class="term">bit 2</span></dt><dd>set if the full original <a class="link" href="lalist.html" title="3.4. Lambda Lists">lambda list</a> is kept in the
       closure object, see <a class="xref" href="declarations.html#space-decl" title="3.3.6. Declaration SPACE">Section 3.3.6, “Declaration <code class="literal">SPACE</code>”</a>
    </dd><dt><span class="term">bit 1</span></dt><dd>set if the <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/stagenfun_doc_umentationcp.html" target="_top"><code class="function">FUNCTION</code></a> <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/stagenfun_doc_umentationcp.html" target="_top"><code class="function">DOCUMENTATION</code></a> <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><code class="classname">STRING</code></a>
       is kept in the closure object, see <a class="xref" href="declarations.html#space-decl" title="3.3.6. Declaration SPACE">Section 3.3.6, “Declaration <code class="literal">SPACE</code>”</a>
  </dd></dl></div></dd><dt><span class="term"><code class="literal">signature</code> (1 byte)</span></dt><dd>An abbreviation code depending on
    <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">numreq</code></a>, <code class="literal">numopt</code>, <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">flags</code></a>.
    It is used for speeding up the function
    call.</dd><dt><span class="term"><code class="literal">numkey</code> (2 bytes, only if the
   function has <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;KEY</code></a>)</span></dt><dd>The number of <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;KEY</code></a> parameters.
 </dd><dt><span class="term"><code class="literal">keyconsts</code> (2 bytes, only if the
   function has <a class="ulink" href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;KEY</code></a>)</span></dt><dd>The offset of the <a class="link" href="comp-fun.html" title="37.3. The structure of compiled functions"><code class="literal">keyword-const</code></a> in the function.
 </dd><dt><span class="term"><code class="literal">byte</code>* (any number of bytes)</span></dt><dd>The bytecode instructions.
 </dd></dl></div></div><div class="bookinfo"><hr /><table width="100%" summary="impnotes meta info"><th><td align="left">These notes document <a class="ulink" href="http://clisp.cons.org" target="_top"><span class="command"><strong>CLISP</strong></span></a> version 2.46</td><td align="right">Last modified: 2008-07-02</td></th></table></div><div class="custom-footer"><hr /><table width="100%"><tr><td align="left"><a href="http://clisp.cons.org"><img src="clisp.png" width="48" height="48" alt="[CLISP home]" /></a></td><td align="center"><a href="http://sourceforge.net/donate/index.php?group_id=1355"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" alt="[Support CLISP]" /></a></td><td align="right"><a href="http://sourceforge.net"><img width="125" height="37" alt="[SourceForge]" src="http://sflogo.sourceforge.net/sflogo.php?group_id=1355&amp;type=2&amp;page=comp-fun" /></a></td></tr></table></div><hr /><form method="get" action="http://www.google.com/custom" target="_top"><table width="100%" border="0"><tr><td nowrap="nowrap" align="center"><input type="hidden" name="domains" value="clisp.cons.org;clisp.podval.org;www.lisp.org" /><label for="sbi" style="display: none">Enter your search terms</label><input type="text" name="q" size="50" maxlength="255" id="sbi" value="37.3. The structure of compiled functions" /><label for="sbb" style="display: none">Submit search form</label><input type="submit" name="sa" value="Google Search" id="sbb" /></td></tr><tr><td nowrap="nowrap" align="center"><input type="radio" name="sitesearch" value="" checked="1" id="ss0" /><label for="ss0" title="Search the Web"><small>Web</small></label><input type="radio" name="sitesearch" value="clisp.cons.org" id="ss1" /><label for="ss1" title="Search clisp.cons.org"><small>clisp.cons.org</small></label><input type="radio" name="sitesearch" value="clisp.podval.org" id="ss2" /><label for="ss2" title="Search clisp.podval.org"><small>clisp.podval.org</small></label><input type="radio" name="sitesearch" value="www.lisp.org" id="ss3" /><label for="ss3" title="Search www.lisp.org"><small>www.lisp.org</small></label><input type="hidden" name="client" value="pub-4445255502750357" /><input type="hidden" name="forid" value="1" /><input type="hidden" name="ie" value="UTF-8" /><input type="hidden" name="oe" value="UTF-8" /><input type="hidden" name="cof" value="GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:000000;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:48;LW:48;L:http://clisp.cons.org/clisp.png;S:http://clisp.cons.org;FORID:1" /><input type="hidden" name="hl" value="en" /></td></tr></table></form><hr /><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="vm.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="bytecode.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="instr-struct.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">37.2. The virtual machine </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 37.4. The general structure of the instructions</td></tr></table></div></body></html>
