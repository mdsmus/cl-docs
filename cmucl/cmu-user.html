<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
"http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta name="generator" content=
"HTML Tidy for Mac OS X (vers 31 October 2006 - Apple Inc. build 13), see www.w3.org">
<title>CMUCL User's Manual</title>
<meta http-equiv="Content-Type" content=
"text/html; charset=us-ascii">
<meta name="GENERATOR" content="hevea 1.06">
<link rel="stylesheet" href="cmucl.css" type="text/css">
<meta http-equiv="Content-Language" content="en">
</head>
<body>
<!--HEVEA command line is: hevea -fix cmu-user.hva cmu-user.tex -->
<!--HTMLHEAD-->
<!--ENDHTML-->
<!--PREFIX <ARG >CMUCL User's Manual: </ARG>-->
<!--CUT DEF chapter 10 -->
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<div align="center">
<hr size="2">
<br>
<br>
<br>
<font size="7">CMUCL User's Manual</font><br>
<br>
<br>
<br>
<br>
<br>
<table cellspacing="2" cellpadding="0">
<tr>
<td align="center" nowrap><font size="4">Robert A. MacLachlan,
<i>Editor</i></font></td>
</tr>
</table>
<br>
<br>
<br>
<font size="4">Mar 2008<br>
Release 19e</font><br>
<br>
<br>
<br>
<hr size="2"></div>
<br>
<blockquote>CMUCL is a free, high-performance implementation of the
Common Lisp programming language, which runs on most major Unix
platforms. It mainly conforms to the ANSI Common Lisp Standard.
CMUCL features a sophisticated native-code compiler, a foreign
function interface, a graphical source-level debugger, an interface
to the X11 Window System, and an Emacs-like editor.<br>
<br>
<br>
<b>Keywords</b>: lisp, Common Lisp, manual, compiler, programming
language implementation, programming environment</blockquote>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
This manual is based on CMU Technical Report CMU-CS-92-161, edited
by Robert A. MacLachlan, dated July 1992.<br>
<br>
<br>
<br>
<!--TOC chapter Table of Contents-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><b><font size="6">Table of Contents</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<ul>
<li><a href="#htoc1">Chapter&nbsp;1&nbsp;&nbsp;Introduction</a>
<ul>
<li><a href="#htoc2">1.1&nbsp;&nbsp;Distribution and
Support</a></li>
<li><a href="#htoc3">1.2&nbsp;&nbsp;Command Line Options</a></li>
<li><a href="#htoc4">1.3&nbsp;&nbsp;Credits</a></li>
</ul>
</li>
<li><a href="#htoc5">Chapter&nbsp;2&nbsp;&nbsp;Design Choices and
Extensions</a>
<ul>
<li><a href="#htoc6">2.1&nbsp;&nbsp;Data Types</a>
<ul>
<li><a href="#htoc7">2.1.1&nbsp;&nbsp;Integers</a></li>
<li><a href="#htoc8">2.1.2&nbsp;&nbsp;Floats</a></li>
<li><a href="#htoc9">2.1.3&nbsp;&nbsp;Extended Floats</a></li>
<li><a href="#htoc10">2.1.4&nbsp;&nbsp;Characters</a></li>
<li><a href="#htoc11">2.1.5&nbsp;&nbsp;Array
Initialization</a></li>
<li><a href="#htoc12">2.1.6&nbsp;&nbsp;Hash tables</a></li>
</ul>
</li>
<li><a href="#htoc13">2.2&nbsp;&nbsp;Default Interrupts for
Lisp</a></li>
<li><a href="#htoc14">2.3&nbsp;&nbsp;Implementation-Specific
Packages</a></li>
<li><a href="#htoc15">2.4&nbsp;&nbsp;Hierarchical Packages</a>
<ul>
<li><a href="#htoc16">2.4.1&nbsp;&nbsp;Introduction</a></li>
<li><a href="#htoc17">2.4.2&nbsp;&nbsp;Relative Package
Names</a></li>
<li><a href="#htoc18">2.4.3&nbsp;&nbsp;Compatibility with ANSI
Common Lisp</a></li>
</ul>
</li>
<li><a href="#htoc19">2.5&nbsp;&nbsp;Package Locks</a>
<ul>
<li><a href="#htoc20">2.5.1&nbsp;&nbsp;Rationale</a></li>
<li><a href="#htoc21">2.5.2&nbsp;&nbsp;Disabling package
locks</a></li>
</ul>
</li>
<li><a href="#htoc22">2.6&nbsp;&nbsp;The Editor</a></li>
<li><a href="#htoc23">2.7&nbsp;&nbsp;Garbage Collection</a>
<ul>
<li><a href="#htoc24">2.7.1&nbsp;&nbsp;GC Parameters</a></li>
<li><a href="#htoc25">2.7.2&nbsp;&nbsp;Generational GC</a></li>
<li><a href="#htoc26">2.7.3&nbsp;&nbsp;Weak Pointers</a></li>
<li><a href="#htoc27">2.7.4&nbsp;&nbsp;Finalization</a></li>
</ul>
</li>
<li><a href="#htoc28">2.8&nbsp;&nbsp;Describe</a></li>
<li><a href="#htoc29">2.9&nbsp;&nbsp;The Inspector</a>
<ul>
<li><a href="#htoc30">2.9.1&nbsp;&nbsp;The Graphical
Interface</a></li>
<li><a href="#htoc31">2.9.2&nbsp;&nbsp;The TTY Inspector</a></li>
</ul>
</li>
<li><a href="#htoc32">2.10&nbsp;&nbsp;Load</a></li>
<li><a href="#htoc33">2.11&nbsp;&nbsp;The Reader</a>
<ul>
<li><a href="#htoc34">2.11.1&nbsp;&nbsp;Reader Extensions</a></li>
<li><a href="#htoc35">2.11.2&nbsp;&nbsp;Reader Parameters</a></li>
</ul>
</li>
<li><a href="#htoc36">2.12&nbsp;&nbsp;Stream Extensions</a></li>
<li><a href="#htoc37">2.13&nbsp;&nbsp;Simple Streams</a></li>
<li><a href="#htoc38">2.14&nbsp;&nbsp;Running Programs from
Lisp</a>
<ul>
<li><a href="#htoc39">2.14.1&nbsp;&nbsp;Process Accessors</a></li>
</ul>
</li>
<li><a href="#htoc40">2.15&nbsp;&nbsp;Saving a Core Image</a></li>
<li><a href="#htoc41">2.16&nbsp;&nbsp;Pathnames</a>
<ul>
<li><a href="#htoc42">2.16.1&nbsp;&nbsp;Unix Pathnames</a></li>
<li><a href="#htoc43">2.16.2&nbsp;&nbsp;Wildcard Pathnames</a></li>
<li><a href="#htoc44">2.16.3&nbsp;&nbsp;Logical Pathnames</a></li>
<li><a href="#htoc45">2.16.4&nbsp;&nbsp;Search Lists</a></li>
<li><a href="#htoc46">2.16.5&nbsp;&nbsp;Predefined
Search-Lists</a></li>
<li><a href="#htoc47">2.16.6&nbsp;&nbsp;Search-List
Operations</a></li>
<li><a href="#htoc48">2.16.7&nbsp;&nbsp;Search List
Example</a></li>
</ul>
</li>
<li><a href="#htoc49">2.17&nbsp;&nbsp;Filesystem Operations</a>
<ul>
<li><a href="#htoc50">2.17.1&nbsp;&nbsp;Wildcard Matching</a></li>
<li><a href="#htoc51">2.17.2&nbsp;&nbsp;File Name
Completion</a></li>
<li><a href="#htoc52">2.17.3&nbsp;&nbsp;Miscellaneous Filesystem
Operations</a></li>
</ul>
</li>
<li><a href="#htoc53">2.18&nbsp;&nbsp;Time Parsing and
Formatting</a></li>
<li><a href="#htoc54">2.19&nbsp;&nbsp;Random Number Generation</a>
<ul>
<li><a href="#htoc55">2.19.1&nbsp;&nbsp;Original Generator</a></li>
<li><a href="#htoc56">2.19.2&nbsp;&nbsp;New Generator</a></li>
<li><a href="#htoc57">2.19.3&nbsp;&nbsp;MT-19937 Generator</a></li>
</ul>
</li>
<li><a href="#htoc58">2.20&nbsp;&nbsp;Lisp Threads</a></li>
<li><a href="#htoc59">2.21&nbsp;&nbsp;Lisp Library</a></li>
<li><a href="#htoc60">2.22&nbsp;&nbsp;Generalized Function
Names</a></li>
<li><a href="#htoc61">2.23&nbsp;&nbsp;CLOS</a>
<ul>
<li><a href="#htoc62">2.23.1&nbsp;&nbsp;Primary Method
Errors</a></li>
<li><a href="#htoc63">2.23.2&nbsp;&nbsp;Slot Type Checking</a></li>
<li><a href="#htoc64">2.23.3&nbsp;&nbsp;Slot Access
Optimization</a></li>
<li><a href="#htoc65">2.23.4&nbsp;&nbsp;Inlining Methods in
Effective Methods</a></li>
<li><a href="#htoc66">2.23.5&nbsp;&nbsp;Effective Method
Precomputation</a></li>
<li><a href="#htoc67">2.23.6&nbsp;&nbsp;Sealing</a></li>
<li><a href="#htoc68">2.23.7&nbsp;&nbsp;Method Tracing and
Profiling</a></li>
<li><a href="#htoc69">2.23.8&nbsp;&nbsp;Misc</a></li>
</ul>
</li>
<li><a href="#htoc70">2.24&nbsp;&nbsp;Differences from ANSI Common
Lisp</a>
<ul>
<li><a href="#htoc71">2.24.1&nbsp;&nbsp;Extensions</a></li>
</ul>
</li>
<li><a href="#htoc72">2.25&nbsp;&nbsp;Function Wrappers</a></li>
<li><a href="#htoc73">2.26&nbsp;&nbsp;Dynamic-Extent
Declarations</a>
<ul>
<li><a href="#htoc74">2.26.1&nbsp;&nbsp;<tt class=
"code">&amp;rest</tt> argument lists</a></li>
<li><a href="#htoc75">2.26.2&nbsp;&nbsp;Closures</a></li>
<li><a href="#htoc76">2.26.3&nbsp;&nbsp;<tt class="code">list</tt>,
<tt class="code">list*</tt>, and <tt class=
"code">cons</tt></a></li>
</ul>
</li>
<li><a href="#htoc77">2.27&nbsp;&nbsp;Modular Arithmetic</a></li>
<li><a href="#htoc78">2.28&nbsp;&nbsp;Extension to REQUIRE</a></li>
</ul>
</li>
<li><a href="#htoc79">Chapter&nbsp;3&nbsp;&nbsp;The Debugger</a>
<ul>
<li><a href="#htoc80">3.1&nbsp;&nbsp;Debugger Introduction</a></li>
<li><a href="#htoc81">3.2&nbsp;&nbsp;The Command Loop</a></li>
<li><a href="#htoc82">3.3&nbsp;&nbsp;Stack Frames</a>
<ul>
<li><a href="#htoc83">3.3.1&nbsp;&nbsp;Stack Motion</a></li>
<li><a href="#htoc84">3.3.2&nbsp;&nbsp;How Arguments are
Printed</a></li>
<li><a href="#htoc85">3.3.3&nbsp;&nbsp;Function Names</a></li>
<li><a href="#htoc86">3.3.4&nbsp;&nbsp;Funny Frames</a></li>
<li><a href="#htoc87">3.3.5&nbsp;&nbsp;Debug Tail
Recursion</a></li>
<li><a href="#htoc88">3.3.6&nbsp;&nbsp;Unknown Locations and
Interrupts</a></li>
</ul>
</li>
<li><a href="#htoc89">3.4&nbsp;&nbsp;Variable Access</a>
<ul>
<li><a href="#htoc90">3.4.1&nbsp;&nbsp;Variable Value
Availability</a></li>
<li><a href="#htoc91">3.4.2&nbsp;&nbsp;Note On Lexical Variable
Access</a></li>
</ul>
</li>
<li><a href="#htoc92">3.5&nbsp;&nbsp;Source Location Printing</a>
<ul>
<li><a href="#htoc93">3.5.1&nbsp;&nbsp;How the Source is
Found</a></li>
<li><a href="#htoc94">3.5.2&nbsp;&nbsp;Source Location
Availability</a></li>
</ul>
</li>
<li><a href="#htoc95">3.6&nbsp;&nbsp;Compiler Policy
Control</a></li>
<li><a href="#htoc96">3.7&nbsp;&nbsp;Exiting Commands</a></li>
<li><a href="#htoc97">3.8&nbsp;&nbsp;Information Commands</a></li>
<li><a href="#htoc98">3.9&nbsp;&nbsp;Breakpoint Commands</a>
<ul>
<li><a href="#htoc99">3.9.1&nbsp;&nbsp;Breakpoint Example</a></li>
</ul>
</li>
<li><a href="#htoc100">3.10&nbsp;&nbsp;Function Tracing</a>
<ul>
<li><a href="#htoc101">3.10.1&nbsp;&nbsp;Encapsulation
Functions</a></li>
</ul>
</li>
<li><a href="#htoc102">3.11&nbsp;&nbsp;Specials</a></li>
</ul>
</li>
<li><a href="#htoc103">Chapter&nbsp;4&nbsp;&nbsp;The Compiler</a>
<ul>
<li><a href="#htoc104">4.1&nbsp;&nbsp;Compiler
Introduction</a></li>
<li><a href="#htoc105">4.2&nbsp;&nbsp;Calling the Compiler</a></li>
<li><a href="#htoc106">4.3&nbsp;&nbsp;Compilation Units</a>
<ul>
<li><a href="#htoc107">4.3.1&nbsp;&nbsp;Undefined Warnings</a></li>
</ul>
</li>
<li><a href="#htoc108">4.4&nbsp;&nbsp;Interpreting Error
Messages</a>
<ul>
<li><a href="#htoc109">4.4.1&nbsp;&nbsp;The Parts of the Error
Message</a></li>
<li><a href="#htoc110">4.4.2&nbsp;&nbsp;The Original and Actual
Source</a></li>
<li><a href="#htoc111">4.4.3&nbsp;&nbsp;The Processing
Path</a></li>
<li><a href="#htoc112">4.4.4&nbsp;&nbsp;Error Severity</a></li>
<li><a href="#htoc113">4.4.5&nbsp;&nbsp;Errors During
Macroexpansion</a></li>
<li><a href="#htoc114">4.4.6&nbsp;&nbsp;Read Errors</a></li>
<li><a href="#htoc115">4.4.7&nbsp;&nbsp;Error Message
Parameterization</a></li>
</ul>
</li>
<li><a href="#htoc116">4.5&nbsp;&nbsp;Types in Python</a>
<ul>
<li><a href="#htoc117">4.5.1&nbsp;&nbsp;Compile Time Type
Errors</a></li>
<li><a href="#htoc118">4.5.2&nbsp;&nbsp;Precise Type
Checking</a></li>
<li><a href="#htoc119">4.5.3&nbsp;&nbsp;Weakened Type
Checking</a></li>
</ul>
</li>
<li><a href="#htoc120">4.6&nbsp;&nbsp;Getting Existing Programs to
Run</a></li>
<li><a href="#htoc121">4.7&nbsp;&nbsp;Compiler Policy</a>
<ul>
<li><a href="#htoc122">4.7.1&nbsp;&nbsp;The Optimize
Declaration</a></li>
<li><a href="#htoc123">4.7.2&nbsp;&nbsp;The Optimize-Interface
Declaration</a></li>
</ul>
</li>
<li><a href="#htoc124">4.8&nbsp;&nbsp;Open Coding and Inline
Expansion</a></li>
</ul>
</li>
<li><a href="#htoc125">Chapter&nbsp;5&nbsp;&nbsp;Advanced Compiler
Use and Efficiency Hints</a>
<ul>
<li><a href="#htoc126">5.1&nbsp;&nbsp;Advanced Compiler
Introduction</a>
<ul>
<li><a href="#htoc127">5.1.1&nbsp;&nbsp;Types</a></li>
<li><a href="#htoc128">5.1.2&nbsp;&nbsp;Optimization</a></li>
<li><a href="#htoc129">5.1.3&nbsp;&nbsp;Function Call</a></li>
<li><a href="#htoc130">5.1.4&nbsp;&nbsp;Representation of
Objects</a></li>
<li><a href="#htoc131">5.1.5&nbsp;&nbsp;Writing Efficient
Code</a></li>
</ul>
</li>
<li><a href="#htoc132">5.2&nbsp;&nbsp;More About Types in
Python</a>
<ul>
<li><a href="#htoc133">5.2.1&nbsp;&nbsp;More Types
Meaningful</a></li>
<li><a href="#htoc134">5.2.2&nbsp;&nbsp;Canonicalization</a></li>
<li><a href="#htoc135">5.2.3&nbsp;&nbsp;Member Types</a></li>
<li><a href="#htoc136">5.2.4&nbsp;&nbsp;Union Types</a></li>
<li><a href="#htoc137">5.2.5&nbsp;&nbsp;The Empty Type</a></li>
<li><a href="#htoc138">5.2.6&nbsp;&nbsp;Function Types</a></li>
<li><a href="#htoc139">5.2.7&nbsp;&nbsp;The Values
Declaration</a></li>
<li><a href="#htoc140">5.2.8&nbsp;&nbsp;Structure Types</a></li>
<li><a href="#htoc141">5.2.9&nbsp;&nbsp;The Freeze-Type
Declaration</a></li>
<li><a href="#htoc142">5.2.10&nbsp;&nbsp;Type Restrictions</a></li>
<li><a href="#htoc143">5.2.11&nbsp;&nbsp;Type Style
Recommendations</a></li>
</ul>
</li>
<li><a href="#htoc144">5.3&nbsp;&nbsp;Type Inference</a>
<ul>
<li><a href="#htoc145">5.3.1&nbsp;&nbsp;Variable Type
Inference</a></li>
<li><a href="#htoc146">5.3.2&nbsp;&nbsp;Local Function Type
Inference</a></li>
<li><a href="#htoc147">5.3.3&nbsp;&nbsp;Global Function Type
Inference</a></li>
<li><a href="#htoc148">5.3.4&nbsp;&nbsp;Operation Specific Type
Inference</a></li>
<li><a href="#htoc149">5.3.5&nbsp;&nbsp;Dynamic Type
Inference</a></li>
<li><a href="#htoc150">5.3.6&nbsp;&nbsp;Type Check
Optimization</a></li>
</ul>
</li>
<li><a href="#htoc151">5.4&nbsp;&nbsp;Source Optimization</a>
<ul>
<li><a href="#htoc152">5.4.1&nbsp;&nbsp;Let Optimization</a></li>
<li><a href="#htoc153">5.4.2&nbsp;&nbsp;Constant Folding</a></li>
<li><a href="#htoc154">5.4.3&nbsp;&nbsp;Unused Expression
Elimination</a></li>
<li><a href="#htoc155">5.4.4&nbsp;&nbsp;Control
Optimization</a></li>
<li><a href="#htoc156">5.4.5&nbsp;&nbsp;Unreachable Code
Deletion</a></li>
<li><a href="#htoc157">5.4.6&nbsp;&nbsp;Multiple Values
Optimization</a></li>
<li><a href="#htoc158">5.4.7&nbsp;&nbsp;Source to Source
Transformation</a></li>
<li><a href="#htoc159">5.4.8&nbsp;&nbsp;Style
Recommendations</a></li>
</ul>
</li>
<li><a href="#htoc160">5.5&nbsp;&nbsp;Tail Recursion</a>
<ul>
<li><a href="#htoc161">5.5.1&nbsp;&nbsp;Tail Recursion
Exceptions</a></li>
</ul>
</li>
<li><a href="#htoc162">5.6&nbsp;&nbsp;Local Call</a>
<ul>
<li><a href="#htoc163">5.6.1&nbsp;&nbsp;Self-Recursive
Calls</a></li>
<li><a href="#htoc164">5.6.2&nbsp;&nbsp;Let Calls</a></li>
<li><a href="#htoc165">5.6.3&nbsp;&nbsp;Closures</a></li>
<li><a href="#htoc166">5.6.4&nbsp;&nbsp;Local Tail
Recursion</a></li>
<li><a href="#htoc167">5.6.5&nbsp;&nbsp;Return Values</a></li>
</ul>
</li>
<li><a href="#htoc168">5.7&nbsp;&nbsp;Block Compilation</a>
<ul>
<li><a href="#htoc169">5.7.1&nbsp;&nbsp;Block Compilation
Semantics</a></li>
<li><a href="#htoc170">5.7.2&nbsp;&nbsp;Block Compilation
Declarations</a></li>
<li><a href="#htoc171">5.7.3&nbsp;&nbsp;Compiler Arguments</a></li>
<li><a href="#htoc172">5.7.4&nbsp;&nbsp;Practical
Difficulties</a></li>
<li><a href="#htoc173">5.7.5&nbsp;&nbsp;Context
Declarations</a></li>
<li><a href="#htoc174">5.7.6&nbsp;&nbsp;Context Declaration
Example</a></li>
</ul>
</li>
<li><a href="#htoc175">5.8&nbsp;&nbsp;Inline Expansion</a>
<ul>
<li><a href="#htoc176">5.8.1&nbsp;&nbsp;Inline Expansion
Recording</a></li>
<li><a href="#htoc177">5.8.2&nbsp;&nbsp;Semi-Inline
Expansion</a></li>
<li><a href="#htoc178">5.8.3&nbsp;&nbsp;The Maybe-Inline
Declaration</a></li>
</ul>
</li>
<li><a href="#htoc179">5.9&nbsp;&nbsp;Byte Coded
Compilation</a></li>
<li><a href="#htoc180">5.10&nbsp;&nbsp;Object Representation</a>
<ul>
<li><a href="#htoc181">5.10.1&nbsp;&nbsp;Think Before You Use a
List</a></li>
<li><a href="#htoc182">5.10.2&nbsp;&nbsp;Structure
Representation</a></li>
<li><a href="#htoc183">5.10.3&nbsp;&nbsp;Arrays</a></li>
<li><a href="#htoc184">5.10.4&nbsp;&nbsp;Vectors</a></li>
<li><a href="#htoc185">5.10.5&nbsp;&nbsp;Bit-Vectors</a></li>
<li><a href="#htoc186">5.10.6&nbsp;&nbsp;Hashtables</a></li>
</ul>
</li>
<li><a href="#htoc187">5.11&nbsp;&nbsp;Numbers</a>
<ul>
<li><a href="#htoc188">5.11.1&nbsp;&nbsp;Descriptors</a></li>
<li><a href="#htoc189">5.11.2&nbsp;&nbsp;Non-Descriptor
Representations</a></li>
<li><a href="#htoc190">5.11.3&nbsp;&nbsp;Variables</a></li>
<li><a href="#htoc191">5.11.4&nbsp;&nbsp;Generic
Arithmetic</a></li>
<li><a href="#htoc192">5.11.5&nbsp;&nbsp;Fixnums</a></li>
<li><a href="#htoc193">5.11.6&nbsp;&nbsp;Word Integers</a></li>
<li><a href="#htoc194">5.11.7&nbsp;&nbsp;Floating Point
Efficiency</a></li>
<li><a href="#htoc195">5.11.8&nbsp;&nbsp;Specialized
Arrays</a></li>
<li><a href="#htoc196">5.11.9&nbsp;&nbsp;Specialized Structure
Slots</a></li>
<li><a href="#htoc197">5.11.10&nbsp;&nbsp;Interactions With Local
Call</a></li>
<li><a href="#htoc198">5.11.11&nbsp;&nbsp;Representation of
Characters</a></li>
</ul>
</li>
<li><a href="#htoc199">5.12&nbsp;&nbsp;General Efficiency Hints</a>
<ul>
<li><a href="#htoc200">5.12.1&nbsp;&nbsp;Compile Your Code</a></li>
<li><a href="#htoc201">5.12.2&nbsp;&nbsp;Avoid Unnecessary
Consing</a></li>
<li><a href="#htoc202">5.12.3&nbsp;&nbsp;Complex Argument
Syntax</a></li>
<li><a href="#htoc203">5.12.4&nbsp;&nbsp;Mapping and
Iteration</a></li>
<li><a href="#htoc204">5.12.5&nbsp;&nbsp;Trace Files and
Disassembly</a></li>
</ul>
</li>
<li><a href="#htoc205">5.13&nbsp;&nbsp;Efficiency Notes</a>
<ul>
<li><a href="#htoc206">5.13.1&nbsp;&nbsp;Type Uncertainty</a></li>
<li><a href="#htoc207">5.13.2&nbsp;&nbsp;Efficiency Notes and Type
Checking</a></li>
<li><a href="#htoc208">5.13.3&nbsp;&nbsp;Representation Efficiency
Notes</a></li>
<li><a href="#htoc209">5.13.4&nbsp;&nbsp;Verbosity Control</a></li>
</ul>
</li>
<li><a href="#htoc210">5.14&nbsp;&nbsp;Profiling</a>
<ul>
<li><a href="#htoc211">5.14.1&nbsp;&nbsp;Profile Interface</a></li>
<li><a href="#htoc212">5.14.2&nbsp;&nbsp;Profiling
Techniques</a></li>
<li><a href="#htoc213">5.14.3&nbsp;&nbsp;Nested or Recursive
Calls</a></li>
<li><a href="#htoc214">5.14.4&nbsp;&nbsp;Clock resolution</a></li>
<li><a href="#htoc215">5.14.5&nbsp;&nbsp;Profiling
overhead</a></li>
<li><a href="#htoc216">5.14.6&nbsp;&nbsp;Additional Timing
Utilities</a></li>
<li><a href="#htoc217">5.14.7&nbsp;&nbsp;A Note on Timing</a></li>
<li><a href="#htoc218">5.14.8&nbsp;&nbsp;Benchmarking
Techniques</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#htoc219">Chapter&nbsp;6&nbsp;&nbsp;UNIX Interface</a>
<ul>
<li><a href="#htoc220">6.1&nbsp;&nbsp;Reading the Command
Line</a></li>
<li><a href="#htoc221">6.2&nbsp;&nbsp;Useful Variables</a></li>
<li><a href="#htoc222">6.3&nbsp;&nbsp;Lisp Equivalents for C
Routines</a></li>
<li><a href="#htoc223">6.4&nbsp;&nbsp;Type Translations</a></li>
<li><a href="#htoc224">6.5&nbsp;&nbsp;System Area Pointers</a></li>
<li><a href="#htoc225">6.6&nbsp;&nbsp;Unix System Calls</a></li>
<li><a href="#htoc226">6.7&nbsp;&nbsp;File Descriptor
Streams</a></li>
<li><a href="#htoc227">6.8&nbsp;&nbsp;Unix Signals</a>
<ul>
<li><a href="#htoc228">6.8.1&nbsp;&nbsp;Changing Signal
Handlers</a></li>
<li><a href="#htoc229">6.8.2&nbsp;&nbsp;Examples of Signal
Handlers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#htoc230">Chapter&nbsp;7&nbsp;&nbsp;Event Dispatching
with SERVE-EVENT</a>
<ul>
<li><a href="#htoc231">7.1&nbsp;&nbsp;Object Sets</a></li>
<li><a href="#htoc232">7.2&nbsp;&nbsp;The SERVE-EVENT
Function</a></li>
<li><a href="#htoc233">7.3&nbsp;&nbsp;Using SERVE-EVENT with Unix
File Descriptors</a></li>
<li><a href="#htoc234">7.4&nbsp;&nbsp;Using SERVE-EVENT with the
CLX Interface to X</a>
<ul>
<li><a href="#htoc235">7.4.1&nbsp;&nbsp;Without Object
Sets</a></li>
<li><a href="#htoc236">7.4.2&nbsp;&nbsp;With Object Sets</a></li>
</ul>
</li>
<li><a href="#htoc237">7.5&nbsp;&nbsp;A SERVE-EVENT Example</a>
<ul>
<li><a href="#htoc238">7.5.1&nbsp;&nbsp;Without Object Sets
Example</a></li>
<li><a href="#htoc239">7.5.2&nbsp;&nbsp;With Object Sets
Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#htoc240">Chapter&nbsp;8&nbsp;&nbsp;Alien Objects</a>
<ul>
<li><a href="#htoc241">8.1&nbsp;&nbsp;Introduction to
Aliens</a></li>
<li><a href="#htoc242">8.2&nbsp;&nbsp;Alien Types</a>
<ul>
<li><a href="#htoc243">8.2.1&nbsp;&nbsp;Defining Alien
Types</a></li>
<li><a href="#htoc244">8.2.2&nbsp;&nbsp;Alien Types and Lisp
Types</a></li>
<li><a href="#htoc245">8.2.3&nbsp;&nbsp;Alien Type
Specifiers</a></li>
<li><a href="#htoc246">8.2.4&nbsp;&nbsp;The C-Call Package</a></li>
</ul>
</li>
<li><a href="#htoc247">8.3&nbsp;&nbsp;Alien Operations</a>
<ul>
<li><a href="#htoc248">8.3.1&nbsp;&nbsp;Alien Access
Operations</a></li>
<li><a href="#htoc249">8.3.2&nbsp;&nbsp;Alien Coercion
Operations</a></li>
<li><a href="#htoc250">8.3.3&nbsp;&nbsp;Alien Dynamic
Allocation</a></li>
</ul>
</li>
<li><a href="#htoc251">8.4&nbsp;&nbsp;Alien Variables</a>
<ul>
<li><a href="#htoc252">8.4.1&nbsp;&nbsp;Local Alien
Variables</a></li>
<li><a href="#htoc253">8.4.2&nbsp;&nbsp;External Alien
Variables</a></li>
</ul>
</li>
<li><a href="#htoc254">8.5&nbsp;&nbsp;Alien Data Structure
Example</a></li>
<li><a href="#htoc255">8.6&nbsp;&nbsp;Loading Unix Object
Files</a></li>
<li><a href="#htoc256">8.7&nbsp;&nbsp;Alien Function Calls</a>
<ul>
<li><a href="#htoc257">8.7.1&nbsp;&nbsp;The alien-funcall
Primitive</a></li>
<li><a href="#htoc258">8.7.2&nbsp;&nbsp;The def-alien-routine
Macro</a></li>
<li><a href="#htoc259">8.7.3&nbsp;&nbsp;def-alien-routine
Example</a></li>
<li><a href="#htoc260">8.7.4&nbsp;&nbsp;Calling Lisp from
C</a></li>
<li><a href="#htoc261">8.7.5&nbsp;&nbsp;Callback Example</a></li>
<li><a href="#htoc262">8.7.6&nbsp;&nbsp;Accessing Lisp
Arrays</a></li>
</ul>
</li>
<li><a href="#htoc263">8.8&nbsp;&nbsp;Step-by-Step Alien
Example</a></li>
</ul>
</li>
<li><a href="#htoc264">Chapter&nbsp;9&nbsp;&nbsp;Interprocess
Communication under LISP</a>
<ul>
<li><a href="#htoc265">9.1&nbsp;&nbsp;The REMOTE Package</a>
<ul>
<li><a href="#htoc266">9.1.1&nbsp;&nbsp;Connecting Servers and
Clients</a></li>
<li><a href="#htoc267">9.1.2&nbsp;&nbsp;Remote Evaluations</a></li>
<li><a href="#htoc268">9.1.3&nbsp;&nbsp;Remote Objects</a></li>
</ul>
</li>
<li><a href="#htoc269">9.2&nbsp;&nbsp;The WIRE Package</a>
<ul>
<li><a href="#htoc270">9.2.1&nbsp;&nbsp;Untagged Data</a></li>
<li><a href="#htoc271">9.2.2&nbsp;&nbsp;Tagged Data</a></li>
<li><a href="#htoc272">9.2.3&nbsp;&nbsp;Making Your Own
Wires</a></li>
</ul>
</li>
<li><a href="#htoc273">9.3&nbsp;&nbsp;Out-Of-Band Data</a></li>
</ul>
</li>
<li><a href="#htoc274">Chapter&nbsp;10&nbsp;&nbsp;Networking
Support</a>
<ul>
<li><a href="#htoc275">10.1&nbsp;&nbsp;Byte Order
Converters</a></li>
<li><a href="#htoc276">10.2&nbsp;&nbsp;Domain Name Services
(DNS)</a></li>
<li><a href="#htoc277">10.3&nbsp;&nbsp;Binding to
Interfaces</a></li>
<li><a href="#htoc278">10.4&nbsp;&nbsp;Accepting
Connections</a></li>
<li><a href="#htoc279">10.5&nbsp;&nbsp;Connecting</a></li>
<li><a href="#htoc280">10.6&nbsp;&nbsp;Out-of-Band Data</a></li>
<li><a href="#htoc281">10.7&nbsp;&nbsp;Unbound Sockets, Socket
Options, and Closing Sockets</a></li>
<li><a href="#htoc282">10.8&nbsp;&nbsp;Unix Datagrams</a></li>
<li><a href="#htoc283">10.9&nbsp;&nbsp;Errors</a></li>
</ul>
</li>
<li><a href="#htoc284">Chapter&nbsp;11&nbsp;&nbsp;Debugger
Programmer's Interface</a>
<ul>
<li><a href="#htoc285">11.1&nbsp;&nbsp;DI Exceptional
Conditions</a>
<ul>
<li><a href="#htoc286">11.1.1&nbsp;&nbsp;Debug-conditions</a></li>
<li><a href="#htoc287">11.1.2&nbsp;&nbsp;Debug-errors</a></li>
</ul>
</li>
<li><a href="#htoc288">11.2&nbsp;&nbsp;Debug-variables</a></li>
<li><a href="#htoc289">11.3&nbsp;&nbsp;Frames</a></li>
<li><a href="#htoc290">11.4&nbsp;&nbsp;Debug-functions</a></li>
<li><a href="#htoc291">11.5&nbsp;&nbsp;Debug-blocks</a></li>
<li><a href="#htoc292">11.6&nbsp;&nbsp;Breakpoints</a></li>
<li><a href="#htoc293">11.7&nbsp;&nbsp;Code-locations</a></li>
<li><a href="#htoc294">11.8&nbsp;&nbsp;Debug-sources</a></li>
<li><a href="#htoc295">11.9&nbsp;&nbsp;Source Translation
Utilities</a></li>
</ul>
</li>
<li><a href="#htoc296">Chapter&nbsp;12&nbsp;&nbsp;Cross-Referencing
Facility</a>
<ul>
<li><a href="#htoc297">12.1&nbsp;&nbsp;Populating the
cross-reference database</a></li>
<li><a href="#htoc298">12.2&nbsp;&nbsp;Querying the cross-reference
database</a></li>
<li><a href="#htoc299">12.3&nbsp;&nbsp;Example usage</a></li>
<li><a href="#htoc300">12.4&nbsp;&nbsp;Limitations of the
cross-referencing facility</a></li>
</ul>
</li>
</ul>
<!--NAME cmu-user.htoc.html-->
<br>
<br>
<!--TOC chapter Introduction-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc1" id="htoc1"><b><font size=
"6">Chapter&nbsp;1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"6">Introduction</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL is a free, high-performance implementation of the Common Lisp
programming language which runs on most major Unix platforms. It
mainly conforms to the ANSI Common Lisp standard. Here is a summary
of its main features:
<ul>
<li>a <em>sophisticated native-code compiler</em> which is capable
of powerful type inferences, and generates code competitive in
speed with C compilers.<br>
<br></li>
<li>generational garbage collection and multiprocessing capability
on the x86 ports.<br>
<br></li>
<li>a foreign function interface which allows interfacing with C
code and system libraries, including shared libraries on most
platforms, and direct access to Unix system calls.<br>
<br></li>
<li>support for interprocess communication and remote procedure
calls.<br>
<br></li>
<li>an implementation of CLOS, the Common Lisp Object System, which
includes multimethods and a metaobject protocol.<br>
<br></li>
<li>a graphical source-level debugger using a Motif interface, and
a code profiler.<br>
<br></li>
<li>an interface to the X11 Window System (CLX), and a
sophisticated graphical widget library (Garnet).<br>
<br></li>
<li>programmer-extensible input and output streams.<br>
<br></li>
<li>an Emacs-like editor implemented in Common Lisp.<br>
<br></li>
<li>public domain: free, with full source code and no strings
attached (and no warranty). Like GNU/Linux and the *BSD operating
systems, CMUCL is maintained and improved by a team of volunteers
collaborating over the Internet.</li>
</ul>
This user's manual contains only implementation-specific
information about CMUCL. Users will also need a separate manual
describing the Common Lisp standard, for example, the
<em>Hyperspec</em> at <a href=
"http://www.xanalys.com/software_tools">www.xanalys.com</a><br>
<br>
In addition to the language itself, this document describes a
number of useful library modules that run in CMUCL. Hemlock, an
Emacs-like text editor, is included as an integral part of the
CMUCL environment. Two documents describe Hemlock: the <i>Hemlock
User's Manual</i>, and the <i>Hemlock Command Implementor's
Manual</i>.<br>
<br>
<!--TOC section Distribution and Support-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc2" id="htoc2"><b><font size=
"5">1.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Distribution and
Support</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL is developed and maintained by a group of volunteers who
collaborate over the internet. Sources and binary releases for the
various supported platforms can be obtained from <a href=
"http://www.cons.org/cmucl/">www.cons.org/cmucl</a>. These pages
describe how to download by FTP or CVS.<br>
<br>
A number of mailing lists are available for users and developers;
please see the web site for more information.<br>
<br>
<!--TOC section Command Line Options-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc3" id="htoc3"><b><font size=
"5">1.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Command Line
Options</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept0"></a> <a name="command-line-options" id=
"command-line-options"></a><br>
The command line syntax and environment is described in the
<code>lisp(1)</code> man page in the man/man1 directory of the
distribution. See also <code>cmucl(1)</code>. Currently CMUCL
accepts the following switches:<br>
<br>
<dl compact="compact">
<dt><tt class="code">-batch</tt><br></dt>
<dd>specifies batch mode, where all input is directed from
standard-input. An error code of 0 is returned upon encountering an
EOF and 1 otherwise.<br>
<br></dd>
<dt><tt class="code">-quiet</tt><br></dt>
<dd>enters quiet mode. This implies setting the variables
<tt class="code">*load-verbose*</tt>, <tt class=
"code">*compile-verbose*</tt>, <tt class=
"code">*compile-print*</tt>, <tt class=
"code">*compile-progress*</tt>, <tt class=
"code">*require-verbose*</tt> and <tt class=
"code">*gc-verbose*</tt> to NIL, and disables the printing of the
startup banner.<br>
<br></dd>
<dt><tt class="code">-core</tt><br></dt>
<dd>requires an argument that should be the name of a core file.
Rather than using the default core file, which is searched in a
number of places, according to the initial value of the <tt class=
"code">library:</tt> search-list, the specified core file is
loaded. This switch overrides the value of the <tt class=
"code">CMUCLCORE</tt> environment variable, if present.<br>
<br></dd>
<dt><tt class="code">-lib</tt><br></dt>
<dd>requires an argument that should be the path to the CMUCL
library directory, which is going to be used to initialize the
<tt class="code">library:</tt> search-list, among other things.
This switch overrides the value of the <tt class=
"code">CMUCLLIB</tt> environment variable, if present.<br>
<br></dd>
<dt><tt class="code">-dynamic-space-size</tt><br></dt>
<dd>requires an argument that should be the number of megabytes
(1048576 bytes) that should be allocated to the heap. If not
specified, a platform-specific default is used. The actual maximum
allowed heap size is platform-specific.<br>
<br>
Currently, this option is only available for the x86 and sparc
platforms.<br>
<br></dd>
<dt><tt class="code">-edit</tt><br></dt>
<dd>specifies to enter Hemlock. A file to edit may be specified by
placing the name of the file between the program name (usually
<tt class="filename">lisp</tt>) and the first switch.<br>
<br></dd>
<dt><tt class="code">-eval</tt><br></dt>
<dd>accepts one argument which should be a Lisp form to evaluate
during the start up sequence. The value of the form will not be
printed unless it is wrapped in a form that does output.<br>
<br></dd>
<dt><tt class="code">-hinit</tt><br></dt>
<dd>accepts an argument that should be the name of the hemlock init
file to load the first time the function <a name=
"@funs0"></a><tt class="code">ed</tt> is invoked. The default is to
load <tt class="filename">hemlock-init.<tt class=
"variable">object-type</tt></tt>, or if that does not exist,
<tt class="filename">hemlock-init.lisp</tt> from the user's home
directory. If the file is not in the user's home directory, the
full path must be specified.<br>
<br></dd>
<dt><tt class="code">-init</tt><br></dt>
<dd>accepts an argument that should be the name of an init file to
load during the normal start up sequence. The default is to load
<tt class="filename">init.<tt class=
"variable">object-type</tt></tt> or, if that does not exist,
<tt class="filename">init.lisp</tt> from the user's home directory.
If the file is not in the user's home directory, the full path must
be specified.<br>
<br></dd>
<dt><tt class="code">-noinit</tt><br></dt>
<dd>accepts no arguments and specifies that an init file should not
be loaded during the normal start up sequence. Also, this switch
suppresses the loading of a hemlock init file when Hemlock is
started up with the <tt class="code">-edit</tt> switch.<br>
<br></dd>
<dt><tt class="code">-nositeinit</tt><br></dt>
<dd>accepts no arguments and specifies that the site init file
should not be loaded during the normal start up sequence.<br>
<br></dd>
<dt><tt class="code">-load</tt><br></dt>
<dd>accepts an argument which should be the name of a file to load
into Lisp before entering Lisp's read-eval-print loop.<br>
<br></dd>
<dt><tt class="code">-slave</tt><br></dt>
<dd>specifies that Lisp should start up as a islave Lisp and try to
connect to an editor Lisp. The name of the editor to connect to
must be specified---to find the editor's name, use the Hemlock
``<tt class="code">Accept Slave Connections</tt>'' command. The
name for the editor Lisp is of the form:
<blockquote class="example">
<pre>
    <tt class="variable">machine-name</tt><tt class=
"code">:</tt><tt class="variable">socket</tt>
  
</pre></blockquote>
where <tt class="variable">machine-name</tt> is the internet host
name for the machine and <tt class="variable">socket</tt> is the
decimal number of the socket to connect to.</dd>
</dl>
For more details on the use of the <tt class="code">-edit</tt> and
<tt class="code">-slave</tt> switches, see the <i>Hemlock User's
Manual</i>.<br>
<br>
Arguments to the above switches can be specified in one of two
ways: <tt class="variable">switch</tt><tt class=
"code">=</tt><tt class="variable">value</tt> or <tt class=
"variable">switch</tt>&lt;<tt class=
"variable">space</tt>&gt;<tt class="variable">value</tt>. For
example, to start up the saved core file mylisp.core use either of
the following two commands:
<blockquote class="example">
<pre>
   lisp -core=mylisp.core
   lisp -core mylisp.core
</pre></blockquote>
<!--TOC section Credits-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc4" id="htoc4"><b><font size=
"5">1.3</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Credits</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL was developed at the Computer Science Department of Carnegie
Mellon University. The work was a small autonomous part within the
Mach microkernel-based operating system project, and started more
as a tool development effort than a research project. The project
started out as Spice Lisp, which provided a modern Lisp
implementation for use in the CMU community. CMUCL has been under
continual development since the early 1980's (concurrent with the
Common Lisp standardization effort). Most of the CMU Common Lisp
implementors went on to work on the Gwydion environment for Dylan.
The CMU team was lead by Scott E. Fahlman, the Python compiler was
written by Robert MacLachlan.<br>
<br>
CMUCL's CLOS implementation is derived from the PCL reference
implementation written at Xerox PARC:
<blockquote>Copyright (c) 1985, 1986, 1987, 1988, 1989, 1990 Xerox
Corporation.<br>
All rights reserved.<br>
<br>
<br>
Use and copying of this software and preparation of derivative
works based upon this software are permitted. Any distribution of
this software or derivative works must comply with all applicable
United States export control laws.<br>
<br>
<br>
This software is made available AS IS, and Xerox Corporation makes
no warranty about the software, its performance or its conformity
to any specification.</blockquote>
Its implementation of the LOOP macro was derived from code from
Symbolics, which was derived from code written at MIT:
<blockquote>Portions of LOOP are Copyright (c) 1986 by the
Massachusetts Institute of Technology.<br>
All Rights Reserved.<br>
<br>
<br>
Permission to use, copy, modify and distribute this software and
its documentation for any purpose and without fee is hereby
granted, provided that the M.I.T. copyright notice appear in all
copies and that both that copyright notice and this permission
notice appear in supporting documentation. The names "M.I.T." and
"Massachusetts Institute of Technology" may not be used in
advertising or publicity pertaining to distribution of the software
without specific, written prior permission. Notice must be given in
supporting documentation that copying distribution is by permission
of M.I.T. M.I.T. makes no representations about the suitability of
this software for any purpose. It is provided "as is" without
express or implied warranty.<br>
<br>
<br>
<br>
<br>
Portions of LOOP are Copyright (c) 1989, 1990, 1991, 1992 by
Symbolics, Inc.<br>
All Rights Reserved.<br>
<br>
<br>
Permission to use, copy, modify and distribute this software and
its documentation for any purpose and without fee is hereby
granted, provided that the Symbolics copyright notice appear in all
copies and that both that copyright notice and this permission
notice appear in supporting documentation. The name "Symbolics" may
not be used in advertising or publicity pertaining to distribution
of the software without specific, written prior permission. Notice
must be given in supporting documentation that copying distribution
is by permission of Symbolics. Symbolics makes no representations
about the suitability of this software for any purpose. It is
provided "as is" without express or implied warranty.<br>
<br>
<br>
Symbolics, CLOE Runtime, and Minima are trademarks, and CLOE,
Genera, and Zetalisp are registered trademarks of Symbolics,
Inc.</blockquote>
The CLX code is copyrighted by Texas Instruments Incorporated:
<blockquote>Copyright (C) 1987 Texas Instruments Incorporated.<br>
<br>
<br>
Permission is granted to any individual or institution to use,
copy, modify, and distribute this software, provided that this
complete copyright and permission notice is maintained, intact, in
all copies and supporting documentation.<br>
<br>
<br>
Texas Instruments Incorporated provides this software "as is"
without express or implied warranty.</blockquote>
CMUCL was funded by DARPA under CMU's "Research on Parallel
Computing" contract. Rather than doing pure research on programming
languages and environments, the emphasis was on developing
practical programming tools. Sometimes this required new
technology, but much of the work was in creating a Common Lisp
environment that incorporates state-of-the-art features from
existing systems (both Lisp and non-Lisp). Archives of the project
are available online.<br>
<br>
The project funding stopped in 1994, so support at Carnegie Mellon
University has been discontinued. All code and documentation
developed at CMU was released into the public domain. The project
continues as a group of users and developers collaborating over the
Internet. The currently active maintainers are:
<ul>
<li>Marco Antoniotti</li>
<li>Martin Cracauer</li>
<li>Rob MacLachlan</li>
<li>Pierre Mai</li>
<li>Eric Marsden</li>
<li>Gerd Moellman</li>
<li>Tim Moore</li>
<li>Raymond Toy</li>
<li>Peter Van Eynde</li>
<li>Paul Werkowski</li>
</ul>
In particular, Paul Werkowski and Douglas Crosher completed the
port for the x86 architecture for FreeBSD. Peter VanEnyde took the
FreeBSD port and created a Linux version. Other people who have
contributed to the development of CMUCL since 1981 are
<ul>
<li>David Axmark</li>
<li>Miles Bader</li>
<li>Rick Busdiecker</li>
<li>Bill Chiles</li>
<li>Douglas Thomas Crosher</li>
<li>Casper Dik</li>
<li>Ted Dunning</li>
<li>Scott Fahlman</li>
<li>Mike Garland</li>
<li>Paul Gleichauf</li>
<li>Sean Hallgren</li>
<li>Richard Harris</li>
<li>Joerg-Cyril Hoehl</li>
<li>Chris Hoover</li>
<li>John Kolojejchick</li>
<li>Todd Kaufmann</li>
<li>Simon Leinen</li>
<li>Sandra Loosemore</li>
<li>William Lott</li>
<li>Dave McDonald</li>
<li>Tim Moore</li>
<li>Skef Wholey</li>
</ul>
Countless others have contributed to the project by sending in bug
reports, bug fixes, new features.<br>
<br>
This manual is based on CMU Technical Report CMU-CS-92-161, edited
by Robert A. MacLachlan, dated July 1992. Other contributors
include Raymond Toy, Paul Werkowski and Eric Marsden. The
Hierarchical Packages chapter is based on documentation written by
Franz. Inc, and is used with permission. The remainder of the
document is in the public domain. <!--NAME introduction.html-->
 <!--TOC chapter Design Choices and Extensions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc5" id="htoc5"><b><font size=
"6">Chapter&nbsp;2</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Design Choices
and Extensions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Several design choices in Common Lisp are left to the individual
implementation, and some essential parts of the programming
environment are left undefined. This chapter discusses the most
important design choices and extensions.<br>
<br>
<!--TOC section Data Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc6" id="htoc6"><b><font size=
"5">2.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Data
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<!--TOC subsection Integers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc7" id="htoc7"><b><font size=
"4">2.1.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Integers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <a name="@types0"></a><tt class="code">fixnum</tt> type is
equivalent to <tt class="code">(signed-byte 30)</tt>. Integers
outside this range are represented as a <a name=
"@types1"></a><tt class="code">bignum</tt> or a word integer (see
section&nbsp;<a href="#word-integers">5.11.6</a>.) Almost all
integers that appear in programs can be represented as a <tt class=
"code">fixnum</tt>, so integer number consing is rare.<br>
<br>
<!--TOC subsection Floats-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc8" id="htoc8"><b><font size=
"4">2.1.2</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Floats</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="ieee-float" id="ieee-float"></a><br>
CMUCL supports three floating point formats: <a name=
"@types2"></a><tt class="code">single-float</tt>, <a name=
"@types3"></a><tt class="code">double-float</tt> and <a name=
"@types4"></a><tt class="code">double-double-float</tt>. The first
two are implemented with IEEE single and double float arithmetic,
respectively. The last is an extension; see section&nbsp;<a href=
"#extended-float">2.1.3</a> for more information. <tt class=
"code">short-float</tt> is a synonym for <tt class=
"code">single-float</tt>, and <tt class="code">long-float</tt> is a
synonym for <tt class="code">double-float</tt>. The initial value
of <a name="@vars0"></a><tt class=
"code">*read-default-float-format*</tt> is <tt class=
"code">single-float</tt>.<br>
<br>
Both <tt class="code">single-float</tt> and <tt class=
"code">double-float</tt> are represented with a pointer descriptor,
so float operations can cause number consing. Number consing is
greatly reduced if programs are written to allow the use of
non-descriptor representations (see section&nbsp;<a href=
"#numeric-types">5.11</a>.)<br>
<br>
<!--TOC subsubsection IEEE Special Values-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.1.2.1</b></td>
<td width="100%" align="center"><b>IEEE Special Values</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL supports the IEEE infinity and NaN special values. These
non-numeric values will only be generated when trapping is disabled
for some floating point exception (see section&nbsp;<a href=
"#float-traps">2.1.2.4</a>), so users of the default configuration
need not concern themselves with special values.<br>
<br>
<br>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">short-float-positive-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">short-float-negative-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">single-float-positive-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">single-float-negative-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">double-float-positive-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">double-float-negative-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">long-float-positive-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">long-float-negative-infinity</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
The values of these constants are the IEEE positive and negative
infinity objects for each float format.</blockquote>
<br>
<a name="@funs1"></a><a name="FN:float-infinity-p" id=
"FN:float-infinity-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">float-infinity-p</tt> <tt class="variable">x</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns true if <tt class="variable">x</tt> is an
IEEE float infinity (of either sign.) <tt class="variable">x</tt>
must be a float.</blockquote>
<br>
<a name="@funs2"></a><a name="FN:float-nan-p" id=
"FN:float-nan-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">float-nan-p</tt> <tt class="variable">x</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs3"></a><a name="FN:float-trapping-nan-p" id=
"FN:float-trapping-nan-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">float-trapping-nan-p</tt> <tt class=
"variable">x</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<br>
<tt class="code">float-nan-p</tt> returns true if <tt class=
"variable">x</tt> is an IEEE NaN (Not A Number) object. <tt class=
"code">float-trapping-nan-p</tt> returns true only if <tt class=
"variable">x</tt> is a trapping NaN. With either function,
<tt class="variable">x</tt> must be a float.</blockquote>
<!--TOC subsubsection Negative Zero-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.1.2.2</b></td>
<td width="100%" align="center"><b>Negative Zero</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The IEEE float format provides for distinct positive and negative
zeros. To test the sign on zero (or any other float), use the
Common Lisp <a name="@funs4"></a><tt class="code">float-sign</tt>
function. Negative zero prints as <tt class="code">-0.0f0</tt> or
<tt class="code">-0.0d0</tt>.<br>
<br>
<!--TOC subsubsection Denormalized Floats-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.1.2.3</b></td>
<td width="100%" align="center"><b>Denormalized Floats</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL supports IEEE denormalized floats. Denormalized floats
provide a mechanism for gradual underflow. The Common Lisp <a name=
"@funs5"></a><tt class="code">float-precision</tt> function returns
the actual precision of a denormalized float, which will be less
than <a name="@funs6"></a><tt class="code">float-digits</tt>. Note
that in order to generate (or even print) denormalized floats,
trapping must be disabled for the underflow exception (see
section&nbsp;<a href="#float-traps">2.1.2.4</a>.) The Common Lisp
<tt class="code">least-positive-</tt><tt class=
"variable">format</tt>-<tt class="code">float</tt> constants are
denormalized.<br>
<br>
<br>
<a name="@funs7"></a><a name="FN:float-denormalized-p" id=
"FN:float-denormalized-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">float-denormalized-p</tt> <tt class=
"variable">x</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns true if <tt class="variable">x</tt> is a
denormalized float. <tt class="variable">x</tt> must be a
float.</blockquote>
<!--TOC subsubsection Floating Point Exceptions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.1.2.4</b></td>
<td width="100%" align="center"><b>Floating Point
Exceptions</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="float-traps" id="float-traps"></a><br>
The IEEE floating point standard defines several exceptions that
occur when the result of a floating point operation is unclear or
undesirable. Exceptions can be ignored, in which case some default
action is taken, such as returning a special value. When trapping
is enabled for an exception, a error is signalled whenever that
exception occurs. These are the possible floating point exceptions:
<dl compact="compact">
<dt><tt class="code">:underflow</tt><br></dt>
<dd>This exception occurs when the result of an operation is too
small to be represented as a normalized float in its format. If
trapping is enabled, the <a name="@types5"></a><tt class=
"code">floating-point-underflow</tt> condition is signalled.
Otherwise, the operation results in a denormalized float or
zero.<br>
<br></dd>
<dt><tt class="code">:overflow</tt><br></dt>
<dd>This exception occurs when the result of an operation is too
large to be represented as a float in its format. If trapping is
enabled, the <a name="@types6"></a><tt class=
"code">floating-point-overflow</tt> exception is signalled.
Otherwise, the operation results in the appropriate infinity.<br>
<br></dd>
<dt><tt class="code">:inexact</tt><br></dt>
<dd>This exception occurs when the result of a floating point
operation is not exact, i.e. the result was rounded. If trapping is
enabled, the <tt class=
"code">extensions:floating-point-inexact</tt> condition is
signalled. Otherwise, the rounded result is returned.<br>
<br></dd>
<dt><tt class="code">:invalid</tt><br></dt>
<dd>This exception occurs when the result of an operation is
ill-defined, such as <tt class="code">(/ 0.0 0.0)</tt>. If trapping
is enabled, the <tt class=
"code">extensions:floating-point-invalid</tt> condition is
signalled. Otherwise, a quiet NaN is returned.<br>
<br></dd>
<dt><tt class="code">:divide-by-zero</tt><br></dt>
<dd>This exception occurs when a float is divided by zero. If
trapping is enabled, the <a name="@types7"></a><tt class=
"code">divide-by-zero</tt> condition is signalled. Otherwise, the
appropriate infinity is returned.</dd>
</dl>
<!--TOC subsubsection Floating Point Rounding Mode-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.1.2.5</b></td>
<td width="100%" align="center"><b>Floating Point Rounding
Mode</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="float-rounding-modes" id="float-rounding-modes"></a><br>
IEEE floating point specifies four possible rounding modes:
<dl compact="compact">
<dt><tt class="code">:nearest</tt><br></dt>
<dd>In this mode, the inexact results are rounded to the nearer of
the two possible result values. If the neither possibility is
nearer, then the even alternative is chosen. This form of rounding
is also called ``round to even'', and is the form of rounding
specified for the Common Lisp <a name="@funs8"></a><tt class=
"code">round</tt> function.<br>
<br></dd>
<dt><tt class="code">:positive-infinity</tt><br></dt>
<dd>This mode rounds inexact results to the possible value closer
to positive infinity. This is analogous to the Common Lisp <a name=
"@funs9"></a><tt class="code">ceiling</tt> function.<br>
<br></dd>
<dt><tt class="code">:negative-infinity</tt><br></dt>
<dd>This mode rounds inexact results to the possible value closer
to negative infinity. This is analogous to the Common Lisp <a name=
"@funs10"></a><tt class="code">floor</tt> function.<br>
<br></dd>
<dt><tt class="code">:zero</tt><br></dt>
<dd>This mode rounds inexact results to the possible value closer
to zero. This is analogous to the Common Lisp <a name=
"@funs11"></a><tt class="code">truncate</tt> function.</dd>
</dl>
<!--TOC paragraph Warning:-->
<h5>Warning:</h5>
<!--SEC END -->
Although the rounding mode can be changed with <tt class=
"code">set-floating-point-modes</tt>, use of any value other than
the default (<tt class="code">:nearest</tt>) can cause unusual
behavior, since it will affect rounding done by Common Lisp system
code as well as rounding in user code. In particular, the unary
<tt class="code">round</tt> function will stop doing
round-to-nearest on floats, and instead do the selected form of
rounding.<br>
<br>
<!--TOC subsubsection Accessing the Floating Point Modes-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.1.2.6</b></td>
<td width="100%" align="center"><b>Accessing the Floating Point
Modes</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These functions can be used to modify or read the floating point
modes:<br>
<br>
<br>
<a name="@funs12"></a><a name="FN:set-floating-point-modes" id=
"FN:set-floating-point-modes"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">set-floating-point-modes</tt> <tt class=
"code">&amp;key</tt> <tt class="code">:traps</tt> <tt class=
"code">:rounding-mode</tt><br>
<tt class="code">:fast-mode</tt> <tt class=
"code">:accrued-exceptions</tt><br>
<tt class="code">:current-exceptions</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs13"></a><a name="FN:get-floating-point-modes" id=
"FN:get-floating-point-modes"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">get-floating-point-modes</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
The keyword arguments to <tt class=
"code">set-floating-point-modes</tt> set various modes controlling
how floating point arithmetic is done:
<dl compact="compact">
<dt><tt class="code">:traps</tt><br></dt>
<dd>A list of the exception conditions that should cause traps.
Possible exceptions are <tt class="code">:underflow</tt>,
<tt class="code">:overflow</tt>, <tt class="code">:inexact</tt>,
<tt class="code">:invalid</tt> and <tt class=
"code">:divide-by-zero</tt>. Initially all traps except <tt class=
"code">:inexact</tt> are enabled. See section&nbsp;<a href=
"#float-traps">2.1.2.4</a>.<br>
<br></dd>
<dt><tt class="code">:rounding-mode</tt><br></dt>
<dd>The rounding mode to use when the result is not exact. Possible
values are <tt class="code">:nearest</tt>, <tt class=
"code">:positive-infinity</tt>, <tt class=
"code">:negative-infinity</tt> and <tt class="code">:zero</tt>.
Initially, the rounding mode is <tt class="code">:nearest</tt>. See
the warning in section <a href="#float-rounding-modes">2.1.2.5</a>
about use of other rounding modes.<br>
<br></dd>
<dt><tt class="code">:current-exceptions</tt>, <tt class=
"code">:accrued-exceptions</tt><br></dt>
<dd>Lists of exception keywords used to set the exception flags.
The <tt class="variable">current-exceptions</tt> are the exceptions
for the previous operation, so setting it is not very useful. The
<tt class="variable">accrued-exceptions</tt> are a cumulative
record of the exceptions that occurred since the last time these
flags were cleared. Specifying <tt class="code">()</tt> will clear
any accrued exceptions.<br>
<br></dd>
<dt><tt class="code">:fast-mode</tt><br></dt>
<dd>Set the hardware's ``fast mode'' flag, if any. When set, IEEE
conformance or debuggability may be impaired. Some machines may not
have this feature, in which case the value is always <tt class=
"code">nil</tt>. Sparc platforms support a fast mode where denormal
numbers are silently truncated to zero.</dd>
</dl>
If a keyword argument is not supplied, then the associated state is
not changed.<br>
<br>
<tt class="code">get-floating-point-modes</tt> returns a list
representing the state of the floating point modes. The list is in
the same format as the keyword arguments to <tt class=
"code">set-floating-point-modes</tt>, so <tt class=
"code">apply</tt> could be used with <tt class=
"code">set-floating-point-modes</tt> to restore the modes in effect
at the time of the call to <tt class=
"code">get-floating-point-modes</tt>.</blockquote>
To make handling control of floating-point exceptions, the
following macro is useful.<br>
<br>
<br>
<a name="@funs14"></a><a name="FN:with-float-traps-masked" id=
"FN:with-float-traps-masked"></a>
<div align="left">[Macro]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">with-float-traps-masked</tt> traps <tt class=
"code">&amp;body</tt> body &nbsp;&nbsp;&nbsp;</div>
<blockquote><tt class="code">body</tt> is executed with the
selected floating-point exceptions given by <tt class=
"code">traps</tt> masked out (disabled). <tt class=
"code">traps</tt> should be a list of possible floating-point
exceptions that should be ignored. Possible values are <tt class=
"code">:underflow</tt>, <tt class="code">:overflow</tt>, <tt class=
"code">:inexact</tt>, <tt class="code">:invalid</tt> and <tt class=
"code">:divide-by-zero</tt>.<br>
<br>
This is equivalent to saving the current traps from <tt class=
"code">get-floating-point-modes</tt>, setting the floating-point
modes to the desired exceptions, running the <tt class=
"code">body</tt>, and restoring the saved floating-point modes. The
advantage of this macro is that it causes less consing to
occur.<br>
<br>
Some points about the with-float-traps-masked:
<ul>
<li>Two approaches are available for detecting FP exceptions:
<ol type="1">
<li>enabling the traps and handling the exceptions</li>
<li>disabling the traps and either handling the return values or
checking the accrued exceptions.</li>
</ol>
Of these the latter is the most portable because on the alpha port
it is not possible to enable some traps at run-time.<br>
<br></li>
<li>To assist the checking of the exceptions within the body any
accrued exceptions matching the given traps are cleared at the
start of the body when the traps are masked.<br>
<br></li>
<li>To allow the macros to be nested these accrued exceptions are
restored at the end of the body to their values at the start of the
body. Thus any exceptions that occurred within the body will not
affect the accrued exceptions outside the macro.<br>
<br></li>
<li>Note that only the given exceptions are restored at the end of
the body so other exception will be visible in the accrued
exceptions outside the body.<br>
<br></li>
<li>On the x86, setting the accrued exceptions of an unmasked
exception would cause a FP trap. The macro behaviour of restoring
the accrued exceptions ensures than if an accrued exception is
initially not flagged and occurs within the body it will be
restored/cleared at the exit of the body and thus not cause a
trap.<br>
<br></li>
<li>On the x86, and, perhaps, the hppa, the FP exceptions may be
delivered at the next FP instruction which requires a FP <tt class=
"code">wait</tt> instruction (<tt class=
"code">x86::float-wait</tt>) if using the lisp conditions to catch
trap within a <tt class="code">handler-bind</tt>. The <tt class=
"code">handler-bind</tt> macro does the right thing and inserts a
float-wait (at the end of its body on the x86). The masking and
noting of exceptions is also safe here.<br>
<br></li>
<li>The setting of the FP flags uses the <tt class=
"code">(floating-point-modes)</tt> and the <tt class="code">(set
(floating-point-modes)...)</tt> VOPs. These VOPs blindly update the
flags which may include other state. We assume this state hasn't
changed in between getting and setting the state. For example, if
you used the FP unit between the above calls, the state may be
incorrectly restored! The <tt class=
"code">with-float-traps-masked</tt> macro keeps the intervening
code to a minimum and uses only integer operations.</li>
</ul>
</blockquote>
<!--TOC subsection Extended Floats-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc9" id="htoc9"><b><font size=
"4">2.1.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Extended
Floats</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="extended-float" id="extended-float"></a><br>
CMUCL also has an extension to support <tt class=
"code">double-double-float</tt> type. This float format provides
extended precision of about 31 decimal digits, with the same
exponent range as <tt class="code">double-float</tt>. It is
completely integrated into CMUCL, and can be used just like any
other floating-point object, including arrays, complex <tt class=
"code">double-double-float</tt>'s, and special functions. With
appropriate declarations, no boxing is needed, just like <tt class=
"code">single-float</tt> and <tt class=
"code">double-float</tt>.<br>
<br>
The exponent marker for a double-double float number is ``W'', so
``1.234w0'' is a double-double float number.<br>
<br>
Note that there are a few shortcomings with <tt class=
"code">double-double-float</tt>'s:
<ul>
<li>There are no equivalents to <tt class=
"code">most-positive-double-float</tt>, <tt class=
"code">double-float-positive-infinity</tt>, <i>etc</i>. This is
because these are not really well defined for <tt class=
"code">double-double-float</tt>'s.</li>
<li>Underflow and overflow may be prematurely signaled. This is due
to how <tt class="code">double-double-float</tt>'s are
implemented.</li>
<li>Basic arithmetic operations are inlined, so the code size is
fairly large.</li>
<li><tt class="code">double-double-float</tt> arithmetic is quite a
bit slower than <tt class="code">double-float</tt> since there is
no hardware support for this type.</li>
<li>The constant <tt class="code">pi</tt> is still a <tt class=
"code">double-float</tt> instead of a <tt class=
"code">double-double-float</tt>. Use <tt class=
"code">ext:dd-pi</tt> if you want a <tt class=
"code">double-double-float</tt> value for <font face=
"symbol">p</font>.</li>
</ul>
<br>
<br>
<a name="@types8"></a>
<div align="left">[float]<br>
<tt class="function-name">extensions:double-double-float</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>The <tt class="code">double-double-float</tt> type. It
is in the <tt class="code">EXTENSIONS</tt> package.</blockquote>
<br>
<div align="left">[Constant]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">dd-pi</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>A <tt class="code">double-double-float</tt>
approximation to <font face="symbol">p</font>.</blockquote>
<!--TOC subsection Characters-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc10" id="htoc10"><b><font size=
"4">2.1.4</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Characters</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL implements characters according to <i>Common Lisp: The
Language II</i>. The main difference from the first version is that
character bits and font have been eliminated, and the names of the
types have been changed. <a name="@types9"></a><tt class=
"code">base-character</tt> is the new equivalent of the old
<a name="@types10"></a><tt class="code">string-char</tt>. In this
implementation, all characters are base characters (there are no
extended characters.) Character codes range between <tt class=
"code">0</tt> and <tt class="code">255</tt>, using the ASCII
encoding. Table&nbsp;<a href="#tbl:chars">2.1</a>&nbsp;tbl:chars
shows characters recognized by CMUCL.
<blockquote>
<div align="center">
<hr width="80%" size="2"></div>
<div align="center">
<table border="1" cellspacing="0" cellpadding="1">
<tr>
<td align="center" nowrap colspan="2">ASCII</td>
<td align="center" nowrap>Lisp</td>
<td align="center" nowrap colspan="3">&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap>Name</td>
<td align="center" nowrap>Code</td>
<td align="center" nowrap>Name</td>
<td align="center" nowrap colspan="3">1.5exAlternatives</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">nul</tt></td>
<td align="center" nowrap>0</td>
<td align="left" nowrap><tt class="code">#\NULL</tt></td>
<td align="left" nowrap><tt class="code">#\NUL</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">bel</tt></td>
<td align="center" nowrap>7</td>
<td align="left" nowrap><tt class="code">#\BELL</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">bs</tt></td>
<td align="center" nowrap>8</td>
<td align="left" nowrap><tt class="code">#\BACKSPACE</tt></td>
<td align="left" nowrap><tt class="code">#\BS</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">tab</tt></td>
<td align="center" nowrap>9</td>
<td align="left" nowrap><tt class="code">#\TAB</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">lf</tt></td>
<td align="center" nowrap>10</td>
<td align="left" nowrap><tt class="code">#\NEWLINE</tt></td>
<td align="left" nowrap><tt class="code">#\NL</tt></td>
<td align="left" nowrap><tt class="code">#\LINEFEED</tt></td>
<td align="left" nowrap><tt class="code">#\LF</tt></td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">ff</tt></td>
<td align="center" nowrap>11</td>
<td align="left" nowrap><tt class="code">#\VT</tt></td>
<td align="left" nowrap><tt class="code">#\PAGE</tt></td>
<td align="left" nowrap><tt class="code">#\FORM</tt></td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">cr</tt></td>
<td align="center" nowrap>13</td>
<td align="left" nowrap><tt class="code">#\RETURN</tt></td>
<td align="left" nowrap><tt class="code">#\CR</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">esc</tt></td>
<td align="center" nowrap>27</td>
<td align="left" nowrap><tt class="code">#\ESCAPE</tt></td>
<td align="left" nowrap><tt class="code">#\ESC</tt></td>
<td align="left" nowrap><tt class="code">#\ALTMODE</tt></td>
<td align="left" nowrap><tt class="code">#\ALT</tt></td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">sp</tt></td>
<td align="center" nowrap>32</td>
<td align="left" nowrap><tt class="code">#\SPACE</tt></td>
<td align="left" nowrap><tt class="code">#\SP</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
<tr>
<td align="center" nowrap><tt class="code">del</tt></td>
<td align="center" nowrap>127</td>
<td align="left" nowrap><tt class="code">#\DELETE</tt></td>
<td align="left" nowrap><tt class="code">#\RUBOUT</tt></td>
<td align="left" nowrap>&nbsp;</td>
<td align="left" nowrap>&nbsp;</td>
</tr>
</table>
<br>
<div align="center">Table 2.1: Characters recognized by CMUCL</div>
<br>
<a name="tbl:chars" id="tbl:chars"></a></div>
<div align="center">
<hr width="80%" size="2"></div>
</blockquote>
<!--TOC subsection Array Initialization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc11" id="htoc11"><b><font size=
"4">2.1.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Array
Initialization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
If no <tt class="code">:initial-value</tt> is specified, arrays are
initialized to zero.<br>
<br>
<!--TOC subsection Hash tables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc12" id="htoc12"><b><font size=
"4">2.1.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Hash
tables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <a name="@types11"></a><tt class="code">hash-tables</tt>
defined by Common Lisp have limited utility because they are
limited to testing their keys using the equality predicates
provided by (pre-CLOS) Common Lisp. CMUCL overcomes this limitation
by allowing its users to specify new hash table tests and hashing
methods. The hashing method must also be specified, since the
compiler is unable to determine a good hashing function for an
arbitrary equality (equivalence) predicate.<br>
<br>
<br>
<a name="@funs15"></a><a name="FN:define-hash-table-test" id=
"FN:define-hash-table-test"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">define-hash-table-test</tt> <tt class=
"variable">hash-table-test-name</tt> <tt class=
"variable">test-function</tt> <tt class=
"variable">hash-function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The <tt class="variable">hash-table-test-name</tt> must be a
symbol. The <tt class="variable">test-function</tt> takes two
objects and returns true iff they are the same. The <tt class=
"variable">hash-function</tt> takes one object and returns two
values: the (positive fixnum) hash value and true if the hashing
depends on pointer values and will have to be redone if the object
moves.<br>
<br>
To create a hash-table using this new ``test'' (really, a
test/hash-function pair), use <tt class="code">(<a name=
"@funs16"></a>make-hash-table :test <tt class=
"variable">hash-table-test-name</tt> ...)</tt>.<br>
<br>
Note that it is the <tt class="variable">hash-table-test-name</tt>
that will be returned by the function <a name=
"@funs17"></a><tt class="code">hash-table-test</tt>, when applied
to a hash-table created using this function.<br>
<br>
This function updates <a name="@vars1"></a><tt class=
"code">*hash-table-tests*</tt>, which is now internal.</blockquote>
CMUCL also supports a number of weak hash tables. These weak tables
are created using the <tt class="code">:weak-p</tt> argument to
<tt class="code">make-hash-table</tt>. Normally, a reference to an
object as either the key or value of the hash-table will prevent
that object from being garbage-collected. However, in a weak table,
if the only reference is the hash-table, the object can be
collected.<br>
<br>
The possible values for <tt class="code">:weak-p</tt> are listed
below. An entry in the table remains if the condition holds
<dl compact="compact">
<dt><tt class="code">:key</tt><br></dt>
<dd>The key is referenced elsewhere</dd>
<dt><tt class="code">:value</tt><br></dt>
<dd>The value is referenced elsewhere</dd>
<dt><tt class="code">:key-and-value</tt><br></dt>
<dd>Both the key and value are referenced elsewhere</dd>
<dt><tt class="code">:key-or-value</tt><br></dt>
<dd>Either the key or value are referenced elsewhere</dd>
<dt>T<br></dt>
<dd>For backward compatibility, this means the same as <tt class=
"code">:key</tt>.</dd>
</dl>
If the condition does not hold, the object can be removed from the
hash table.<br>
<br>
Weak hash tables can only be created if the test is <tt class=
"code">eq</tt> or <tt class="code">eql</tt>. An error is signaled
if this is not the case.<br>
<br>
<br>
<a name="@funs18"></a><a name="FN:make-hash-table" id=
"FN:make-hash-table"></a>
<div align="left">[Function]<br>
<tt class="function-name">make-hash-table</tt> <tt class=
"code">&amp;key</tt> <tt class="code">:test</tt> <tt class=
"code">:size</tt> <tt class="code">:rehash-size</tt> <tt class=
"code">:rehash-threshold</tt> <tt class="code">:weak-p</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Creates a hash-table with the specified
properties.</blockquote>
<!--TOC section Default Interrupts for Lisp-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc13" id="htoc13"><b><font size=
"5">2.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Default
Interrupts for Lisp</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL has several interrupt handlers defined when it starts up, as
follows:
<dl compact="compact">
<dt><tt class="code">SIGINT</tt> (<tt class=
"code">Ctrl-c</tt>)<br></dt>
<dd>causes Lisp to enter a break loop. This puts you into the
debugger which allows you to look at the current state of the
computation. If you proceed from the break loop, the computation
will proceed from where it was interrupted.<br>
<br></dd>
<dt><tt class="code">SIGQUIT</tt> (<tt class=
"code">Ctrl-L</tt>)<br></dt>
<dd>causes Lisp to do a throw to the top-level. This causes the
current computation to be aborted, and control returned to the
top-level read-eval-print loop.<br>
<br></dd>
<dt><tt class="code">SIGTSTP</tt> (<tt class=
"code">Ctrl-z</tt>)<br></dt>
<dd>causes Lisp to suspend execution and return to the Unix shell.
If control is returned to Lisp, the computation will proceed from
where it was interrupted.<br>
<br></dd>
<dt><tt class="code">SIGILL</tt>, <tt class="code">SIGBUS</tt>,
<tt class="code">SIGSEGV</tt>, and <tt class=
"code">SIGFPE</tt><br></dt>
<dd>cause Lisp to signal an error.</dd>
</dl>
For keyboard interrupt signals, the standard interrupt character is
in parentheses. Your <tt class="filename">.login</tt> may set up
different interrupt characters. When a signal is generated, there
may be some delay before it is processed since Lisp cannot be
interrupted safely in an arbitrary place. The computation will
continue until a safe point is reached and then the interrupt will
be processed. See section&nbsp;<a href="#signal-handlers">6.8.1</a>
to define your own signal handlers.<br>
<br>
<!--TOC section Implementation-Specific Packages-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc14" id="htoc14"><b><font size=
"5">2.3</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Implementation-Specific Packages</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
When CMUCL is first started up, the default package is the
<tt class="code">common-lisp-user</tt> package. The <tt class=
"code">common-lisp-user</tt> package uses the <tt class=
"code">common-lisp</tt> and <tt class="code">extensions</tt>
packages. The symbols exported from these three packages can be
referenced without package qualifiers. This section describes
packages which have exported interfaces that may concern users. The
numerous internal packages which implement parts of the system are
not described here. Package nicknames are in parenthesis after the
full name.<br>
<br>
<dl compact="compact">
<dt><tt class="code">alien</tt>, <tt class=
"code">c-call</tt><br></dt>
<dd>Export the features of the Alien foreign data structure
facility (see section&nbsp;<a href="#aliens">8</a>.)<br>
<br></dd>
<dt><tt class="code">pcl</tt><br></dt>
<dd>This package contains PCL (Portable CommonLoops), which is a
portable implementation of CLOS (the Common Lisp Object System.)
This implements most (but not all) of the features in the CLOS
chapter of <i>Common Lisp: The Language II</i>.<br>
<br></dd>
<dt><tt class="code">clos-mop (mop)</tt><br></dt>
<dd>This package contains an implementation of the CLOS Metaobject
Protocol, as per the book <i>The Art of the Metaobject
Protocol</i>.<br>
<br></dd>
<dt><tt class="code">debug</tt><br></dt>
<dd>The <tt class="code">debug</tt> package contains the
command-line oriented debugger. It exports utility various
functions and switches.<br>
<br></dd>
<dt><tt class="code">debug-internals</tt><br></dt>
<dd>The <tt class="code">debug-internals</tt> package exports the
primitives used to write debuggers. See section&nbsp;<a href=
"#debug-internals">11</a>.<br>
<br></dd>
<dt><tt class="code">extensions (ext)</tt><br></dt>
<dd>The <tt class="code">extensions</tt> packages exports local
extensions to Common Lisp that are documented in this manual.
Examples include the <tt class="code">save-lisp</tt> function and
time parsing.<br>
<br></dd>
<dt><tt class="code">hemlock (ed)</tt><br></dt>
<dd>The <tt class="code">hemlock</tt> package contains all the code
to implement Hemlock commands. The <tt class="code">hemlock</tt>
package currently exports no symbols.<br>
<br></dd>
<dt><tt class="code">hemlock-internals (hi)</tt><br></dt>
<dd>The <tt class="code">hemlock-internals</tt> package contains
code that implements low level primitives and exports those symbols
used to write Hemlock commands.<br>
<br></dd>
<dt><tt class="code">keyword</tt><br></dt>
<dd>The <tt class="code">keyword</tt> package contains keywords
(e.g., <tt class="code">:start</tt>). All symbols in the <tt class=
"code">keyword</tt> package are exported and evaluate to themselves
(i.e., the value of the symbol is the symbol itself).<br>
<br></dd>
<dt><tt class="code">profile</tt><br></dt>
<dd>The <tt class="code">profile</tt> package exports a simple
run-time profiling facility (see section&nbsp;<a href=
"#profiling">5.14</a>).<br>
<br></dd>
<dt><tt class="code">common-lisp (cl)</tt><br></dt>
<dd>The <tt class="code">common-lisp</tt> package exports all the
symbols defined by <i>Common Lisp: The Language</i> and only those
symbols. Strictly portable Lisp code will depend only on the
symbols exported from the <tt class="code">common-lisp</tt>
package.<br>
<br></dd>
<dt><tt class="code">unix</tt><br></dt>
<dd>This package exports system call interfaces to Unix (see
section&nbsp;<a href="#unix-interface">6</a>).<br>
<br></dd>
<dt><tt class="code">system (sys)</tt><br></dt>
<dd>The <tt class="code">system</tt> package contains functions and
information necessary for system interfacing. This package is used
by the <tt class="code">lisp</tt> package and exports several
symbols that are necessary to interface to system code.<br>
<br></dd>
<dt><tt class="code">xlib</tt><br></dt>
<dd>The <tt class="code">xlib</tt> package contains the Common Lisp
X interface (CLX) to the X11 protocol. This is mostly Lisp code
with a couple of functions that are defined in C to connect to the
server.<br>
<br></dd>
<dt><tt class="code">wire</tt><br></dt>
<dd>The <tt class="code">wire</tt> package exports a remote
procedure call facility (see section&nbsp;<a href=
"#remote">9</a>).<br>
<br></dd>
<dt><tt class="code">stream</tt><br></dt>
<dd>The <tt class="code">stream</tt> package exports the public
interface to the simple-streams implementation (see
section&nbsp;<a href="#simple-streams">2.13</a>).</dd>
</dl>
<!--TOC section Hierarchical Packages-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc15" id="htoc15"><b><font size=
"5">2.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Hierarchical
Packages</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept1"></a><br>
<!--TOC subsection Introduction-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc16" id="htoc16"><b><font size=
"4">2.4.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Introduction</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The Common Lisp package system, designed and standardized several
years ago, is not hierarchical. Since Common Lisp was standardized,
other languages, including Java and Perl, have evolved namespaces
which are hierarchical. This document describes a hierarchical
package naming scheme for Common Lisp. The scheme was proposed by
Franz Inc and implemented in their <i>Allegro Common Lisp</i>
product; a compatible implementation of the naming scheme is
implemented in CMUCL. This documentation is based on the Franz Inc.
documentation, and is included with permission.<br>
<br>
The goals of hierarchical packages in Common Lisp are:
<ul>
<li>Reduce collisions with user-defined packages: it is a
well-known problem that package names used by the Lisp
implementation and those defined by users can easily conflict. The
intent of hierarchical packages is to reduce such conflicts to a
minimum.<br>
<br></li>
<li>Improve modularity: the current organization of packages in
various implementations has grown over the years and appears
somewhat random. Organizing future packages into a hierarchy will
help make the intention of the implementation more clear.<br>
<br></li>
<li>Foster growth in Common Lisp programs, or modules, available to
the CL community: the Perl and Java communities are able to
contribute code to repositories, with minimal fear of collision,
because of the hierarchical nature of the name spaces used by the
contributed code. We want the Lisp community to benefit from shared
modules in the same way.</li>
</ul>
In a nutshell, a dot (<code>.</code>) is used to separate levels in
package names, and a leading dot signifies a relative package name.
The choice of dot follows Java. Perl, another language with
hierarchical packages, uses a colon (<code>:</code>) as a
delimiter, but the colon is already reserved in Common Lisp.
Absolute package names require no modifications to the underlying
Common Lisp implementation. Relative package names require only
small and simple modifications.<br>
<br>
<!--TOC subsection Relative Package Names-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc17" id="htoc17"><b><font size=
"4">2.4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Relative Package
Names</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Relative package names are needed for the same reason as relative
pathnames, for brevity and to reduce the brittleness of absolute
names. A relative package name is one that begins with one or more
dots. A single dot means the current package, two dots mean the
parent of the current package, and so on.<br>
<br>
Table&nbsp;<a href="#tbl:hierarchical-packages">2.2</a> presents a
number of examples, assuming that the packages named
<code>foo</code>, <code>foo.bar</code>, <code>mypack</code>,
<code>mypack.foo</code>, <code>mypack.foo.bar</code>,
<code>mypack.foo.baz</code>, <code>mypack.bar</code>, and
<code>mypack.bar.baz</code>, have all been created.
<blockquote>
<div align="center">
<hr width="80%" size="2"></div>
<div align="center">
<table border="1" cellspacing="0" cellpadding="1">
<tr>
<td align="left" nowrap>relative name</td>
<td align="left" nowrap>current package</td>
<td align="left" nowrap>absolute name of referenced package</td>
</tr>
<tr>
<td align="left" nowrap>foo</td>
<td align="left" nowrap>any</td>
<td align="left" nowrap>foo</td>
</tr>
<tr>
<td align="left" nowrap>foo.bar</td>
<td align="left" nowrap>any</td>
<td align="left" nowrap>foo.bar</td>
</tr>
<tr>
<td align="left" nowrap>.foo</td>
<td align="left" nowrap>mypack</td>
<td align="left" nowrap>mypack.foo</td>
</tr>
<tr>
<td align="left" nowrap>.foo.bar</td>
<td align="left" nowrap>mypack</td>
<td align="left" nowrap>mypack.foo.bar</td>
</tr>
<tr>
<td align="left" nowrap>..foo</td>
<td align="left" nowrap>mypack.bar</td>
<td align="left" nowrap>mypack.foo</td>
</tr>
<tr>
<td align="left" nowrap>..foo.baz</td>
<td align="left" nowrap>mypack.bar</td>
<td align="left" nowrap>mypack.foo.baz</td>
</tr>
<tr>
<td align="left" nowrap>...foo</td>
<td align="left" nowrap>mypack.bar.baz</td>
<td align="left" nowrap>mypack.foo</td>
</tr>
<tr>
<td align="left" nowrap>.</td>
<td align="left" nowrap>mypack.bar.baz</td>
<td align="left" nowrap>mypack.bar.baz</td>
</tr>
<tr>
<td align="left" nowrap>..</td>
<td align="left" nowrap>mypack.bar.baz</td>
<td align="left" nowrap>mypack.bar</td>
</tr>
<tr>
<td align="left" nowrap>...</td>
<td align="left" nowrap>mypack.bar.baz</td>
<td align="left" nowrap>mypack</td>
</tr>
</table>
</div>
<br>
<div align="center">Table 2.2: Examples of hierarchical
packages</div>
<br>
<a name="tbl:hierarchical-packages" id=
"tbl:hierarchical-packages"></a>
<div align="center">
<hr width="80%" size="2"></div>
</blockquote>
Additional notes:
<ol type="1">
<li>All packages in the hierarchy must exist.<br>
<br></li>
<li><b>Warning about nicknames</b>: Unless you provide nicknames
for your hierarchical packages (and we recommend against doing so
because the number gets quite large), you can only use the names
supplied. You cannot mix in nicknames or alternate names.
<tt class="code">cl-user</tt> is nickname of the <tt class=
"code">common-lisp-user</tt> package. Consider the following:
<pre>
   (defpackage :cl-user.foo)
</pre>
When the current package (the value of the variable <tt class=
"code">*package*</tt>) is <tt class="code">common-lisp-user</tt>,
you might expect <code>.foo</code> to refer to
<code>cl-user.foo</code>, but it does not. It actually refers to
the non-existent package <code>common-lisp-user.foo</code>. Note
that the purpose of nicknames is to provide shorter names in place
of the longer names that are designed to be fully descriptive. The
hope is that hierarchical packages makes longer names unnecessary
and thus makes nicknames unnecessary.<br>
<br></li>
<li>Multiple dots can only appear at the beginning of a package
name. For example, <code>foo.bar..baz</code> does not mean
<code>foo.baz</code> -- it is invalid. (Of course, it is perfectly
legal to name a package <code>foo.bar..baz</code>, but <tt class=
"code">cl:find-package</tt> will not process such a name to find
<code>foo.baz</code> in the package hierarchy.)</li>
</ol>
<!--TOC subsection Compatibility with ANSI Common Lisp-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc18" id="htoc18"><b><font size=
"4">2.4.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Compatibility
with ANSI Common Lisp</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The implementation of hierarchical packages modifies the <tt class=
"code">cl:find-package</tt> function, and provides certain
auxiliary functions, <tt class="code">package-parent</tt>,
<tt class="code">package-children</tt>, and <tt class=
"code">relative-package-name-to-package</tt>, as described in this
section. The function <tt class="code">defpackage</tt> itself
requires no modification.<br>
<br>
While the changes to <tt class="code">cl:find-package</tt> are
small and described below, it is an important consideration for
authors who would like their programs to run on a variety of
implementations that using hierarchical packages will work in an
implementation without the modifications discussed in this
document. We show why after describing the changes to <tt class=
"code">cl:find-package</tt>.<br>
<br>
Absolute hierarchical package names require no changes in the
underlying Common Lisp implementation.<br>
<br>
<!--TOC subsubsection Changes to <TT class=code>cl:find-package</TT>-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.4.3.1</b></td>
<td width="100%" align="center"><b>Changes to</b> <tt class=
"code"><b>cl:find-package</b></tt></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Using relative hierarchical package names requires a simple
modification of <tt class="code">cl:find-package</tt>.<br>
<br>
In ANSI Common Lisp, <tt class="code">cl:find-package</tt>, if
passed a package object, returns it; if passed a string, <tt class=
"code">cl:find-package</tt> looks for a package with that string as
its name or nickname, and returns the package if it finds one, or
returns nil if it does not; if passed a symbol, the symbol name (a
string) is extracted and <tt class="code">cl:find-package</tt>
proceeds as it does with a string.<br>
<br>
For implementing hierarchical packages, the behavior when the
argument is a package object (return it) does not change. But when
the argument is a string starting with one or more dots not
directly naming a package, <tt class="code">cl:find-package</tt>
will, instead of returning nil, check whether the string can be
resolved as naming a relative package, and if so, return the
associated absolute package object. (If the argument is a symbol,
the symbol name is extracted and <tt class=
"code">cl:find-package</tt> proceeds as it does with a string
argument.)<br>
<br>
Note that you should not use leading dots in package names when
using hierarchical packages.<br>
<br>
<!--TOC subsubsection Using Hierarchical Packages without Modifying cl:find-package-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.4.3.2</b></td>
<td width="100%" align="center"><b>Using Hierarchical Packages
without Modifying cl:find-package</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Even without the modifications to <tt class=
"code">cl:find-package</tt>, authors need not avoid using relative
package names, but the ability to reuse relative package names is
restricted. Consider for example a module <i>foo</i> which is
composed of the <code>my.foo.bar</code> and <code>my.foo.baz</code>
packages. In the code for each of the these packages there are
relative package references, <code>..bar</code> and
<code>..baz</code>.<br>
<br>
Implementations that have the new <tt class=
"code">cl:find-package</tt> would have
<code>:relative-package-names</code> on their <tt class=
"code">*features*</tt> list (this is the case of CMUCL releases
starting from 18d). Then, in the <i>foo</i> module, there would be
definitions of the <code>my.foo.bar</code> and
<code>my.foo.baz</code> packages like so:
<pre>
   (defpackage :my.foo.bar
     #-relative-package-names (:nicknames #:..bar)
     ...)

   (defpackage :my.foo.baz
     #-relative-package-names (:nicknames #:..baz)
     ...)
</pre>
Then, in a <code>#-relative-package-names</code> implementation,
the symbol <code>my.foo.bar:blam</code> would be visible from
<code>my.foo.baz</code> as <code>..bar:blam</code>, just as it
would from a <code>#+relative-package-names</code>
implementation.<br>
<br>
So, even without the implementation of the augmented <tt class=
"code">cl:find-package</tt>, one can still write Common Lisp code
that will work in both types of implementations, but
<code>..bar</code> and <code>..baz</code> are now used, so you
cannot also have <code>otherpack.foo.bar</code> and
<code>otherpack.foo.baz</code> and use <code>..bar</code> and
<code>..baz</code> as relative names. (The point of hierarchical
packages, of course, is to allow reusing relative package
names.)<br>
<br>
<!--NAME hierarchical-packages.html-->
<br>
<br>
<!--TOC section Package Locks-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc19" id="htoc19"><b><font size=
"5">2.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Package
Locks</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept2"></a><br>
CMUCL provides two types of package locks, as an extension to the
ANSI Common Lisp standard. The package-lock protects a package from
changes in its structure (the set of exported symbols, its use
list, etc). The package-definition-lock protects the symbols in the
package from being redefined due to the execution of a <tt class=
"code">defun</tt>, <tt class="code">defmacro</tt>, <tt class=
"code">defstruct</tt>, <tt class="code">deftype</tt> or <tt class=
"code">defclass</tt> form.<br>
<br>
<!--TOC subsection Rationale-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc20" id="htoc20"><b><font size=
"4">2.5.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Rationale</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Package locks are an aid to program development, by helping to
detect inadvertent name collisions and function redefinitions. They
are consistent with the principle that a package ``belongs to'' its
implementor, and that noone other than the package's developer
should be making or modifying definitions on symbols in that
package. Package locks are compatible with the ANSI Common Lisp
standard, which states that the consequences of redefining
functions in the <tt class="code">COMMON-LISP</tt> package are
undefined.<br>
<br>
Violation of a package lock leads to a continuable error of type
<tt class="code">lisp::package-locked-error</tt> being signaled.
The user may choose to ignore the lock and proceed, or to abort the
computation. Two other restarts are available, one which disables
all locks on all packages, and one to disable only the package-lock
or package-definition-lock that was tripped.<br>
<br>
The following transcript illustrates the behaviour seen when
attempting to redefine a standard macro in the <tt class=
"code">COMMON-LISP</tt> package, or to redefine a function in one
of CMUCL's implementation-defined packages:
<pre>
CL-USER&gt; (defmacro 1+ (x) (* x 2))
Attempt to modify the locked package COMMON-LISP, by defining macro 1+
   [Condition of type LISP::PACKAGE-LOCKED-ERROR]

Restarts:
  0: [continue      ] Ignore the lock and continue
  1: [unlock-package] Disable the package's definition-lock then continue
  2: [unlock-all    ] Unlock all packages, then continue
  3: [abort         ] Return to Top-Level.

CL-USER&gt; (defun ext:gc () t)
Attempt to modify the locked package EXTENSIONS, by redefining function GC
   [Condition of type LISP::PACKAGE-LOCKED-ERROR]

Restarts:
  0: [continue      ] Ignore the lock and continue
  1: [unlock-package] Disable package's definition-lock, then continue
  2: [unlock-all    ] Disable all package locks, then continue
  3: [abort         ] Return to Top-Level.
</pre>
The following transcript illustrates the behaviour seen when an
attempt to modify the structure of a package is made:
<pre>
CL-USER&gt; (unexport 'load-foreign :ext)
Attempt to modify the locked package EXTENSIONS, by unexporting symbols LOAD-FOREIGN
   [Condition of type lisp::package-locked-error]

Restarts:
  0: [continue      ] Ignore the lock and continue
  1: [unlock-package] Disable package's lock then continue
  2: [unlock-all    ] Unlock all packages, then continue
  3: [abort         ] Return to Top-Level.
</pre>
The <tt class="code">COMMON-LISP</tt> package and the
CMUCL-specific implementation packages are locked on startup. Users
can lock their own packages by using the <tt class=
"code">ext:package-lock</tt> and <tt class=
"code">ext:package-definition-lock</tt> accessors.<br>
<br>
<!--TOC subsection Disabling package locks-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc21" id="htoc21"><b><font size=
"4">2.5.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Disabling package
locks</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
A package's locks can be enabled or disabled by using the
<tt class="code">ext:package-lock</tt> and <tt class=
"code">ext:package-definition-lock</tt> accessors, as follows:
<blockquote class="lisp">
<pre>
   (setf (ext:package-lock (find-package "UNIX")) nil)
   (setf (ext:package-definition-lock (find-package "UNIX")) nil)
</pre></blockquote>
<br>
<a name="@funs19"></a><a name="FN:package-lock" id=
"FN:package-lock"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">package-lock</tt> <tt class="variable">package</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This function is an accessor for a package's structural
lock, which protects it against modifications to its list of
exported symbols.</blockquote>
<br>
<a name="@funs20"></a><a name="FN:package-definition-lock" id=
"FN:package-definition-lock"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">package-definition-lock</tt> <tt class=
"variable">package</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>This function is an accessor for a package's
definition-lock, which protects symbols in that package from
redefinition. As well as protecting the symbol's fdefinition from
change, attempts to change the symbol's definition using <tt class=
"code">defstruct</tt>, <tt class="code">defclass</tt> or <tt class=
"code">deftype</tt> will be trapped.</blockquote>
<br>
<a name="@funs21"></a><a name="FN:without-package-locks" id=
"FN:without-package-locks"></a>
<div align="left">[Macro]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">without-package-locks</tt> <tt class=
"code">&amp;rest</tt> <tt class="variable">body</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This macro can be used to execute forms with all
package locks (both structure and definition locks)
disabled.</blockquote>
<br>
<a name="@funs22"></a><a name="FN:unlock-all-packages" id=
"FN:unlock-all-packages"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">unlock-all-packages</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>This function disables both structure and definition
locks on all currently defined packages. Note that package locks
are reset when CMUCL is restarted, so the effect of this function
is limited to the current session.</blockquote>
<!--NAME package-locks.html-->
<br>
<br>
<!--TOC section The Editor-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc22" id="htoc22"><b><font size=
"5">2.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The
Editor</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <tt class="code">ed</tt> function invokes the Hemlock editor
which is described in <i>Hemlock User's Manual</i> and <i>Hemlock
Command Implementor's Manual</i>. Most users at CMU prefer to use
Hemlock's slave Common Lisp mechanism which provides an interactive
buffer for the <tt class="code">read-eval-print</tt> loop and
editor commands for evaluating and compiling text from a buffer
into the slave Common Lisp. Since the editor runs in the Common
Lisp, using slaves keeps users from trashing their editor by
developing in the same Common Lisp with Hemlock.<br>
<br>
<!--TOC section Garbage Collection-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc23" id="htoc23"><b><font size=
"5">2.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Garbage
Collection</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL uses either a stop-and-copy garbage collector or a
generational, mostly copying garbage collector. Which collector is
available depends on the platform and the features of the platform.
The stop-and-copy GC is available on all RISC platforms. The x86
platform supports a conservative stop-and-copy collector, which is
now rarely used, and a generational conservative collector. On the
Sparc platform, both the stop-and-copy GC and the generational GC
are available, but the stop-and-copy GC is deprecated in favor of
the generational GC.<br>
<br>
The generational GC is available if <tt class=
"variable">*features*</tt> contains <tt class=
"code">:gencgc</tt>.<br>
<br>
The following functions invoke the garbage collector or control
whether automatic garbage collection is in effect:<br>
<br>
<br>
<a name="@funs23"></a><a name="FN:-" id="FN:-"></a>
<div align="left">[Function]<br>
<tt class="function-name">[</tt><tt class="function-name">-</tt> c
&nbsp;&nbsp;&nbsp;</div>
<blockquote>heney]extensions:gc<tt class="code">&amp;optional</tt>
<tt class="variable">verbose-p</tt><br>
<br>
This function runs the garbage collector. If <tt class=
"code">ext:*gc-verbose*</tt> is non-<tt class="code">nil</tt>, then
it invokes <tt class="code">ext:*gc-notify-before*</tt> before
GC'ing and <tt class="code">ext:*gc-notify-after*</tt>
afterwards.<br>
<br>
<tt class="code">verbose-p</tt> indicates whether GC statistics are
printed or not.</blockquote>
<br>
<a name="@funs24"></a><a name="FN:gc-off" id="FN:gc-off"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">gc-off</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function inhibits automatic garbage collection. After calling
it, the system will not GC unless you call <tt class=
"code">ext:gc</tt> or <tt class="code">ext:gc-on</tt>.</blockquote>
<br>
<a name="@funs25"></a><a name="FN:gc-on" id="FN:gc-on"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">gc-on</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function reinstates automatic garbage collection. If the
system would have GC'ed while automatic GC was inhibited, then this
will call <tt class="code">ext:gc</tt>.</blockquote>
<!--TOC subsection GC Parameters-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc24" id="htoc24"><b><font size=
"4">2.7.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">GC
Parameters</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The following variables control the behavior of the garbage
collector:<br>
<br>
<br>
<a name="@vars2"></a><a name="VR:bytes-consed-between-gcs" id=
"VR:bytes-consed-between-gcs"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*bytes-consed-between-gcs*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
CMUCL automatically GC's whenever the amount of memory allocated to
dynamic objects exceeds the value of an internal variable. After
each GC, the system sets this internal variable to the amount of
dynamic space in use at that point plus the value of the variable
<tt class="code">ext:*bytes-consed-between-gcs*</tt>. The default
value is 2000000.</blockquote>
<br>
<a name="@vars3"></a><a name="VR:gc-verbose" id=
"VR:gc-verbose"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*gc-verbose*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable controls whether <tt class="code">ext:gc</tt> invokes
the functions in <tt class="code">ext:*gc-notify-before*</tt> and
<tt class="code">ext:*gc-notify-after*</tt>. If <tt class=
"code">*gc-verbose*</tt> is <tt class="code">nil</tt>, <tt class=
"code">ext:gc</tt> foregoes printing any messages. The default
value is <tt class="code">T</tt>.</blockquote>
<br>
<a name="@vars4"></a><a name="VR:gc-notify-before" id=
"VR:gc-notify-before"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*gc-notify-before*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable's value is a function that should notify the user
that the system is about to GC. It takes one argument, the amount
of dynamic space in use before the GC measured in bytes. The
default value of this variable is a function that prints a message
similar to the following:
<pre>
   [GC threshold exceeded with 2,107,124 bytes in use.  Commencing GC.]
</pre></blockquote>
<br>
<a name="@vars5"></a><a name="VR:gc-notify-after" id=
"VR:gc-notify-after"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*gc-notify-after*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable's value is a function that should notify the user
when a GC finishes. The function must take three arguments, the
amount of dynamic spaced retained by the GC, the amount of dynamic
space freed, and the new threshold which is the minimum amount of
space in use before the next GC will occur. All values are byte
quantities. The default value of this variable is a function that
prints a message similar to the following:
<pre>
    [GC completed with 25,680 bytes retained and 2,096,808 bytes freed.]
    [GC will next occur when at least 2,025,680 bytes are in use.]
  
</pre></blockquote>
Note that a garbage collection will not happen at exactly the new
threshold printed by the default <tt class=
"code">ext:*gc-notify-after*</tt> function. The system periodically
checks whether this threshold has been exceeded, and only then does
a garbage collection.<br>
<br>
<br>
<a name="@vars6"></a><a name="VR:gc-inhibit-hook" id=
"VR:gc-inhibit-hook"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*gc-inhibit-hook*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable's value is either a function of one argument or
<tt class="code">nil</tt>. When the system has triggered an
automatic GC, if this variable is a function, then the system calls
the function with the amount of dynamic space currently in use
(measured in bytes). If the function returns <tt class=
"code">nil</tt>, then the GC occurs; otherwise, the system inhibits
automatic GC as if you had called <tt class="code">ext:gc-off</tt>.
The writer of this hook is responsible for knowing when automatic
GC has been turned off and for calling or providing a way to call
<tt class="code">ext:gc-on</tt>. The default value of this variable
is <tt class="code">nil</tt>.</blockquote>
<br>
<a name="@vars7"></a><a name="VR:before-gc-hooks" id=
"VR:before-gc-hooks"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*before-gc-hooks*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars8"></a><a name="VR:after-gc-hooks" id=
"VR:after-gc-hooks"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*after-gc-hooks*</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
These variables' values are lists of functions to call before or
after any GC occurs. The system provides these purely for
side-effect, and the functions take no arguments.</blockquote>
<!--TOC subsection Generational GC-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc25" id="htoc25"><b><font size=
"4">2.7.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Generational
GC</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
Generational GC also supports some additional functions and
variables to control it.<br>
<br>
<br>
<a name="@funs26"></a><a name="FN:-" id="FN:-"></a>
<div align="left">[Function]<br>
<tt class="function-name">[</tt><tt class="function-name">-</tt> g
&nbsp;&nbsp;&nbsp;</div>
<blockquote>encgc]extensions:gc<tt class="code">&amp;key</tt>
<tt class="code">:verbose</tt> <tt class="code">:gen</tt>
<tt class="code">:full</tt><br>
<br>
This function runs the garbage collector. If <tt class=
"code">ext:*gc-verbose*</tt> is non-<tt class="code">nil</tt>, then
it invokes <tt class="code">ext:*gc-notify-before*</tt> before
GC'ing and <tt class="code">ext:*gc-notify-after*</tt>
afterwards.<br>
<br>
<dl compact="compact">
<dt><tt class="code">verbose</tt><br></dt>
<dd>Print GC statistics if non-<tt class="code">NIL</tt>.</dd>
<dt><tt class="code">gen</tt><br></dt>
<dd>The number of generations to be collected.</dd>
<dt><tt class="code">full</tt><br></dt>
<dd>If non-<tt class="code">NIL</tt>, a full collection of all
generations is performed.</dd>
</dl>
</blockquote>
<br>
<a name="@funs27"></a><a name="FN:gencgc-stats" id=
"FN:gencgc-stats"></a>
<div align="left">[Function]<br>
<tt class="function-name">lisp::</tt><tt class=
"function-name">gencgc-stats</tt> <tt class=
"variable">generation</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns statistics about the generation, as multiple
values:
<ol type="1">
<li>Bytes allocated in this generation</li>
<li>The GC trigger for this generation. When this many bytes have
been allocated, a GC is started automatically.</li>
<li>The number of bytes consed between GCs.</li>
<li>The number of GCs that have been done on this generation. This
is reset to zero when the generation is raised.</li>
<li>The trigger age, which is the maximum number of GCs to perform
before this generation is raised.</li>
<li>The total number of bytes allocated to this generation.</li>
<li>Average age of the objects in this generations. The average age
is the cumulative bytes allocated divided by current number of
bytes allocated.</li>
</ol>
</blockquote>
<br>
<a name="@funs28"></a><a name="FN:set-gc-trigger" id=
"FN:set-gc-trigger"></a>
<div align="left">[Function]<br>
<tt class="function-name">lisp::</tt><tt class=
"function-name">set-gc-trigger</tt> <tt class="variable">gen</tt>
<tt class="variable">trigger</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Sets the GC trigger value for the specified
generation.</blockquote>
<br>
<a name="@funs29"></a><a name="FN:set-trigger-age" id=
"FN:set-trigger-age"></a>
<div align="left">[Function]<br>
<tt class="function-name">lisp::</tt><tt class=
"function-name">set-trigger-age</tt> <tt class="variable">gen</tt>
<tt class="variable">trigger-age</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Sets the GC trigger age for the specified
generation.</blockquote>
<br>
<a name="@funs30"></a><a name="FN:set-min-mem-age" id=
"FN:set-min-mem-age"></a>
<div align="left">[Function]<br>
<tt class="function-name">lisp::</tt><tt class=
"function-name">set-min-mem-age</tt> <tt class="variable">gen</tt>
<tt class="variable">min-mem-age</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Sets the minimum average memory age for the specified
generation. If the computed memory age is below this, GC is not
performed, which helps prevent a GC when a large number of new live
objects have been added in which case a GC would usually be a waste
of time.</blockquote>
<!--TOC subsection Weak Pointers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc26" id="htoc26"><b><font size=
"4">2.7.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Weak
Pointers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
A weak pointer provides a way to maintain a reference to an object
without preventing an object from being garbage collected. If the
garbage collector discovers that the only pointers to an object are
weak pointers, then it breaks the weak pointers and deallocates the
object.<br>
<br>
<br>
<a name="@funs31"></a><a name="FN:make-weak-pointer" id=
"FN:make-weak-pointer"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">make-weak-pointer</tt> <tt class=
"variable">object</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs32"></a><a name="FN:weak-pointer-value" id=
"FN:weak-pointer-value"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">weak-pointer-value</tt> <tt class=
"variable">weak-pointer</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<br>
<tt class="code">make-weak-pointer</tt> returns a weak pointer to
an object. <tt class="code">weak-pointer-value</tt> follows a weak
pointer, returning the two values: the object pointed to (or
<tt class="code">nil</tt> if broken) and a boolean value which is
<tt class="code">nil</tt> if the pointer has been broken, and true
otherwise.</blockquote>
<!--TOC subsection Finalization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc27" id="htoc27"><b><font size=
"4">2.7.4</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Finalization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Finalization provides a ``hook'' that is triggered when the garbage
collector reclaims an object. It is usually used to recover
non-Lisp resources that were allocated to implement the finalized
Lisp object. For example, when a unix file-descriptor stream is
collected, finalization is used to close the underlying file
descriptor.<br>
<br>
<br>
<a name="@funs33"></a><a name="FN:finalize" id="FN:finalize"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">finalize</tt> <tt class="variable">object</tt>
<tt class="variable">function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function registers <tt class="variable">object</tt> for
finalization. <tt class="variable">function</tt> is called with no
arguments when <tt class="variable">object</tt> is reclaimed.
Normally <tt class="variable">function</tt> will be a closure over
the underlying state that needs to be freed, e.g. the unix file
descriptor in the fd-stream case. Note that <tt class=
"variable">function</tt> must not close over <tt class=
"variable">object</tt> itself, as this prevents the object from
ever becoming garbage.</blockquote>
<br>
<a name="@funs34"></a><a name="FN:cancel-finalization" id=
"FN:cancel-finalization"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">cancel-finalization</tt> <tt class=
"variable">object</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function cancel any finalization request for <tt class=
"variable">object</tt>.</blockquote>
<!--TOC section Describe-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc28" id="htoc28"><b><font size=
"5">2.8</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Describe</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs35"></a><a name="FN:describe" id="FN:describe"></a>
<div align="left">[Function]<br>
<tt class="function-name">describe</tt> <tt class=
"variable">object</tt> &amp;optional <tt class=
"variable">stream</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The <tt class="code">describe</tt> function prints useful
information about <tt class="variable">object</tt> on <tt class=
"variable">stream</tt>, which defaults to <tt class=
"code">*standard-output*</tt>. For any object, <tt class=
"code">describe</tt> will print out the type. Then it prints other
information based on the type of <tt class="variable">object</tt>.
The types which are presently handled are:<br>
<br>
<dl compact="compact">
<dt><a name="@types12"></a><tt class=
"code">hash-table</tt><br></dt>
<dd><tt class="code">describe</tt> prints the number of entries
currently in the hash table and the number of buckets currently
allocated.<br>
<br></dd>
<dt><a name="@types13"></a><tt class="code">function</tt><br></dt>
<dd><tt class="code">describe</tt> prints a list of the function's
name (if any) and its formal parameters. If the name has function
documentation, then it will be printed. If the function is
compiled, then the file where it is defined will be printed as
well.<br>
<br></dd>
<dt><a name="@types14"></a><tt class="code">fixnum</tt><br></dt>
<dd><tt class="code">describe</tt> prints whether the integer is
prime or not.<br>
<br></dd>
<dt><a name="@types15"></a><tt class="code">symbol</tt><br></dt>
<dd>The symbol's value, properties, and documentation are printed.
If the symbol has a function definition, then the function is
described.</dd>
</dl>
If there is anything interesting to be said about some component of
the object, describe will invoke itself recursively to describe
that object. The level of recursion is indicated by indenting
output.</blockquote>
A number of switches can be used to control <tt class=
"code">describe</tt>'s behavior.<br>
<br>
<br>
<a name="@vars9"></a><a name="VR:describe-level" id=
"VR:describe-level"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*describe-level*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The maximum level of recursive description allowed. Initially
two.</blockquote>
<br>
<a name="@vars10"></a><a name="VR:describe-indentation" id=
"VR:describe-indentation"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*describe-indentation*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The number of spaces to indent for each level of recursive
description, initially three.</blockquote>
<br>
<a name="@vars11"></a><a name="VR:describe-print-level" id=
"VR:describe-print-level"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*describe-print-level*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars12"></a><a name="VR:describe-print-length" id=
"VR:describe-print-length"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*describe-print-length*</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
The values of <tt class="code">*print-level*</tt> and <tt class=
"code">*print-length*</tt> during description. Initially two and
five.</blockquote>
<!--TOC section The Inspector-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc29" id="htoc29"><b><font size=
"5">2.9</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The
Inspector</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL has both a graphical inspector that uses the X Window System,
and a simple terminal-based inspector.<br>
<br>
<br>
<a name="@funs36"></a><a name="FN:inspect" id="FN:inspect"></a>
<div align="left">[Function]<br>
<tt class="function-name">inspect</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">object</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">inspect</tt> calls the inspector on the optional
argument <tt class="variable">object</tt>. If <tt class=
"variable">object</tt> is unsupplied, <tt class="code">inspect</tt>
immediately returns <tt class="code">nil</tt>. Otherwise, the
behavior of inspect depends on whether Lisp is running under X.
When <tt class="code">inspect</tt> is eventually exited, it returns
some selected Lisp object.</blockquote>
<!--TOC subsection The Graphical Interface-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc30" id="htoc30"><b><font size=
"4">2.9.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Graphical
Interface</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="motif-interface" id="motif-interface"></a><br>
CMUCL has an interface to Motif which is functionally similar to
CLM, but works better in CMUCL. This interface is documented in
separate manuals <i>CMUCL Motif Toolkit</i> and <i>Design Notes on
the Motif Toolkit</i>, which are distributed with CMUCL.<br>
<br>
This motif interface has been used to write the inspector and
graphical debugger. There is also a Lisp control panel with a
simple file management facility, apropos and inspector dialogs, and
controls for setting global options. See the <tt class=
"code">interface</tt> and <tt class="code">toolkit</tt>
packages.<br>
<br>
<br>
<a name="@funs37"></a><a name="FN:lisp-control-panel" id=
"FN:lisp-control-panel"></a>
<div align="left">[Function]<br>
<tt class="function-name">interface:</tt><tt class=
"function-name">lisp-control-panel</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function creates a control panel for the Lisp
process.</blockquote>
<br>
<a name="@vars13"></a><a name="VR:interface-style" id=
"VR:interface-style"></a>
<div align="left">[Variable]<br>
<tt class="function-name">interface:</tt><tt class=
"function-name">*interface-style*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
When the graphical interface is loaded, this variable controls
whether it is used by <tt class="code">inspect</tt> and the error
system. If the value is <tt class="code">:graphics</tt> (the
default) and the <tt class="code">DISPLAY</tt> environment variable
is defined, the graphical inspector and debugger will be invoked by
<a name="@funs38"></a><tt class="code">inspect</tt> or when an
error is signalled. Possible values are <tt class=
"code">:graphics</tt> and tty. If the value is <tt class=
"code">:graphics</tt>, but there is no X display, then we quietly
use the TTY interface.</blockquote>
<!--TOC subsection The TTY Inspector-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc31" id="htoc31"><b><font size=
"4">2.9.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The TTY
Inspector</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
If X is unavailable, a terminal inspector is invoked. The TTY
inspector is a crude interface to <tt class="code">describe</tt>
which allows objects to be traversed and maintains a history. This
inspector prints information about and object and a numbered list
of the components of the object. The command-line based interface
is a normal <tt class="code">read</tt>--<tt class=
"code">eval</tt>--<tt class="code">print</tt> loop, but an integer
<tt class="variable">n</tt> descends into the <tt class=
"variable">n</tt>'th component of the current object, and symbols
with these special names are interpreted as commands:<br>
<br>
<dl compact="compact">
<dt>U<br></dt>
<dd>Move back to the enclosing object. As you descend into the
components of an object, a stack of all the objects previously seen
is kept. This command pops you up one level of this stack.<br>
<br></dd>
<dt>Q, E<br></dt>
<dd>Return the current object from <tt class=
"code">inspect</tt>.<br>
<br></dd>
<dt>R<br></dt>
<dd>Recompute object display, and print again. Useful if the object
may have changed.<br>
<br></dd>
<dt>D<br></dt>
<dd>Display again without recomputing.<br>
<br></dd>
<dt>H, ?<br></dt>
<dd>Show help message.</dd>
</dl>
<!--TOC section Load-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc32" id="htoc32"><b><font size=
"5">2.10</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Load</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs39"></a><a name="FN:load" id="FN:load"></a>
<div align="left">[Function]<br>
<tt class="function-name">load</tt> <tt class=
"variable">filename</tt> <tt class="code">&amp;key</tt> <tt class=
"code">:verbose</tt> <tt class="code">:print</tt> <tt class=
"code">:if-does-not-exist</tt><br>
<tt class="code">:if-source-newer</tt> <tt class=
"code">:contents</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
As in standard Common Lisp, this function loads a file containing
source or object code into the running Lisp. Several CMU extensions
have been made to <tt class="code">load</tt> to conveniently
support a variety of program file organizations. <tt class=
"variable">filename</tt> may be a wildcard pathname such as
<tt class="filename">*.lisp</tt>, in which case all matching files
are loaded.<br>
<br>
If <tt class="variable">filename</tt> has a <tt class=
"code">pathname-type</tt> (or extension), then that exact file is
loaded. If the file has no extension, then this tells <tt class=
"code">load</tt> to use a heuristic to load the ``right'' file. The
<tt class="code">*load-source-types*</tt> and <tt class=
"code">*load-object-types*</tt> variables below are used to
determine the default source and object file types. If only the
source or the object file exists (but not both), then that file is
quietly loaded. Similarly, if both the source and object file
exist, and the object file is newer than the source file, then the
object file is loaded. The value of the <tt class=
"variable">if-source-newer</tt> argument is used to determine what
action to take when both the source and object files exist, but the
object file is out of date:
<dl compact="compact">
<dt><tt class="code">:load-object</tt><br></dt>
<dd>The object file is loaded even though the source file is
newer.<br>
<br></dd>
<dt><tt class="code">:load-source</tt><br></dt>
<dd>The source file is loaded instead of the older object file.<br>
<br></dd>
<dt><tt class="code">:compile</tt><br></dt>
<dd>The source file is compiled and then the new object file is
loaded.<br>
<br></dd>
<dt><tt class="code">:query</tt><br></dt>
<dd>The user is asked a yes or no question to determine whether the
source or object file is loaded.</dd>
</dl>
This argument defaults to the value of <tt class=
"code">ext:*load-if-source-newer*</tt> (initially <tt class=
"code">:load-object</tt>.)<br>
<br>
The <tt class="variable">contents</tt> argument can be used to
override the heuristic (based on the file extension) that normally
determines whether to load the file as a source file or an object
file. If non-null, this argument must be either <tt class=
"code">:source</tt> or <tt class="code">:binary</tt>, which forces
loading in source and binary mode, respectively. You really
shouldn't ever need to use this argument.</blockquote>
<br>
<a name="@vars14"></a><a name="VR:load-source-types" id=
"VR:load-source-types"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*load-source-types*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars15"></a><a name="VR:load-object-types" id=
"VR:load-object-types"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*load-object-types*</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
These variables are lists of possible <tt class=
"code">pathname-type</tt> values for source and object files to be
passed to <tt class="code">load</tt>. These variables are only used
when the file passed to <tt class="code">load</tt> has no type; in
this case, the possible source and object types are used to default
the type in order to determine the names of the source and object
files.</blockquote>
<br>
<a name="@vars16"></a><a name="VR:load-if-source-newer" id=
"VR:load-if-source-newer"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*load-if-source-newer*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable determines the default value of the <tt class=
"variable">if-source-newer</tt> argument to <tt class=
"code">load</tt>. Its initial value is <tt class=
"code">:load-object</tt>.</blockquote>
<!--TOC section The Reader-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc33" id="htoc33"><b><font size=
"5">2.11</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The
Reader</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<!--TOC subsection Reader Extensions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc34" id="htoc34"><b><font size=
"4">2.11.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Reader
Extensions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
CMUCL supports an ANSI-compatible extension to enable reading of
specialized arrays. Thus
<blockquote class="example">
<pre>
  * (setf *print-readably* nil)
  NIL
  * (make-array '(2 2) :element-type '(signed-byte 8))
  #2A((0 0) (0 0))
  * (setf *print-readably* t)
  T
  * (make-array '(2 2) :element-type '(signed-byte 8))
  #A((SIGNED-BYTE 8) (2 2) ((0 0) (0 0)))
  * (type-of (read-from-string "#A((SIGNED-BYTE 8) (2 2) ((0 0) (0 0)))"))
  (SIMPLE-ARRAY (SIGNED-BYTE 8) (2 2))
  * (setf *print-readably* nil)
  NIL
  * (type-of (read-from-string "#A((SIGNED-BYTE 8) (2 2) ((0 0) (0 0)))"))
  (SIMPLE-ARRAY (SIGNED-BYTE 8) (2 2))
</pre></blockquote>
<!--TOC subsection Reader Parameters-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc35" id="htoc35"><b><font size=
"4">2.11.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Reader
Parameters</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@vars17"></a><a name="VR:ignore-extra-close-parentheses"
id="VR:ignore-extra-close-parentheses"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*ignore-extra-close-parentheses*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
If this variable is <tt class="code">t</tt> (the default), then the
reader merely prints a warning when an extra close parenthesis is
detected (instead of signalling an error.)</blockquote>
<!--TOC section Stream Extensions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc36" id="htoc36"><b><font size=
"5">2.12</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Stream
Extensions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs40"></a><a name="FN:read-n-bytes" id=
"FN:read-n-bytes"></a>
<div align="left">[Function]<br>
<tt class="function-name">sys:</tt><tt class=
"function-name">read-n-bytes</tt> <tt class="variable">stream
buffer start numbytes</tt> <tt class="code">&amp;optional</tt>
<tt class="variable">eof-error-p</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
On streams that support it, this function reads multiple bytes of
data into a buffer. The buffer must be a <tt class=
"code">simple-string</tt> or <tt class="code">(simple-array
(unsigned-byte 8) (*))</tt>. The argument <tt class=
"variable">nbytes</tt> specifies the desired number of bytes, and
the return value is the number of bytes actually read.
<ul>
<li>If <tt class="variable">eof-error-p</tt> is true, an <a name=
"@types16"></a><tt class="code">end-of-file</tt> condition is
signalled if end-of-file is encountered before <tt class=
"variable">count</tt> bytes have been read.<br>
<br></li>
<li>If <tt class="variable">eof-error-p</tt> is false, <tt class=
"code">read-n-bytes reads</tt> as much data is currently available
(up to count bytes.) On pipes or similar devices, this function
returns as soon as any data is available, even if the amount read
is less than <tt class="variable">count</tt> and eof has not been
hit. See also <a name="@funs41"></a><tt class=
"code">make-fd-stream</tt>.</li>
</ul>
</blockquote>
<!--TOC section Simple Streams-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc37" id="htoc37"><b><font size=
"5">2.13</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Simple
Streams</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept3"></a> <a name="simple-streams" id=
"simple-streams"></a><br>
CMUCL includes a partial implementation of <em>Simple Streams</em>,
a protocol that allows user-extensible streams<sup><a name="text1"
href="#note1" id="text1"><font size="2">1</font></a></sup>. The
protocol was proposed by Franz, Inc. and is intended to replace the
<em>Gray Streams</em> method of extending streams. Simple streams
are distributed as a CMUCL subsystem, that can be loaded into the
image by saying
<blockquote class="lisp">
<pre>
   (require :simple-streams)
</pre></blockquote>
Note that CMUCL's implementation of simple streams is incomplete,
and in particular is currently missing support for the functions
<tt class="code">read-sequence</tt> and <tt class=
"code">write-sequence</tt>. Please consult the <i>Allegro Common
Lisp</i> documentation for more information on simple streams.<br>
<br>
<!--NAME simple-streams.html-->
<br>
<br>
<!--TOC section Running Programs from Lisp-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc38" id="htoc38"><b><font size=
"5">2.14</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Running Programs
from Lisp</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
It is possible to run programs from Lisp by using the following
function.<br>
<br>
<br>
<a name="@funs42"></a><a name="FN:run-program" id=
"FN:run-program"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">run-program</tt> <tt class="variable">program</tt>
<tt class="variable">args</tt> <tt class="code">&amp;key</tt>
<tt class="code">:env</tt> <tt class="code">:wait</tt> <tt class=
"code">:pty</tt> <tt class="code">:input</tt><br>
<tt class="code">:if-input-does-not-exist</tt><br>
<tt class="code">:output</tt> <tt class=
"code">:if-output-exists</tt><br>
<tt class="code">:error</tt> <tt class=
"code">:if-error-exists</tt><br>
<tt class="code">:status-hook</tt> <tt class=
"code">:before-execve</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">run-program</tt> runs <tt class=
"variable">program</tt> in a child process. <tt class=
"variable">Program</tt> should be a pathname or string naming the
program. <tt class="variable">Args</tt> should be a list of strings
which this passes to <tt class="variable">program</tt> as normal
Unix parameters. For no arguments, specify <tt class=
"variable">args</tt> as <tt class="code">nil</tt>. The value
returned is either a process structure or <tt class=
"code">nil</tt>. The process interface follows the description of
<tt class="code">run-program</tt>. If <tt class=
"code">run-program</tt> fails to fork the child process, it returns
<tt class="code">nil</tt>.<br>
<br>
Except for sharing file descriptors as explained in keyword
argument descriptions, <tt class="code">run-program</tt> closes all
file descriptors in the child process before running the program.
When you are done using a process, call <tt class=
"code">process-close</tt> to reclaim system resources. You only
need to do this when you supply <tt class="code">:stream</tt> for
one of <tt class="code">:input</tt>, <tt class="code">:output</tt>,
or <tt class="code">:error</tt>, or you supply <tt class=
"code">:pty</tt> non-<tt class="code">nil</tt>. You can call
<tt class="code">process-close</tt> regardless of whether you must
to reclaim resources without penalty if you feel safer.<br>
<br>
<tt class="code">run-program</tt> accepts the following keyword
arguments:<br>
<br>
<dl compact="compact">
<dt><tt class="code">:env</tt><br></dt>
<dd>This is an a-list mapping keywords and simple-strings. The
default is <tt class="code">ext:*environment-list*</tt>. If
<tt class="code">:env</tt> is specified, <tt class=
"code">run-program</tt> uses the value given and does not combine
the environment passed to Lisp with the one specified.<br>
<br></dd>
<dt><tt class="code">:wait</tt><br></dt>
<dd>If non-<tt class="code">nil</tt> (the default), wait until the
child process terminates. If <tt class="code">nil</tt>, continue
running Lisp while the child process runs.<br>
<br></dd>
<dt><tt class="code">:pty</tt><br></dt>
<dd>This should be one of <tt class="code">t</tt>, <tt class=
"code">nil</tt>, or a stream. If specified non-<tt class=
"code">nil</tt>, the subprocess executes under a Unix PTY. If
specified as a stream, the system collects all output to this pty
and writes it to this stream. If specified as <tt class=
"code">t</tt>, the <tt class="code">process-pty</tt> slot contains
a stream from which you can read the program's output and to which
you can write input for the program. The default is <tt class=
"code">nil</tt>.<br>
<br></dd>
<dt><tt class="code">:input</tt><br></dt>
<dd>This specifies how the program gets its input. If specified as
a string, it is the name of a file that contains input for the
child process. <tt class="code">run-program</tt> opens the file as
standard input. If specified as <tt class="code">nil</tt> (the
default), then standard input is the file <tt class=
"filename">/dev/null</tt>. If specified as <tt class="code">t</tt>,
the program uses the current standard input. This may cause some
confusion if <tt class="code">:wait</tt> is <tt class=
"code">nil</tt> since two processes may use the terminal at the
same time. If specified as <tt class="code">:stream</tt>, then the
<tt class="code">process-input</tt> slot contains an output stream.
Anything written to this stream goes to the program as input.
<tt class="code">:input</tt> may also be an input stream that
already contains all the input for the process. In this case
<tt class="code">run-program</tt> reads all the input from this
stream before returning, so this cannot be used to interact with
the process.<br>
<br></dd>
<dt><tt class="code">:if-input-does-not-exist</tt><br></dt>
<dd>This specifies what to do if the input file does not exist. The
following values are valid: <tt class="code">nil</tt> (the default)
causes <tt class="code">run-program</tt> to return <tt class=
"code">nil</tt> without doing anything; <tt class=
"code">:create</tt> creates the named file; and <tt class=
"code">:error</tt> signals an error.<br>
<br></dd>
<dt><tt class="code">:output</tt><br></dt>
<dd>This specifies what happens with the program's output. If
specified as a pathname, it is the name of a file that contains
output the program writes to its standard output. If specified as
<tt class="code">nil</tt> (the default), all output goes to
<tt class="filename">/dev/null</tt>. If specified as <tt class=
"code">t</tt>, the program writes to the Lisp process's standard
output. This may cause confusion if <tt class="code">:wait</tt> is
<tt class="code">nil</tt> since two processes may write to the
terminal at the same time. If specified as <tt class=
"code">:stream</tt>, then the <tt class="code">process-output</tt>
slot contains an input stream from which you can read the program's
output.<br>
<br></dd>
<dt><tt class="code">:if-output-exists</tt><br></dt>
<dd>This specifies what to do if the output file already exists.
The following values are valid: <tt class="code">nil</tt> causes
<tt class="code">run-program</tt> to return <tt class=
"code">nil</tt> without doing anything; <tt class=
"code">:error</tt> (the default) signals an error; <tt class=
"code">:supersede</tt> overwrites the current file; and <tt class=
"code">:append</tt> appends all output to the file.<br>
<br></dd>
<dt><tt class="code">:error</tt><br></dt>
<dd>This is similar to <tt class="code">:output</tt>, except the
file becomes the program's standard error. Additionally, <tt class=
"code">:error</tt> can be <tt class="code">:output</tt> in which
case the program's error output is routed to the same place
specified for <tt class="code">:output</tt>. If specified as
<tt class="code">:stream</tt>, the <tt class=
"code">process-error</tt> contains a stream similar to the
<tt class="code">process-output</tt> slot when specifying the
<tt class="code">:output</tt> argument.<br>
<br></dd>
<dt><tt class="code">:if-error-exists</tt><br></dt>
<dd>This specifies what to do if the error output file already
exists. It accepts the same values as <tt class=
"code">:if-output-exists</tt>.<br>
<br></dd>
<dt><tt class="code">:status-hook</tt><br></dt>
<dd>This specifies a function to call whenever the process changes
status. This is especially useful when specifying <tt class=
"code">:wait</tt> as <tt class="code">nil</tt>. The function takes
the process as a required argument.<br>
<br></dd>
<dt><tt class="code">:before-execve</tt><br></dt>
<dd>This specifies a function to run in the child process before it
becomes the program to run. This is useful for actions such as
authenticating the child process without modifying the parent Lisp
process.</dd>
</dl>
</blockquote>
<!--TOC subsection Process Accessors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc39" id="htoc39"><b><font size=
"4">2.14.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Process
Accessors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The following functions interface the process returned by
<tt class="code">run-program</tt>:<br>
<br>
<br>
<a name="@funs43"></a><a name="FN:process-p" id="FN:process-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-p</tt> <tt class="variable">thing</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="code">t</tt> if <tt class=
"variable">thing</tt> is a process. Otherwise it returns <tt class=
"code">nil</tt></blockquote>
<br>
<a name="@funs44"></a><a name="FN:process-pid" id=
"FN:process-pid"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-pid</tt> <tt class="variable">process</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the process ID, an integer, for the
<tt class="variable">process</tt>.</blockquote>
<br>
<a name="@funs45"></a><a name="FN:process-status" id=
"FN:process-status"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-status</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the current status of <tt class=
"variable">process</tt>, which is one of <tt class=
"code">:running</tt>, <tt class="code">:stopped</tt>, <tt class=
"code">:exited</tt>, or <tt class=
"code">:signaled</tt>.</blockquote>
<br>
<a name="@funs46"></a><a name="FN:process-exit-code" id=
"FN:process-exit-code"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-exit-code</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns either the exit code for <tt class=
"variable">process</tt>, if it is <tt class="code">:exited</tt>, or
the termination signal <tt class="variable">process</tt> if it is
<tt class="code">:signaled</tt>. The result is undefined for
processes that are still alive.</blockquote>
<br>
<a name="@funs47"></a><a name="FN:process-core-dumped" id=
"FN:process-core-dumped"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-core-dumped</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="code">t</tt> if someone used a
Unix signal to terminate the <tt class="variable">process</tt> and
caused it to dump a Unix core image.</blockquote>
<br>
<a name="@funs48"></a><a name="FN:process-pty" id=
"FN:process-pty"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-pty</tt> <tt class="variable">process</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns either the two-way stream connected to
<tt class="variable">process</tt>'s Unix PTY connection or
<tt class="code">nil</tt> if there is none.</blockquote>
<br>
<a name="@funs49"></a><a name="FN:process-input" id=
"FN:process-input"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-input</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs50"></a><a name="FN:process-output" id=
"FN:process-output"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-output</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs51"></a><a name="FN:process-error" id=
"FN:process-error"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-error</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
If the corresponding stream was created, these functions return the
input, output or error fd-stream. <tt class="code">nil</tt> is
returned if there is no stream.</blockquote>
<br>
<a name="@funs52"></a><a name="FN:process-status-hook" id=
"FN:process-status-hook"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-status-hook</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the current function to call whenever
<tt class="variable">process</tt>'s status changes. This function
takes the <tt class="variable">process</tt> as a required argument.
<tt class="code">process-status-hook</tt> is <tt class=
"code">setf</tt>'able.</blockquote>
<br>
<a name="@funs53"></a><a name="FN:process-plist" id=
"FN:process-plist"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-plist</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns annotations supplied by users, and it is
<tt class="code">setf</tt>'able. This is available solely for users
to associate information with <tt class="variable">process</tt>
without having to build a-lists or hash tables of process
structures.</blockquote>
<br>
<a name="@funs54"></a><a name="FN:process-wait" id=
"FN:process-wait"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-wait</tt> <tt class="variable">process</tt>
<tt class="code">&amp;optional</tt> <tt class=
"variable">check-for-stopped</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function waits for <tt class="variable">process</tt> to
finish. If <tt class="variable">check-for-stopped</tt> is
non-<tt class="code">nil</tt>, this also returns when <tt class=
"variable">process</tt> stops.</blockquote>
<br>
<a name="@funs55"></a><a name="FN:process-kill" id=
"FN:process-kill"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-kill</tt> <tt class="variable">process</tt>
<tt class="variable">signal</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">whom</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function sends the Unix <tt class="variable">signal</tt> to
<tt class="variable">process</tt>. <tt class="variable">Signal</tt>
should be the number of the signal or a keyword with the Unix name
(for example, <tt class="code">:sigsegv</tt>). <tt class=
"variable">Whom</tt> should be one of the following:
<dl compact="compact">
<dt><tt class="code">:pid</tt><br></dt>
<dd>This is the default, and it indicates sending the signal to
<tt class="variable">process</tt> only.<br>
<br></dd>
<dt><tt class="code">:process-group</tt><br></dt>
<dd>This indicates sending the signal to <tt class=
"variable">process</tt>'s group.<br>
<br></dd>
<dt><tt class="code">:pty-process-group</tt><br></dt>
<dd>This indicates sending the signal to the process group
currently in the foreground on the Unix PTY connected to <tt class=
"variable">process</tt>. This last option is useful if the running
program is a shell, and you wish to signal the program running
under the shell, not the shell itself. If <tt class=
"code">process-pty</tt> of <tt class="variable">process</tt> is
<tt class="code">nil</tt>, using this option is an error.</dd>
</dl>
</blockquote>
<br>
<a name="@funs56"></a><a name="FN:process-alive-p" id=
"FN:process-alive-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-alive-p</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="code">t</tt> if <tt class=
"variable">process</tt>'s status is either <tt class=
"code">:running</tt> or <tt class=
"code">:stopped</tt>.</blockquote>
<br>
<a name="@funs57"></a><a name="FN:process-close" id=
"FN:process-close"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">process-close</tt> <tt class=
"variable">process</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function closes all the streams associated with <tt class=
"variable">process</tt>. When you are done using a process, call
this to reclaim system resources.</blockquote>
<!--TOC section Saving a Core Image-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc40" id="htoc40"><b><font size=
"5">2.15</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Saving a Core
Image</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
A mechanism has been provided to save a running Lisp core image and
to later restore it. This is convenient if you don't want to load
several files into a Lisp when you first start it up. The main
problem is the large size of each saved Lisp image, typically at
least 20 megabytes.<br>
<br>
<br>
<a name="@funs58"></a><a name="FN:save-lisp" id="FN:save-lisp"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">save-lisp</tt> <tt class="variable">file</tt>
<tt class="code">&amp;key</tt> <tt class="code">:purify</tt>
<tt class="code">:root-structures</tt> <tt class=
"code">:init-function</tt><br>
<tt class="code">:load-init-file</tt> <tt class=
"code">:print-herald</tt> <tt class="code">:site-init</tt><br>
<tt class="code">:process-command-line</tt> <tt class=
"code">:batch-mode</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The <tt class="code">save-lisp</tt> function saves the state of the
currently running Lisp core image in <tt class=
"variable">file</tt>. The keyword arguments have the following
meaning:
<dl compact="compact">
<dt><tt class="code">:purify</tt><br></dt>
<dd>If non-<tt class="code">nil</tt> (the default), the core image
is purified before it is saved (see <a name=
"@funs59"></a><tt class="code">purify</tt>.) This reduces the
amount of work the garbage collector must do when the resulting
core image is being run. Also, if more than one Lisp is running on
the same machine, this maximizes the amount of memory that can be
shared between the two processes.<br>
<br></dd>
<dt><tt class="code">:root-structures</tt><br></dt>
<dd>This should be a list of the main entry points in any newly
loaded systems. This need not be supplied, but locality and/or GC
performance will be better if they are. Meaningless if <tt class=
"code">:purify</tt> is <tt class="code">nil</tt>. See <a name=
"@funs60"></a><tt class="code">purify</tt>.<br>
<br></dd>
<dt><tt class="code">:init-function</tt><br></dt>
<dd>This is the function that starts running when the created core
file is resumed. The default function simply invokes the top level
read-eval-print loop. If the function returns the lisp will
exit.<br>
<br></dd>
<dt><tt class="code">:load-init-file</tt><br></dt>
<dd>If non-NIL, then load an init file; either the one specified on
the command line or ``<tt class="filename">init.</tt><tt class=
"variable">fasl-type</tt>'', or, if ``<tt class=
"filename">init.</tt><tt class="variable">fasl-type</tt>'' does not
exist, <tt class="code">init.lisp</tt> from the user's home
directory. If the init file is found, it is loaded into the resumed
core file before the read-eval-print loop is entered.<br>
<br></dd>
<dt><tt class="code">:site-init</tt><br></dt>
<dd>If non-NIL, the name of the site init file to quietly load. The
default is <tt class="filename">library:site-init</tt>. No error is
signalled if the file does not exist.<br>
<br></dd>
<dt><tt class="code">:print-herald</tt><br></dt>
<dd>If non-NIL (the default), then print out the standard Lisp
herald when starting.<br>
<br></dd>
<dt><tt class="code">:process-command-line</tt><br></dt>
<dd>If non-NIL (the default), processes the command line switches
and performs the appropriate actions.<br>
<br></dd>
<dt><tt class="code">:batch-mode</tt><br></dt>
<dd>If NIL (the default), then the presence of the -batch
command-line switch will invoke batch-mode processing upon resuming
the saved core. If non-NIL, the produced core will always be in
batch-mode, regardless of any command-line switches.<br>
<br></dd>
<dt><tt class="code">:executable</tt><br></dt>
<dd>If non-NIL, an executable image is created. Normally, CMUCL
consists of the C runtime along with a core file image. When
<tt class="code">:executable</tt> is non-NIL, the core file is
incorporated into the C runtime, so one (large) executable is
created instead of a new separate core file.<br>
<br>
This feature is only available on some platforms. Currently only
x86 on Linux and FreeBSD support this.</dd>
</dl>
</blockquote>
To resume a saved file, type:
<blockquote class="example">
<pre>
lisp -core file
</pre></blockquote>
<br>
<a name="@funs61"></a><a name="FN:purify" id="FN:purify"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">purify</tt> <tt class="variable">file</tt>
<tt class="code">&amp;key</tt> <tt class=
"code">:root-structures</tt> <tt class=
"code">:environment-name</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function optimizes garbage collection by moving all currently
live objects into non-collected storage. Once statically allocated,
the objects can never be reclaimed, even if all pointers to them
are dropped. This function should generally be called after a large
system has been loaded and initialized.<br>
<br>
<dl compact="compact">
<dt><tt class="code">:root-structures</tt><br></dt>
<dd>is an optional list of objects which should be copied first to
maximize locality. This should be a list of the main entry points
for the resulting core image. The purification process tries to
localize symbols, functions, etc., in the core image so that paging
performance is improved. The default value is NIL which means that
Lisp objects will still be localized but probably not as optimally
as they could be.<br>
<br>
<tt class="variable">defstruct</tt> structures defined with the
<tt class="code">(:pure t)</tt> option are moved into read-only
storage, further reducing GC cost. List and vector slots of pure
structures are also moved into read-only storage.<br>
<br></dd>
<dt><tt class="code">:environment-name</tt><br></dt>
<dd>is gratuitous documentation for the compacted version of the
current global environment (as seen in <tt class=
"code">c::*info-environment*</tt>.) If <tt class="code">nil</tt> is
supplied, then environment compaction is inhibited.</dd>
</dl>
</blockquote>
<!--TOC section Pathnames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc41" id="htoc41"><b><font size=
"5">2.16</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Pathnames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
In Common Lisp quite a few aspects of <a name=
"@types17"></a><tt class="code">pathname</tt> semantics are left to
the implementation.<br>
<br>
<!--TOC subsection Unix Pathnames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc42" id="htoc42"><b><font size=
"4">2.16.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Unix
Pathnames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept4"></a><br>
Unix pathnames are always parsed with a <tt class=
"code">unix-host</tt> object as the host and <tt class=
"code">nil</tt> as the device. The last two dots (<tt class=
"code">.</tt>) in the namestring mark the type and version, however
if the first character is a dot, it is considered part of the name.
If the last character is a dot, then the pathname has the
empty-string as its type. The type defaults to <tt class=
"code">nil</tt> and the version defaults to <tt class=
"code">:newest</tt>.
<blockquote class="example">
<pre>
(defun parse (x)
  (values (pathname-name x) (pathname-type x) (pathname-version x)))

(parse "foo") ==&gt; "foo", NIL, :NEWEST
(parse "foo.bar") ==&gt; "foo", "bar", :NEWEST
(parse ".foo") ==&gt; ".foo", NIL, :NEWEST
(parse ".foo.bar") ==&gt; ".foo", "bar", :NEWEST
(parse "..") ==&gt; ".", "", :NEWEST
(parse "foo.") ==&gt; "foo", "", :NEWEST
(parse "foo.bar.1") ==&gt; "foo", "bar", 1
(parse "foo.bar.baz") ==&gt; "foo.bar", "baz", :NEWEST
</pre></blockquote>
The directory of pathnames beginning with a slash (or a
search-list, see section&nbsp;<a href="#search-lists">2.16.4</a>)
is starts <tt class="code">:absolute</tt>, others start with
<tt class="code">:relative</tt>. The <tt class="code">..</tt>
directory is parsed as <tt class="code">:up</tt>; there is no
namestring for <tt class="code">:back</tt>:
<blockquote class="example">
<pre>
(pathname-directory "/usr/foo/bar.baz") ==&gt; (:ABSOLUTE "usr" "foo")
(pathname-directory "../foo/bar.baz") ==&gt; (:RELATIVE :UP "foo")
</pre></blockquote>
<!--TOC subsection Wildcard Pathnames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc43" id="htoc43"><b><font size=
"4">2.16.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Wildcard
Pathnames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Wildcards are supported in Unix pathnames. If `<tt class=
"code">*</tt>' is specified for a part of a pathname, that is
parsed as <tt class="code">:wild</tt>. `<tt class="code">**</tt>'
can be used as a directory name to indicate <tt class=
"code">:wild-inferiors</tt>. Filesystem operations treat <tt class=
"code">:wild-inferiors</tt> the same as <tt class=
"code">:wild</tt>, but pathname pattern matching (e.g. for logical
pathname translation, see section&nbsp;<a href=
"#logical-pathnames">2.16.3</a>) matches any number of directory
parts with `<tt class="code">**</tt>' (see see
section&nbsp;<a href="#wildcard-matching">2.17.1</a>.)<br>
<br>
`<tt class="code">*</tt>' embedded in a pathname part matches any
number of characters. Similarly, `<tt class="code">?</tt>' matches
exactly one character, and `<tt class="code">[a,b]</tt>' matches
the characters `<tt class="code">a</tt>' or `<tt class=
"code">b</tt>'. These pathname parts are parsed as <tt class=
"code">pattern</tt> objects.<br>
<br>
Backslash can be used as an escape character in namestring parsing
to prevent the next character from being treated as a wildcard.
Note that if typed in a string constant, the backslash must be
doubled, since the string reader also uses backslash as a quote:
<blockquote class="example">
<pre>
(pathname-name "foo\\*bar") =&gt; "foo*bar"
</pre></blockquote>
<!--TOC subsection Logical Pathnames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc44" id="htoc44"><b><font size=
"4">2.16.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Logical
Pathnames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept5"></a> <a name="logical-pathnames" id=
"logical-pathnames"></a><br>
If a namestring begins with the name of a defined logical pathname
host followed by a colon, then it will be parsed as a logical
pathname. Both `<tt class="code">*</tt>' and `<tt class=
"code">**</tt>' wildcards are implemented. <a name=
"@funs62"></a><tt class=
"code">load-logical-pathname-translations</tt> on <tt class=
"variable">name</tt> looks for a logical host definition file in
<tt class="filename">library:<tt class=
"variable">name</tt>.translations</tt>. Note that <tt class=
"filename">library:</tt> designates the search list (see
section&nbsp;<a href="#search-lists">2.16.4</a>) initialized to the
CMUCL <tt class="filename">lib/</tt> directory, not a logical
pathname. The format of the file is a single list of two-lists of
the from and to patterns:
<blockquote class="example">
<pre>
(("foo;*.text" "/usr/ram/foo/*.txt")
 ("foo;*.lisp" "/usr/ram/foo/*.l"))
</pre></blockquote>
<!--TOC subsection Search Lists-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc45" id="htoc45"><b><font size=
"4">2.16.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Search
Lists</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept6"></a> <a name="search-lists" id=
"search-lists"></a><br>
Search lists are an extension to Common Lisp pathnames. They serve
a function somewhat similar to Common Lisp logical pathnames, but
work more like Unix PATH variables. Search lists are used for two
purposes:
<ul>
<li>They provide a convenient shorthand for commonly used directory
names, and<br>
<br></li>
<li>They allow the abstract (directory structure independent)
specification of file locations in program pathname constants
(similar to logical pathnames.)</li>
</ul>
Each search list has an associated list of directories (represented
as pathnames with no name or type component.) The namestring for
any relative pathname may be prefixed with ``<tt class=
"variable">slist</tt><tt class="code">:</tt>'', indicating that the
pathname is relative to the search list <tt class=
"variable">slist</tt> (instead of to the current working
directory.) Once qualified with a search list, the pathname is no
longer considered to be relative.<br>
<br>
When a search list qualified pathname is passed to a file-system
operation such as <tt class="code">open</tt>, <tt class=
"code">load</tt> or <tt class="code">truename</tt>, each directory
in the search list is successively used as the root of the pathname
until the file is located. When a file is written to a search list
directory, the file is always written to the first directory in the
list.<br>
<br>
<!--TOC subsection Predefined Search-Lists-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc46" id="htoc46"><b><font size=
"4">2.16.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Predefined
Search-Lists</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These search-lists are initialized from the Unix environment or
when Lisp was built:
<dl compact="compact">
<dt><tt class="code">default:</tt><br></dt>
<dd>The current directory at startup.<br>
<br></dd>
<dt><tt class="code">home:</tt><br></dt>
<dd>The user's home directory.<br>
<br></dd>
<dt><tt class="code">library:</tt><br></dt>
<dd>The CMUCL <tt class="filename">lib/</tt> directory (<tt class=
"code">CMUCLLIB</tt> environment variable.)<br>
<br></dd>
<dt><tt class="code">path:</tt><br></dt>
<dd>The Unix command path (<tt class="code">PATH</tt> environment
variable.)<br>
<br></dd>
<dt><tt class="code">target:</tt><br></dt>
<dd>The root of the tree where CMUCL was compiled.</dd>
</dl>
It can be useful to redefine these search-lists, for example,
<tt class="filename">library:</tt> can be augmented to allow
logical pathname translations to be located, and <tt class=
"filename">target:</tt> can be redefined to point to where CMUCL
system sources are locally installed.<br>
<br>
<!--TOC subsection Search-List Operations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc47" id="htoc47"><b><font size=
"4">2.16.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Search-List
Operations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These operations define and access search-list definitions. A
search-list name may be parsed into a pathname before the
search-list is actually defined, but the search-list must be
defined before it can actually be used in a filesystem
operation.<br>
<br>
<br>
<a name="@funs63"></a><a name="FN:search-list" id=
"FN:search-list"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">search-list</tt> <tt class="variable">name</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the list of directories associated with the
search list <tt class="variable">name</tt>. If <tt class=
"variable">name</tt> is not a defined search list, then an error is
signaled. When set with <tt class="code">setf</tt>, the list of
directories is changed to the new value. If the new value is just a
namestring or pathname, then it is interpreted as a one-element
list. Note that (unlike Unix pathnames), search list names are
case-insensitive.</blockquote>
<br>
<a name="@funs64"></a><a name="FN:search-list-defined-p" id=
"FN:search-list-defined-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">search-list-defined-p</tt> <tt class=
"variable">name</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs65"></a><a name="FN:clear-search-list" id=
"FN:clear-search-list"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">clear-search-list</tt> <tt class=
"variable">name</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<br>
<tt class="code">search-list-defined-p</tt> returns <tt class=
"code">t</tt> if <tt class="variable">name</tt> is a defined search
list name, <tt class="code">nil</tt> otherwise. <tt class=
"code">clear-search-list</tt> make the search list <tt class=
"variable">name</tt> undefined.</blockquote>
<br>
<a name="@funs66"></a><a name="FN:enumerate-search-list" id=
"FN:enumerate-search-list"></a>
<div align="left">[Macro]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">enumerate-search-list</tt> (<tt class=
"variable">var</tt> <tt class="variable">pathname</tt> <tt class=
"code">{result}</tt>) <tt class="code">{form}</tt><sup><font size=
"2">*</font></sup> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro provides an interface to search list resolution. The
body <tt class="variable">forms</tt> are executed with <tt class=
"variable">var</tt> bound to each successive possible expansion for
<tt class="variable">name</tt>. If <tt class="variable">name</tt>
does not contain a search-list, then the body is executed exactly
once. Everything is wrapped in a block named <tt class=
"code">nil</tt>, so <tt class="code">return</tt> can be used to
terminate early. The <tt class="variable">result</tt> form (default
<tt class="code">nil</tt>) is evaluated to determine the result of
the iteration.</blockquote>
<!--TOC subsection Search List Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc48" id="htoc48"><b><font size=
"4">2.16.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Search List
Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The search list <tt class="code">code:</tt> can be defined as
follows:
<blockquote class="example">
<pre>
(setf (ext:search-list "code:") '("/usr/lisp/code/"))
</pre></blockquote>
It is now possible to use <tt class="code">code:</tt> as an
abbreviation for the directory <tt class=
"filename">/usr/lisp/code/</tt> in all file operations. For
example, you can now specify <tt class="code">code:eval.lisp</tt>
to refer to the file <tt class=
"filename">/usr/lisp/code/eval.lisp</tt>.<br>
<br>
To obtain the value of a search-list name, use the function
search-list as follows:
<blockquote class="example">
<pre>
(ext:search-list <tt class="variable">name</tt>)
</pre></blockquote>
Where <tt class="variable">name</tt> is the name of a search list
as described above. For example, calling <tt class=
"code">ext:search-list</tt> on <tt class="code">code:</tt> as
follows:
<blockquote class="example">
<pre>
(ext:search-list "code:")
</pre></blockquote>
returns the list <tt class="code">("/usr/lisp/code/")</tt>.<br>
<br>
<!--TOC section Filesystem Operations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc49" id="htoc49"><b><font size=
"5">2.17</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Filesystem
Operations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL provides a number of extensions and optional features beyond
those required by the Common Lisp specification.<br>
<br>
<!--TOC subsection Wildcard Matching-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc50" id="htoc50"><b><font size=
"4">2.17.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Wildcard
Matching</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="wildcard-matching" id="wildcard-matching"></a><br>
Unix filesystem operations such as <tt class="code">open</tt> will
accept wildcard pathnames that match a single file (of course,
<tt class="code">directory</tt> allows any number of matches.)
Filesystem operations treat <tt class="code">:wild-inferiors</tt>
the same as <tt class="code">:wild</tt>.<br>
<br>
<br>
<a name="@funs67"></a><a name="FN:directory" id="FN:directory"></a>
<div align="left">[Function]<br>
<tt class="function-name">directory</tt> <tt class=
"variable">wildname</tt> <tt class="code">&amp;key</tt> <tt class=
"code">:all</tt> <tt class="code">:check-for-subdirs</tt>
<tt class="code">:truenamep</tt><br>
<tt class="code">:follow-links</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The keyword arguments to this Common Lisp function are a CMUCL
extension. The arguments (all default to <tt class="code">t</tt>)
have the following functions:
<dl compact="compact">
<dt><tt class="code">:all</tt><br></dt>
<dd>Include files beginning with dot such as <tt class=
"filename">.login</tt>, similar to ``<tt class="code">ls
-a</tt>''.<br>
<br></dd>
<dt><tt class="code">:check-for-subdirs</tt><br></dt>
<dd>Test whether files are directories, similar to ``<tt class=
"code">ls -F</tt>''.<br>
<br></dd>
<dt><tt class="code">:truenamep</tt><br></dt>
<dd>Call <tt class="code">truename</tt> on each file, which expands
out all symbolic links. Note that this option can easily result in
pathnames being returned which have a different directory from the
one in the <tt class="variable">wildname</tt> argument.<br>
<br></dd>
<dt><tt class="code">:follow-links</tt><br></dt>
<dd>Follow symbolic links when searching for matching
directories.</dd>
</dl>
</blockquote>
<br>
<a name="@funs68"></a><a name="FN:print-directory" id=
"FN:print-directory"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">print-directory</tt> <tt class=
"variable">wildname</tt> <tt class="code">&amp;optional</tt>
<tt class="variable">stream</tt> <tt class="code">&amp;key</tt>
<tt class="code">:all</tt> <tt class="code">:verbose</tt><br>
<tt class="code">:return-list</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Print a directory of <tt class="variable">wildname</tt> listing to
<tt class="variable">stream</tt> (default <tt class=
"code">*standard-output*</tt>.) <tt class="code">:all</tt> and
<tt class="code">:verbose</tt> both default to <tt class=
"code">nil</tt> and correspond to the ``<tt class="code">-a</tt>''
and ``<tt class="code">-l</tt>'' options of <tt class=
"filename">ls</tt>. Normally this function returns <tt class=
"code">nil</tt>, but if <tt class="code">:return-list</tt> is true,
a list of the matched pathnames are returned.</blockquote>
<!--TOC subsection File Name Completion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc51" id="htoc51"><b><font size=
"4">2.17.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">File Name
Completion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs69"></a><a name="FN:complete-file" id=
"FN:complete-file"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">complete-file</tt> <tt class=
"variable">pathname</tt> <tt class="code">&amp;key</tt> <tt class=
"code">:defaults</tt> <tt class="code">:ignore-types</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Attempt to complete a file name to the longest unambiguous prefix.
If supplied, directory from <tt class="code">:defaults</tt> is used
as the ``working directory'' when doing completion. <tt class=
"code">:ignore-types</tt> is a list of strings of the pathname
types (a.k.a. extensions) that should be disregarded as possible
matches (binary file names, etc.)</blockquote>
<br>
<a name="@funs70"></a><a name="FN:ambiguous-files" id=
"FN:ambiguous-files"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">ambiguous-files</tt> <tt class=
"variable">pathname</tt> <tt class="code">&amp;optional</tt>
<tt class="variable">defaults</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Return a list of pathnames for all the possible completions of
<tt class="variable">pathname</tt> with respect to <tt class=
"variable">defaults</tt>.</blockquote>
<!--TOC subsection Miscellaneous Filesystem Operations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc52" id="htoc52"><b><font size=
"4">2.17.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Miscellaneous
Filesystem Operations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs71"></a><a name="FN:default-directory" id=
"FN:default-directory"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">default-directory</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Return the current working directory as a pathname. If set with
<tt class="code">setf</tt>, set the working directory.</blockquote>
<br>
<a name="@funs72"></a><a name="FN:file-writable" id=
"FN:file-writable"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">file-writable</tt> <tt class="variable">name</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function accepts a pathname and returns <tt class=
"code">t</tt> if the current process can write it, and <tt class=
"code">nil</tt> otherwise.</blockquote>
<br>
<a name="@funs73"></a><a name="FN:unix-namestring" id=
"FN:unix-namestring"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">unix-namestring</tt> <tt class=
"variable">pathname</tt> <tt class="code">&amp;optional</tt>
<tt class="variable">for-input</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function converts <tt class="variable">pathname</tt> into a
string that can be used with UNIX system calls. Search-lists and
wildcards are expanded. <tt class="variable">for-input</tt>
controls the treatment of search-lists: when true (the default) and
the file exists anywhere on the search-list, then that absolute
pathname is returned; otherwise the first element of the
search-list is used as the directory.</blockquote>
<!--TOC section Time Parsing and Formatting-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc53" id="htoc53"><b><font size=
"5">2.18</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Time Parsing and
Formatting</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<a name="@concept7"></a> <a name="@concept8"></a> Functions are
provided to allow parsing strings containing time information and
printing time in various formats are available.<br>
<br>
<br>
<a name="@funs74"></a><a name="FN:parse-time" id=
"FN:parse-time"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">parse-time</tt> <tt class=
"variable">time-string</tt> <tt class="code">&amp;key</tt>
<tt class="code">:error-on-mismatch</tt> <tt class=
"code">:default-seconds</tt><br>
<tt class="code">:default-minutes</tt> <tt class=
"code">:default-hours</tt><br>
<tt class="code">:default-day</tt> <tt class=
"code">:default-month</tt><br>
<tt class="code">:default-year</tt> <tt class=
"code">:default-zone</tt><br>
<tt class="code">:default-weekday</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">parse-time</tt> accepts a string containing a time
(e.g., "<tt class="code">Jan 12, 1952</tt>") and returns the
universal time if it is successful. If it is unsuccessful and the
keyword argument <tt class="code">:error-on-mismatch</tt> is
non-<tt class="code">nil</tt>, it signals an error. Otherwise it
returns <tt class="code">nil</tt>. The other keyword arguments have
the following meaning:<br>
<br>
<dl compact="compact">
<dt><tt class="code">:default-seconds</tt><br></dt>
<dd>specifies the default value for the seconds value if one is not
provided by <tt class="variable">time-string</tt>. The default
value is 0.<br>
<br></dd>
<dt><tt class="code">:default-minutes</tt><br></dt>
<dd>specifies the default value for the minutes value if one is not
provided by <tt class="variable">time-string</tt>. The default
value is 0.<br>
<br></dd>
<dt><tt class="code">:default-hours</tt><br></dt>
<dd>specifies the default value for the hours value if one is not
provided by <tt class="variable">time-string</tt>. The default
value is 0.<br>
<br></dd>
<dt><tt class="code">:default-day</tt><br></dt>
<dd>specifies the default value for the day value if one is not
provided by <tt class="variable">time-string</tt>. The default
value is the current day.<br>
<br></dd>
<dt><tt class="code">:default-month</tt><br></dt>
<dd>specifies the default value for the month value if one is not
provided by <tt class="variable">time-string</tt>. The default
value is the current month.<br>
<br></dd>
<dt><tt class="code">:default-year</tt><br></dt>
<dd>specifies the default value for the year value if one is not
provided by <tt class="variable">time-string</tt>. The default
value is the current year.<br>
<br></dd>
<dt><tt class="code">:default-zone</tt><br></dt>
<dd>specifies the default value for the time zone value if one is
not provided by <tt class="variable">time-string</tt>. The default
value is the current time zone.<br>
<br></dd>
<dt><tt class="code">:default-weekday</tt><br></dt>
<dd>specifies the default value for the day of the week if one is
not provided by <tt class="variable">time-string</tt>. The default
value is the current day of the week.</dd>
</dl>
Any of the above keywords can be given the value <tt class=
"code">:current</tt> which means to use the current value as
determined by a call to the operating system.</blockquote>
<br>
<a name="@funs75"></a><a name="FN:format-universal-time" id=
"FN:format-universal-time"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">format-universal-time</tt> <tt class=
"variable">dest</tt> <tt class="variable">universal-time</tt><br>
<tt class="code">&amp;key</tt> <tt class="code">:timezone</tt><br>
<tt class="code">:style</tt> <tt class="code">:date-first</tt><br>
<tt class="code">:print-seconds</tt> <tt class=
"code">:print-meridian</tt><br>
<tt class="code">:print-timezone</tt> <tt class=
"code">:print-weekday</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs76"></a><a name="FN:format-decoded-time" id=
"FN:format-decoded-time"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">format-decoded-time</tt> <tt class=
"variable">dest</tt> <tt class="variable">seconds</tt> <tt class=
"variable">minutes</tt> <tt class="variable">hours</tt> <tt class=
"variable">day</tt> <tt class="variable">month</tt> <tt class=
"variable">year</tt><br>
<tt class="code">&amp;key</tt> <tt class="code">:timezone</tt><br>
<tt class="code">:style</tt> <tt class="code">:date-first</tt><br>
<tt class="code">:print-seconds</tt> <tt class=
"code">:print-meridian</tt><br>
<tt class="code">:print-timezone</tt> <tt class=
"code">:print-weekday</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<br>
<tt class="code">format-universal-time</tt> formats the time
specified by <tt class="variable">universal-time</tt>. <tt class=
"code">format-decoded-time</tt> formats the time specified by
<tt class="variable">seconds</tt>, <tt class=
"variable">minutes</tt>, <tt class="variable">hours</tt>,
<tt class="variable">day</tt>, <tt class="variable">month</tt>, and
<tt class="variable">year</tt>. <tt class="variable">Dest</tt> is
any destination accepted by the <tt class="code">format</tt>
function. The keyword arguments have the following meaning:
<dl compact="compact">
<dt><tt class="code">:timezone</tt><br></dt>
<dd>is an integer specifying the hours west of Greenwich.
<tt class="code">:timezone</tt> defaults to the current time
zone.<br>
<br></dd>
<dt><tt class="code">:style</tt><br></dt>
<dd>specifies the style to use in formatting the time. The legal
values are:
<dl compact="compact">
<dt><tt class="code">:short</tt><br></dt>
<dd>specifies to use a numeric date.<br>
<br></dd>
<dt><tt class="code">:long</tt><br></dt>
<dd>specifies to format months and weekdays as words instead of
numbers.<br>
<br></dd>
<dt><tt class="code">:abbreviated</tt><br></dt>
<dd>is similar to long except the words are abbreviated.<br>
<br></dd>
<dt><tt class="code">:government</tt><br></dt>
<dd>is similar to abbreviated, except the date is of the form ``day
month year'' instead of ``month day, year''.</dd>
</dl>
<br>
<br></dd>
<dt><tt class="code">:date-first</tt><br></dt>
<dd>if non-<tt class="code">nil</tt> (default) will place the date
first. Otherwise, the time is placed first.<br>
<br></dd>
<dt><tt class="code">:print-seconds</tt><br></dt>
<dd>if non-<tt class="code">nil</tt> (default) will format the
seconds as part of the time. Otherwise, the seconds will be
omitted.<br>
<br></dd>
<dt><tt class="code">:print-meridian</tt><br></dt>
<dd>if non-<tt class="code">nil</tt> (default) will format ``AM''
or ``PM'' as part of the time. Otherwise, the ``AM'' or ``PM'' will
be omitted.<br>
<br></dd>
<dt><tt class="code">:print-timezone</tt><br></dt>
<dd>if non-<tt class="code">nil</tt> (default) will format the time
zone as part of the time. Otherwise, the time zone will be
omitted.<br>
<br></dd>
<dt><tt class="code">:print-weekday</tt><br></dt>
<dd>if non-<tt class="code">nil</tt> (default) will format the
weekday as part of date. Otherwise, the weekday will be
omitted.</dd>
</dl>
</blockquote>
<!--TOC section Random Number Generation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc54" id="htoc54"><b><font size=
"5">2.19</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Random Number
Generation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept9"></a><br>
Common Lisp includes a random number generator as a standard part
of the language; however, the implementation of the generator is
not specified. Two random number generators are available in CMUCL,
depending on the version.<br>
<br>
<!--TOC subsection Original Generator-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc55" id="htoc55"><b><font size=
"4">2.19.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Original
Generator</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<a name="@concept10"></a> The default random number generator uses
a lagged Fibonacci generator given by<br>
<div align="center"><i>z</i>[<i>i</i>] = <i>z</i>[<i>i</i> - 24] -
<i>z</i>[<i>i</i> - 55] mod536870908</div>
<br>
where <i>z</i>[<i>i</i>] is the <i>i</i>'th random number. This
generator produces small integer-valued numbers. For larger
integer, the small random integers are concatenated to produce
larger integers. For floating-point numbers, the bits from this
generator are used as the bits of the floating-point
significand.<br>
<br>
<!--TOC subsection New Generator-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc56" id="htoc56"><b><font size=
"4">2.19.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">New
Generator</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept11"></a><br>
In some versions of CMUCL, the original generator above has been
replaced with a subtract-with-borrow generator combined with a Weyl
generator.<sup><a name="text2" href="#note2" id="text2"><font size=
"2">2</font></a></sup> The reason for the change was to use a
documented generator which has passed tests for randomness.<br>
<br>
The subtract-with-borrow generator is described by the following
equation
<div align="center"><i>z</i>[<i>i</i>] = <i>z</i>[<i>i</i> + 20] -
<i>z</i>[<i>i</i> + 5] - <i>b</i></div>
where <i>z</i>[<i>i</i>] is the <i>i</i>'th random number, which is
a <tt class="code">double-float</tt>. All of the indices in this
equation are interpreted modulo 32. The quantity <i>b</i> is
carried over from the previous iteration and is either 0 or
<tt class="code">double-float-epsilon</tt>. If <i>z</i>[<i>i</i>]
is positive, <i>b</i> is set to zero. Otherwise, <i>b</i> is set to
<tt class="code">double-float-epsilon</tt>.<br>
<br>
To increase the randomness of this generator, this generator is
combined with a Weyl generator defined by
<div align="center"><i>x</i>[<i>i</i>] = <i>x</i>[<i>i</i> - 1] -
<i>y</i> mod1,</div>
where <i>y</i> = 7097293079245107 &times; 2<sup><font size=
"2">-53</font></sup>. Thus, the resulting random number
<i>r</i>[<i>i</i>] is
<div align="center"><i>r</i>[<i>i</i>] = (<i>z</i>[<i>i</i>] -
<i>x</i>[<i>i</i>]) mod1</div>
<br>
This generator has been tested by Peter VanEynde using Marsaglia's
diehard test suite for random number generators; this generator
passes the test suite.<br>
<br>
This generator is designed for generating floating-point random
numbers. To obtain integers, the bits from the significand of the
floating-point number are used as the bits of the integer. As many
floating-point numbers as needed are generated to obtain the
desired number of bits in the random integer.<br>
<br>
For floating-point numbers, this generator can by significantly
faster than the original generator.<br>
<br>
<!--TOC subsection MT-19937 Generator-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc57" id="htoc57"><b><font size=
"4">2.19.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">MT-19937
Generator</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept12"></a> On all platforms, this is the preferred
generator as indicated by <tt class="code">:rand-mt19937</tt> being
in <tt class="code">*features*</tt>. This is a Lisp implementation
of the MT-19937 generator of Makoto Matsumoto and T. Nishimura. We
refer the reader to their paper<sup><a name="text3" href="#note3"
id="text3"><font size="2">3</font></a></sup> or to their website at
<a href=
"http://www.math.keio.ac.jp/~matumoto/emt.html"><tt>http://www.math.keio.ac.jp/&nbsp;matsumoto/emt.html</tt></a>.<br>

<br>
<!--TOC section Lisp Threads-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc58" id="htoc58"><b><font size=
"5">2.20</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Lisp
Threads</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept13"></a><br>
CMUCL supports Lisp threads for the x86 platform.<br>
<br>
<!--TOC section Lisp Library-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc59" id="htoc59"><b><font size=
"5">2.21</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Lisp
Library</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="lisp-lib" id="lisp-lib"></a><br>
The CMUCL project maintains a collection of useful or interesting
programs written by users of our system. The library is in
<tt class="filename">lib/contrib/</tt>. Two files there that users
should read are:
<dl compact="compact">
<dt>CATALOG.TXT<br></dt>
<dd>This file contains a page for each entry in the library. It
contains information such as the author, portability or dependency
issues, how to load the entry, etc.<br>
<br></dd>
<dt>READ-ME.TXT<br></dt>
<dd>This file describes the library's organization and all the
possible pieces of information an entry's catalog description could
contain.</dd>
</dl>
Hemlock has a command <tt class="code">Library Entry</tt> that
displays a list of the current library entries in an editor buffer.
There are mode specific commands that display catalog descriptions
and load entries. This is a simple and convenient way to browse the
library.<br>
<br>
<!--TOC section Generalized Function Names-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc60" id="htoc60"><b><font size=
"5">2.22</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Generalized
Function Names</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs77"></a><a name="FN:define-function-name-syntax" id=
"FN:define-function-name-syntax"></a>
<div align="left">[Macro]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">define-function-name-syntax</tt> name (var)
<tt class="code">&amp;body</tt> body &nbsp;&nbsp;&nbsp;</div>
<blockquote>Define lists starting with the symbol <tt class=
"code">name</tt> as a new extended function name syntax.<br>
<br>
<tt class="code">body</tt> is executed with <tt class=
"code">var</tt> bound to an actual function name of that form, and
should return two values:
<ul>
<li>A generalized boolean that is true if <tt class="code">var</tt>
is a valid function name.</li>
<li>A symbol that can be used as a <tt class="code">block</tt> name
in functions whose name is <tt class="code">var</tt>. (For some
sorts of function names it might make sense to return <tt class=
"code">nil</tt> for the block name, or just return one value.)</li>
</ul>
Users should not define function names starting with a symbol that
CMUCL might be using internally. It is therefore advisable to only
define new function names starting with a symbol from a
user-defined package.</blockquote>
<br>
<a name="@funs78"></a><a name="FN:valid-function-name-p" id=
"FN:valid-function-name-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">valid-function-name-p</tt> name
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns two values:
<ul>
<li>True if <tt class="code">name</tt> is a valid function
name.</li>
<li>A symbol that can be used as a <tt class="code">block</tt> name
in functions whose name is <tt class="code">name</tt>. This can be
<tt class="code">nil</tt> for some function names.</li>
</ul>
</blockquote>
<!--TOC section CLOS-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc61" id="htoc61"><b><font size=
"5">2.23</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">CLOS</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<!--TOC subsection Primary Method Errors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc62" id="htoc62"><b><font size=
"4">2.23.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Primary Method
Errors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept14"></a><br>
The standard requires that an error is signaled when a generic
function is called and
<ul>
<li>no primary method is applicable to the generic function's
actual arguments, and</li>
<li>the generic function's method combination is either the
standard method combination or a method combination defined with
the short form of <tt class="code">define-method-combination</tt>.
The latter includes the standardized method combinations like
<tt class="code">progn</tt>, <tt class="code">and</tt>, etc.</li>
</ul>
<br>
<a name="@funs79"></a><a name=
"FN:no-primary-method-generic-generic" id=
"FN:no-primary-method-generic-generic"></a>
<div align="left">[Generic Function]<br>
<tt class="function-name">pcl:</tt><tt class=
"function-name">no-primary-method</tt> gf &amp;rest args
&nbsp;&nbsp;&nbsp;</div>
In CMUCL, this generic function is called in the above erroneous
cases. The parameter <tt class="code">gf</tt> is the generic
function being called, and <tt class="code">args</tt> is a list of
actual arguments in the generic function call.<br>
<br>
<br>
<a name="@funs80"></a><a name=
"FN:no-primary-method-method-standard" id=
"FN:no-primary-method-method-standard"></a>
<div align="left">[Method]<br>
<tt class="function-name">pcl:</tt><tt class=
"function-name">no-primary-method</tt> (gf
standard-generic-function) &amp;rest args &nbsp;&nbsp;&nbsp;</div>
This method signals a continuable error of type <tt class=
"code">pcl:no-primary-method-error</tt>.<br>
<br>
<!--TOC subsection Slot Type Checking-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc63" id="htoc63"><b><font size=
"4">2.23.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Slot Type
Checking</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept15"></a><br>
Declared slot types are used when
<ul>
<li>reading slot values with <tt class="code">slot-value</tt> in
methods, or<br>
<br></li>
<li>setting slots with <tt class="code">(setf slot-value)</tt> in
methods, or<br>
<br></li>
<li>creating instances with <tt class="code">make-instance</tt>,
when slots are initialized from initforms. This currently depends
on PCL being able to use its internal <tt class=
"code">make-instance</tt> optimization, which it usually can.</li>
</ul>
Example:
<blockquote class="example">
<pre>
(defclass foo ()
  ((a :type fixnum)))

(defmethod bar ((object foo) value)
  (with-slots (a) object
    (setf a value)))

(defmethod baz ((object foo))
  (&lt; (slot-value object 'a) 10))
</pre></blockquote>
In method <tt class="code">bar</tt>, and with a suitable safety
setting, a type error will occur if <tt class="code">value</tt> is
not a <tt class="code">fixnum</tt>. In method <tt class=
"code">baz</tt>, a <tt class="code">fixnum</tt> comparison can be
used by the compiler.<br>
<br>
<br>
<a name="@vars18"></a><a name="VR:use-slot-types-p" id=
"VR:use-slot-types-p"></a>
<div align="left">[Variable]<br>
<tt class="function-name">pcl::</tt><tt class=
"function-name">*use-slot-types-p*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Slot type checking can be turned off by setting this
variable to <tt class="code">nil</tt>, which can be useful for
compiling code containing incorrect slot type
declarations.</blockquote>
<!--TOC subsection Slot Access Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc64" id="htoc64"><b><font size=
"4">2.23.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Slot Access
Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept16"></a> <a name="@concept17"></a><br>
The declaration <tt class="code">ext:slots</tt> is used for
optimizing slot access in methods.
<blockquote class="example">
<pre>
declare (ext:slots specifier*)

specifier   ::= (quality class-entry*)
quality     ::= SLOT-BOUNDP | INLINE
class-entry ::= class | (class slot-name*)
class       ::= the name of a class
slot-name   ::= the name of a slot
</pre></blockquote>
The <tt class="code">slot-boundp</tt> quality specifies that all or
some slots of a class are always bound.<br>
<br>
The <tt class="code">inline</tt> quality specifies that access to
all or some slots of a class should be inlined, using compile-time
knowledge of class layouts.<br>
<br>
<!--TOC subsubsection <TT class=code>slot-boundp</TT> Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.23.3.1</b></td>
<td width="100%" align="center"><tt class=
"code"><b>slot-boundp</b></tt> <b>Declaration</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept18"></a><br>
Example:
<blockquote class="example">
<pre>
(defclass foo ()
  (a b))

(defmethod bar ((x foo))
  (declare (ext:slots (slot-boundp foo)))
  (list (slot-value x 'a) (slot-value x 'b)))
</pre></blockquote>
The <tt class="code">slot-boundp</tt> declaration in method
<tt class="code">bar</tt> specifies that the slots <tt class=
"code">a</tt> and <tt class="code">b</tt> accessed through
parameter <tt class="code">x</tt> in the scope of the declaration
are always bound, because parameter <tt class="code">x</tt> is
specialized on class <tt class="code">foo</tt> to which the
<tt class="code">slot-boundp</tt> declaration applies. The
PCL-generated code for the <tt class="code">slot-value</tt> forms
will thus not contain tests for the slots being bound or not. The
consequences are undefined should one of the accessed slots not be
bound.<br>
<br>
<!--TOC subsubsection <TT class=code>inline</TT> Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.23.3.2</b></td>
<td width="100%" align="center"><tt class="code"><b>inline</b></tt>
<b>Declaration</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept19"></a><br>
Example:
<blockquote class="example">
<pre>
(defclass foo ()
  (a b))

(defmethod bar ((x foo))
  (declare (ext:slots (inline (foo a))))
  (list (slot-value x 'a) (slot-value x 'b)))
</pre></blockquote>
The <tt class="code">inline</tt> declaration in method <tt class=
"code">bar</tt> tells PCL to use compile-time knowledge of slot
locations for accessing slot <tt class="code">a</tt> of class
<tt class="code">foo</tt>, in the scope of the declaration.<br>
<br>
Class <tt class="code">foo</tt> must be known at compile time for
this optimization to be possible. PCL prints a warning and uses
normal slot access If the class is not defined at compile time.<br>
<br>
If a class is <tt class="code">proclaim</tt>ed to use inline slot
access before it is defined, the class is defined at compile time.
Example:
<blockquote class="example">
<pre>
(declaim (ext:slots (inline (foo slot-a))))
(defclass foo () ...)
(defclass bar (foo) ...)
</pre></blockquote>
Class <tt class="code">foo</tt> will be defined at compile time
because it is declared to use inline slot access; methods accessing
slot <tt class="code">slot-a</tt> of <tt class="code">foo</tt> will
use inline slot access if otherwise possible. Class <tt class=
"code">bar</tt> will be defined at compile time because its
superclass <tt class="code">foo</tt> is declared to use inline slot
access. PCL uses compile-time information from subclasses to warn
about situations where using inline slot access is not
possible.<br>
<br>
Normal slot access will be used if PCL finds, at method compilation
time, that
<ul>
<li>class <tt class="code">foo</tt> has a subclass in which slot
<tt class="code">a</tt> is at a different location, or<br>
<br></li>
<li>there exists a <tt class="code">slot-value-using-class</tt>
method for <tt class="code">foo</tt> or a subclass of <tt class=
"code">foo</tt>.</li>
</ul>
When the declaration is used to optimize calls to slot accessor
generic functions in methods, as opposed to <tt class=
"code">slot-value</tt> or <tt class="code">(setf slot-value)</tt>,
the optimization is additionally not used if
<ul>
<li>there exist, at compile time, applicable methods on the
reader/writer generic function that are not standard accessor
methods (for instance, there exist around-methods), or<br>
<br></li>
<li>applicable reader/writer methods access different slots in a
class accessed inline, and one of its subclasses.</li>
</ul>
The consequences are undefined if the compile-time environment is
not the same as the run-time environment in these respects, or if
the definition of class <tt class="code">foo</tt> or any subclass
of <tt class="code">foo</tt> is changed in an incompatible way,
that is, if slot locations change.<br>
<br>
The effect of the <tt class="code">inline</tt> optimization
combined with the <tt class="code">slot-boundp</tt> optimization is
that CLOS slot access becomes as fast as structure slot access,
which is an order of magnitude faster than normal CLOS slot
access.<br>
<br>
<br>
<a name="@vars19"></a><a name="VR:optimize-inline-slot-access-p"
id="VR:optimize-inline-slot-access-p"></a>
<div align="left">[Variable]<br>
<tt class="function-name">pcl::</tt><tt class=
"function-name">*optimize-inline-slot-access-p*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This variable controls if inline slot access
optimizations are performed. It is true by default.</blockquote>
<!--TOC subsubsection Automatic Method Recompilation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>2.23.3.3</b></td>
<td width="100%" align="center"><b>Automatic Method
Recompilation</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept20"></a> <a name="@concept21"></a> <a name=
"@concept22"></a><br>
Methods using inline slot access can be automatically recompiled
after class changes. Two declarations control which methods are
automatically recompiled.
<blockquote class="example">
<pre>
declaim (ext:auto-compile specifier*)
declaim (ext:not-auto-compile specifier*)

specifier   ::= gf-name | (gf-name qualifier* (specializer*))
gf-name     ::= the name of a generic function
qualifier   ::= a method qualifier
specializer ::= a method specializer
</pre></blockquote>
If no specifier is given, auto-compilation is by default done/not
done for all methods of all generic functions using inline slot
access; current default is that it is not done. This global policy
can be overridden on a generic function and method basis. If
<tt class="code">specifier</tt> is a generic function name, it
applies to all methods of that generic function.<br>
<br>
Examples:
<blockquote class="example">
<pre>
(declaim (ext:auto-compile foo))
(defmethod foo :around ((x bar)) ...)
</pre></blockquote>
The around-method <tt class="code">foo</tt> will be automatically
recompiled because the declamation applies to all methods with name
<tt class="code">foo</tt>.
<blockquote class="example">
<pre>
(declaim (ext:auto-compile (foo (bar))))
(defmethod foo :around ((x bar)) ...)
(defmethod foo ((x bar)) ...)
</pre></blockquote>
The around-method will not be automatically recompiled, but the
primary method will.
<blockquote class="example">
<pre>
(declaim (ext:auto-compile foo))
(declaim (ext:not-auto-compile (foo :around (bar)))  
(defmethod foo :around ((x bar)) ...)
(defmethod foo ((x bar)) ...)
</pre></blockquote>
The around-method will not be automatically recompiled, because it
is explicitly declaimed not to be. The primary method will be
automatically recompiled because the first declamation applies to
it.<br>
<br>
Auto-recompilation works by recording method bodies using inline
slot access. When PCL determines that a recompilation is necessary,
a <tt class="code">defmethod</tt> form is constructed and
evaluated.<br>
<br>
Auto-compilation can only be done for methods defined in a null
lexical environment. PCL prints a warning and doesn't record the
method body if a method using inline slot access is defined in a
non-null lexical environment. Instead of doing a recompilation on
itself, PCL will then print a warning that the method must be
recompiled manually when classes are changed.<br>
<br>
<!--TOC subsection Inlining Methods in Effective Methods-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc65" id="htoc65"><b><font size=
"4">2.23.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Inlining Methods
in Effective Methods</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept23"></a> <a name="@concept24"></a> <a name=
"@concept25"></a> <a name="@concept26"></a><br>
When a generic function is called, an effective method is
constructed from applicable methods. The effective method is called
with the original arguments, and itself calls applicable methods
according to the generic function's method combination. Some of the
function call overhead in effective methods can be removed by
inlining methods in effective methods, at the expense of increased
code size.<br>
<br>
Inlining of methods is controlled by the usual <tt class=
"code">inline</tt> declaration. In the following example, both
<tt class="code">foo</tt> methods shown will be inlined in
effective methods:
<blockquote class="example">
<pre>
(declaim (inline (method foo (foo))
                 (method foo :before (foo))))
(defmethod foo ((x foo)) ...)
(defmethod foo :before ((x foo)) ...)
</pre></blockquote>
Please note that this form of inlining has no noticeable effect for
effective methods that consist of a primary method only, which
doesn't have keyword arguments. In such cases, PCL uses the primary
method directly for the effective method.<br>
<br>
When the definition of an inlined method is changed, effective
methods are <b>not</b> automatically updated to reflect the change.
This is just as it is when inlining normal functions. Different
from the normal case is that users do not have direct access to
effective methods, as it would be the case when a function is
inlined somewhere else. Because of this, the function <tt class=
"code">pcl:flush-emf-cache</tt> is provided for forcing such an
update of effective methods.<br>
<br>
<br>
<a name="@funs81"></a><a name="FN:flush-emf-cache" id=
"FN:flush-emf-cache"></a>
<div align="left">[Function]<br>
<tt class="function-name">pcl:</tt><tt class=
"function-name">flush-emf-cache</tt> &amp;optional gf
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Flush cached effective method functions. If <tt class=
"code">gf</tt> is supplied, it should be a generic function
metaobject or the name of a generic function, and this function
flushes all cached effective methods for the given generic
function. If <tt class="code">gf</tt> is not supplied, all cached
effective methods are flushed.</blockquote>
<br>
<a name="@vars20"></a><a name="VR:inline-methods-in-emfs" id=
"VR:inline-methods-in-emfs"></a>
<div align="left">[Variable]<br>
<tt class="function-name">pcl::</tt><tt class=
"function-name">*inline-methods-in-emfs*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>If true, the default, perform method inlining as
described above. If false, don't.</blockquote>
<!--TOC subsection Effective Method Precomputation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc66" id="htoc66"><b><font size=
"4">2.23.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Effective Method
Precomputation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept27"></a> <a name="@concept28"></a> <a name=
"@concept29"></a><br>
When a generic function is called, the generic function's
discriminating function computes the set of methods applicable to
actual arguments and constructs an effective method function from
applicable methods, using the generic function's method
combination.<br>
<br>
Effective methods can be precomputed at method load time instead of
when the generic function is called depending on the value of
<tt class="code">pcl:*max-emf-precomputation-methods*</tt>.<br>
<br>
<br>
<a name="@vars21"></a><a name=
"VR:*max-emf-precomputation-methods*"></a>
<div align="left">[Variable]<br>
<tt class="function-name">pcl:</tt><tt class=
"function-name">**max-emf-precomputation-methods**</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>If nonzero, the default value is 100, precompute
effective methods when methods are loaded, and the method's generic
function has less than the specified number of methods.<br>
<br>
If zero, compute effective methods only when the generic function
is called.</blockquote>
<!--TOC subsection Sealing-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc67" id="htoc67"><b><font size=
"4">2.23.6</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Sealing</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept30"></a> <a name="@concept31"></a> <a name=
"@concept32"></a> <a name="@concept33"></a><br>
Support for sealing classes and generic functions have been
implemented. Please note that this interface is subject to
change.<br>
<br>
<br>
<a name="@funs82"></a><a name="FN:seal" id="FN:seal"></a>
<div align="left">[Macro]<br>
<tt class="function-name">pcl:</tt><tt class=
"function-name">seal</tt> name (var) <tt class=
"code">&amp;rest</tt> specifiers &nbsp;&nbsp;&nbsp;</div>
<blockquote>Seal <tt class="code">name</tt> with respect to the
given specifiers; <tt class="code">name</tt> can be the name of a
class or generic-function.<br>
<br>
Supported specifiers are <tt class="code">:subclasses</tt> for
classes, which prevents changing subclasses of a class, and
<tt class="code">:methods</tt> which prevents changing the methods
of a generic function.<br>
<br>
Sealing violations signal an error of type <tt class=
"code">pcl:sealed-error</tt>.</blockquote>
<br>
<a name="@funs83"></a><a name="FN:unseal" id="FN:unseal"></a>
<div align="left">[Function]<br>
<tt class="function-name">pcl:</tt><tt class=
"function-name">unseal</tt> name-or-object &nbsp;&nbsp;&nbsp;</div>
<blockquote>Remove seals from <tt class=
"code">name-or-object</tt>.</blockquote>
<!--TOC subsection Method Tracing and Profiling-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc68" id="htoc68"><b><font size=
"4">2.23.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Method Tracing
and Profiling</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="sec:method-tracing" id="sec:method-tracing"></a> <a name=
"@concept34"></a> <a name="@concept35"></a> <a name=
"@concept36"></a> <a name="@concept37"></a> <a name=
"@concept38"></a> <a name="@concept39"></a><br>
Methods can be traced with <tt class="code">trace</tt>, using
function names of the form <tt class="code">(method &lt;name&gt;
&lt;qualifiers&gt; &lt;specializers&gt;)</tt>. Example:
<blockquote class="example">
<pre>
(defmethod foo ((x integer)) x)
(defmethod foo :before ((x integer)) x)

(trace (method foo (integer)))
(trace (method foo :before (integer)))
(untrace (method foo :before (integer)))
</pre></blockquote>
<br>
<br>
<tt class="code">trace</tt> and <tt class="code">untrace</tt> also
allow a name specifier <tt class="code">:methods gf-form</tt> for
tracing all methods of a generic function:
<blockquote class="example">
<pre>
(trace :methods 'foo)
(untrace :methods 'foo)
</pre></blockquote>
Methods can also be specified for the <tt class=
"code">:wherein</tt> option to <tt class="code">trace</tt>. Because
this option is a name or a list of names, methods must be specified
as a list. Thus, to trace all calls of <tt class="code">foo</tt>
from the method <tt class="code">bar</tt> specialized on integer
argument, use
<blockquote class="example">
<pre>
  (trace foo :wherein ((method bar (integer))))
</pre></blockquote>
Before and after methods are supported as well:
<blockquote class="example">
<pre>
  (trace foo :wherein ((method bar :before (integer))))
</pre></blockquote>
Method profiling is done analogously to <tt class=
"code">trace</tt>:
<blockquote class="example">
<pre>
(defmethod foo ((x integer)) x)
(defmethod foo :before ((x integer)) x)

(profile:profile (method foo (integer)))
(profile:profile (method foo :before (integer)))
(profile:unprofile (method foo :before (integer)))

(profile:profile :methods 'foo)
(profile:unprofile :methods 'foo)

(profile:profile-all :methods t)
</pre></blockquote>
<!--TOC subsection Misc-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc69" id="htoc69"><b><font size=
"4">2.23.8</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Misc</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept40"></a><br>
<br>
<a name="@vars22"></a><a name="VR:compile-interpreted-methods-p"
id="VR:compile-interpreted-methods-p"></a>
<div align="left">[Variable]<br>
<tt class="function-name">pcl::</tt><tt class=
"function-name">*compile-interpreted-methods-p*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This variable controls compilation of interpreted
method functions, e.g. for methods defined interactively at the
REPL. Default is true, that is, method functions are
compiled.</blockquote>
<!--TOC section Differences from ANSI Common Lisp-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc70" id="htoc70"><b><font size=
"5">2.24</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Differences from
ANSI Common Lisp</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
This section describes some of the known differences between CMUCL
and ANSI Common Lisp. Some may be non-compliance issues; same may
be extensions.<br>
<br>
<!--TOC subsection Extensions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc71" id="htoc71"><b><font size=
"4">2.24.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Extensions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs84"></a><a name="FN:constantly" id=
"FN:constantly"></a>
<div align="left">[Function]<br>
<tt class="function-name">constantly</tt> value &amp;optional val1
val2 &amp;rest more-values &nbsp;&nbsp;&nbsp;</div>
<blockquote>As an extension, CMUCL allows <tt class=
"code">constantly</tt> to accept more than one value which are
returned as multiple values.</blockquote>
<!--TOC section Function Wrappers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc72" id="htoc72"><b><font size=
"5">2.25</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Function
Wrappers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept41"></a> <a name="@concept42"></a><br>
Function wrappers, fwrappers for short, are a facility for
efficiently encapsulating functions<sup><a name="text4" href=
"#note4" id="text4"><font size="2">4</font></a></sup>.<br>
<br>
Functions in CMUCL are represented by <tt class=
"code">kernel:fdefn</tt> objects. Each <tt class="code">fdefn</tt>
object contains a reference to its function's actual code, which we
call the function's primary function.<br>
<br>
A function wrapper replaces the primary function in the <tt class=
"code">fdefn</tt> object with a function of its own, and records
the original function in an fwrapper object, a funcallable
instance. Thus, when the function is called, the fwrapper gets
called, which in turn might call the primary function, or a
previously installed fwrapper that was found in the <tt class=
"code">fdefn</tt> object when the second fwrapper was
installed.<br>
<br>
Example:
<blockquote class="lisp">
<pre>
(use-package :fwrappers)

(define-fwrapper foo (x y)
  (format t "x = ~s, y = ~s, user-data = ~s~%"
          x y (fwrapper-user-data fwrapper))
  (let ((value (call-next-function)))
    (format t "value = ~s~%" value)
    value))

(defun bar (x y)
  (+ x y))

(fwrap 'bar #'foo :type 'foo :user-data 42)

(bar 1 2)
 =&gt;
 x = 1, y = 2, user-data = 42
 value = 3
 3   
</pre></blockquote>
Fwrappers are used in the implementation of <tt class=
"code">trace</tt> and <tt class="code">profile</tt>.<br>
<br>
Please note that <tt class="code">fdefinition</tt> always returns
the primary definition of a function; if a function is fwrapped,
<tt class="code">fdefinition</tt> returns the primary function
stored in the innermost fwrapper object. Likewise, if a function is
fwrapped, <tt class="code">(setf fdefinition)</tt> will set the
primary function in the innermost fwrapper.<br>
<br>
<br>
<a name="@funs85"></a><a name="FN:define-fwrapper" id=
"FN:define-fwrapper"></a>
<div align="left">[Macro]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">define-fwrapper</tt> name lambda-list <tt class=
"code">&amp;body</tt>body &nbsp;&nbsp;&nbsp;</div>
<blockquote>This macro is like <tt class="code">defun</tt>, but
defines a function named <tt class="variable">name</tt> that can be
used as an fwrapper definition.<br>
<br>
In <tt class="variable">body</tt>, the symbol <tt class=
"code">fwrapper</tt> is bound to the current fwrapper object.<br>
<br>
The macro <tt class="code">call-next-function</tt> can be used to
invoke the next fwrapper, or the primary function that is being
fwrapped. When called with no arguments, <tt class=
"code">call-next-function</tt> invokes the next function with the
original arguments passed to the fwrapper, unless you modify one of
the parameters. When called with arguments, <tt class=
"code">call-next-function</tt> invokes the next function with the
given arguments.</blockquote>
<br>
<a name="@funs86"></a><a name="FN:fwrap" id="FN:fwrap"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">fwrap</tt> function-name fwrapper &amp;key type
user-data &nbsp;&nbsp;&nbsp;</div>
<blockquote>This function wraps function <tt class=
"code">function-name</tt> in an fwrapper <tt class=
"variable">fwrapper</tt> which was defined with <tt class=
"code">define-fwrapper</tt>.<br>
<br>
The value of <tt class="variable">type</tt>, if supplied, is used
as an identifying tag that can be used in various other
operations.<br>
<br>
The value of <tt class="variable">user-data</tt> is stored as
user-supplied data in the fwrapper object that is created for the
function encapsulation. User-data is accessible in the body of
fwrappers defined with <tt class="code">define-fwrapper</tt> as
<tt class="code">(fwrapper-user-data fwrapper)</tt>.<br>
<br>
Value is the fwrapper object created.</blockquote>
<br>
<a name="@funs87"></a><a name="FN:funwrap" id="FN:funwrap"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">funwrap</tt> function-name &amp;key type test
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Remove fwrappers from the function named <tt class=
"variable">function-name</tt>. If <tt class="variable">type</tt> is
supplied, remove fwrappers whose type is <tt class=
"code">equal</tt> to <tt class="variable">type</tt>. If <tt class=
"variable">test</tt> is supplied, remove fwrappers satisfying
<tt class="variable">test</tt>.</blockquote>
<br>
<a name="@funs88"></a><a name="FN:find-fwrapper" id=
"FN:find-fwrapper"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">find-fwrapper</tt> function-name &amp;key type test
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Find an fwrapper of <tt class=
"variable">function-name</tt>. If <tt class="variable">type</tt> is
supplied, find an fwrapper whose type is <tt class=
"code">equal</tt> to <tt class="variable">type</tt>. If <tt class=
"variable">test</tt> is supplied, find an fwrapper satisfying
<tt class="variable">test</tt>.</blockquote>
<br>
<a name="@funs89"></a><a name="FN:update-fwrapper" id=
"FN:update-fwrapper"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">update-fwrapper</tt> fwrapper
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Update the funcallable instance function of the
fwrapper object <tt class="variable">fwrapper</tt> from the
definition of its function that was defined with <tt class=
"code">define-fwrapper</tt>. This can be used to update fwrappers
after changing a <tt class=
"code">define-fwrapper</tt>.</blockquote>
<br>
<a name="@funs90"></a><a name="FN:update-fwrappers" id=
"FN:update-fwrappers"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">update-fwrappers</tt> function-name &amp;key type
test &nbsp;&nbsp;&nbsp;</div>
<blockquote>Update fwrappers of <tt class=
"variable">function-name</tt>; see <tt class=
"code">update-fwrapper</tt>. If <tt class="variable">type</tt> is
supplied, update fwrappers whose type is <tt class=
"code">equal</tt> to <tt class="variable">type</tt>. If <tt class=
"variable">test</tt> is supplied, update fwrappers satisfying
<tt class="variable">test</tt>.</blockquote>
<br>
<a name="@funs91"></a><a name="FN:set-fwrappers" id=
"FN:set-fwrappers"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">set-fwrappers</tt> function-name fwrappers
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Set <tt class="variable">function-names</tt>'s
fwrappers to elements of the list <tt class=
"variable">fwrappers</tt>, which is assumed to be ordered from
outermost to innermost. <tt class="variable">fwrappers</tt> null
means remove all fwrappers.</blockquote>
<br>
<a name="@funs92"></a><a name="FN:list-fwrappers" id=
"FN:list-fwrappers"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">list-fwrappers</tt> function-name
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Return a list of all fwrappers of <tt class=
"variable">function-name</tt>, ordered from outermost to
innermost.</blockquote>
<br>
<a name="@funs93"></a><a name="FN:push-fwrapper" id=
"FN:push-fwrapper"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">push-fwrapper</tt> fwrapper function-name
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Prepend fwrapper <tt class="variable">fwrapper</tt> to
the definition of <tt class="variable">function-name</tt>. Signal
an error if <tt class="variable">function-name</tt> is an undefined
function.</blockquote>
<br>
<a name="@funs94"></a><a name="FN:delete-fwrapper" id=
"FN:delete-fwrapper"></a>
<div align="left">[Function]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">delete-fwrapper</tt> fwrapper function-name
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Remove fwrapper <tt class="variable">fwrapper</tt> from
the definition of <tt class="variable">function-name</tt>. Signal
an error if <tt class="variable">function-name</tt> is an undefined
function.</blockquote>
<br>
<a name="@funs95"></a><a name="FN:do-fwrappers" id=
"FN:do-fwrappers"></a>
<div align="left">[Macro]<br>
<tt class="function-name">fwrappers:</tt><tt class=
"function-name">do-fwrappers</tt> (var fdefn <tt class=
"code">&amp;optional</tt>result) <tt class=
"code">&amp;body</tt>body &nbsp;&nbsp;&nbsp;</div>
<blockquote>Evaluate <tt class="variable">body</tt> with <tt class=
"variable">var</tt> bound to consecutive fwrappers of <tt class=
"variable">fdefn</tt>. Return <tt class="variable">result</tt> at
the end. Note that <tt class="variable">fdefn</tt> must be an
<tt class="code">fdefn</tt> object. You can use <tt class=
"code">kernel:fdefn-or-lose</tt>, for instance, to get the
<tt class="code">fdefn</tt> object from a function
name.</blockquote>
<!--TOC section Dynamic-Extent Declarations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc73" id="htoc73"><b><font size=
"5">2.26</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Dynamic-Extent
Declarations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept43"></a><br>
<em>Note: As of the 19a release,</em> <tt class=
"code"><em>dynamic-extent</em></tt> <em>is unfortunately disabled
by default. It is known to cause some issues with CLX and Hemlock.
The cause is not known, but causes random errors and brokeness.
Enable at your own risk. However, it is safe enough to build all of
CMUCL without problems.</em><br>
<br>
On x86 and sparc, CMUCL can exploit <tt class=
"code">dynamic-extent</tt> declarations by allocating objects on
the stack instead of the heap.<br>
<br>
You can tell CMUCL to trust or not trust <tt class=
"code">dynamic-extent</tt> declarations by setting the variable
<tt class="variable">*trust-dynamic-extent-declarations*</tt>.<br>
<br>
<br>
<a name="@vars23"></a><a name=
"VR:trust-dynamic-extent-declarations" id=
"VR:trust-dynamic-extent-declarations"></a>
<div align="left">[Variable]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">*trust-dynamic-extent-declarations*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>If the value of <tt class=
"variable">*trust-dynamic-extent-declarations*</tt> is <tt class=
"code">NIL</tt>, <tt class="code">dynamic-extent</tt> declarations
are effectively ignored.<br>
<br>
If the value of this variable is a function, the function is called
with four arguments to determine if a <tt class=
"code">dynamic-extent</tt> declaration should be trusted. The
arguments are the safety, space, speed, and debug settings at the
point where the <tt class="code">dynamic-extent</tt> declaration is
used. If the function returns true, the declaration is trusted,
otherwise it is not trusted.<br>
<br>
In all other cases, <tt class="code">dynamic-extent</tt>
declarations are trusted.</blockquote>
Please note that stack-allocation is inherently unsafe. If you make
a mistake, and a stack-allocated object or part of it escapes,
CMUCL is likely to crash, or format your hard disk.<br>
<br>
<!--TOC subsection <TT class=code>&amp;rest</TT> argument lists-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc74" id="htoc74"><b><font size=
"4">2.26.1</font></b></a></td>
<td width="100%" align="center"><tt class="code"><b><font size=
"4">&amp;rest</font></b></tt> <b><font size="4">argument
lists</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept44"></a><br>
Rest argument lists can be allocated on the stack by declaring the
rest argument variable <tt class="code">dynamic-extent</tt>.
Examples:
<blockquote class="lisp">
<pre>
(defun foo (x &amp;rest rest)
  (declare (dynamic-extent rest))
  ...)

(defun bar ()
  (lambda (&amp;rest rest)
    (declare (dynamic-extent rest))
    ...))
</pre></blockquote>
<!--TOC subsection Closures-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc75" id="htoc75"><b><font size=
"4">2.26.2</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Closures</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept45"></a><br>
Closures for local functions can be allocated on the stack if the
local function is declared <tt class="code">dynamic-extent</tt>,
and the closure appears as an argument in the call of a named
function. In the example:
<blockquote class="lisp">
<pre>
(defun foo (x)
  (flet ((bar () x))
    (declare (dynamic-extent #'bar))
    (baz #'bar)))
</pre></blockquote>
the closure passed to function <tt class="code">baz</tt> is
allocated on the stack. Likewise in the example:
<blockquote class="lisp">
<pre>
(defun foo (x)
  (flet ((bar () x))
    (baz #'bar)
    (locally (declare (dynamic-extent #'bar))
      (baz #'bar))))
</pre></blockquote>
<a name="@concept46"></a> Stack-allocation of closures can also
automatically take place when calling certain known CL functions
taking function arguments, for example <tt class="code">some</tt>
or <tt class="code">find-if</tt>.<br>
<br>
<!--TOC subsection <TT class=code>list</TT>, <TT class=code>list*</TT>, and <TT class=code>cons</TT>-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc76" id="htoc76"><b><font size=
"4">2.26.3</font></b></a></td>
<td width="100%" align="center"><tt class="code"><b><font size=
"4">list</font></b></tt><b><font size="4">,</font></b> <tt class=
"code"><b><font size="4">list*</font></b></tt><b><font size="4">,
and</font></b> <tt class="code"><b><font size=
"4">cons</font></b></tt></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept47"></a><br>
New conses allocated by <tt class="code">list</tt>, <tt class=
"code">list*</tt>, or <tt class="code">cons</tt> which are used to
initialize variables can be allocated from the stack if the
variables are declared <tt class="code">dynamic-extent</tt>. In the
case of <tt class="code">cons</tt>, only the outermost cons cell is
allocated from the stack; this is an arbitrary restriction.
<blockquote class="lisp">
<pre>
(let ((x (list 1 2))
      (y (list* 1 2 x))
      (z (cons 1 (cons 2 nil))))
  (declare (dynamic-extent x y z))
  ...
  (setq x (list 2 3))
  ...)
</pre></blockquote>
Please note that the <tt class="code">setq</tt> of <tt class=
"code">x</tt> in the example program assigns to <tt class=
"code">x</tt> a list that is allocated from the heap. This is
another arbitrary restriction that exists because other Lisps
behave that way.<br>
<br>
<!--TOC section Modular Arithmetic-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc77" id="htoc77"><b><font size=
"5">2.27</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Modular
Arithmetic</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept48"></a><br>
This section is mostly taken, with permission, from the
documentation for SBCL.<br>
<br>
Some numeric functions have a property: <tt class="code">N</tt>
lower bits of the result depend only on <tt class="code">N</tt>
lower bits of (all or some) arguments. If the compiler sees an
expression of form <tt class="code">(logand exp mask)</tt>, where
<tt class="code">exp</tt> is a tree of such ``good'' functions and
<tt class="code">mask</tt> is known to be of type <tt class=
"code">(unsigned-byte w)</tt>, where <tt class="code">w</tt> is a
"good" width, all intermediate results will be cut to <tt class=
"code">w</tt> bits (but it is not done for variables and
constants!). This often results in an ability to use simple machine
instructions for the functions.<br>
<br>
Consider an example.
<blockquote class="lisp">
<pre>
(defun i (x y)
  (declare (type (unsigned-byte 32) x y))
  (ldb (byte 32 0) (logxor x (lognot y))))
</pre></blockquote>
The result of <tt class="code">(lognot y)</tt> will be negative and
of type <tt class="code">(signed-byte 33)</tt>, so a naive
implementation on a 32-bit platform is unable to use 32-bit
arithmetic here. But modular arithmetic optimizer is able to do it:
because the result is cut down to 32 bits, the compiler will
replace <tt class="code">logxor</tt> and <tt class=
"code">lognot</tt> with versions cutting results to 32 bits, and
because terminals (here---expressions <tt class="code">x</tt> and
<tt class="code">y</tt>) are also of type <tt class=
"code">(unsigned-byte 32)</tt>, 32-bit machine arithmetic can be
used.<br>
<br>
Currently ``good'' functions are <tt class="code">+</tt>,
<tt class="code">-</tt>, <tt class="code">*</tt>; <tt class=
"code">logand</tt>, <tt class="code">logior</tt>, <tt class=
"code">logxor</tt>, <tt class="code">lognot</tt> and their
combinations; and <tt class="code">ash</tt> with the positive
second argument. ``Good'' widths are 32 on HPPA, MIPS, PPC, Sparc
and X86 and 64 on Alpha. While it is possible to support smaller
widths as well, currently it is not implemented.<br>
<br>
A more extensive description of modular arithmetic can be found in
the paper ``Efficient Hardware Arithmetic in Common Lisp'' by
Alexey Dejneka, and Christophe Rhodes, to be published.<br>
<br>
<!--TOC section Extension to REQUIRE-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc78" id="htoc78"><b><font size=
"5">2.28</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Extension to
REQUIRE</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept49"></a><br>
The behavior of <tt class="code">require</tt> when called with only
one argument is implementation-defined. In CMUCL, functions from
the list <tt class="variable">*module-provider-functions*</tt> are
called in order with the stringified module name as the argument.
The first function to return non-<tt class="variable">NIL</tt> is
assumed to have loaded the module.<br>
<br>
By default the functions <tt class=
"code">module-provide-cmucl-defmodule</tt> and <tt class=
"code">module-provide- cmucl-library</tt> are on this list of
functions, in that order.<br>
<br>
<br>
<a name="@vars24"></a><a name="VR:module-provider-functions" id=
"VR:module-provider-functions"></a>
<div align="left">[Variable]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">*module-provider-functions*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This is a list of functions taking a single argument.
<tt class="code">require</tt> calls each function in turn with the
stringified module name. The first function to return
non-<tt class="variable">NIL</tt> indicates that the module has
been loaded. The remaining functions, if any, are not called.<br>
<br>
To add new providers, push the new provider function onto the
beginning of this list.</blockquote>
<br>
<a name="@funs96"></a><a name="FN:defmodule" id="FN:defmodule"></a>
<div align="left">[Macro]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">defmodule</tt> name <tt class="code">&amp;rest</tt>
files &nbsp;&nbsp;&nbsp;</div>
<blockquote>Defines a module by registering the files that need to
be loaded when the module is required. If <tt class=
"variable">name</tt> is a symbol, its print name is used after
downcasing it.</blockquote>
<br>
<a name="@funs97"></a><a name="FN:module-provide-cmucl-defmodule"
id="FN:module-provide-cmucl-defmodule"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">module-provide-cmucl-defmodule</tt> module-name
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This function is the module-provider for modules
registered by a <tt class="code">ext:defmodule</tt>
form.</blockquote>
<br>
<a name="@funs98"></a><a name="FN:module-provide-cmucl-library" id=
"FN:module-provide-cmucl-library"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">module-provide-cmucl-library</tt> module-name
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This function is the module-provider for CMUCL's
libraries, including Gray streams, simple streams, CLX, CLM,
Hemlock, <em>etc</em>.<br>
<br>
This function causes a file to be loaded whose name is formed by
merging the search-list ``modules:'' and the concatenation of
module-name with the suffix ``-LIBRARY''. Note that both the
module-name and the suffix are each, separately, converted from
:case :common to :case :local. This merged name will be probed with
both a .lisp and .fasl extensions, calling <tt class=
"code">LOAD</tt> if it exists.</blockquote>
<!--NAME extensions.html-->
<!--BEGIN NOTES chapter-->
<hr width="50%" size="1">
<dl>
<dt><a name="note1" href="#text1" id="note1"><font size=
"5">1</font></a></dt>
<dd>This implementation was donated by Paul Foley</dd>
<dt><a name="note2" href="#text2" id="note2"><font size=
"5">2</font></a></dt>
<dd>The generator described here is available if the feature
<tt class="code">:new-random</tt> is available.</dd>
<dt><a name="note3" href="#text3" id="note3"><font size=
"5">3</font></a></dt>
<dd>``Mersenne Twister: A 623-Dimensionally Equidistributed Uniform
Pseudorandom Number Generator,'' ACM Trans. on Modeling and
Computer Simulation, Vol. 8, No. 1, January 1998, pp.3--30</dd>
<dt><a name="note4" href="#text4" id="note4"><font size=
"5">4</font></a></dt>
<dd>This feature was independently developed, but the interface is
modelled after a similar feature in Allegro. Some names, however,
have been changed.</dd>
</dl>
<!--END NOTES-->
<!--TOC chapter The Debugger-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc79" id="htoc79"><b><font size=
"6">Chapter&nbsp;3</font></b></a></td>
<td width="100%" align="center"><b><font size="6">The
Debugger</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept50"></a> <a name="debugger" id="debugger"></a><br>
<div align="center"><b>by Robert MacLachlan</b></div>
<br>
<!--TOC section Debugger Introduction-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc80" id="htoc80"><b><font size=
"5">3.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Debugger
Introduction</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The CMUCL debugger is unique in its level of support for
source-level debugging of compiled code. Although some other
debuggers allow access of variables by name, this seems to be the
first Common Lisp debugger that:
<ul>
<li>Tells you when a variable doesn't have a value because it
hasn't been initialized yet or has already been deallocated, or<br>
<br></li>
<li>Can display the precise source location corresponding to a code
location in the debugged program.</li>
</ul>
These features allow the debugging of compiled code to be made
almost indistinguishable from interpreted code debugging.<br>
<br>
The debugger is an interactive command loop that allows a user to
examine the function call stack. The debugger is invoked when:
<ul>
<li>A <a name="@types18"></a><tt class=
"code">serious-condition</tt> is signaled, and it is not handled,
or<br>
<br></li>
<li><a name="@funs99"></a><tt class="code">error</tt> is called,
and the condition it signals is not handled, or<br>
<br></li>
<li>The debugger is explicitly invoked with the Common Lisp
<a name="@funs100"></a><tt class="code">break</tt> or <a name=
"@funs101"></a><tt class="code">debug</tt> functions.</li>
</ul>
<i>Note: there are two debugger interfaces in CMUCL: the TTY
debugger (described below) and the Motif debugger. Since the
difference is only in the user interface, much of this chapter also
applies to the Motif version. See section&nbsp;</i><a href=
"#motif-interface"><i>2.9.1</i></a> <i>for a very brief discussion
of the graphical interface.</i><br>
<br>
When you enter the TTY debugger, it looks something like this:
<blockquote class="example">
<pre>
Error in function CAR.
Wrong type argument, 3, should have been of type LIST.

Restarts:
  0: Return to Top-Level.

Debug  (type H for help)

(CAR 3)
0]
</pre></blockquote>
The first group of lines describe what the error was that put us in
the debugger. In this case <tt class="code">car</tt> was called on
<tt class="code">3</tt>. After <tt class="code">Restarts:</tt> is a
list of all the ways that we can restart execution after this
error. In this case, the only option is to return to top-level.
After printing its banner, the debugger prints the current frame
and the debugger prompt.<br>
<br>
<!--TOC section The Command Loop-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc81" id="htoc81"><b><font size=
"5">3.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The Command
Loop</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The debugger is an interactive read-eval-print loop much like the
normal top-level, but some symbols are interpreted as debugger
commands instead of being evaluated. A debugger command starts with
the symbol name of the command, possibly followed by some arguments
on the same line. Some commands prompt for additional input.
Debugger commands can be abbreviated by any unambiguous prefix:
<tt class="code">help</tt> can be typed as <tt class="code">h</tt>,
<tt class="code">he</tt>, etc. For convenience, some commands have
ambiguous one-letter abbreviations: <tt class="code">f</tt> for
<tt class="code">frame</tt>.<br>
<br>
The package is not significant in debugger commands; any symbol
with the name of a debugger command will work. If you want to show
the value of a variable that happens also to be the name of a
debugger command, you can use the <tt class="code">list-locals</tt>
command or the <tt class="code">debug:var</tt> function, or you can
wrap the variable in a <tt class="code">progn</tt> to hide it from
the command loop.<br>
<br>
The debugger prompt is ``<tt class="variable">frame</tt><tt class=
"code">]</tt>'', where <tt class="variable">frame</tt> is the
number of the current frame. Frames are numbered starting from zero
at the top (most recent call), increasing down to the bottom. The
current frame is the frame that commands refer to. The current
frame also provides the lexical environment for evaluation of
non-command forms.<br>
<br>
<a name="@concept51"></a> The debugger evaluates forms in the
lexical environment of the functions being debugged. The debugger
can only access variables. You can't <tt class="code">go</tt> or
<tt class="code">return-from</tt> into a function, and you can't
call local functions. Special variable references are evaluated
with their current value (the innermost binding around the debugger
invocation)---you don't get the value that the special had in the
current frame. See section&nbsp;<a href="#debug-vars">3.4</a> for
more information on debugger variable access.<br>
<br>
<!--TOC section Stack Frames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc82" id="htoc82"><b><font size=
"5">3.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Stack
Frames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept52"></a> <a name="@concept53"></a><br>
A stack frame is the run-time representation of a call to a
function; the frame stores the state that a function needs to
remember what it is doing. Frames have:
<ul>
<li>Variables (see section&nbsp;<a href="#debug-vars">3.4</a>),
which are the values being operated on, and<br>
<br></li>
<li>Arguments to the call (which are really just particularly
interesting variables), and<br>
<br></li>
<li>A current location (see section&nbsp;<a href=
"#source-locations">3.5</a>), which is the place in the program
where the function was running when it stopped to call another
function, or because of an interrupt or error.</li>
</ul>
<!--TOC subsection Stack Motion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc83" id="htoc83"><b><font size=
"4">3.3.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Stack
Motion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These commands move to a new stack frame and print the name of the
function and the values of its arguments in the style of a Lisp
function call:
<dl compact="compact">
<dt><tt class="code">up</tt><br></dt>
<dd>Move up to the next higher frame. More recent function calls
are considered to be higher on the stack.<br>
<br></dd>
<dt><tt class="code">down</tt><br></dt>
<dd>Move down to the next lower frame.<br>
<br></dd>
<dt><tt class="code">top</tt><br></dt>
<dd>Move to the highest frame.<br>
<br></dd>
<dt><tt class="code">bottom</tt><br></dt>
<dd>Move to the lowest frame.<br>
<br></dd>
<dt><tt class="code">frame</tt> [<i>n</i><br></dt>
<dd>] Move to the frame with the specified number. Prompts for the
number if not supplied.</dd>
</dl>
<!--TOC subsection How Arguments are Printed-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc84" id="htoc84"><b><font size=
"4">3.3.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">How Arguments are
Printed</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
A frame is printed to look like a function call, but with the
actual argument values in the argument positions. So the frame for
this call in the source:
<blockquote class="lisp">
<pre>
(myfun (+ 3 4) 'a)
</pre></blockquote>
would look like this:
<blockquote class="example">
<pre>
(MYFUN 7 A)
</pre></blockquote>
All keyword and optional arguments are displayed with their actual
values; if the corresponding argument was not supplied, the value
will be the default. So this call:
<blockquote class="lisp">
<pre>
(subseq "foo" 1)
</pre></blockquote>
would look like this:
<blockquote class="example">
<pre>
(SUBSEQ "foo" 1 3)
</pre></blockquote>
And this call:
<blockquote class="lisp">
<pre>
(string-upcase "test case")
</pre></blockquote>
would look like this:
<blockquote class="example">
<pre>
(STRING-UPCASE "test case" :START 0 :END NIL)
</pre></blockquote>
The arguments to a function call are displayed by accessing the
argument variables. Although those variables are initialized to the
actual argument values, they can be set inside the function; in
this case the new value will be displayed.<br>
<br>
<tt class="code"><tt class="code">&amp;rest</tt></tt> arguments are
handled somewhat differently. The value of the rest argument
variable is displayed as the spread-out arguments to the call, so:
<blockquote class="lisp">
<pre>
(format t "~A is a ~A." "This" 'test)
</pre></blockquote>
would look like this:
<blockquote class="example">
<pre>
(FORMAT T "~A is a ~A." "This" 'TEST)
</pre></blockquote>
Rest arguments cause an exception to the normal display of keyword
arguments in functions that have both <tt class="code"><tt class=
"code">&amp;rest</tt></tt> and <tt class="code">&amp;key</tt>
arguments. In this case, the keyword argument variables are not
displayed at all; the rest arg is displayed instead. So for these
functions, only the keywords actually supplied will be shown, and
the values displayed will be the argument values, not values of the
(possibly modified) variables.<br>
<br>
If the variable for an argument is never referenced by the
function, it will be deleted. The variable value is then
unavailable, so the debugger prints <tt class=
"code">#unused-arg</tt> instead of the value. Similarly, if for any
of a number of reasons (described in more detail in section
<a href="#debug-vars">3.4</a>) the value of the variable is
unavailable or not known to be available, then <tt class=
"code">#unavailable-arg</tt> will be printed instead of the
argument value.<br>
<br>
Printing of argument values is controlled by <tt class=
"code">*debug-print-level*</tt> and <a name=
"@vars25"></a><tt class="code">*debug-print-length*</tt>.<br>
<br>
<!--TOC subsection Function Names-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc85" id="htoc85"><b><font size=
"4">3.3.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Function
Names</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept54"></a> <a name="@concept55"></a><br>
If a function is defined by <tt class="code">defun</tt>, <tt class=
"code">labels</tt>, or <tt class="code">flet</tt>, then the
debugger will print the actual function name after the open
parenthesis, like:
<blockquote class="example">
<pre>
(STRING-UPCASE "test case" :START 0 :END NIL)
((SETF AREF) #\a "for" 1)
</pre></blockquote>
Otherwise, the function name is a string, and will be printed in
quotes:
<blockquote class="example">
<pre>
("DEFUN MYFUN" BAR)
("DEFMACRO DO" (DO ((I 0 (1+ I))) ((= I 13))) NIL)
("SETQ *GC-NOTIFY-BEFORE*")
</pre></blockquote>
This string name is derived from the <tt class=
"code">def</tt><tt class="variable">mumble</tt> form that encloses
or expanded into the lambda, or the outermost enclosing form if
there is no <tt class="code">def</tt><tt class=
"variable">mumble</tt>.<br>
<br>
<!--TOC subsection Funny Frames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc86" id="htoc86"><b><font size=
"4">3.3.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Funny
Frames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept56"></a> <a name="@concept57"></a> <a name=
"@concept58"></a> <a name="@concept59"></a> <a name=
"@concept60"></a> <a name="@concept61"></a><br>
Sometimes the evaluator introduces new functions that are used to
implement a user function, but are not directly specified in the
source. The main place this is done is for checking argument type
and syntax. Usually these functions do their thing and then go
away, and thus are not seen on the stack in the debugger. But when
you get some sort of error during lambda-list processing, you end
up in the debugger on one of these funny frames.<br>
<br>
These funny frames are flagged by printing ``<tt class=
"code">[</tt><tt class="variable">keyword</tt><tt class=
"code">]</tt>'' after the parentheses. For example, this call:
<blockquote class="lisp">
<pre>
(car 'a 'b)
</pre></blockquote>
will look like this:
<blockquote class="example">
<pre>
(CAR 2 A) [:EXTERNAL]
</pre></blockquote>
And this call:
<blockquote class="lisp">
<pre>
(string-upcase "test case" :end)
</pre></blockquote>
would look like this:
<blockquote class="example">
<pre>
("DEFUN STRING-UPCASE" "test case" 335544424 1) [:OPTIONAL]
</pre></blockquote>
As you can see, these frames have only a vague resemblance to the
original call. Fortunately, the error message displayed when you
enter the debugger will usually tell you what problem is (in these
cases, too many arguments and odd keyword arguments.) Also, if you
go down the stack to the frame for the calling function, you can
display the original source (see section&nbsp;<a href=
"#source-locations">3.5</a>.)<br>
<br>
With recursive or block compiled functions (see
section&nbsp;<a href="#block-compilation">5.7</a>), an <tt class=
"code">:EXTERNAL</tt> frame may appear before the frame
representing the first call to the recursive function or entry to
the compiled block. This is a consequence of the way the compiler
does block compilation: there is nothing odd with your program. You
will also see <tt class="code">:CLEANUP</tt> frames during the
execution of <tt class="code">unwind-protect</tt> cleanup code.
Note that inline expansion and open-coding affect what frames are
present in the debugger, see sections <a href=
"#debugger-policy">3.6</a> and <a href="#open-coding">4.8</a>.<br>
<br>
<!--TOC subsection Debug Tail Recursion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc87" id="htoc87"><b><font size=
"4">3.3.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Debug Tail
Recursion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="debug-tail-recursion" id="debug-tail-recursion"></a>
<a name="@concept62"></a> <a name="@concept63"></a><br>
Both the compiler and the interpreter are ``properly tail
recursive.'' If a function call is in a tail-recursive position,
the stack frame will be deallocated <em>at the time of the
call</em>, rather than after the call returns. Consider this
backtrace:
<blockquote class="example">
<pre>
(BAR ...) 
(FOO ...)
</pre></blockquote>
Because of tail recursion, it is not necessarily the case that
<tt class="code">FOO</tt> directly called <tt class=
"code">BAR</tt>. It may be that <tt class="code">FOO</tt> called
some other function <tt class="code">FOO2</tt> which then called
<tt class="code">BAR</tt> tail-recursively, as in this example:
<blockquote class="example">
<pre>
(defun foo ()
  ...
  (foo2 ...)
  ...)

(defun foo2 (...)
  ...
  (bar ...))

(defun bar (...)
  ...)
</pre></blockquote>
Usually the elimination of tail-recursive frames makes debugging
more pleasant, since theses frames are mostly uninformative. If
there is any doubt about how one function called another, it can
usually be eliminated by finding the source location in the calling
frame (section <a href="#source-locations">3.5</a>.)<br>
<br>
The elimination of tail-recursive frames can be prevented by
disabling tail-recursion optimization, which happens when the
<tt class="code">debug</tt> optimization quality is greater than
<tt class="code">2</tt> (see section&nbsp;<a href=
"#debugger-policy">3.6</a>.)<br>
<br>
For a more thorough discussion of tail recursion, see
section&nbsp;<a href="#tail-recursion">5.5</a>.<br>
<br>
<!--TOC subsection Unknown Locations and Interrupts-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc88" id="htoc88"><b><font size=
"4">3.3.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Unknown Locations
and Interrupts</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="unknown-locations" id="unknown-locations"></a> <a name=
"@concept64"></a> <a name="@concept65"></a> <a name=
"@concept66"></a> <a name="@concept67"></a><br>
The debugger operates using special debugging information attached
to the compiled code. This debug information tells the debugger
what it needs to know about the locations in the code where the
debugger can be invoked. If the debugger somehow encounters a
location not described in the debug information, then it is said to
be <tt class="variable">unknown</tt>. If the code location for a
frame is unknown, then some variables may be inaccessible, and the
source location cannot be precisely displayed.<br>
<br>
There are three reasons why a code location could be unknown:
<ul>
<li>There is inadequate debug information due to the value of the
<tt class="code">debug</tt> optimization quality. See
section&nbsp;<a href="#debugger-policy">3.6</a>.<br>
<br></li>
<li>The debugger was entered because of an interrupt such as
<tt class="code"><i>C</i></tt>.<br>
<br></li>
<li>A hardware error such as ``<tt class="code">bus error</tt>''
occurred in code that was compiled unsafely due to the value of the
<tt class="code">safety</tt> optimization quality. See
section&nbsp;<a href="#optimize-declaration">4.7.1</a>.</li>
</ul>
In the last two cases, the values of argument variables are
accessible, but may be incorrect. See section&nbsp;<a href=
"#debug-var-validity">3.4.1</a> for more details on when variable
values are accessible.<br>
<br>
It is possible for an interrupt to happen when a function call or
return is in progress. The debugger may then flame out with some
obscure error or insist that the bottom of the stack has been
reached, when the real problem is that the current stack frame
can't be located. If this happens, return from the interrupt and
try again.<br>
<br>
When running interpreted code, all locations should be known.
However, an interrupt might catch some subfunction of the
interpreter at an unknown location. In this case, you should be
able to go up the stack a frame or two and reach an interpreted
frame which can be debugged.<br>
<br>
<!--TOC section Variable Access-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc89" id="htoc89"><b><font size=
"5">3.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Variable
Access</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="debug-vars" id="debug-vars"></a> <a name="@concept68"></a>
<a name="@concept69"></a><br>
There are three ways to access the current frame's local variables
in the debugger. The simplest is to type the variable's name into
the debugger's read-eval-print loop. The debugger will evaluate the
variable reference as though it had appeared inside that frame.<br>
<br>
The debugger doesn't really understand lexical scoping; it has just
one namespace for all the variables in a function. If a symbol is
the name of multiple variables in the same function, then the
reference appears ambiguous, even though lexical scoping specifies
which value is visible at any given source location. If the scopes
of the two variables are not nested, then the debugger can resolve
the ambiguity by observing that only one variable is
accessible.<br>
<br>
When there are ambiguous variables, the evaluator assigns each one
a small integer identifier. The <tt class="code">debug:var</tt>
function and the <tt class="code">list-locals</tt> command use this
identifier to distinguish between ambiguous variables:
<dl compact="compact">
<dt><tt class="code">list-locals</tt> <tt class="code">{<tt class=
"variable">prefix</tt>}</tt><br></dt>
<dd>This command prints the name and value of all variables in the
current frame whose name has the specified <tt class=
"variable">prefix</tt>. <tt class="variable">prefix</tt> may be a
string or a symbol. If no <tt class="variable">prefix</tt> is
given, then all available variables are printed. If a variable has
a potentially ambiguous name, then the name is printed with a
``<tt class="code">#</tt><tt class="variable">identifier</tt>''
suffix, where <tt class="variable">identifier</tt> is the small
integer used to make the name unique.</dd>
</dl>
<br>
<a name="@funs102"></a><a name="FN:var" id="FN:var"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug:</tt><tt class=
"function-name">var</tt> <tt class="variable">name</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">identifier</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the value of the variable in the current
frame with the specified <tt class="variable">name</tt>. If
supplied, <tt class="variable">identifier</tt> determines which
value to return when there are ambiguous variables.<br>
<br>
When <tt class="variable">name</tt> is a symbol, it is interpreted
as the symbol name of the variable, i.e. the package is
significant. If <tt class="variable">name</tt> is an uninterned
symbol (gensym), then return the value of the uninterned variable
with the same name. If <tt class="variable">name</tt> is a string,
<tt class="code">debug:var</tt> interprets it as the prefix of a
variable name, and must unambiguously complete to the name of a
valid variable.<br>
<br>
This function is useful mainly for accessing the value of
uninterned or ambiguous variables, since most variables can be
evaluated directly.</blockquote>
<!--TOC subsection Variable Value Availability-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc90" id="htoc90"><b><font size=
"4">3.4.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Variable Value
Availability</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="debug-var-validity" id="debug-var-validity"></a> <a name=
"@concept70"></a> <a name="@concept71"></a> <a name=
"@concept72"></a><br>
The value of a variable may be unavailable to the debugger in
portions of the program where Common Lisp says that the variable is
defined. If a variable value is not available, the debugger will
not let you read or write that variable. With one exception, the
debugger will never display an incorrect value for a variable.
Rather than displaying incorrect values, the debugger tells you the
value is unavailable.<br>
<br>
The one exception is this: if you interrupt (e.g., with <tt class=
"code"><i>C</i></tt>) or if there is an unexpected hardware error
such as ``<tt class="code">bus error</tt>'' (which should only
happen in unsafe code), then the values displayed for arguments to
the interrupted frame might be incorrect.<sup><a name="text5" href=
"#note5" id="text5"><font size="2">1</font></a></sup> This
exception applies only to the interrupted frame: any frame farther
down the stack will be fine.<br>
<br>
The value of a variable may be unavailable for these reasons:
<ul>
<li>The value of the <tt class="code">debug</tt> optimization
quality may have omitted debug information needed to determine
whether the variable is available. Unless a variable is an
argument, its value will only be available when <tt class=
"code">debug</tt> is at least <tt class="code">2</tt>.<br>
<br></li>
<li>The compiler did lifetime analysis and determined that the
value was no longer needed, even though its scope had not been
exited. Lifetime analysis is inhibited when the <tt class=
"code">debug</tt> optimization quality is <tt class=
"code">3</tt>.<br>
<br></li>
<li>The variable's name is an uninterned symbol (gensym). To save
space, the compiler only dumps debug information about uninterned
variables when the <tt class="code">debug</tt> optimization quality
is <tt class="code">3</tt>.<br>
<br></li>
<li>The frame's location is unknown (see section&nbsp;<a href=
"#unknown-locations">3.3.6</a>) because the debugger was entered
due to an interrupt or unexpected hardware error. Under these
conditions the values of arguments will be available, but might be
incorrect. This is the exception above.<br>
<br></li>
<li>The variable was optimized out of existence. Variables with no
reads are always optimized away, even in the interpreter. The
degree to which the compiler deletes variables will depend on the
value of the <tt class="code">compile-speed</tt> optimization
quality, but most source-level optimizations are done under all
compilation policies.</li>
</ul>
Since it is especially useful to be able to get the arguments to a
function, argument variables are treated specially when the
<tt class="code">speed</tt> optimization quality is less than
<tt class="code">3</tt> and the <tt class="code">debug</tt> quality
is at least <tt class="code">1</tt>. With this compilation policy,
the values of argument variables are almost always available
everywhere in the function, even at unknown locations. For
non-argument variables, <tt class="code">debug</tt> must be at
least <tt class="code">2</tt> for values to be available, and even
then, values are only available at known locations.<br>
<br>
<!--TOC subsection Note On Lexical Variable Access-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc91" id="htoc91"><b><font size=
"4">3.4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Note On Lexical
Variable Access</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept73"></a><br>
When the debugger command loop establishes variable bindings for
available variables, these variable bindings have lexical scope and
dynamic extent.<sup><a name="text6" href="#note6" id=
"text6"><font size="2">2</font></a></sup> You can close over them,
but such closures can't be used as upward funargs.<br>
<br>
You can also set local variables using <tt class="code">setq</tt>,
but if the variable was closed over in the original source and
never set, then setting the variable in the debugger may not change
the value in all the functions the variable is defined in. Another
risk of setting variables is that you may assign a value of a type
that the compiler proved the variable could never take on. This may
result in bad things happening.<br>
<br>
<!--TOC section Source Location Printing-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc92" id="htoc92"><b><font size=
"5">3.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Source Location
Printing</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="source-locations" id="source-locations"></a> <a name=
"@concept74"></a><br>
One of CMUCL's unique capabilities is source level debugging of
compiled code. These commands display the source location for the
current frame:
<dl compact="compact">
<dt><tt class="code">source</tt> <tt class="code">{<tt class=
"variable">context</tt>}</tt><br></dt>
<dd>This command displays the file that the current frame's
function was defined from (if it was defined from a file), and then
the source form responsible for generating the code that the
current frame was executing. If <tt class="variable">context</tt>
is specified, then it is an integer specifying the number of
enclosing levels of list structure to print.<br>
<br></dd>
<dt><tt class="code">vsource</tt> <tt class="code">{<tt class=
"variable">context</tt>}</tt><br></dt>
<dd>This command is identical to <tt class="code">source</tt>,
except that it uses the global values of <tt class=
"code">*print-level*</tt> and <tt class="code">*print-length*</tt>
instead of the debugger printing control variables <tt class=
"code">*debug-print-level*</tt> and <tt class=
"code">*debug-print-length*</tt>.</dd>
</dl>
The source form for a location in the code is the innermost list
present in the original source that encloses the form responsible
for generating that code. If the actual source form is not a list,
then some enclosing list will be printed. For example, if the
source form was a reference to the variable <tt class=
"code">*some-random-special*</tt>, then the innermost enclosing
evaluated form will be printed. Here are some possible enclosing
forms:
<blockquote class="example">
<pre>
(let ((a *some-random-special*))
  ...)

(+ *some-random-special* ...)
</pre></blockquote>
If the code at a location was generated from the expansion of a
macro or a source-level compiler optimization, then the form in the
original source that expanded into that code will be printed.
Suppose the file <tt class="filename">/usr/me/mystuff.lisp</tt>
looked like this:
<blockquote class="example">
<pre>
(defmacro mymac ()
  '(myfun))

(defun foo ()
  (mymac)
  ...)
</pre></blockquote>
If <tt class="code">foo</tt> has called <tt class=
"code">myfun</tt>, and is waiting for it to return, then the
<tt class="code">source</tt> command would print:
<blockquote class="example">
<pre>
; File: /usr/me/mystuff.lisp

(MYMAC)
</pre></blockquote>
Note that the macro use was printed, not the actual function call
form, <tt class="code">(myfun)</tt>.<br>
<br>
If enclosing source is printed by giving an argument to <tt class=
"code">source</tt> or <tt class="code">vsource</tt>, then the
actual source form is marked by wrapping it in a list whose first
element is <tt class="code">#:***HERE***</tt>. In the previous
example, <tt class="code">source 1</tt> would print:
<blockquote class="example">
<pre>
; File: /usr/me/mystuff.lisp

(DEFUN FOO ()
  (#:***HERE***
   (MYMAC))
  ...)
</pre></blockquote>
<!--TOC subsection How the Source is Found-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc93" id="htoc93"><b><font size=
"4">3.5.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">How the Source is
Found</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
If the code was defined from Common Lisp by <tt class=
"code">compile</tt> or <tt class="code">eval</tt>, then the source
can always be reliably located. If the code was defined from a
<tt class="code">fasl</tt> file created by <a name=
"@funs103"></a><tt class="code">compile-file</tt>, then the
debugger gets the source forms it prints by reading them from the
original source file. This is a potential problem, since the source
file might have moved or changed since the time it was
compiled.<br>
<br>
The source file is opened using the <tt class="code">truename</tt>
of the source file pathname originally given to the compiler. This
is an absolute pathname with all logical names and symbolic links
expanded. If the file can't be located using this name, then the
debugger gives up and signals an error.<br>
<br>
If the source file can be found, but has been modified since the
time it was compiled, the debugger prints this warning:
<blockquote class="example">
<pre>
; File has been modified since compilation:
;   <tt class="variable">filename</tt>
; Using form offset instead of character position.
</pre></blockquote>
where <tt class="variable">filename</tt> is the name of the source
file. It then proceeds using a robust but not foolproof heuristic
for locating the source. This heuristic works if:
<ul>
<li>No top-level forms before the top-level form containing the
source have been added or deleted, and<br>
<br></li>
<li>The top-level form containing the source has not been modified
much. (More precisely, none of the list forms beginning before the
source form have been added or deleted.)</li>
</ul>
If the heuristic doesn't work, the displayed source will be wrong,
but will probably be near the actual source. If the ``shape'' of
the top-level form in the source file is too different from the
original form, then an error will be signaled. When the heuristic
is used, the the source location commands are noticeably
slowed.<br>
<br>
Source location printing can also be confused if (after the source
was compiled) a read-macro you used in the code was redefined to
expand into something different, or if a read-macro ever returns
the same <tt class="code">eq</tt> list twice. If you don't define
read macros and don't use <tt class="code">##</tt> in perverted
ways, you don't need to worry about this.<br>
<br>
<!--TOC subsection Source Location Availability-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc94" id="htoc94"><b><font size=
"4">3.5.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Source Location
Availability</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<a name="@concept75"></a> Source location information is only
available when the <tt class="code">debug</tt> optimization quality
is at least <tt class="code">2</tt>. If source location information
is unavailable, the source commands will give an error message.<br>
<br>
If source location information is available, but the source
location is unknown because of an interrupt or unexpected hardware
error (see section&nbsp;<a href="#unknown-locations">3.3.6</a>),
then the command will print:
<blockquote class="example">
<pre>
Unknown location: using block start.
</pre></blockquote>
and then proceed to print the source location for the start of the
<em>basic block</em> enclosing the code location. <a name=
"@concept76"></a> <a name="@concept77"></a> It's a bit complicated
to explain exactly what a basic block is, but here are some
properties of the block start location:
<ul>
<li>The block start location may be the same as the true
location.<br>
<br></li>
<li>The block start location will never be later in the the
program's flow of control than the true location.<br>
<br></li>
<li>No conditional control structures (such as <tt class=
"code">if</tt>, <tt class="code">cond</tt>, <tt class=
"code">or</tt>) will intervene between the block start and the true
location (but note that some conditionals present in the original
source could be optimized away.) Function calls <em>do not</em> end
basic blocks.<br>
<br></li>
<li>The head of a loop will be the start of a block.<br>
<br></li>
<li>The programming language concept of ``block structure'' and the
Common Lisp <tt class="code">block</tt> special form are totally
unrelated to the compiler's basic block.</li>
</ul>
In other words, the true location lies between the printed location
and the next conditional (but watch out because the compiler may
have changed the program on you.)<br>
<br>
<!--TOC section Compiler Policy Control-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc95" id="htoc95"><b><font size=
"5">3.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Compiler Policy
Control</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="debugger-policy" id="debugger-policy"></a> <a name=
"@concept78"></a> <a name="@concept79"></a> <a name=
"@concept80"></a><br>
The compilation policy specified by <tt class="code">optimize</tt>
declarations affects the behavior seen in the debugger. The
<tt class="code">debug</tt> quality directly affects the debugger
by controlling the amount of debugger information dumped. Other
optimization qualities have indirect but observable effects due to
changes in the way compilation is done.<br>
<br>
Unlike the other optimization qualities (which are compared in
relative value to evaluate tradeoffs), the <tt class=
"code">debug</tt> optimization quality is directly translated to a
level of debug information. This absolute interpretation allows the
user to count on a particular amount of debug information being
available even when the values of the other qualities are changed
during compilation. These are the levels of debug information that
correspond to the values of the <tt class="code">debug</tt>
quality:
<dl compact="compact">
<dt><tt class="code">0</tt><br></dt>
<dd>Only the function name and enough information to allow the
stack to be parsed.<br>
<br></dd>
<dt><tt class="code">&gt; 0</tt><br></dt>
<dd>Any level greater than <tt class="code">0</tt> gives level
<tt class="code">0</tt> plus all argument variables. Values will
only be accessible if the argument variable is never set and
<tt class="code">speed</tt> is not <tt class="code">3</tt>. CMUCL
allows any real value for optimization qualities. It may be useful
to specify <tt class="code">0.5</tt> to get backtrace argument
display without argument documentation.<br>
<br></dd>
<dt><tt class="code">1</tt><br></dt>
<dd>Level <tt class="code">1</tt> provides argument documentation
(printed arglists) and derived argument/result type information.
This makes <a name="@funs104"></a><tt class="code">describe</tt>
more informative, and allows the compiler to do compile-time
argument count and type checking for any calls compiled at
run-time.<br>
<br></dd>
<dt><tt class="code">2</tt><br></dt>
<dd>Level <tt class="code">1</tt> plus all interned local
variables, source location information, and lifetime information
that tells the debugger when arguments are available (even when
<tt class="code">speed</tt> is <tt class="code">3</tt> or the
argument is set.) This is the default.<br>
<br></dd>
<dt><tt class="code">&gt; 2</tt><br></dt>
<dd>Any level greater than <tt class="code">2</tt> gives level
<tt class="code">2</tt> and in addition disables tail-call
optimization, so that the backtrace will contain frames for all
invoked functions, even those in tail positions.<br>
<br></dd>
<dt><tt class="code">3</tt><br></dt>
<dd>Level <tt class="code">2</tt> plus all uninterned variables. In
addition, lifetime analysis is disabled (even when <tt class=
"code">speed</tt> is <tt class="code">3</tt>), ensuring that all
variable values are available at any known location within the
scope of the binding. This has a speed penalty in addition to the
obvious space penalty.</dd>
</dl>
As you can see, if the <tt class="code">speed</tt> quality is
<tt class="code">3</tt>, debugger performance is degraded. This
effect comes from the elimination of argument variable
special-casing (see section&nbsp;<a href=
"#debug-var-validity">3.4.1</a>.) Some degree of
speed/debuggability tradeoff is unavoidable, but the effect is not
too drastic when <tt class="code">debug</tt> is at least <tt class=
"code">2</tt>.<br>
<br>
<a name="@concept81"></a> <a name="@concept82"></a> In addition to
<tt class="code">inline</tt> and <tt class="code">notinline</tt>
declarations, the relative values of the <tt class=
"code">speed</tt> and <tt class="code">space</tt> qualities also
change whether functions are inline expanded (see
section&nbsp;<a href="#inline-expansion">5.8</a>.) If a function is
inline expanded, then there will be no frame to represent the call,
and the arguments will be treated like any other local variable.
Functions may also be ``semi-inline'', in which case there is a
frame to represent the call, but the call is to an optimized local
version of the function, not to the original function.<br>
<br>
<!--TOC section Exiting Commands-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc96" id="htoc96"><b><font size=
"5">3.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Exiting
Commands</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These commands get you out of the debugger.<br>
<br>
<dl compact="compact">
<dt><tt class="code">quit</tt><br></dt>
<dd>Throw to top level.<br>
<br></dd>
<dt><tt class="code">restart</tt> <tt class="code">{<tt class=
"variable">n</tt>}</tt><br></dt>
<dd>Invokes the <tt class="variable">n</tt>th restart case as
displayed by the <tt class="code">error</tt> command. If <tt class=
"variable">n</tt> is not specified, the available restart cases are
reported.<br>
<br></dd>
<dt><tt class="code">go</tt><br></dt>
<dd>Calls <tt class="code">continue</tt> on the condition given to
<tt class="code">debug</tt>. If there is no restart case named
<tt class="variable">continue</tt>, then an error is signaled.<br>
<br></dd>
<dt><tt class="code">abort</tt><br></dt>
<dd>Calls <tt class="code">abort</tt> on the condition given to
<tt class="code">debug</tt>. This is useful for popping debug
command loop levels or aborting to top level, as the case may
be.</dd>
</dl>
<!--TOC section Information Commands-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc97" id="htoc97"><b><font size=
"5">3.8</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Information
Commands</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Most of these commands print information about the current frame or
function, but a few show general information.<br>
<br>
<dl compact="compact">
<dt><tt class="code">help</tt>, <tt class="code">?</tt><br></dt>
<dd>Displays a synopsis of debugger commands.<br>
<br></dd>
<dt><tt class="code">describe</tt><br></dt>
<dd>Calls <tt class="code">describe</tt> on the current function,
displays number of local variables, and indicates whether the
function is compiled or interpreted.<br>
<br></dd>
<dt><tt class="code">print</tt><br></dt>
<dd>Displays the current function call as it would be displayed by
moving to this frame.<br>
<br></dd>
<dt><tt class="code">vprint</tt> (or <tt class="code">pp</tt>)
<tt class="code">{<tt class=
"variable">verbosity</tt>}</tt><br></dt>
<dd>Displays the current function call using <tt class=
"code">*print-level*</tt> and <tt class="code">*print-length*</tt>
instead of <tt class="code">*debug-print-level*</tt> and <tt class=
"code">*debug-print-length*</tt>. <tt class=
"variable">verbosity</tt> is a small integer (default 2) that
controls other dimensions of verbosity.<br>
<br></dd>
<dt><tt class="code">error</tt><br></dt>
<dd>Prints the condition given to <tt class=
"code">invoke-debugger</tt> and the active proceed cases.<br>
<br></dd>
<dt><tt class="code">backtrace</tt> <tt class="code">{<tt class=
"variable">n</tt>}</tt><br></dt>
<dd><br>
Displays all the frames from the current to the bottom. Only shows
<tt class="variable">n</tt> frames if specified. The printing is
controlled by <tt class="code">*debug-print-level*</tt> and
<tt class="code">*debug-print-length*</tt>.</dd>
</dl>
<!--TOC section Breakpoint Commands-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc98" id="htoc98"><b><font size=
"5">3.9</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Breakpoint
Commands</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept83"></a><br>
CMUCL supports setting of breakpoints inside compiled functions and
stepping of compiled code. Breakpoints can only be set at at known
locations (see section&nbsp;<a href=
"#unknown-locations">3.3.6</a>), so these commands are largely
useless unless the <tt class="code">debug</tt> optimize quality is
at least <tt class="code">2</tt> (see section&nbsp;<a href=
"#debugger-policy">3.6</a>). These commands manipulate breakpoints:
<dl compact="compact">
<dt><tt class="code">breakpoint</tt> <tt class=
"variable">location</tt> <tt class="code">{<tt class=
"variable">option</tt> <tt class=
"variable">value</tt>}</tt><sup><font size=
"2">*</font></sup><br></dt>
<dd>Set a breakpoint in some function. <tt class=
"variable">location</tt> may be an integer code location number (as
displayed by <tt class="code">list-locations</tt>) or a keyword.
The keyword can be used to indicate setting a breakpoint at the
function start (<tt class="code">:start</tt>, <tt class=
"code">:s</tt>) or function end (<tt class="code">:end</tt>,
<tt class="code">:e</tt>). The <tt class="code">breakpoint</tt>
command has <tt class="code">:condition</tt>, <tt class=
"code">:break</tt>, <tt class="code">:print</tt> and <tt class=
"code">:function</tt> options which work similarly to the
<tt class="code">trace</tt> options.<br>
<br></dd>
<dt><tt class="code">list-locations</tt> (or <tt class=
"code">ll</tt>) <tt class="code">{<tt class=
"variable">function</tt>}</tt><br></dt>
<dd>List all the code locations in the current frame's function, or
in <tt class="variable">function</tt> if it is supplied. The
display format is the code location number, a colon and then the
source form for that location:
<blockquote class="example">
<pre>
3: (1- N)
</pre></blockquote>
If consecutive locations have the same source, then a numeric range
like <tt class="code">3-5:</tt> will be printed. For example, a
default function call has a known location both immediately before
and after the call, which would result in two code locations with
the same source. The listed function becomes the new default
function for breakpoint setting (via the <tt class=
"code">breakpoint</tt>) command.<br>
<br></dd>
<dt><tt class="code">list-breakpoints</tt> (or <tt class=
"code">lb</tt>)<br></dt>
<dd>List all currently active breakpoints with their breakpoint
number.<br>
<br></dd>
<dt><tt class="code">delete-breakpoint</tt> (or <tt class=
"code">db</tt>) <tt class="code">{<tt class=
"variable">number</tt>}</tt><br></dt>
<dd>Delete a breakpoint specified by its breakpoint number. If no
number is specified, delete all breakpoints.<br>
<br></dd>
<dt><tt class="code">step</tt><br></dt>
<dd>Step to the next possible breakpoint location in the current
function. This always steps over function calls, instead of
stepping into them</dd>
</dl>
<!--TOC subsection Breakpoint Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc99" id="htoc99"><b><font size=
"4">3.9.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Breakpoint
Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Consider this definition of the factorial function:
<blockquote class="lisp">
<pre>
(defun ! (n)
  (if (zerop n)
      1
      (* n (! (1- n)))))
</pre></blockquote>
This debugger session demonstrates the use of breakpoints:
<blockquote class="example">
<pre>
common-lisp-user&gt; (break) ; Invoke debugger

Break

Restarts:
  0: [CONTINUE] Return from BREAK.
  1: [ABORT   ] Return to Top-Level.

Debug  (type H for help)

(INTERACTIVE-EVAL (BREAK))
0] ll #'!
0: #'(LAMBDA (N) (BLOCK ! (IF # 1 #)))
1: (ZEROP N)
2: (* N (! (1- N)))
3: (1- N)
4: (! (1- N))
5: (* N (! (1- N)))
6: #'(LAMBDA (N) (BLOCK ! (IF # 1 #)))
0] br 2
(* N (! (1- N)))
1: 2 in !
Added.
0] q

common-lisp-user&gt; (! 10) ; Call the function

*Breakpoint hit*

Restarts:
  0: [CONTINUE] Return from BREAK.
  1: [ABORT   ] Return to Top-Level.

Debug  (type H for help)

(! 10) ; We are now in first call (arg 10) before the multiply
Source: (* N (! (1- N)))
3] st

*Step*

(! 10) ; We have finished evaluation of (1- n)
Source: (1- N)
3] st

*Breakpoint hit*

Restarts:
  0: [CONTINUE] Return from BREAK.
  1: [ABORT   ] Return to Top-Level.

Debug  (type H for help)

(! 9) ; We hit the breakpoint in the recursive call
Source: (* N (! (1- N)))
3] 
</pre></blockquote>
<!--TOC section Function Tracing-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc100" id="htoc100"><b><font size=
"5">3.10</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Function
Tracing</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept84"></a> <a name="@concept85"></a><br>
The tracer causes selected functions to print their arguments and
their results whenever they are called. Options allow conditional
printing of the trace information and conditional breakpoints on
function entry or exit.<br>
<br>
<br>
<a name="@funs105"></a><a name="FN:trace" id="FN:trace"></a>
<div align="left">[Macro]<br>
<tt class="function-name">trace</tt> <tt class="code">{option
global-value}</tt><sup><font size="2">*</font></sup> <tt class=
"code">{name <tt class="code">{option value}</tt><sup><font size=
"2">*</font></sup>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">trace</tt> is a debugging tool that prints
information when specified functions are called. In its simplest
form:
<blockquote class="example">
<pre>
    (trace <tt class="variable">name-1</tt> <tt class=
"variable">name-2</tt> ...)
  
</pre></blockquote>
<tt class="code">trace</tt> causes a printout on <a name=
"@vars26"></a><tt class="code">*trace-output*</tt> each time that
one of the named functions is entered or returns (the <tt class=
"variable">names</tt> are not evaluated.) Trace output is indented
according to the number of pending traced calls, and this trace
depth is printed at the beginning of each line of output. Printing
verbosity of arguments and return values is controlled by <a name=
"@vars27"></a><tt class="code">*debug-print-level*</tt> and
<a name="@vars28"></a><tt class=
"code">*debug-print-length*</tt>.<br>
<br>
Local functions defined by <tt class="code">flet</tt> and
<tt class="code">labels</tt> can be traced using the syntax
<tt class="code">(flet f f1 f2 ...)</tt> or <tt class=
"code">(labels f f1 f2 ...)</tt> where <tt class="code">f</tt> is
the <tt class="code">flet</tt> or <tt class="code">labels</tt>
function we want to trace and <tt class="code">f1</tt>, <tt class=
"code">f2</tt>, are the functions containing the local function
<tt class="code">f</tt>. Invidiual methods can also be traced using
the syntax <tt class="code">(method <tt class="variable">name</tt>
<tt class="variable">qualifiers</tt> <tt class=
"variable">specializers</tt>)</tt>. See&nbsp;<a href=
"#sec:method-tracing">2.23.7</a> for more information.<br>
<br>
If no <tt class="variable">names</tt> or <tt class=
"variable">options</tt> are are given, <tt class="code">trace</tt>
returns the list of all currently traced functions, <tt class=
"code">*traced-function-list*</tt>.<br>
<br>
Trace options can cause the normal printout to be suppressed, or
cause extra information to be printed. Each option is a pair of an
option keyword and a value form. Options may be interspersed with
function names. Options only affect tracing of the function whose
name they appear immediately after. Global options are specified
before the first name, and affect all functions traced by a given
use of <tt class="code">trace</tt>. If an already traced function
is traced again, any new options replace the old options. The
following options are defined:
<dl compact="compact">
<dt><tt class="code">:condition</tt> <tt class=
"variable">form</tt>, <tt class="code">:condition-after</tt>
<tt class="variable">form</tt>, <tt class=
"code">:condition-all</tt> <tt class="variable">form</tt><br></dt>
<dd>If <tt class="code">:condition</tt> is specified, then
<tt class="code">trace</tt> does nothing unless <tt class=
"variable">form</tt> evaluates to true at the time of the call.
<tt class="code">:condition-after</tt> is similar, but suppresses
the initial printout, and is tested when the function returns.
<tt class="code">:condition-all</tt> tries both before and
after.<br>
<br></dd>
<dt><tt class="code">:wherein</tt> <tt class=
"variable">names</tt><br></dt>
<dd>If specified, <tt class="variable">names</tt> is a function
name or list of names. <tt class="code">trace</tt> does nothing
unless a call to one of those functions encloses the call to this
function (i.e. it would appear in a backtrace.) Anonymous functions
have string names like <tt class="code">"DEFUN FOO"</tt>.
Individual methods can also be traced. See section&nbsp;<a href=
"#sec:method-tracing">2.23.7</a>.<br>
<br></dd>
<dt><tt class="code">:wherein-only</tt> <tt class=
"variable">names</tt><br></dt>
<dd>If specified, this is just like <tt class="code">:wherein</tt>,
but trace produces output only if the immediate caller of the
traced function is one of the functions listed in <tt class=
"variable">names</tt>.<br>
<br></dd>
<dt><tt class="code">:break</tt> <tt class="variable">form</tt>,
<tt class="code">:break-after</tt> <tt class="variable">form</tt>,
<tt class="code">:break-all</tt> <tt class=
"variable">form</tt><br></dt>
<dd>If specified, and <tt class="variable">form</tt> evaluates to
true, then the debugger is invoked at the start of the function, at
the end of the function, or both, according to the respective
option.<br>
<br></dd>
<dt><tt class="code">:print</tt> <tt class="variable">form</tt>,
<tt class="code">:print-after</tt> <tt class="variable">form</tt>,
<tt class="code">:print-all</tt> <tt class=
"variable">form</tt><br></dt>
<dd>In addition to the usual printout, the result of evaluating
<tt class="variable">form</tt> is printed at the start of the
function, at the end of the function, or both, according to the
respective option. Multiple print options cause multiple values to
be printed.<br>
<br></dd>
<dt><tt class="code">:function</tt> <tt class=
"variable">function-form</tt><br></dt>
<dd>This is a not really an option, but rather another way of
specifying what function to trace. The <tt class=
"variable">function-form</tt> is evaluated immediately, and the
resulting function is traced.<br>
<br></dd>
<dt><tt class="code">:encapsulate <tt class="code">{:default | t |
nil}</tt></tt><br></dt>
<dd>In CMUCL, tracing can be done either by temporarily redefining
the function name (encapsulation), or using breakpoints. When
breakpoints are used, the function object itself is destructively
modified to cause the tracing action. The advantage of using
breakpoints is that tracing works even when the function is
anonymously called via <tt class="code">funcall</tt>.<br>
<br>
When <tt class="code">:encapsulate</tt> is true, tracing is done
via encapsulation. <tt class="code">:default</tt> is the default,
and means to use encapsulation for interpreted functions and
funcallable instances, breakpoints otherwise. When encapsulation is
used, forms are <i>not</i> evaluated in the function's lexical
environment, but <tt class="code">debug:arg</tt> can still be
used.<br>
<br>
Note that if you trace using <tt class="code">:encapsulate</tt>,
you will only get a trace or breakpoint at the outermost call to
the traced function, not on recursive calls.</dd>
</dl>
In the case of functions where the known return convention is used
to optimize, encapsulation may be necessary in order to make
tracing work at all. The symptom of this occurring is an error
stating
<blockquote class="example">
<pre>
    Error in function <tt class=
"variable">foo</tt>: :FUNCTION-END breakpoints are
    currently unsupported for the known return convention.
  
</pre></blockquote>
in such cases we recommend using <tt class="code">(trace <tt class=
"variable">foo</tt> :encapsulate t)</tt><br>
<br>
<a name="@concept86"></a> <a name="@concept87"></a> <a name=
"@concept88"></a> <a name="@concept89"></a> <a name=
"@concept90"></a><br>
<br>
<tt class="code">:condition</tt>, <tt class="code">:break</tt> and
<tt class="code">:print</tt> forms are evaluated in the lexical
environment of the called function; <tt class="code">debug:var</tt>
and <tt class="code">debug:arg</tt> can be used. The <tt class=
"code">-after</tt> and <tt class="code">-all</tt> forms are
evaluated in the null environment.</blockquote>
<br>
<a name="@funs106"></a><a name="FN:untrace" id="FN:untrace"></a>
<div align="left">[Macro]<br>
<tt class="function-name">untrace</tt> <tt class=
"code">&amp;rest</tt> <tt class="variable">function-names</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro turns off tracing for the specified functions, and
removes their names from <tt class=
"code">*traced-function-list*</tt>. If no <tt class=
"variable">function-names</tt> are given, then all currently traced
functions are untraced.</blockquote>
<br>
<a name="@vars29"></a><a name="VR:traced-function-list" id=
"VR:traced-function-list"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*traced-function-list*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
A list of function names maintained and used by <tt class=
"code">trace</tt>, <tt class="code">untrace</tt>, and <tt class=
"code">untrace-all</tt>. This list should contain the names of all
functions currently being traced.</blockquote>
<br>
<a name="@vars30"></a><a name="VR:max-trace-indentation" id=
"VR:max-trace-indentation"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*max-trace-indentation*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The maximum number of spaces which should be used to indent trace
printout. This variable is initially set to 40.</blockquote>
<br>
<a name="@vars31"></a><a name="VR:trace-encapsulate-package-names"
id="VR:trace-encapsulate-package-names"></a>
<div align="left">[Variable]<br>
<tt class="function-name">debug:</tt><tt class=
"function-name">*trace-encapsulate-package-names*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
A list of package names. Functions from these packages are traced
using encapsulation instead of function-end breakpoints. This list
should at least include those packages containing functions used
directly or indirectly in the implementation of <tt class=
"code">trace</tt>.</blockquote>
<!--TOC subsection Encapsulation Functions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc101" id="htoc101"><b><font size=
"4">3.10.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Encapsulation
Functions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept91"></a> <a name="@concept92"></a><br>
The encapsulation functions provide a mechanism for intercepting
the arguments and results of a function. <tt class=
"code">encapsulate</tt> changes the function definition of a
symbol, and saves it so that it can be restored later. The new
definition normally calls the original definition. The Common Lisp
<a name="@funs107"></a><tt class="code">fdefinition</tt> function
always returns the original definition, stripping off any
encapsulation.<br>
<br>
The original definition of the symbol can be restored at any time
by the <tt class="code">unencapsulate</tt> function. <tt class=
"code">encapsulate</tt> and <tt class="code">unencapsulate</tt>
allow a symbol to be multiply encapsulated in such a way that
different encapsulations can be completely transparent to each
other.<br>
<br>
Each encapsulation has a type which may be an arbitrary lisp
object. If a symbol has several encapsulations of different types,
then any one of them can be removed without affecting more recent
ones. A symbol may have more than one encapsulation of the same
type, but only the most recent one can be undone.<br>
<br>
<br>
<a name="@funs108"></a><a name="FN:encapsulate" id=
"FN:encapsulate"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">encapsulate</tt> <tt class="variable">symbol</tt>
<tt class="variable">type</tt> <tt class="variable">body</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Saves the current definition of <tt class="variable">symbol</tt>,
and replaces it with a function which returns the result of
evaluating the form, <tt class="variable">body</tt>. <tt class=
"variable">Type</tt> is an arbitrary lisp object which is the type
of encapsulation.<br>
<br>
When the new function is called, the following variables are bound
for the evaluation of <tt class="variable">body</tt>:
<dl compact="compact">
<dt><tt class="code">extensions:argument-list</tt><br></dt>
<dd>A list of the arguments to the function.<br>
<br></dd>
<dt><tt class="code">extensions:basic-definition</tt><br></dt>
<dd>The unencapsulated definition of the function.</dd>
</dl>
The unencapsulated definition may be called with the original
arguments by including the form
<blockquote class="lisp">
<pre>
    (apply extensions:basic-definition extensions:argument-list)
  
</pre></blockquote>
<br>
<br>
<tt class="code">encapsulate</tt> always returns <tt class=
"variable">symbol</tt>.</blockquote>
<br>
<a name="@funs109"></a><a name="FN:unencapsulate" id=
"FN:unencapsulate"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">unencapsulate</tt> <tt class="variable">symbol</tt>
<tt class="variable">type</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Undoes <tt class="variable">symbol</tt>'s most recent encapsulation
of type <tt class="variable">type</tt>. <tt class=
"variable">Type</tt> is compared with <tt class="code">eq</tt>.
Encapsulations of other types are left in place.</blockquote>
<br>
<a name="@funs110"></a><a name="FN:encapsulated-p" id=
"FN:encapsulated-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">encapsulated-p</tt> <tt class=
"variable">symbol</tt> <tt class="variable">type</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Returns <tt class="code">t</tt> if <tt class="variable">symbol</tt>
has an encapsulation of type <tt class="variable">type</tt>.
Returns <tt class="code">nil</tt> otherwise. <tt class=
"variable">type</tt> is compared with <tt class=
"code">eq</tt>.</blockquote>
<!--TOC section Specials-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc102" id="htoc102"><b><font size=
"5">3.11</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Specials</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
These are the special variables that control the debugger
action.<br>
<br>
<br>
<a name="@vars32"></a><a name="VR:debug-print-level" id=
"VR:debug-print-level"></a>
<div align="left">[Variable]<br>
<tt class="function-name">debug:</tt><tt class=
"function-name">*debug-print-level*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars33"></a><a name="VR:debug-print-length" id=
"VR:debug-print-length"></a>
<div align="left">[Variable]<br>
<tt class="function-name">debug:</tt><tt class=
"function-name">*debug-print-length*</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<br>
<tt class="code">*print-level*</tt> and <tt class=
"code">*print-length*</tt> are bound to these values during the
execution of some debug commands. When evaluating arbitrary
expressions in the debugger, the normal values of <tt class=
"code">*print-level*</tt> and <tt class="code">*print-length*</tt>
are in effect. These variables are initially set to 3 and 5,
respectively.</blockquote>
<!--NAME debugger.html-->
<!--BEGIN NOTES chapter-->
<hr width="50%" size="1">
<dl>
<dt><a name="note5" href="#text5" id="note5"><font size=
"5">1</font></a></dt>
<dd>Since the location of an interrupt or hardware error will
always be an unknown location (see section&nbsp;<a href=
"#unknown-locations">3.3.6</a>), non-argument variable values will
never be available in the interrupted frame.</dd>
<dt><a name="note6" href="#text6" id="note6"><font size=
"5">2</font></a></dt>
<dd>The variable bindings are actually created using the Common
Lisp <tt class="code">symbol-macrolet</tt> special form.</dd>
</dl>
<!--END NOTES-->
<!--TOC chapter The Compiler-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc103" id="htoc103"><b><font size=
"6">Chapter&nbsp;4</font></b></a></td>
<td width="100%" align="center"><b><font size="6">The
Compiler</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<!--TOC section Compiler Introduction-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc104" id="htoc104"><b><font size=
"5">4.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Compiler
Introduction</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This chapter contains information about the compiler that every
CMUCL user should be familiar with. Chapter <a href=
"#advanced-compiler">5</a> goes into greater depth, describing ways
to use more advanced features.<br>
<br>
The CMUCL compiler (also known as Python, not to be confused with
the programming language of the same name) has many features that
are seldom or never supported by conventional Common Lisp
compilers:
<ul>
<li>Source level debugging of compiled code (see chapter <a href=
"#debugger">3</a>.)<br>
<br></li>
<li>Type error compiler warnings for type errors detectable at
compile time.<br>
<br></li>
<li>Compiler error messages that provide a good indication of where
the error appeared in the source.<br>
<br></li>
<li>Full run-time checking of all potential type errors, with
optimization of type checks to minimize the cost.<br>
<br></li>
<li>Scheme-like features such as proper tail recursion and
extensive source-level optimization.<br>
<br></li>
<li>Advanced tuning and optimization features such as comprehensive
efficiency notes, flow analysis, and untagged number
representations (see chapter <a href=
"#advanced-compiler">5</a>.)</li>
</ul>
<!--TOC section Calling the Compiler-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc105" id="htoc105"><b><font size=
"5">4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Calling the
Compiler</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept93"></a><br>
Functions may be compiled using <tt class="code">compile</tt>,
<tt class="code">compile-file</tt>, or <tt class=
"code">compile-from-stream</tt>.<br>
<br>
<br>
<a name="@funs111"></a><a name="FN:compile" id="FN:compile"></a>
<div align="left">[Function]<br>
<tt class="function-name">compile</tt> <tt class=
"variable">name</tt> <tt class="code">&amp;optional</tt> <tt class=
"variable">definition</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function compiles the function whose name is <tt class=
"variable">name</tt>. If <tt class="variable">name</tt> is
<tt class="code">nil</tt>, the compiled function object is
returned. If <tt class="variable">definition</tt> is supplied, it
should be a lambda expression that is to be compiled and then
placed in the function cell of <tt class="variable">name</tt>. As
per the proposed X3J13 cleanup ``compile-argument-problems'',
<tt class="variable">definition</tt> may also be an interpreted
function.<br>
<br>
The return values are as per the proposed X3J13 cleanup
``compiler-diagnostics''. The first value is the function name or
function object. The second value is <tt class="code">nil</tt> if
no compiler diagnostics were issued, and <tt class="code">t</tt>
otherwise. The third value is <tt class="code">nil</tt> if no
compiler diagnostics other than style warnings were issued. A
non-<tt class="code">nil</tt> value indicates that there were
``serious'' compiler diagnostics issued, or that other conditions
of type <a name="@types19"></a><tt class="code">error</tt> or
<a name="@types20"></a><tt class="code">warning</tt> (but not
<a name="@types21"></a><tt class="code">style-warning</tt>) were
signaled during compilation.</blockquote>
<br>
<a name="@funs112"></a><a name="FN:compile-file" id=
"FN:compile-file"></a>
<div align="left">[Function]<br>
<tt class="function-name">compile-file</tt> <tt class=
"variable">input-pathname</tt> <tt class="code">&amp;key</tt>
<tt class="code">:output-file</tt> <tt class=
"code">:error-file</tt> <tt class="code">:trace-file</tt><br>
<tt class="code">:error-output</tt> <tt class="code">:verbose</tt>
<tt class="code">:print</tt> <tt class="code">:progress</tt><br>
<tt class="code">:load</tt> <tt class="code">:block-compile</tt>
<tt class="code">:entry-points</tt><br>
<tt class="code">:byte-compile</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The CMUCL <tt class="code">compile-file</tt> is extended through
the addition of several new keywords and an additional
interpretation of <tt class="variable">input-pathname</tt>:
<dl compact="compact">
<dt><tt class="variable">input-pathname</tt><br></dt>
<dd>If this argument is a list of input files, rather than a single
input pathname, then all the source files are compiled into a
single object file. In this case, the name of the first file is
used to determine the default output file names. This is especially
useful in combination with <tt class=
"variable">block-compile</tt>.<br>
<br></dd>
<dt><tt class="code">:output-file</tt><br></dt>
<dd>This argument specifies the name of the output file. <tt class=
"code">t</tt> gives the default name, <tt class="code">nil</tt>
suppresses the output file.<br>
<br></dd>
<dt><tt class="code">:error-file</tt><br></dt>
<dd>A listing of all the error output is directed to this file. If
there are no errors, then no error file is produced (and any
existing error file is deleted.) <tt class="code">t</tt> gives
"<tt class="variable">name</tt><tt class="code">.err</tt>" (the
default), and <tt class="code">nil</tt> suppresses the output
file.<br>
<br></dd>
<dt><tt class="code">:error-output</tt><br></dt>
<dd>If <tt class="code">t</tt> (the default), then error output is
sent to <tt class="code">*error-output*</tt>. If a stream, then
output is sent to that stream instead. If <tt class=
"code">nil</tt>, then error output is suppressed. Note that this
error output is in addition to (but the same as) the output placed
in the <tt class="variable">error-file</tt>.<br>
<br></dd>
<dt><tt class="code">:verbose</tt><br></dt>
<dd>If <tt class="code">t</tt> (the default), then the compiler
prints to error output at the start and end of compilation of each
file. See <a name="@vars34"></a><tt class=
"code">*compile-verbose*</tt>.<br>
<br></dd>
<dt><tt class="code">:print</tt><br></dt>
<dd>If <tt class="code">t</tt> (the default), then the compiler
prints to error output when each function is compiled. See <a name=
"@vars35"></a><tt class="code">*compile-print*</tt>.<br>
<br></dd>
<dt><tt class="code">:progress</tt><br></dt>
<dd>If <tt class="code">t</tt> (default <tt class="code">nil</tt>),
then the compiler prints to error output progress information about
the phases of compilation of each function. This is a CMUCL
extension that is useful mainly in large block compilations. See
<a name="@vars36"></a><tt class="code">*compile-progress*</tt>.<br>
<br></dd>
<dt><tt class="code">:trace-file</tt><br></dt>
<dd>If <tt class="code">t</tt>, several of the intermediate
representations (including annotated assembly code) are dumped out
to this file. <tt class="code">t</tt> gives "<tt class=
"variable">name</tt><tt class="code">.trace</tt>". Trace output is
off by default. See section&nbsp;<a href=
"#trace-files">5.12.5</a>.<br>
<br></dd>
<dt><tt class="code">:load</tt><br></dt>
<dd>If <tt class="code">t</tt>, load the resulting output file.<br>
<br></dd>
<dt><tt class="code">:block-compile</tt><br></dt>
<dd>Controls the compile-time resolution of function calls. By
default, only self-recursive calls are resolved, unless an
<tt class="code">ext:block-start</tt> declaration appears in the
source file. See section&nbsp;<a href=
"#compile-file-block">5.7.3</a>.<br>
<br></dd>
<dt><tt class="code">:entry-points</tt><br></dt>
<dd>If non-null, then this is a list of the names of all functions
in the file that should have global definitions installed (because
they are referenced in other files.) See section&nbsp;<a href=
"#compile-file-block">5.7.3</a>.<br>
<br></dd>
<dt><tt class="code">:byte-compile</tt><br></dt>
<dd>If <tt class="code">t</tt>, compiling to a compact interpreted
byte code is enabled. Possible values are <tt class="code">t</tt>,
<tt class="code">nil</tt>, and <tt class="code">:maybe</tt> (the
default.) See <a name="@vars37"></a><tt class=
"code">*byte-compile-default*</tt> and See section&nbsp;<a href=
"#byte-compile">5.9</a>.</dd>
</dl>
The return values are as per the proposed X3J13 cleanup
``compiler-diagnostics''. The first value from <tt class=
"code">compile-file</tt> is the truename of the output file, or
<tt class="code">nil</tt> if the file could not be created. The
interpretation of the second and third values is described above
for <tt class="code">compile</tt>.</blockquote>
<br>
<a name="@vars38"></a><a name="VR:compile-verbose" id=
"VR:compile-verbose"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*compile-verbose*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars39"></a><a name="VR:compile-print" id=
"VR:compile-print"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*compile-print*</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@vars40"></a><a name="VR:compile-progress" id=
"VR:compile-progress"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*compile-progress*</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
These variables determine the default values for the <tt class=
"code">:verbose</tt>, <tt class="code">:print</tt> and <tt class=
"code">:progress</tt> arguments to <tt class=
"code">compile-file</tt>.</blockquote>
<br>
<a name="@funs113"></a><a name="FN:compile-from-stream" id=
"FN:compile-from-stream"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">compile-from-stream</tt> <tt class=
"variable">input-stream</tt> <tt class="code">&amp;key</tt>
<tt class="code">:error-stream</tt><br>
<tt class="code">:trace-stream</tt><br>
<tt class="code">:block-compile</tt> <tt class=
"code">:entry-points</tt><br>
<tt class="code">:byte-compile</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function is similar to <tt class="code">compile-file</tt>, but
it takes all its arguments as streams. It reads Common Lisp code
from <tt class="variable">input-stream</tt> until end of file is
reached, compiling into the current environment. This function
returns the same two values as the last two values of <tt class=
"code">compile</tt>. No output files are produced.</blockquote>
<!--TOC section Compilation Units-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc106" id="htoc106"><b><font size=
"5">4.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Compilation
Units</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept94"></a><br>
CMUCL supports the <tt class="code">with-compilation-unit</tt>
macro added to the language by the X3J13 ``with-compilation-unit''
compiler cleanup issue. This provides a mechanism for eliminating
spurious undefined warnings when there are forward references
across files, and also provides a standard way to access compiler
extensions.<br>
<br>
<br>
<a name="@funs114"></a><a name="FN:with-compilation-unit" id=
"FN:with-compilation-unit"></a>
<div align="left">[Macro]<br>
<tt class="function-name">with-compilation-unit</tt> (<tt class=
"code">{<tt class="variable">key</tt> <tt class=
"variable">value</tt>}</tt><sup><font size="2">*</font></sup>)
<tt class="code">{<tt class=
"variable">form</tt>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro evaluates the <tt class="variable">forms</tt> in an
environment that causes warnings for undefined variables, functions
and types to be delayed until all the forms have been evaluated.
Each keyword <tt class="variable">value</tt> is an evaluated form.
These keyword options are recognized:
<dl compact="compact">
<dt><tt class="code">:override</tt><br></dt>
<dd>If uses of <tt class="code">with-compilation-unit</tt> are
dynamically nested, the outermost use will take precedence,
suppressing printing of undefined warnings by inner uses. However,
when the <tt class="code">override</tt> option is true this
shadowing is inhibited; an inner use will print summary warnings
for the compilations within the inner scope.<br>
<br></dd>
<dt><tt class="code">:optimize</tt><br></dt>
<dd>This is a CMUCL extension that specifies of the ``global''
compilation policy for the dynamic extent of the body. The argument
should evaluate to an <tt class="code">optimize</tt> declare form,
like:
<blockquote class="lisp">
<pre>
      (optimize (speed 3) (safety 0))
    
</pre></blockquote>
See section&nbsp;<a href="#optimize-declaration">4.7.1</a><br>
<br></dd>
<dt><tt class="code">:optimize-interface</tt><br></dt>
<dd>Similar to <tt class="code">:optimize</tt>, but specifies the
compilation policy for function interfaces (argument count and type
checking) for the dynamic extent of the body. See
section&nbsp;<a href=
"#optimize-interface-declaration">4.7.2</a>.<br>
<br></dd>
<dt><tt class="code">:context-declarations</tt><br></dt>
<dd>This is a CMUCL extension that pattern-matches on function
names, automatically splicing in any appropriate declarations at
the head of the function definition. See section&nbsp;<a href=
"#context-declarations">5.7.5</a>.</dd>
</dl>
</blockquote>
<!--TOC subsection Undefined Warnings-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc107" id="htoc107"><b><font size=
"4">4.3.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Undefined
Warnings</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<a name="@concept95"></a> Warnings about undefined variables,
functions and types are delayed until the end of the current
compilation unit. The compiler entry functions (<tt class=
"code">compile</tt>, etc.) implicitly use <tt class=
"code">with-compilation-unit</tt>, so undefined warnings will be
printed at the end of the compilation unless there is an enclosing
<tt class="code">with-compilation-unit</tt>. In order the gain the
benefit of this mechanism, you should wrap a single <tt class=
"code">with-compilation-unit</tt> around the calls to <tt class=
"code">compile-file</tt>, i.e.:
<blockquote class="lisp">
<pre>
(with-compilation-unit ()
  (compile-file "file1")
  (compile-file "file2")
  ...)
</pre></blockquote>
Unlike for functions and types, undefined warnings for variables
are not suppressed when a definition (e.g. <tt class=
"code">defvar</tt>) appears after the reference (but in the same
compilation unit.) This is because doing special declarations out
of order just doesn't work---although early references will be
compiled as special, bindings will be done lexically.<br>
<br>
Undefined warnings are printed with full source context (see
section&nbsp;<a href="#error-messages">4.4</a>), which tremendously
simplifies the problem of finding undefined references that
resulted from macroexpansion. After printing detailed information
about the undefined uses of each name, <tt class=
"code">with-compilation-unit</tt> also prints summary listings of
the names of all the undefined functions, types and variables.<br>
<br>
<br>
<a name="@vars41"></a><a name="VR:undefined-warning-limit" id=
"VR:undefined-warning-limit"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*undefined-warning-limit*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable controls the number of undefined warnings for each
distinct name that are printed with full source context when the
compilation unit ends. If there are more undefined references than
this, then they are condensed into a single warning:
<blockquote class="example">
<pre>
    Warning: <tt class=
"variable">count</tt> more uses of undefined function <tt class=
"variable">name</tt>.
  
</pre></blockquote>
When the value is <tt class="code">0</tt>, then the undefined
warnings are not broken down by name at all: only the summary
listing of undefined names is printed.</blockquote>
<!--TOC section Interpreting Error Messages-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc108" id="htoc108"><b><font size=
"5">4.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Interpreting
Error Messages</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="error-messages" id="error-messages"></a> <a name=
"@concept96"></a> <a name="@concept97"></a><br>
One of Python's unique features is the level of source location
information it provides in error messages. The error messages
contain a lot of detail in a terse format, to they may be confusing
at first. Error messages will be illustrated using this example
program:
<blockquote class="lisp">
<pre>
(defmacro zoq (x)
  `(roq (ploq (+ ,x 3))))

(defun foo (y)
  (declare (symbol y))
  (zoq y))
</pre></blockquote>
The main problem with this program is that it is trying to add
<tt class="code">3</tt> to a symbol. Note also that the functions
<tt class="code">roq</tt> and <tt class="code">ploq</tt> aren't
defined anywhere.<br>
<br>
<!--TOC subsection The Parts of the Error Message-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc109" id="htoc109"><b><font size=
"4">4.4.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Parts of the
Error Message</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The compiler will produce this warning:
<blockquote class="example">
<pre>
File: /usr/me/stuff.lisp
In: DEFUN FOO
  (ZOQ Y)
--&gt; ROQ PLOQ + 
==&gt;
  Y
Warning: Result is a SYMBOL, not a NUMBER.
</pre></blockquote>
In this example we see each of the six possible parts of a compiler
error message:<br>
<br>
<dl compact="compact">
<dt><tt class="code">File: /usr/me/stuff.lisp</tt><br></dt>
<dd>This is the <tt class="variable">file</tt> that the compiler
read the relevant code from. The file name is displayed because it
may not be immediately obvious when there is an error during
compilation of a large system, especially when <tt class=
"code">with-compilation-unit</tt> is used to delay undefined
warnings.<br>
<br></dd>
<dt><tt class="code">In: DEFUN FOO</tt><br></dt>
<dd>This is the <tt class="variable">definition</tt> or top-level
form responsible for the error. It is obtained by taking the first
two elements of the enclosing form whose first element is a symbol
beginning with ``<tt class="code">DEF</tt>''. If there is no
enclosing <tt class="variable">def</tt>mumble, then the outermost
form is used. If there are multiple <tt class=
"variable">def</tt>mumbles, then they are all printed from the out
in, separated by <tt class="code">=&gt;</tt>'s. In this example,
the problem was in the <tt class="code">defun</tt> for <tt class=
"code">foo</tt>.<br>
<br></dd>
<dt><tt class="code">(ZOQ Y)</tt><br></dt>
<dd>This is the <em>original source</em> form responsible for the
error. Original source means that the form directly appeared in the
original input to the compiler, i.e. in the lambda passed to
<tt class="code">compile</tt> or the top-level form read from the
source file. In this example, the expansion of the <tt class=
"code">zoq</tt> macro was responsible for the error.<br>
<br></dd>
<dt><tt class="code">--&gt; ROQ PLOQ +</tt><br></dt>
<dd>This is the <em>processing path</em> that the compiler used to
produce the errorful code. The processing path is a representation
of the evaluated forms enclosing the actual source that the
compiler encountered when processing the original source. The path
is the first element of each form, or the form itself if the form
is not a list. These forms result from the expansion of macros or
source-to-source transformation done by the compiler. In this
example, the enclosing evaluated forms are the calls to <tt class=
"code">roq</tt>, <tt class="code">ploq</tt> and <tt class=
"code">+</tt>. These calls resulted from the expansion of the
<tt class="code">zoq</tt> macro.<br>
<br></dd>
<dt><tt class="code">==&gt; Y</tt><br></dt>
<dd>This is the <em>actual source</em> responsible for the error.
If the actual source appears in the explanation, then we print the
next enclosing evaluated form, instead of printing the actual
source twice. (This is the form that would otherwise have been the
last form of the processing path.) In this example, the problem is
with the evaluation of the reference to the variable <tt class=
"code">y</tt>.<br>
<br></dd>
<dt><tt class="code">Warning: Result is a SYMBOL, not a
NUMBER.</tt><br></dt>
<dd>This is the <tt class="variable">explanation</tt> the problem.
In this example, the problem is that <tt class="code">y</tt>
evaluates to a <tt class="code">symbol</tt>, but is in a context
where a number is required (the argument to <tt class=
"code">+</tt>).</dd>
</dl>
Note that each part of the error message is distinctively marked:
<ul>
<li><tt class="code">File:</tt> and <tt class="code">In:</tt> mark
the file and definition, respectively.<br>
<br></li>
<li>The original source is an indented form with no prefix.<br>
<br></li>
<li>Each line of the processing path is prefixed with <tt class=
"code">--&gt;</tt>.<br>
<br></li>
<li>The actual source form is indented like the original source,
but is marked by a preceding <tt class="code">==&gt;</tt> line.
This is like the ``macroexpands to'' notation used in <i>Common
Lisp: The Language</i>.<br>
<br></li>
<li>The explanation is prefixed with the error severity (see
section&nbsp;<a href="#error-severity">4.4.4</a>), either
<tt class="code">Error:</tt>, <tt class="code">Warning:</tt>, or
<tt class="code">Note:</tt>.</li>
</ul>
Each part of the error message is more specific than the preceding
one. If consecutive error messages are for nearby locations, then
the front part of the error messages would be the same. In this
case, the compiler omits as much of the second message as in common
with the first. For example:
<blockquote class="example">
<pre>
File: /usr/me/stuff.lisp
In: DEFUN FOO
  (ZOQ Y)
--&gt; ROQ 
==&gt;
  (PLOQ (+ Y 3))
Warning: Undefined function: PLOQ

==&gt;
  (ROQ (PLOQ (+ Y 3)))
Warning: Undefined function: ROQ
</pre></blockquote>
In this example, the file, definition and original source are
identical for the two messages, so the compiler omits them in the
second message. If consecutive messages are entirely identical,
then the compiler prints only the first message, followed by:
<blockquote class="example">
<pre>
[Last message occurs <tt class="variable">repeats</tt> times]
</pre></blockquote>
where <tt class="variable">repeats</tt> is the number of times the
message was given.<br>
<br>
If the source was not from a file, then no file line is printed. If
the actual source is the same as the original source, then the
processing path and actual source will be omitted. If no forms
intervene between the original source and the actual source, then
the processing path will also be omitted.<br>
<br>
<!--TOC subsection The Original and Actual Source-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc110" id="htoc110"><b><font size=
"4">4.4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Original and
Actual Source</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept98"></a> <a name="@concept99"></a><br>
The <em>original source</em> displayed will almost always be a
list. If the actual source for an error message is a symbol, the
original source will be the immediately enclosing evaluated list
form. So even if the offending symbol does appear in the original
source, the compiler will print the enclosing list and then print
the symbol as the actual source (as though the symbol were
introduced by a macro.)<br>
<br>
When the <em>actual source</em> is displayed (and is not a symbol),
it will always be code that resulted from the expansion of a macro
or a source-to-source compiler optimization. This is code that did
not appear in the original source program; it was introduced by the
compiler.<br>
<br>
Keep in mind that when the compiler displays a source form in an
error message, it always displays the most specific (innermost)
responsible form. For example, compiling this function:
<blockquote class="lisp">
<pre>
(defun bar (x)
  (let (a)
    (declare (fixnum a))
    (setq a (foo x))
    a))
</pre></blockquote>
gives this error message:
<blockquote class="example">
<pre>
In: DEFUN BAR
  (LET (A) (DECLARE (FIXNUM A)) (SETQ A (FOO X)) A)
Warning: The binding of A is not a FIXNUM:
  NIL
</pre></blockquote>
This error message is not saying ``there's a problem somewhere in
this <tt class="code">let</tt>''---it is saying that there is a
problem with the <tt class="code">let</tt> itself. In this example,
the problem is that <tt class="code">a</tt>'s <tt class=
"code">nil</tt> initial value is not a <tt class=
"code">fixnum</tt>.<br>
<br>
<!--TOC subsection The Processing Path-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc111" id="htoc111"><b><font size=
"4">4.4.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Processing
Path</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept100"></a> <a name="@concept101"></a> <a name=
"@concept102"></a><br>
The processing path is mainly useful for debugging macros, so if
you don't write macros, you can ignore the processing path.
Consider this example:
<blockquote class="lisp">
<pre>
(defun foo (n)
  (dotimes (i n *undefined*)))
</pre></blockquote>
Compiling results in this error message:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (DOTIMES (I N *UNDEFINED*))
--&gt; DO BLOCK LET TAGBODY RETURN-FROM 
==&gt;
  (PROGN *UNDEFINED*)
Warning: Undefined variable: *UNDEFINED*
</pre></blockquote>
Note that <tt class="code">do</tt> appears in the processing path.
This is because <tt class="code">dotimes</tt> expands into:
<blockquote class="lisp">
<pre>
(do ((i 0 (1+ i)) (#:g1 n))
    ((&gt;= i #:g1) *undefined*)
  (declare (type unsigned-byte i)))
</pre></blockquote>
The rest of the processing path results from the expansion of
<tt class="code">do</tt>:
<blockquote class="lisp">
<pre>
(block nil
  (let ((i 0) (#:g1 n))
    (declare (type unsigned-byte i))
    (tagbody (go #:g3)
     #:g2    (psetq i (1+ i))
     #:g3    (unless (&gt;= i #:g1) (go #:g2))
             (return-from nil (progn *undefined*)))))
</pre></blockquote>
In this example, the compiler descended into the <tt class=
"code">block</tt>, <tt class="code">let</tt>, <tt class=
"code">tagbody</tt> and <tt class="code">return-from</tt> to reach
the <tt class="code">progn</tt> printed as the actual source. This
is a place where the ``actual source appears in explanation'' rule
was applied. The innermost actual source form was the symbol
<tt class="code">*undefined*</tt> itself, but that also appeared in
the explanation, so the compiler backed out one level.<br>
<br>
<!--TOC subsection Error Severity-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc112" id="htoc112"><b><font size=
"4">4.4.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Error
Severity</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="error-severity" id="error-severity"></a> <a name=
"@concept103"></a> <a name="@concept104"></a><br>
There are three levels of compiler error severity:<br>
<br>
<dl compact="compact">
<dt>Error<br></dt>
<dd>This severity is used when the compiler encounters a problem
serious enough to prevent normal processing of a form. Instead of
compiling the form, the compiler compiles a call to <tt class=
"code">error</tt>. Errors are used mainly for signaling syntax
errors. If an error happens during macroexpansion, the compiler
will handle it. The compiler also handles and attempts to proceed
from read errors.<br>
<br></dd>
<dt>Warning<br></dt>
<dd>Warnings are used when the compiler can prove that something
bad will happen if a portion of the program is executed, but the
compiler can proceed by compiling code that signals an error at
runtime if the problem has not been fixed:
<ul>
<li>Violation of type declarations, or<br>
<br></li>
<li>Function calls that have the wrong number of arguments or
malformed keyword argument lists, or<br>
<br></li>
<li>Referencing a variable declared <tt class="code">ignore</tt>,
or unrecognized declaration specifiers.</li>
</ul>
<br>
In the language of the Common Lisp standard, these are situations
where the compiler can determine that a situation with undefined
consequences or that would cause an error to be signaled would
result at runtime.<br>
<br></dd>
<dt>Note<br></dt>
<dd>Notes are used when there is something that seems a bit odd,
but that might reasonably appear in correct programs.</dd>
</dl>
Note that the compiler does not fully conform to the proposed X3J13
``compiler-diagnostics'' cleanup. Errors, warnings and notes mostly
correspond to errors, warnings and style-warnings, but many things
that the cleanup considers to be style-warnings are printed as
warnings rather than notes. Also, warnings, style-warnings and most
errors aren't really signaled using the condition system.<br>
<br>
<!--TOC subsection Errors During Macroexpansion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc113" id="htoc113"><b><font size=
"4">4.4.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Errors During
Macroexpansion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept105"></a><br>
The compiler handles errors that happen during macroexpansion,
turning them into compiler errors. If you want to debug the error
(to debug a macro), you can set <tt class=
"code">*break-on-signals*</tt> to <tt class="code">error</tt>. For
example, this definition:
<blockquote class="lisp">
<pre>
(defun foo (e l)
  (do ((current l (cdr current))
       ((atom current) nil))
      (when (eq (car current) e) (return current))))
</pre></blockquote>
gives this error:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (DO ((CURRENT L #) (# NIL)) (WHEN (EQ # E) (RETURN CURRENT)) )
Error: (during macroexpansion)

Error in function LISP::DO-DO-BODY.
DO step variable is not a symbol: (ATOM CURRENT)
</pre></blockquote>
<!--TOC subsection Read Errors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc114" id="htoc114"><b><font size=
"4">4.4.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Read
Errors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept106"></a><br>
The compiler also handles errors while reading the source. For
example:
<blockquote class="example">
<pre>
Error: Read error at 2:
 "(,/\foo)"
Error in function LISP::COMMA-MACRO.
Comma not inside a backquote.
</pre></blockquote>
The ``<tt class="code">at 2</tt>'' refers to the character position
in the source file at which the error was signaled, which is
generally immediately after the erroneous text. The next line,
``<tt class="code">(,/\foo)</tt>'', is the line in the source that
contains the error file position. The ``<tt class="code">/\</tt> ''
indicates the error position within that line (in this example,
immediately after the offending comma.)<br>
<br>
When in Hemlock (or any other EMACS-like editor), you can go to a
character position with:
<blockquote class="example">
<pre>
M-&lt; C-u <tt class="variable">position</tt> C-f
</pre></blockquote>
Note that if the source is from a Hemlock buffer, then the position
is relative to the start of the compiled region or <tt class=
"code">defun</tt>, not the file or buffer start.<br>
<br>
After printing a read error message, the compiler attempts to
recover from the error by backing up to the start of the enclosing
top-level form and reading again with <tt class=
"code">*read-suppress*</tt> true. If the compiler can recover from
the error, then it substitutes a call to <tt class=
"code">cerror</tt> for the unreadable form and proceeds to compile
the rest of the file normally.<br>
<br>
If there is a read error when the file position is at the end of
the file (i.e., an unexpected EOF error), then the error message
looks like this:
<blockquote class="example">
<pre>
Error: Read error in form starting at 14:
 "(defun test ()"
Error in function LISP::FLUSH-WHITESPACE.
EOF while reading #&lt;Stream for file "/usr/me/test.lisp"&gt;
</pre></blockquote>
In this case, ``<tt class="code">starting at 14</tt>'' indicates
the character position at which the compiler started reading, i.e.
the position before the start of the form that was missing the
closing delimiter. The line "<tt class="code">(defun test ()</tt>"
is first line after the starting position that the compiler thinks
might contain the unmatched open delimiter.<br>
<br>
<!--TOC subsection Error Message Parameterization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc115" id="htoc115"><b><font size=
"4">4.4.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Error Message
Parameterization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept107"></a> <a name="@concept108"></a><br>
There is some control over the verbosity of error messages. See
also <a name="@vars42"></a><tt class=
"code">*undefined-warning-limit*</tt>, <tt class=
"code">*efficiency-note-limit*</tt> and <a name=
"@vars43"></a><tt class=
"code">*efficiency-note-cost-threshold*</tt>.<br>
<br>
<br>
<a name="@vars44"></a><a name="VR:enclosing-source-cutoff" id=
"VR:enclosing-source-cutoff"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*enclosing-source-cutoff*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable specifies the number of enclosing actual source forms
that are printed in full, rather than in the abbreviated processing
path format. Increasing the value from its default of <tt class=
"code">1</tt> allows you to see more of the guts of the
macroexpanded source, which is useful when debugging
macros.</blockquote>
<br>
<a name="@vars45"></a><a name="VR:error-print-length" id=
"VR:error-print-length"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*error-print-length*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars46"></a><a name="VR:error-print-level" id=
"VR:error-print-level"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*error-print-level*</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
These variables are the print level and print length used in
printing error messages. The default values are <tt class=
"code">5</tt> and <tt class="code">3</tt>. If null, the global
values of <tt class="code">*print-level*</tt> and <tt class=
"code">*print-length*</tt> are used.</blockquote>
<br>
<a name="@funs115"></a><a name="FN:def-source-context" id=
"FN:def-source-context"></a>
<div align="left">[Macro]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">def-source-context</tt> <tt class=
"variable">name</tt> <tt class="variable">lambda-list</tt>
<tt class="code">{form}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro defines how to extract an abbreviated source context
from the <tt class="variable">name</tt>d form when it appears in
the compiler input. <tt class="variable">lambda-list</tt> is a
<tt class="code">defmacro</tt> style lambda-list used to parse the
arguments. The <tt class="variable">body</tt> should return a list
of subforms that can be printed on about one line. There are
predefined methods for <tt class="code">defstruct</tt>, <tt class=
"code">defmethod</tt>, etc. If no method is defined, then the first
two subforms are returned. Note that this facility implicitly
determines the string name associated with anonymous
functions.</blockquote>
<!--TOC section Types in Python-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc116" id="htoc116"><b><font size=
"5">4.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Types in
Python</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept109"></a><br>
A big difference between Python and all other Common Lisp compilers
is the approach to type checking and amount of knowledge about
types:
<ul>
<li>Python treats type declarations much differently that other
Lisp compilers do. Python doesn't blindly believe type
declarations; it considers them assertions about the program that
should be checked.<br>
<br></li>
<li>Python also has a tremendously greater knowledge of the Common
Lisp type system than other compilers. Support is incomplete only
for the <tt class="code">not</tt>, <tt class="code">and</tt> and
<tt class="code">satisfies</tt> types.</li>
</ul>
See also sections <a href="#advanced-type-stuff">5.2</a> and
<a href="#type-inference">5.3</a>.<br>
<br>
<!--TOC subsection Compile Time Type Errors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc117" id="htoc117"><b><font size=
"4">4.5.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Compile Time Type
Errors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept110"></a> <a name="@concept111"></a><br>
If the compiler can prove at compile time that some portion of the
program cannot be executed without a type error, then it will give
a warning at compile time. It is possible that the offending code
would never actually be executed at run-time due to some higher
level consistency constraint unknown to the compiler, so a type
warning doesn't always indicate an incorrect program. For example,
consider this code fragment:
<blockquote class="lisp">
<pre>
(defun raz (foo)
  (let ((x (case foo
             (:this 13)
             (:that 9)
             (:the-other 42))))
    (declare (fixnum x))
    (foo x)))
</pre></blockquote>
Compilation produces this warning:
<blockquote class="example">
<pre>
In: DEFUN RAZ
  (CASE FOO (:THIS 13) (:THAT 9) (:THE-OTHER 42))
--&gt; LET COND IF COND IF COND IF 
==&gt;
  (COND)
Warning: This is not a FIXNUM:
  NIL
</pre></blockquote>
In this case, the warning is telling you that if <tt class=
"code">foo</tt> isn't any of <tt class="code">:this</tt>,
<tt class="code">:that</tt> or <tt class="code">:the-other</tt>,
then <tt class="code">x</tt> will be initialized to <tt class=
"code">nil</tt>, which the <tt class="code">fixnum</tt> declaration
makes illegal. The warning will go away if <tt class=
"code">ecase</tt> is used instead of <tt class="code">case</tt>, or
if <tt class="code">:the-other</tt> is changed to <tt class=
"code">t</tt>.<br>
<br>
This sort of spurious type warning happens moderately often in the
expansion of complex macros and in inline functions. In such cases,
there may be dead code that is impossible to correctly execute. The
compiler can't always prove this code is dead (could never be
executed), so it compiles the erroneous code (which will always
signal an error if it is executed) and gives a warning.<br>
<br>
<br>
<a name="@funs116"></a><a name="FN:required-argument" id=
"FN:required-argument"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">required-argument</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function can be used as the default value for keyword
arguments that must always be supplied. Since it is known by the
compiler to never return, it will avoid any compile-time type
warnings that would result from a default value inconsistent with
the declared type. When this function is called, it signals an
error indicating that a required keyword argument was not supplied.
This function is also useful for <tt class="code">defstruct</tt>
slot defaults corresponding to required arguments. See
section&nbsp;<a href="#empty-type">5.2.5</a>.<br>
<br>
Although this function is a CMUCL extension, it is relatively
harmless to use it in otherwise portable code, since you can easily
define it yourself:
<blockquote class="lisp">
<pre>
    (defun required-argument ()
      (error "A required keyword argument was not supplied."))
    
</pre></blockquote>
</blockquote>
Type warnings are inhibited when the <tt class=
"code">extensions:inhibit-warnings</tt> optimization quality is
<tt class="code">3</tt> (see section&nbsp;<a href=
"#compiler-policy">4.7</a>.) This can be used in a local
declaration to inhibit type warnings in a code fragment that has
spurious warnings.<br>
<br>
<!--TOC subsection Precise Type Checking-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc118" id="htoc118"><b><font size=
"4">4.5.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Precise Type
Checking</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="precise-type-checks" id="precise-type-checks"></a>
<a name="@concept112"></a> <a name="@concept113"></a><br>
With the default compilation policy, all type
assertions<sup><a name="text7" href="#note7" id="text7"><font size=
"2">1</font></a></sup> are precisely checked. Precise checking
means that the check is done as though <tt class="code">typep</tt>
had been called with the exact type specifier that appeared in the
declaration. Python uses <tt class="variable">policy</tt> to
determine whether to trust type assertions (see
section&nbsp;<a href="#compiler-policy">4.7</a>). Type assertions
from declarations are indistinguishable from the type assertions on
arguments to built-in functions. In Python, adding type
declarations makes code safer.<br>
<br>
If a variable is declared to be <tt class="code">(integer 3
17)</tt>, then its value must always always be an integer between
<tt class="code">3</tt> and <tt class="code">17</tt>. If multiple
type declarations apply to a single variable, then all the
declarations must be correct; it is as though all the types were
intersected producing a single <tt class="code">and</tt> type
specifier.<br>
<br>
Argument type declarations are automatically enforced. If you
declare the type of a function argument, a type check will be done
when that function is called. In a function call, the called
function does the argument type checking, which means that a more
restrictive type assertion in the calling function (e.g., from
<tt class="code">the</tt>) may be lost.<br>
<br>
The types of structure slots are also checked. The value of a
structure slot must always be of the type indicated in any
<tt class="code">:type</tt> slot option.<sup><a name="text8" href=
"#note8" id="text8"><font size="2">2</font></a></sup> Because of
precise type checking, the arguments to slot accessors are checked
to be the correct type of structure.<br>
<br>
In traditional Common Lisp compilers, not all type assertions are
checked, and type checks are not precise. Traditional compilers
blindly trust explicit type declarations, but may check the
argument type assertions for built-in functions. Type checking is
not precise, since the argument type checks will be for the most
general type legal for that argument. In many systems, type
declarations suppress what little type checking is being done, so
adding type declarations makes code unsafe. This is a problem since
it discourages writing type declarations during initial coding. In
addition to being more error prone, adding type declarations during
tuning also loses all the benefits of debugging with checked type
assertions.<br>
<br>
To gain maximum benefit from Python's type checking, you should
always declare the types of function arguments and structure slots
as precisely as possible. This often involves the use of <tt class=
"code">or</tt>, <tt class="code">member</tt> and other list-style
type specifiers. Paradoxically, even though adding type
declarations introduces type checks, it usually reduces the overall
amount of type checking. This is especially true for structure slot
type declarations.<br>
<br>
Python uses the <tt class="code">safety</tt> optimization quality
(rather than presence or absence of declarations) to choose one of
three levels of run-time type error checking: see
section&nbsp;<a href="#optimize-declaration">4.7.1</a>. See
section&nbsp;<a href="#advanced-type-stuff">5.2</a> for more
information about types in Python.<br>
<br>
<!--TOC subsection Weakened Type Checking-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc119" id="htoc119"><b><font size=
"4">4.5.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Weakened Type
Checking</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="weakened-type-checks" id="weakened-type-checks"></a>
<a name="@concept114"></a> <a name="@concept115"></a><br>
When the value for the <tt class="code">speed</tt> optimization
quality is greater than <tt class="code">safety</tt>, and
<tt class="code">safety</tt> is not <tt class="code">0</tt>, then
type checking is weakened to reduce the speed and space penalty. In
structure-intensive code this can double the speed, yet still catch
most type errors. Weakened type checks provide a level of safety
similar to that of ``safe'' code in other Common Lisp
compilers.<br>
<br>
A type check is weakened by changing the check to be for some
convenient supertype of the asserted type. For example, <tt class=
"code">(integer 3 17)</tt> is changed to <tt class=
"code">fixnum</tt>, <tt class="code">(simple-vector 17)</tt> to
<tt class="code">simple-vector</tt>, and structure types are
changed to <tt class="code">structure</tt>. A complex check like:
<blockquote class="example">
<pre>
(or node hunk (member :foo :bar :baz))
</pre></blockquote>
will be omitted entirely (i.e., the check is weakened to <tt class=
"code">*</tt>.) If a precise check can be done for no extra cost,
then no weakening is done.<br>
<br>
Although weakened type checking is similar to type checking done by
other compilers, it is sometimes safer and sometimes less safe.
Weakened checks are done in the same places is precise checks, so
all the preceding discussion about where checking is done still
applies. Weakened checking is sometimes somewhat unsafe because
although the check is weakened, the precise type is still input
into type inference. In some contexts this will result in type
inferences not justified by the weakened check, and hence deletion
of some type checks that would be done by conventional
compilers.<br>
<br>
For example, if this code was compiled with weakened checks:
<blockquote class="lisp">
<pre>
(defstruct foo
  (a nil :type simple-string))

(defstruct bar
  (a nil :type single-float))

(defun myfun (x)
  (declare (type bar x))
  (* (bar-a x) 3.0))
</pre></blockquote>
and <tt class="code">myfun</tt> was passed a <tt class=
"code">foo</tt>, then no type error would be signaled, and we would
try to multiply a <tt class="code">simple-vector</tt> as though it
were a float (with unpredictable results.) This is because the
check for <tt class="code">bar</tt> was weakened to <tt class=
"code">structure</tt>, yet when compiling the call to <tt class=
"code">bar-a</tt>, the compiler thinks it knows it has a <tt class=
"code">bar</tt>.<br>
<br>
Note that normally even weakened type checks report the precise
type in error messages. For example, if <tt class=
"code">myfun</tt>'s <tt class="code">bar</tt> check is weakened to
<tt class="code">structure</tt>, and the argument is <tt class=
"code">nil</tt>, then the error will be:
<blockquote class="example">
<pre>
Type-error in MYFUN:
  NIL is not of type BAR
</pre></blockquote>
However, there is some speed and space cost for signaling a precise
error, so the weakened type is reported if the <tt class=
"code">speed</tt> optimization quality is <tt class="code">3</tt>
or <tt class="code">debug</tt> quality is less than <tt class=
"code">1</tt>:
<blockquote class="example">
<pre>
Type-error in MYFUN:
  NIL is not of type STRUCTURE
</pre></blockquote>
See section&nbsp;<a href="#optimize-declaration">4.7.1</a> for
further discussion of the <tt class="code">optimize</tt>
declaration.<br>
<br>
<!--TOC section Getting Existing Programs to Run-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc120" id="htoc120"><b><font size=
"5">4.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Getting Existing
Programs to Run</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept116"></a> <a name="@concept117"></a> <a name=
"@concept118"></a><br>
Since Python does much more comprehensive type checking than other
Lisp compilers, Python will detect type errors in many programs
that have been debugged using other compilers. These errors are
mostly incorrect declarations, although compile-time type errors
can find actual bugs if parts of the program have never been
tested.<br>
<br>
Some incorrect declarations can only be detected by run-time type
checking. It is very important to initially compile programs with
full type checks and then test this version. After the checking
version has been tested, then you can consider weakening or
eliminating type checks. <b>This applies even to previously
debugged programs.</b> Python does much more type inference than
other Common Lisp compilers, so believing an incorrect declaration
does much more damage.<br>
<br>
The most common problem is with variables whose initial value
doesn't match the type declaration. Incorrect initial values will
always be flagged by a compile-time type error, and they are simple
to fix once located. Consider this code fragment:
<blockquote class="example">
<pre>
(prog (foo)
  (declare (fixnum foo))
  (setq foo ...)
  ...)
</pre></blockquote>
Here the variable <tt class="code">foo</tt> is given an initial
value of <tt class="code">nil</tt>, but is declared to be a
<tt class="code">fixnum</tt>. Even if it is never read, the initial
value of a variable must match the declared type. There are two
ways to fix this problem. Change the declaration:
<blockquote class="example">
<pre>
(prog (foo)
  (declare (type (or fixnum null) foo))
  (setq foo ...)
  ...)
</pre></blockquote>
or change the initial value:
<blockquote class="example">
<pre>
(prog ((foo 0))
  (declare (fixnum foo))
  (setq foo ...)
  ...)
</pre></blockquote>
It is generally preferable to change to a legal initial value
rather than to weaken the declaration, but sometimes it is simpler
to weaken the declaration than to try to make an initial value of
the appropriate type.<br>
<br>
Another declaration problem occasionally encountered is incorrect
declarations on <tt class="code">defmacro</tt> arguments. This
probably usually happens when a function is converted into a macro.
Consider this macro:
<blockquote class="lisp">
<pre>
(defmacro my-1+ (x)
  (declare (fixnum x))
  `(the fixnum (1+ ,x)))
</pre></blockquote>
Although legal and well-defined Common Lisp, this meaning of this
definition is almost certainly not what the writer intended. For
example, this call is illegal:
<blockquote class="lisp">
<pre>
(my-1+ (+ 4 5))
</pre></blockquote>
The call is illegal because the argument to the macro is <tt class=
"code">(+ 4 5)</tt>, which is a <tt class="code">list</tt>, not a
<tt class="code">fixnum</tt>. Because of macro semantics, it is
hardly ever useful to declare the types of macro arguments. If you
really want to assert something about the type of the result of
evaluating a macro argument, then put a <tt class="code">the</tt>
in the expansion:
<blockquote class="lisp">
<pre>
(defmacro my-1+ (x)
  `(the fixnum (1+ (the fixnum ,x))))
</pre></blockquote>
In this case, it would be stylistically preferable to change this
macro back to a function and declare it inline. Macros have no
efficiency advantage over inline functions when using Python. See
section&nbsp;<a href="#inline-expansion">5.8</a>.<br>
<br>
Some more subtle problems are caused by incorrect declarations that
can't be detected at compile time. Consider this code:
<blockquote class="example">
<pre>
(do ((pos 0 (position #\a string :start (1+ pos))))
    ((null pos))
  (declare (fixnum pos))
  ...)
</pre></blockquote>
Although <tt class="code">pos</tt> is almost always a <tt class=
"code">fixnum</tt>, it is <tt class="code">nil</tt> at the end of
the loop. If this example is compiled with full type checks (the
default), then running it will signal a type error at the end of
the loop. If compiled without type checks, the program will go into
an infinite loop (or perhaps <tt class="code">position</tt> will
complain because <tt class="code">(1+ nil)</tt> isn't a sensible
start.) Why? Because if you compile without type checks, the
compiler just quietly believes the type declaration. Since
<tt class="code">pos</tt> is always a <tt class="code">fixnum</tt>,
it is never <tt class="code">nil</tt>, so <tt class="code">(null
pos)</tt> is never true, and the loop exit test is optimized away.
Such errors are sometimes flagged by unreachable code notes (see
section&nbsp;<a href="#dead-code-notes">5.4.5</a>), but it is still
important to initially compile any system with full type checks,
even if the system works fine when compiled using other
compilers.<br>
<br>
In this case, the fix is to weaken the type declaration to
<tt class="code">(or fixnum null)</tt>.<sup><a name="text9" href=
"#note9" id="text9"><font size="2">3</font></a></sup> Note that
there is usually little performance penalty for weakening a
declaration in this way. Any numeric operations in the body can
still assume the variable is a <tt class="code">fixnum</tt>, since
<tt class="code">nil</tt> is not a legal numeric argument. Another
possible fix would be to say:
<blockquote class="example">
<pre>
(do ((pos 0 (position #\a string :start (1+ pos))))
    ((null pos))
  (let ((pos pos))
    (declare (fixnum pos))
    ...))
</pre></blockquote>
This would be preferable in some circumstances, since it would
allow a non-standard representation to be used for the local
<tt class="code">pos</tt> variable in the loop body (see section
<a href="#ND-variables">5.11.3</a>.)<br>
<br>
In summary, remember that <em>all</em> values that a variable
<em>ever</em> has must be of the declared type, and that you should
test using safe code initially.<br>
<br>
<!--TOC section Compiler Policy-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc121" id="htoc121"><b><font size=
"5">4.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Compiler
Policy</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="compiler-policy" id="compiler-policy"></a> <a name=
"@concept119"></a> <a name="@concept120"></a><br>
The policy is what tells the compiler <tt class="variable">how</tt>
to compile a program. This is logically (and often textually)
distinct from the program itself. Broad control of policy is
provided by the <tt class="code">optimize</tt> declaration; other
declarations and variables control more specific aspects of
compilation.<br>
<br>
<!--TOC subsection The Optimize Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc122" id="htoc122"><b><font size=
"4">4.7.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Optimize
Declaration</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="optimize-declaration" id="optimize-declaration"></a>
<a name="@concept121"></a> <a name="@concept122"></a><br>
The <tt class="code">optimize</tt> declaration recognizes six
different <tt class="variable">qualities</tt>. The qualities are
conceptually independent aspects of program performance. In
reality, increasing one quality tends to have adverse effects on
other qualities. The compiler compares the relative values of
qualities when it needs to make a trade-off; i.e., if <tt class=
"code">speed</tt> is greater than <tt class="code">safety</tt>,
then improve speed at the cost of safety.<br>
<br>
The default for all qualities (except <tt class="code">debug</tt>)
is <tt class="code">1</tt>. Whenever qualities are equal, ties are
broken according to a broad idea of what a good default environment
is supposed to be. Generally this downplays <tt class=
"code">speed</tt>, <tt class="code">compile-speed</tt> and
<tt class="code">space</tt> in favor of <tt class=
"code">safety</tt> and <tt class="code">debug</tt>. Novice and
casual users should stick to the default policy. Advanced users
often want to improve speed and memory usage at the cost of safety
and debuggability.<br>
<br>
If the value for a quality is <tt class="code">0</tt> or <tt class=
"code">3</tt>, then it may have a special interpretation. A value
of <tt class="code">0</tt> means ``totally unimportant'', and a
<tt class="code">3</tt> means ``ultimately important.'' These
extreme optimization values enable ``heroic'' compilation
strategies that are not always desirable and sometimes
self-defeating. Specifying more than one quality as <tt class=
"code">3</tt> is not desirable, since it doesn't tell the compiler
which quality is most important.<br>
<br>
These are the optimization qualities:
<dl compact="compact">
<dt><tt class="code">speed</tt><br></dt>
<dd><a name="@concept123"></a>How fast the program should is run.
<tt class="code">speed 3</tt> enables some optimizations that hurt
debuggability.<br>
<br></dd>
<dt><tt class="code">compilation-speed</tt><br></dt>
<dd><a name="@concept124"></a>How fast the compiler should run.
Note that increasing this above <tt class="code">safety</tt>
weakens type checking.<br>
<br></dd>
<dt><tt class="code">space</tt><br></dt>
<dd><a name="@concept125"></a>How much space the compiled code
should take up. Inline expansion is mostly inhibited when
<tt class="code">space</tt> is greater than <tt class=
"code">speed</tt>. A value of <tt class="code">0</tt> enables
promiscuous inline expansion. Wide use of a <tt class="code">0</tt>
value is not recommended, as it may waste so much space that run
time is slowed. See section&nbsp;<a href=
"#inline-expansion">5.8</a> for a discussion of inline
expansion.<br>
<br></dd>
<dt><tt class="code">debug</tt><br></dt>
<dd><a name="@concept126"></a>How debuggable the program should be.
The quality is treated differently from the other qualities: each
value indicates a particular level of debugger information; it is
not compared with the other qualities. See section&nbsp;<a href=
"#debugger-policy">3.6</a> for more details.<br>
<br></dd>
<dt><tt class="code">safety</tt><br></dt>
<dd><a name="@concept127"></a>How much error checking should be
done. If <tt class="code">speed</tt>, <tt class="code">space</tt>
or <tt class="code">compilation-speed</tt> is more important than
<tt class="code">safety</tt>, then type checking is weakened (see
section&nbsp;<a href="#weakened-type-checks">4.5.3</a>). If
<tt class="code">safety</tt> if <tt class="code">0</tt>, then no
run time error checking is done. In addition to suppressing type
checks, <tt class="code">0</tt> also suppresses argument count
checking, unbound-symbol checking and array bounds checks.<br>
<br></dd>
<dt><tt class="code">extensions:inhibit-warnings</tt><br></dt>
<dd><a name="@concept128"></a>This is a CMUCL extension that
determines how little (or how much) diagnostic output should be
printed during compilation. This quality is compared to other
qualities to determine whether to print style notes and warnings
concerning those qualities. If <tt class="code">speed</tt> is
greater than <tt class="code">inhibit-warnings</tt>, then notes
about how to improve speed will be printed, etc. The default value
is <tt class="code">1</tt>, so raising the value for any standard
quality above its default enables notes for that quality. If
<tt class="code">inhibit-warnings</tt> is <tt class="code">3</tt>,
then all notes and most non-serious warnings are inhibited. This is
useful with <tt class="code">declare</tt> to suppress warnings
about unavoidable problems.</dd>
</dl>
<!--TOC subsection The Optimize-Interface Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc123" id="htoc123"><b><font size=
"4">4.7.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The
Optimize-Interface Declaration</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="optimize-interface-declaration" id=
"optimize-interface-declaration"></a> <a name="@concept129"></a>
<a name="@concept130"></a><br>
The <tt class="code">extensions:optimize-interface</tt> declaration
is identical in syntax to the <tt class="code">optimize</tt>
declaration, but it specifies the policy used during compilation of
code the compiler automatically generates to check the number and
type of arguments supplied to a function. It is useful to specify
this policy separately, since even thoroughly debugged functions
are vulnerable to being passed the wrong arguments. The <tt class=
"code">optimize-interface</tt> declaration can specify that
arguments should be checked even when the general <tt class=
"code">optimize</tt> policy is unsafe.<br>
<br>
Note that this argument checking is the checking of user-supplied
arguments to any functions defined within the scope of the
declaration, <tt class="code">not</tt> the checking of arguments to
Common Lisp primitives that appear in those definitions.<br>
<br>
The idea behind this declaration is that it allows the definition
of functions that appear fully safe to other callers, but that do
no internal error checking. Of course, it is possible that
arguments may be invalid in ways other than having incorrect type.
Functions compiled unsafely must still protect themselves against
things like user-supplied array indices that are out of bounds and
improper lists. See also the <tt class=
"code">:context-declarations</tt> option to <a name=
"@funs117"></a><tt class="code">with-compilation-unit</tt>.<br>
<br>
<!--TOC section Open Coding and Inline Expansion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc124" id="htoc124"><b><font size=
"5">4.8</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Open Coding and
Inline Expansion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="open-coding" id="open-coding"></a> <a name=
"@concept131"></a> <a name="@concept132"></a> <a name=
"@concept133"></a><br>
Since Common Lisp forbids the redefinition of standard
functions<sup><a name="text10" href="#note10" id=
"text10"><font size="2">4</font></a></sup>, the compiler can have
special knowledge of these standard functions embedded in it. This
special knowledge is used in various ways (open coding, inline
expansion, source transformation), but the implications to the user
are basically the same:
<ul>
<li>Attempts to redefine standard functions may be frustrated,
since the function may never be called. Although it is technically
illegal to redefine standard functions, users sometimes want to
implicitly redefine these functions when they are debugging using
the <tt class="code">trace</tt> macro. Special-casing of standard
functions can be inhibited using the <tt class=
"code">notinline</tt> declaration.<br>
<br></li>
<li>The compiler can have multiple alternate implementations of
standard functions that implement different trade-offs of speed,
space and safety. This selection is based on the compiler policy,
see section&nbsp;<a href="#compiler-policy">4.7</a>.</li>
</ul>
When a function call is <em>open coded</em>, inline code whose
effect is equivalent to the function call is substituted for that
function call. When a function call is <em>closed coded</em>, it is
usually left as is, although it might be turned into a call to a
different function with different arguments. As an example, if
<tt class="code">nthcdr</tt> were to be open coded, then
<blockquote class="lisp">
<pre>
(nthcdr 4 foobar)
</pre></blockquote>
might turn into
<blockquote class="lisp">
<pre>
(cdr (cdr (cdr (cdr foobar))))
</pre></blockquote>
or even
<blockquote class="lisp">
<pre>
(do ((i 0 (1+ i))
     (list foobar (cdr foobar)))
    ((= i 4) list))
</pre></blockquote>
If <tt class="code">nth</tt> is closed coded, then
<blockquote class="lisp">
<pre>
(nth x l)
</pre></blockquote>
might stay the same, or turn into something like:
<blockquote class="lisp">
<pre>
(car (nthcdr x l))
</pre></blockquote>
In general, open coding sacrifices space for speed, but some
functions (such as <tt class="code">car</tt>) are so simple that
they are always open-coded. Even when not open-coded, a call to a
standard function may be transformed into a different function call
(as in the last example) or compiled as <em>static call</em>.
Static function call uses a more efficient calling convention that
forbids redefinition. <!--NAME compiler.html-->
 <!--BEGIN NOTES chapter-->
<hr width="50%" size="1">
<dl>
<dt><a name="note7" href="#text7" id="note7"><font size=
"5">1</font></a></dt>
<dd>There are a few circumstances where a type declaration is
discarded rather than being used as type assertion. This doesn't
affect safety much, since such discarded declarations are also not
believed to be true by the compiler.</dd>
<dt><a name="note8" href="#text8" id="note8"><font size=
"5">2</font></a></dt>
<dd>The initial value need not be of this type as long as the
corresponding argument to the constructor is always supplied, but
this will cause a compile-time type warning unless <tt class=
"code">required-argument</tt> is used.</dd>
<dt><a name="note9" href="#text9" id="note9"><font size=
"5">3</font></a></dt>
<dd>Actually, this declaration is totally unnecessary in Python,
since it already knows <tt class="code">position</tt> returns a
non-negative <tt class="code">fixnum</tt> or <tt class=
"code">nil</tt>.</dd>
<dt><a name="note10" href="#text10" id="note10"><font size=
"5">4</font></a></dt>
<dd>See the proposed X3J13 ``lisp-symbol-redefinition''
cleanup.</dd>
</dl>
<!--END NOTES-->
<!--TOC chapter Advanced Compiler Use and Efficiency Hints-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc125" id="htoc125"><b><font size=
"6">Chapter&nbsp;5</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Advanced Compiler
Use and Efficiency Hints</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="advanced-compiler" id="advanced-compiler"></a><br>
<div align="center"><b>by Robert MacLachlan</b></div>
<br>
<!--TOC section Advanced Compiler Introduction-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc126" id="htoc126"><b><font size=
"5">5.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Advanced Compiler
Introduction</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
In CMUCL, as with any language on any computer, the path to
efficient code starts with good algorithms and sensible programming
techniques, but to avoid inefficiency pitfalls, you need to know
some of this implementation's quirks and features. This chapter is
mostly a fairly long and detailed overview of what optimizations
Python does. Although there are the usual negative suggestions of
inefficient features to avoid, the main emphasis is on describing
the things that programmers can count on being efficient.<br>
<br>
The optimizations described here can have the effect of speeding up
existing programs written in conventional styles, but the potential
for new programming styles that are clearer and less error-prone is
at least as significant. For this reason, several sections end with
a discussion of the implications of these optimizations for
programming style.<br>
<br>
<!--TOC subsection Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc127" id="htoc127"><b><font size=
"4">5.1.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Python's support for types is unusual in three major ways:
<ul>
<li>Precise type checking encourages the specific use of type
declarations as a form of run-time consistency checking. This
speeds development by localizing type errors and giving more
meaningful error messages. See section&nbsp;<a href=
"#precise-type-checks">4.5.2</a>. Python produces completely safe
code; optimized type checking maintains reasonable efficiency on
conventional hardware (see section&nbsp;<a href=
"#type-check-optimization">5.3.6</a>.)<br>
<br></li>
<li>Comprehensive support for the Common Lisp type system makes
complex type specifiers useful. Using type specifiers such as
<tt class="code">or</tt> and <tt class="code">member</tt> has both
efficiency and robustness advantages. See section&nbsp;<a href=
"#advanced-type-stuff">5.2</a>.<br>
<br></li>
<li>Type inference eliminates the need for some declarations, and
also aids compile-time detection of type errors. Given detailed
type declarations, type inference can often eliminate type checks
and enable more efficient object representations and code
sequences. Checking all types results in fewer type checks. See
sections <a href="#type-inference">5.3</a> and <a href=
"#non-descriptor">5.11.2</a>.</li>
</ul>
<!--TOC subsection Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc128" id="htoc128"><b><font size=
"4">5.1.2</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The main barrier to efficient Lisp programs is not that there is no
efficient way to code the program in Lisp, but that it is difficult
to arrive at that efficient coding. Common Lisp is a highly complex
language, and usually has many semantically equivalent
``reasonable'' ways to code a given problem. It is desirable to
make all of these equivalent solutions have comparable efficiency
so that programmers don't have to waste time discovering the most
efficient solution.<br>
<br>
Source level optimization increases the number of efficient ways to
solve a problem. This effect is much larger than the increase in
the efficiency of the ``best'' solution. Source level optimization
transforms the original program into a more efficient (but
equivalent) program. Although the optimizer isn't doing anything
the programmer couldn't have done, this high-level optimization is
important because:
<ul>
<li>The programmer can code simply and directly, rather than
obfuscating code to please the compiler.<br>
<br></li>
<li>When presented with a choice of similar coding alternatives,
the programmer can chose whichever happens to be most convenient,
instead of worrying about which is most efficient.</li>
</ul>
Source level optimization eliminates the need for macros to
optimize their expansion, and also increases the effectiveness of
inline expansion. See sections <a href=
"#source-optimization">5.4</a> and <a href=
"#inline-expansion">5.8</a>.<br>
<br>
Efficient support for a safer programming style is the biggest
advantage of source level optimization. Existing tuned programs
typically won't benefit much from source optimization, since their
source has already been optimized by hand. However, even tuned
programs tend to run faster under Python because:
<ul>
<li>Low level optimization and register allocation provides modest
speedups in any program.<br>
<br></li>
<li>Block compilation and inline expansion can reduce function call
overhead, but may require some program restructuring. See sections
<a href="#inline-expansion">5.8</a>, <a href="#local-call">5.6</a>
and <a href="#block-compilation">5.7</a>.<br>
<br></li>
<li>Efficiency notes will point out important type declarations
that are often missed even in highly tuned programs. See
section&nbsp;<a href="#efficiency-notes">5.13</a>.<br>
<br></li>
<li>Existing programs can be compiled safely without prohibitive
speed penalty, although they would be faster and safer with added
declarations. See section&nbsp;<a href=
"#type-check-optimization">5.3.6</a>.<br>
<br></li>
<li>The context declaration mechanism allows both space and runtime
of large systems to be reduced without sacrificing robustness by
semi-automatically varying compilation policy without addition any
<tt class="code">optimize</tt> declarations to the source. See
section&nbsp;<a href="#context-declarations">5.7.5</a>.<br>
<br></li>
<li>Byte compilation can be used to dramatically reduce the size of
code that is not speed-critical. See section&nbsp;<a href=
"#byte-compile">5.9</a></li>
</ul>
<!--TOC subsection Function Call-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc129" id="htoc129"><b><font size=
"4">5.1.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Function
Call</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The sort of symbolic programs generally written in Common Lisp
often favor recursion over iteration, or have inner loops so
complex that they involve multiple function calls. Such programs
spend a larger fraction of their time doing function calls than is
the norm in other languages; for this reason Common Lisp
implementations strive to make the general (or full) function call
as inexpensive as possible. Python goes beyond this by providing
two good alternatives to full call:
<ul>
<li>Local call resolves function references at compile time,
allowing better calling sequences and optimization across function
calls. See section&nbsp;<a href="#local-call">5.6</a>.<br>
<br></li>
<li>Inline expansion totally eliminates call overhead and allows
many context dependent optimizations. This provides a safe and
efficient implementation of operations with function semantics,
eliminating the need for error-prone macro definitions or manual
case analysis. Although most Common Lisp implementations support
inline expansion, it becomes a more powerful tool with Python's
source level optimization. See sections <a href=
"#source-optimization">5.4</a> and <a href=
"#inline-expansion">5.8</a>.</li>
</ul>
Generally, Python provides simple implementations for simple uses
of function call, rather than having only a single calling
convention. These features allow a more natural programming style:
<ul>
<li>Proper tail recursion. See section&nbsp;<a href=
"#tail-recursion">5.5</a><br>
<br></li>
<li>Relatively efficient closures.<br>
<br></li>
<li>A <tt class="code">funcall</tt> that is as efficient as normal
named call.<br>
<br></li>
<li>Calls to local functions such as from <tt class=
"code">labels</tt> are optimized:
<ul>
<li>Control transfer is a direct jump.<br>
<br></li>
<li>The closure environment is passed in registers rather than heap
allocated.<br>
<br></li>
<li>Keyword arguments and multiple values are implemented more
efficiently.</li>
</ul>
<br>
See section&nbsp;<a href="#local-call">5.6</a>.</li>
</ul>
<!--TOC subsection Representation of Objects-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc130" id="htoc130"><b><font size=
"4">5.1.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Representation of
Objects</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Sometimes traditional Common Lisp implementation techniques compare
so poorly to the techniques used in other languages that Common
Lisp can become an impractical language choice. Terrible
inefficiencies appear in number-crunching programs, since Common
Lisp numeric operations often involve number-consing and generic
arithmetic. Python supports efficient natural representations for
numbers (and some other types), and allows these efficient
representations to be used in more contexts. Python also provides
good efficiency notes that warn when a crucial declaration is
missing.<br>
<br>
See section <a href="#non-descriptor">5.11.2</a> for more about
object representations and numeric types. Also see
section&nbsp;<a href="#efficiency-notes">5.13</a> about efficiency
notes.<br>
<br>
<!--TOC subsection Writing Efficient Code-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc131" id="htoc131"><b><font size=
"4">5.1.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Writing Efficient
Code</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="efficiency-overview" id="efficiency-overview"></a><br>
Writing efficient code that works is a complex and prolonged
process. It is important not to get so involved in the pursuit of
efficiency that you lose sight of what the original problem
demands. Remember that:
<ul>
<li>The program should be correct---it doesn't matter how quickly
you get the wrong answer.<br>
<br></li>
<li>Both the programmer and the user will make errors, so the
program must be robust---it must detect errors in a way that allows
easy correction.<br>
<br></li>
<li>A small portion of the program will consume most of the
resources, with the bulk of the code being virtually irrelevant to
efficiency considerations. Even experienced programmers familiar
with the problem area cannot reliably predict where these ``hot
spots'' will be.</li>
</ul>
The best way to get efficient code that is still worth using, is to
separate coding from tuning. During coding, you should:
<ul>
<li>Use a coding style that aids correctness and robustness without
being incompatible with efficiency.<br>
<br></li>
<li>Choose appropriate data structures that allow efficient
algorithms and object representations (see section&nbsp;<a href=
"#object-representation">5.10</a>). Try to make interfaces abstract
enough so that you can change to a different representation if
profiling reveals a need.<br>
<br></li>
<li>Whenever you make an assumption about a function argument or
global data structure, add consistency assertions, either with type
declarations or explicit uses of <tt class="code">assert</tt>,
<tt class="code">ecase</tt>, etc.</li>
</ul>
During tuning, you should:
<ul>
<li>Identify the hot spots in the program through profiling
(section <a href="#profiling">5.14</a>.)<br>
<br></li>
<li>Identify inefficient constructs in the hot spot with efficiency
notes, more profiling, or manual inspection of the source. See
sections <a href="#general-efficiency">5.12</a> and <a href=
"#efficiency-notes">5.13</a>.<br>
<br></li>
<li>Add declarations and consider the application of optimizations.
See sections <a href="#local-call">5.6</a>, <a href=
"#inline-expansion">5.8</a> and <a href=
"#non-descriptor">5.11.2</a>.<br>
<br></li>
<li>If all else fails, consider algorithm or data structure
changes. If you did a good job coding, changes will be easy to
introduce.</li>
</ul>
<!--TOC section More About Types in Python-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc132" id="htoc132"><b><font size=
"5">5.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">More About Types
in Python</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="advanced-type-stuff" id="advanced-type-stuff"></a>
<a name="@concept134"></a><br>
This section goes into more detail describing what types and
declarations are recognized by Python. The area where Python
differs most radically from previous Common Lisp compilers is in
its support for types:
<ul>
<li>Precise type checking helps to find bugs at run time.<br>
<br></li>
<li>Compile-time type checking helps to find bugs at compile
time.<br>
<br></li>
<li>Type inference minimizes the need for generic operations, and
also increases the efficiency of run time type checking and the
effectiveness of compile time type checking.<br>
<br></li>
<li>Support for detailed types provides a wealth of opportunity for
operation-specific type inference and optimization.</li>
</ul>
<!--TOC subsection More Types Meaningful-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc133" id="htoc133"><b><font size=
"4">5.2.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">More Types
Meaningful</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Common Lisp has a very powerful type system, but conventional
Common Lisp implementations typically only recognize the small set
of types special in that implementation. In these systems, there is
an unfortunate paradox: a declaration for a relatively general type
like <tt class="code">fixnum</tt> will be recognized by the
compiler, but a highly specific declaration such as <tt class=
"code">(integer 3 17)</tt> is totally ignored.<br>
<br>
This is obviously a problem, since the user has to know how to
specify the type of an object in the way the compiler wants it. A
very minimal (but rarely satisfied) criterion for type system
support is that it be no worse to make a specific declaration than
to make a general one. Python goes beyond this by exploiting a
number of advantages obtained from detailed type information.<br>
<br>
Using more restrictive types in declarations allows the compiler to
do better type inference and more compile-time type checking. Also,
when type declarations are considered to be consistency assertions
that should be verified (conditional on policy), then complex types
are useful for making more detailed assertions.<br>
<br>
Python ``understands'' the list-style <tt class="code">or</tt>,
<tt class="code">member</tt>, <tt class="code">function</tt>, array
and number type specifiers. Understanding means that:
<ul>
<li>If the type contains more information than is used in a
particular context, then the extra information is simply ignored,
rather than derailing type inference.<br>
<br></li>
<li>In many contexts, the extra information from these type
specifier is used to good effect. In particular, type checking in
Python is <tt class="variable">precise</tt>, so these complex types
can be used in declarations to make interesting assertions about
functions and data structures (see section&nbsp;<a href=
"#precise-type-checks">4.5.2</a>.) More specific declarations also
aid type inference and reduce the cost for type checking.</li>
</ul>
For related information, see section&nbsp;<a href=
"#numeric-types">5.11</a> for numeric types, and section <a href=
"#array-types">5.10.3</a> for array types.<br>
<br>
<!--TOC subsection Canonicalization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc134" id="htoc134"><b><font size=
"4">5.2.2</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Canonicalization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept135"></a> <a name="@concept136"></a> <a name=
"@concept137"></a><br>
When given a type specifier, Python will often rewrite it into a
different (but equivalent) type. This is the mechanism that Python
uses for detecting type equivalence. For example, in Python's
canonical representation, these types are equivalent:
<blockquote class="example">
<pre>
(or list (member :end)) &lt;==&gt; (or cons (member nil :end))
</pre></blockquote>
This has two implications for the user:
<ul>
<li>The standard symbol type specifiers for <tt class=
"code">atom</tt>, <tt class="code">null</tt>, <tt class=
"code">fixnum</tt>, etc., are in no way magical. The <a name=
"@types22"></a><tt class="code">null</tt> type is actually defined
to be <tt class="code">(member nil)</tt>, <a name=
"@types23"></a><tt class="code">list</tt> is <tt class="code">(or
cons null)</tt>, and <a name="@types24"></a><tt class=
"code">fixnum</tt> is <tt class="code">(signed-byte 30)</tt>.<br>
<br></li>
<li>When the compiler prints out a type, it may not look like the
type specifier that originally appeared in the program. This is
generally not a problem, but it must be taken into consideration
when reading compiler error messages.</li>
</ul>
<!--TOC subsection Member Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc135" id="htoc135"><b><font size=
"4">5.2.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Member
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept138"></a><br>
The <a name="@types25"></a><tt class="code">member</tt> type
specifier can be used to represent ``symbolic'' values, analogous
to the enumerated types of Pascal. For example, the second value of
<tt class="code">find-symbol</tt> has this type:
<blockquote class="lisp">
<pre>
(member :internal :external :inherited nil)
</pre></blockquote>
Member types are very useful for expressing consistency constraints
on data structures, for example:
<blockquote class="lisp">
<pre>
(defstruct ice-cream
  (flavor :vanilla :type (member :vanilla :chocolate :strawberry)))
</pre></blockquote>
Member types are also useful in type inference, as the number of
members can sometimes be pared down to one, in which case the value
is a known constant.<br>
<br>
<!--TOC subsection Union Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc136" id="htoc136"><b><font size=
"4">5.2.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Union
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept139"></a> <a name="@concept140"></a><br>
The <a name="@types26"></a><tt class="code">or</tt> (union) type
specifier is understood, and is meaningfully applied in many
contexts. The use of <tt class="code">or</tt> allows assertions to
be made about types in dynamically typed programs. For example:
<blockquote class="lisp">
<pre>
(defstruct box
  (next nil :type (or box null))
  (top :removed :type (or box-top (member :removed))))
</pre></blockquote>
The type assertion on the <tt class="code">top</tt> slot ensures
that an error will be signaled when there is an attempt to store an
illegal value (such as <tt class="code">:rmoved</tt>.) Although
somewhat weak, these union type assertions provide a useful input
into type inference, allowing the cost of type checking to be
reduced. For example, this loop is safely compiled with no type
checks:
<blockquote class="lisp">
<pre>
(defun find-box-with-top (box)
  (declare (type (or box null) box))
  (do ((current box (box-next current)))
      ((null current))
    (unless (eq (box-top current) :removed)
      (return current))))
</pre></blockquote>
Union types are also useful in type inference for representing
types that are partially constrained. For example, the result of
this expression:
<blockquote class="lisp">
<pre>
(if foo
    (logior x y)
    (list x y))
</pre></blockquote>
can be expressed as <tt class="code">(or integer cons)</tt>.<br>
<br>
<!--TOC subsection The Empty Type-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc137" id="htoc137"><b><font size=
"4">5.2.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Empty
Type</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="empty-type" id="empty-type"></a> <a name=
"@concept141"></a> <a name="@concept142"></a> <a name=
"@concept143"></a><br>
The type <tt class="code">nil</tt> is also called the empty type,
since no object is of type <tt class="code">nil</tt>. The union of
no types, <tt class="code">(or)</tt>, is also empty. Python's
interpretation of an expression whose type is <tt class=
"code">nil</tt> is that the expression never yields any value, but
rather fails to terminate, or is thrown out of. For example, the
type of a call to <tt class="code">error</tt> or a use of
<tt class="code">return</tt> is <tt class="code">nil</tt>. When the
type of an expression is empty, compile-time type warnings about
its value are suppressed; presumably somebody else is signaling an
error. If a function is declared to have return type <tt class=
"code">nil</tt>, but does in fact return, then (in safe compilation
policies) a ``<tt class="code">NIL Function returned</tt>'' error
will be signaled. See also the function <a name=
"@funs118"></a><tt class="code">required-argument</tt>.<br>
<br>
<!--TOC subsection Function Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc138" id="htoc138"><b><font size=
"4">5.2.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Function
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="function-types" id="function-types"></a> <a name=
"@concept144"></a> <a name="@concept145"></a><br>
<a name="@funs119"></a><tt class="code">function</tt> types are
understood in the restrictive sense, specifying:
<ul>
<li>The argument syntax that the function must be called with. This
is information about what argument counts are acceptable, and which
keyword arguments are recognized. In Python, warnings about
argument syntax are a consequence of function type checking.<br>
<br></li>
<li>The types of the argument values that the caller must pass. If
the compiler can prove that some argument to a call is of a type
disallowed by the called function's type, then it will give a
compile-time type warning. In addition to being used for
compile-time type checking, these type assertions are also used as
output type assertions in code generation. For example, if
<tt class="code">foo</tt> is declared to have a <tt class=
"code">fixnum</tt> argument, then the <tt class="code">1+</tt> in
<tt class="code">(foo (1+ x))</tt> is compiled with knowledge that
the result must be a fixnum.<br>
<br></li>
<li>The types the values that will be bound to argument variables
in the function's definition. Declaring a function's type with
<tt class="code">ftype</tt> implicitly declares the types of the
arguments in the definition. Python checks for consistency between
the definition and the <tt class="code">ftype</tt> declaration.
Because of precise type checking, an error will be signaled when a
function is called with an argument of the wrong type.<br>
<br></li>
<li>The type of return value(s) that the caller can expect. This
information is a useful input to type inference. For example, if a
function is declared to return a <tt class="code">fixnum</tt>, then
when a call to that function appears in an expression, the
expression will be compiled with knowledge that the call will
return a <tt class="code">fixnum</tt>.<br>
<br></li>
<li>The type of return value(s) that the definition must return.
The result type in an <tt class="code">ftype</tt> declaration is
treated like an implicit <tt class="code">the</tt> wrapped around
the body of the definition. If the definition returns a value of
the wrong type, an error will be signaled. If the compiler can
prove that the function returns the wrong type, then it will give a
compile-time warning.</li>
</ul>
This is consistent with the new interpretation of function types
and the <tt class="code">ftype</tt> declaration in the proposed
X3J13 ``function-type-argument-type-semantics'' cleanup. Note also,
that if you don't explicitly declare the type of a function using a
global <tt class="code">ftype</tt> declaration, then Python will
compute a function type from the definition, providing a degree of
inter-routine type inference, see section&nbsp;<a href=
"#function-type-inference">5.3.3</a>.<br>
<br>
<!--TOC subsection The Values Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc139" id="htoc139"><b><font size=
"4">5.2.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Values
Declaration</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept146"></a><br>
CMUCL supports the <tt class="code">values</tt> declaration as an
extension to Common Lisp. The syntax of the declaration is
<tt class="code">(values <tt class="variable">type1</tt> <tt class=
"variable">type2</tt>...<tt class="variable">typen</tt>)</tt>. This
declaration is semantically equivalent to a <tt class=
"code">the</tt> form wrapped around the body of the special form in
which the <tt class="code">values</tt> declaration appears. The
advantage of <tt class="code">values</tt> over <a name=
"@funs120"></a><tt class="code">the</tt> is purely syntactic---it
doesn't introduce more indentation. For example:
<blockquote class="example">
<pre>
(defun foo (x)
  (declare (values single-float))
  (ecase x
    (:this ...)
    (:that ...)
    (:the-other ...)))
</pre></blockquote>
is equivalent to:
<blockquote class="example">
<pre>
(defun foo (x)
  (the single-float
       (ecase x
         (:this ...)
         (:that ...)
         (:the-other ...))))
</pre></blockquote>
and
<blockquote class="example">
<pre>
(defun floor (number &amp;optional (divisor 1))
  (declare (values integer real))
  ...)
</pre></blockquote>
is equivalent to:
<blockquote class="example">
<pre>
(defun floor (number &amp;optional (divisor 1))
  (the (values integer real)
       ...))
</pre></blockquote>
In addition to being recognized by <tt class="code">lambda</tt>
(and hence by <tt class="code">defun</tt>), the <tt class=
"code">values</tt> declaration is recognized by all the other
special forms with bodies and declarations: <tt class=
"code">let</tt>, <tt class="code">let*</tt>, <tt class=
"code">labels</tt> and <tt class="code">flet</tt>. Macros with
declarations usually splice the declarations into one of the above
forms, so they will accept this declaration too, but the exact
effect of a <tt class="code">values</tt> declaration will depend on
the macro.<br>
<br>
If you declare the types of all arguments to a function, and also
declare the return value types with <tt class="code">values</tt>,
you have described the type of the function. Python will use this
argument and result type information to derive a function type that
will then be applied to calls of the function (see
section&nbsp;<a href="#function-types">5.2.6</a>.) This provides a
way to declare the types of functions that is much less
syntactically awkward than using the <tt class="code">ftype</tt>
declaration with a <tt class="code">function</tt> type
specifier.<br>
<br>
Although the <tt class="code">values</tt> declaration is
non-standard, it is relatively harmless to use it in otherwise
portable code, since any warning in non-CMU implementations can be
suppressed with the standard <tt class="code">declaration</tt>
proclamation.<br>
<br>
<!--TOC subsection Structure Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc140" id="htoc140"><b><font size=
"4">5.2.8</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Structure
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="structure-types" id="structure-types"></a> <a name=
"@concept147"></a> <a name="@concept148"></a> <a name=
"@concept149"></a><br>
Because of precise type checking, structure types are much better
supported by Python than by conventional compilers:
<ul>
<li>The structure argument to structure accessors is precisely
checked---if you call <tt class="code">foo-a</tt> on a <tt class=
"code">bar</tt>, an error will be signaled.<br>
<br></li>
<li>The types of slot values are precisely checked---if you pass
the wrong type argument to a constructor or a slot setter, then an
error will be signaled.</li>
</ul>
This error checking is tremendously useful for detecting bugs in
programs that manipulate complex data structures.<br>
<br>
An additional advantage of checking structure types and enforcing
slot types is that the compiler can safely believe slot type
declarations. Python effectively moves the type checking from the
slot access to the slot setter or constructor call. This is more
efficient since caller of the setter or constructor often knows the
type of the value, entirely eliminating the need to check the
value's type. Consider this example:
<blockquote class="lisp">
<pre>
(defstruct coordinate
  (x nil :type single-float)
  (y nil :type single-float))

(defun make-it ()
  (make-coordinate :x 1.0 :y 1.0))

(defun use-it (it)
  (declare (type coordinate it))
  (sqrt (expt (coordinate-x it) 2) (expt (coordinate-y it) 2)))
</pre></blockquote>
<br>
<br>
<tt class="code">make-it</tt> and <tt class="code">use-it</tt> are
compiled with no checking on the types of the float slots, yet
<tt class="code">use-it</tt> can use <tt class=
"code">single-float</tt> arithmetic with perfect safety. Note that
<tt class="code">make-coordinate</tt> must still check the values
of <tt class="code">x</tt> and <tt class="code">y</tt> unless the
call is block compiled or inline expanded (see
section&nbsp;<a href="#local-call">5.6</a>.) But even without this
advantage, it is almost always more efficient to check slot values
on structure initialization, since slots are usually written once
and read many times.<br>
<br>
<!--TOC subsection The Freeze-Type Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc141" id="htoc141"><b><font size=
"4">5.2.9</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Freeze-Type
Declaration</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept150"></a> <a name="freeze-type" id=
"freeze-type"></a><br>
The <tt class="code">extensions:freeze-type</tt> declaration is a
CMUCL extension that enables more efficient compilation of
user-defined types by asserting that the definition is not going to
change. This declaration may only be used globally (with <tt class=
"code">declaim</tt> or <tt class="code">proclaim</tt>). Currently
<tt class="code">freeze-type</tt> only affects structure type
testing done by <tt class="code">typep</tt>, <tt class=
"code">typecase</tt>, etc. Here is an example:
<blockquote class="lisp">
<pre>
(declaim (freeze-type foo bar))
</pre></blockquote>
This asserts that the types <tt class="code">foo</tt> and
<tt class="code">bar</tt> and their subtypes are not going to
change. This allows more efficient type testing, since the compiler
can open-code a test for all possible subtypes, rather than having
to examine the type hierarchy at run-time.<br>
<br>
<!--TOC subsection Type Restrictions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc142" id="htoc142"><b><font size=
"4">5.2.10</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Type
Restrictions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept151"></a><br>
Avoid use of the <tt class="code">and</tt>, <tt class=
"code">not</tt> and <tt class="code">satisfies</tt> types in
declarations, since type inference has problems with them. When
these types do appear in a declaration, they are still checked
precisely, but the type information is of limited use to the
compiler. <tt class="code">and</tt> types are effective as long as
the intersection can be canonicalized to a type that doesn't use
<tt class="code">and</tt>. For example:
<blockquote class="example">
<pre>
(and fixnum unsigned-byte)
</pre></blockquote>
is fine, since it is the same as:
<blockquote class="example">
<pre>
(integer 0 <tt class="variable">most-positive-fixnum</tt>)
</pre></blockquote>
but this type:
<blockquote class="example">
<pre>
(and symbol (not (member :end)))
</pre></blockquote>
will not be fully understood by type interference since the
<tt class="code">and</tt> can't be removed by canonicalization.<br>
<br>
Using any of these type specifiers in a type test with <tt class=
"code">typep</tt> or <tt class="code">typecase</tt> is fine, since
as tests, these types can be translated into the <tt class=
"code">and</tt> macro, the <tt class="code">not</tt> function or a
call to the satisfies predicate.<br>
<br>
<!--TOC subsection Type Style Recommendations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc143" id="htoc143"><b><font size=
"4">5.2.11</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Type Style
Recommendations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept152"></a><br>
Python provides good support for some currently unconventional ways
of using the Common Lisp type system. With Python, it is desirable
to make declarations as precise as possible, but type inference
also makes some declarations unnecessary. Here are some general
guidelines for maximum robustness and efficiency:
<ul>
<li>Declare the types of all function arguments and structure slots
as precisely as possible (while avoiding <tt class="code">not</tt>,
<tt class="code">and</tt> and <tt class="code">satisfies</tt>). Put
these declarations in during initial coding so that type assertions
can find bugs for you during debugging.<br>
<br></li>
<li>Use the <a name="@types27"></a><tt class="code">member</tt>
type specifier where there are a small number of possible symbol
values, for example: <tt class="code">(member :red :blue
:green)</tt>.<br>
<br></li>
<li>Use the <a name="@types28"></a><tt class="code">or</tt> type
specifier in situations where the type is not certain, but there
are only a few possibilities, for example: <tt class="code">(or
list vector)</tt>.<br>
<br></li>
<li>Declare integer types with the tightest bounds that you can,
such as <tt class="code">(integer 3 7)</tt>.<br>
<br></li>
<li>Define <a name="@funs121"></a><tt class="code">deftype</tt> or
<a name="@funs122"></a><tt class="code">defstruct</tt> types before
they are used. Definition after use is legal (producing no
``undefined type'' warnings), but type tests and structure
operations will be compiled much less efficiently.<br>
<br></li>
<li>Use the <tt class="code">extensions:freeze-type</tt>
declaration to speed up type testing for structure types which
won't have new subtypes added later. See section&nbsp;<a href=
"#freeze-type">5.2.9</a><br>
<br></li>
<li>In addition to declaring the array element type and simpleness,
also declare the dimensions if they are fixed, for example:
<blockquote class="example">
<pre>
    (simple-array single-float (1024 1024))
  
</pre></blockquote>
This bounds information allows array indexing for multi-dimensional
arrays to be compiled much more efficiently, and may also allow
array bounds checking to be done at compile time. See
section&nbsp;<a href="#array-types">5.10.3</a>.<br>
<br></li>
<li>Avoid use of the <a name="@funs123"></a><tt class=
"code">the</tt> declaration within expressions. Not only does it
clutter the code, but it is also almost worthless under safe
policies. If the need for an output type assertion is revealed by
efficiency notes during tuning, then you can consider <tt class=
"code">the</tt>, but it is preferable to constrain the argument
types more, allowing the compiler to prove the desired result
type.<br>
<br></li>
<li>Don't bother declaring the type of <a name=
"@funs124"></a><tt class="code">let</tt> or other non-argument
variables unless the type is non-obvious. If you declare function
return types and structure slot types, then the type of a variable
is often obvious both to the programmer and to the compiler. An
important case where the type isn't obvious, and a declaration is
appropriate, is when the value for a variable is pulled out of
untyped structure (e.g., the result of <tt class="code">car</tt>),
or comes from some weakly typed function, such as <tt class=
"code">read</tt>.<br>
<br></li>
<li>Declarations are sometimes necessary for integer loop
variables, since the compiler can't always prove that the value is
of a good integer type. These declarations are best added during
tuning, when an efficiency note indicates the need.</li>
</ul>
<!--TOC section Type Inference-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc144" id="htoc144"><b><font size=
"5">5.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Type
Inference</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="type-inference" id="type-inference"></a> <a name=
"@concept153"></a> <a name="@concept154"></a> <a name=
"@concept155"></a><br>
Type inference is the process by which the compiler tries to figure
out the types of expressions and variables, given an inevitable
lack of complete type information. Although Python does much more
type inference than most Common Lisp compilers, remember that the
more precise and comprehensive type declarations are, the more type
inference will be able to do.<br>
<br>
<!--TOC subsection Variable Type Inference-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc145" id="htoc145"><b><font size=
"4">5.3.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Variable Type
Inference</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="variable-type-inference" id=
"variable-type-inference"></a><br>
The type of a variable is the union of the types of all the
definitions. In the degenerate case of a let, the type of the
variable is the type of the initial value. This inferred type is
intersected with any declared type, and is then propagated to all
the variable's references. The types of <a name=
"@funs125"></a><tt class="code">multiple-value-bind</tt> variables
are similarly inferred from the types of the individual values of
the values form.<br>
<br>
If multiple type declarations apply to a single variable, then all
the declarations must be correct; it is as though all the types
were intersected producing a single <a name=
"@types29"></a><tt class="code">and</tt> type specifier. In this
example:
<blockquote class="example">
<pre>
(defmacro my-dotimes ((var count) &amp;body body)
  `(do ((,var 0 (1+ ,var)))
       ((&gt;= ,var ,count))
     (declare (type (integer 0 *) ,var))
     ,@body))

(my-dotimes (i ...)
  (declare (fixnum i))
  ...)
</pre></blockquote>
the two declarations for <tt class="code">i</tt> are intersected,
so <tt class="code">i</tt> is known to be a non-negative
fixnum.<br>
<br>
In practice, this type inference is limited to lets and local
functions, since the compiler can't analyze all the calls to a
global function. But type inference works well enough on local
variables so that it is often unnecessary to declare the type of
local variables. This is especially likely when function result
types and structure slot types are declared. The main areas where
type inference breaks down are:
<ul>
<li>When the initial value of a variable is a untyped expression,
such as <tt class="code">(car x)</tt>, and<br>
<br></li>
<li>When the type of one of the variable's definitions is a
function of the variable's current value, as in: <tt class=
"code">(setq x (1+ x))</tt></li>
</ul>
<!--TOC subsection Local Function Type Inference-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc146" id="htoc146"><b><font size=
"4">5.3.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Local Function
Type Inference</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept156"></a><br>
The types of arguments to local functions are inferred in the same
was as any other local variable; the type is the union of the
argument types across all the calls to the function, intersected
with the declared type. If there are any assignments to the
argument variables, the type of the assigned value is unioned in as
well.<br>
<br>
The result type of a local function is computed in a special way
that takes tail recursion (see section&nbsp;<a href=
"#tail-recursion">5.5</a>) into consideration. The result type is
the union of all possible return values that aren't tail-recursive
calls. For example, Python will infer that the result type of this
function is <tt class="code">integer</tt>:
<blockquote class="lisp">
<pre>
(defun ! (n res)
  (declare (integer n res))
  (if (zerop n)
      res
      (! (1- n) (* n res))))
</pre></blockquote>
Although this is a rather obvious result, it becomes somewhat less
trivial in the presence of mutual tail recursion of multiple
functions. Local function result type inference interacts with the
mechanisms for ensuring proper tail recursion mentioned in section
<a href="#local-call-return">5.6.5</a>.<br>
<br>
<!--TOC subsection Global Function Type Inference-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc147" id="htoc147"><b><font size=
"4">5.3.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Global Function
Type Inference</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="function-type-inference" id="function-type-inference"></a>
<a name="@concept157"></a><br>
As described in section <a href="#function-types">5.2.6</a>, a
global function type (<a name="@types30"></a><tt class=
"code">ftype</tt>) declaration places implicit type assertions on
the call arguments, and also guarantees the type of the return
value. So wherever a call to a declared function appears, there is
no doubt as to the types of the arguments and return value.
Furthermore, Python will infer a function type from the function's
definition if there is no <tt class="code">ftype</tt> declaration.
Any type declarations on the argument variables are used as the
argument types in the derived function type, and the compiler's
best guess for the result type of the function is used as the
result type in the derived function type.<br>
<br>
This method of deriving function types from the definition
implicitly assumes that functions won't be redefined at run-time.
Consider this example:
<blockquote class="lisp">
<pre>
(defun foo-p (x)
  (let ((res (and (consp x) (eq (car x) 'foo))))
    (format t "It is ~:[not ~;~]foo." res)))

(defun frob (it)
  (if (foo-p it)
      (setf (cadr it) 'yow!)
      (1+ it)))
</pre></blockquote>
Presumably, the programmer really meant to return <tt class=
"code">res</tt> from <tt class="code">foo-p</tt>, but he seems to
have forgotten. When he tries to call do <tt class="code">(frob
(list 'foo nil))</tt>, <tt class="code">frob</tt> will flame out
when it tries to add to a <tt class="code">cons</tt>. Realizing his
error, he fixes <tt class="code">foo-p</tt> and recompiles it. But
when he retries his test case, he is baffled because the error is
still there. What happened in this example is that Python proved
that the result of <tt class="code">foo-p</tt> is <tt class=
"code">null</tt>, and then proceeded to optimize away the
<tt class="code">setf</tt> in <tt class="code">frob</tt>.<br>
<br>
Fortunately, in this example, the error is detected at compile time
due to notes about unreachable code (see section&nbsp;<a href=
"#dead-code-notes">5.4.5</a>.) Still, some users may not want to
worry about this sort of problem during incremental development, so
there is a variable to control deriving function types.<br>
<br>
<br>
<a name="@vars47"></a><a name="VR:derive-function-types" id=
"VR:derive-function-types"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*derive-function-types*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
If true (the default), argument and result type information derived
from compilation of <tt class="code">defun</tt>s is used when
compiling calls to that function. If false, only information from
<tt class="code">ftype</tt> proclamations will be
used.</blockquote>
<!--TOC subsection Operation Specific Type Inference-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc148" id="htoc148"><b><font size=
"4">5.3.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Operation
Specific Type Inference</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="operation-type-inference" id=
"operation-type-inference"></a> <a name="@concept158"></a> <a name=
"@concept159"></a> <a name="@concept160"></a><br>
Many of the standard Common Lisp functions have special type
inference procedures that determine the result type as a function
of the argument types. For example, the result type of <tt class=
"code">aref</tt> is the array element type. Here are some other
examples of type inferences:
<blockquote class="lisp">
<pre>
(logand x #xFF) ==&gt; (unsigned-byte 8)

(+ (the (integer 0 12) x) (the (integer 0 1) y)) ==&gt; (integer 0 13)

(ash (the (unsigned-byte 16) x) -8) ==&gt; (unsigned-byte 8)
</pre></blockquote>
<!--TOC subsection Dynamic Type Inference-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc149" id="htoc149"><b><font size=
"4">5.3.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Dynamic Type
Inference</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="constraint-propagation" id="constraint-propagation"></a>
<a name="@concept161"></a> <a name="@concept162"></a> <a name=
"@concept163"></a><br>
Python uses flow analysis to infer types in dynamically typed
programs. For example:
<blockquote class="example">
<pre>
(ecase x
  (list (length x))
  ...)
</pre></blockquote>
Here, the compiler knows the argument to <tt class=
"code">length</tt> is a list, because the call to <tt class=
"code">length</tt> is only done when <tt class="code">x</tt> is a
list. The most significant efficiency effect of inference from
assertions is usually in type check optimization.<br>
<br>
Dynamic type inference has two inputs: explicit conditionals and
implicit or explicit type assertions. Flow analysis propagates
these constraints on variable type to any code that can be executed
only after passing though the constraint. Explicit type constraints
come from <a name="@funs126"></a><tt class="code">if</tt>s where
the test is either a lexical variable or a function of lexical
variables and constants, where the function is either a type
predicate, a numeric comparison or <tt class="code">eq</tt>.<br>
<br>
If there is an <tt class="code">eq</tt> (or <tt class=
"code">eql</tt>) test, then the compiler will actually substitute
one argument for the other in the true branch. For example:
<blockquote class="lisp">
<pre>
(when (eq x :yow!) (return x))
</pre></blockquote>
becomes:
<blockquote class="lisp">
<pre>
(when (eq x :yow!) (return :yow!))
</pre></blockquote>
This substitution is done when one argument is a constant, or one
argument has better type information than the other. This
transformation reveals opportunities for constant folding or
type-specific optimizations. If the test is against a constant,
then the compiler can prove that the variable is not that constant
value in the false branch, or <tt class="code">(not (member
:yow!))</tt> in the example above. This can eliminate redundant
tests, for example:
<blockquote class="example">
<pre>
(if (eq x nil)
    ...
    (if x a b))
</pre></blockquote>
is transformed to this:
<blockquote class="example">
<pre>
(if (eq x nil)
    ...
    a)
</pre></blockquote>
Variables appearing as <tt class="code">if</tt> tests are
interpreted as <tt class="code">(not (eq <tt class=
"variable">var</tt> nil))</tt> tests. The compiler also converts
<tt class="code">=</tt> into <tt class="code">eql</tt> where
possible. It is difficult to do inference directly on <tt class=
"code">=</tt> since it does implicit coercions.<br>
<br>
When there is an explicit or test on numeric variables, the
compiler makes inferences about the ranges the variables can assume
in the true and false branches. This is mainly useful when it
proves that the values are small enough in magnitude to allow
open-coding of arithmetic operations. For example, in many uses of
<tt class="code">dotimes</tt> with a <tt class="code">fixnum</tt>
repeat count, the compiler proves that fixnum arithmetic can be
used.<br>
<br>
Implicit type assertions are quite common, especially if you
declare function argument types. Dynamic inference from implicit
type assertions sometimes helps to disambiguate programs to a
useful degree, but is most noticeable when it detects a dynamic
type error. For example:
<blockquote class="lisp">
<pre>
(defun foo (x)
  (+ (car x) x))
</pre></blockquote>
results in this warning:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (+ (CAR X) X)
==&gt;
  X
Warning: Result is a LIST, not a NUMBER.
</pre></blockquote>
Note that Common Lisp's dynamic type checking semantics make
dynamic type inference useful even in programs that aren't really
dynamically typed, for example:
<blockquote class="lisp">
<pre>
(+ (car x) (length x))
</pre></blockquote>
Here, <tt class="code">x</tt> presumably always holds a list, but
in the absence of a declaration the compiler cannot assume
<tt class="code">x</tt> is a list simply because list-specific
operations are sometimes done on it. The compiler must consider the
program to be dynamically typed until it proves otherwise. Dynamic
type inference proves that the argument to <tt class=
"code">length</tt> is always a list because the call to <tt class=
"code">length</tt> is only done after the list-specific <tt class=
"code">car</tt> operation.<br>
<br>
<!--TOC subsection Type Check Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc150" id="htoc150"><b><font size=
"4">5.3.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Type Check
Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="type-check-optimization" id="type-check-optimization"></a>
<a name="@concept164"></a> <a name="@concept165"></a><br>
Python backs up its support for precise type checking by minimizing
the cost of run-time type checking. This is done both through type
inference and though optimizations of type checking itself.<br>
<br>
Type inference often allows the compiler to prove that a value is
of the correct type, and thus no type check is necessary. For
example:
<blockquote class="lisp">
<pre>
(defstruct foo a b c)
(defstruct link
  (foo (required-argument) :type foo)
  (next nil :type (or link null)))

(foo-a (link-foo x))
</pre></blockquote>
Here, there is no need to check that the result of <tt class=
"code">link-foo</tt> is a <tt class="code">foo</tt>, since it
always is. Even when some type checks are necessary, type inference
can often reduce the number:
<blockquote class="example">
<pre>
(defun test (x)
  (let ((a (foo-a x))
        (b (foo-b x))
        (c (foo-c x)))
    ...))
</pre></blockquote>
In this example, only one <tt class="code">(foo-p x)</tt> check is
needed. This applies to a lesser degree in list operations, such
as:
<blockquote class="lisp">
<pre>
(if (eql (car x) 3) (cdr x) y)
</pre></blockquote>
Here, we only have to check that <tt class="code">x</tt> is a list
once.<br>
<br>
Since Python recognizes explicit type tests, code that explicitly
protects itself against type errors has little introduced overhead
due to implicit type checking. For example, this loop compiles with
no implicit checks checks for <tt class="code">car</tt> and
<tt class="code">cdr</tt>:
<blockquote class="lisp">
<pre>
(defun memq (e l)
  (do ((current l (cdr current)))
      ((atom current) nil)
    (when (eq (car current) e) (return current))))
</pre></blockquote>
<a name="@concept166"></a> Python reduces the cost of checks that
must be done through an optimization called <tt class=
"variable">complementing</tt>. A complemented check for <tt class=
"variable">type</tt> is simply a check that the value is not of the
type <tt class="code">(not <tt class="variable">type</tt>)</tt>.
This is only interesting when something is known about the actual
type, in which case we can test for the complement of <tt class=
"code">(and <tt class="variable">known-type</tt> (not <tt class=
"variable">type</tt>))</tt>, or the difference between the known
type and the assertion. An example:
<blockquote class="lisp">
<pre>
(link-foo (link-next x))
</pre></blockquote>
Here, we change the type check for <tt class="code">link-foo</tt>
from a test for <tt class="code">foo</tt> to a test for:
<blockquote class="lisp">
<pre>
(not (and (or foo null) (not foo)))
</pre></blockquote>
or more simply <tt class="code">(not null)</tt>. This is probably
the most important use of complementing, since the situation is
fairly common, and a <tt class="code">null</tt> test is much
cheaper than a structure type test.<br>
<br>
Here is a more complicated example that illustrates the combination
of complementing with dynamic type inference:
<blockquote class="lisp">
<pre>
(defun find-a (a x)
  (declare (type (or link null) x))
  (do ((current x (link-next current)))
      ((null current) nil)
    (let ((foo (link-foo current)))
      (when (eq (foo-a foo) a) (return foo)))))
</pre></blockquote>
This loop can be compiled with no type checks. The <tt class=
"code">link</tt> test for <tt class="code">link-foo</tt> and
<tt class="code">link-next</tt> is complemented to <tt class=
"code">(not null)</tt>, and then deleted because of the explicit
<tt class="code">null</tt> test. As before, no check is necessary
for <tt class="code">foo-a</tt>, since the <tt class=
"code">link-foo</tt> is always a <tt class="code">foo</tt>. This
sort of situation shows how precise type checking combined with
precise declarations can actually result in reduced type
checking.<br>
<br>
<!--TOC section Source Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc151" id="htoc151"><b><font size=
"5">5.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Source
Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="source-optimization" id="source-optimization"></a>
<a name="@concept167"></a><br>
This section describes source-level transformations that Python
does on programs in an attempt to make them more efficient.
Although source-level optimizations can make existing programs more
efficient, the biggest advantage of this sort of optimization is
that it makes it easier to write efficient programs. If a clean,
straightforward implementation is can be transformed into an
efficient one, then there is no need for tricky and dangerous hand
optimization.<br>
<br>
<!--TOC subsection Let Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc152" id="htoc152"><b><font size=
"4">5.4.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Let
Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="let-optimization" id="let-optimization"></a><br>
<a name="@concept168"></a> <a name="@concept169"></a><br>
The primary optimization of let variables is to delete them when
they are unnecessary. Whenever the value of a let variable is a
constant, a constant variable or a constant (local or
non-notinline) function, the variable is deleted, and references to
the variable are replaced with references to the constant
expression. This is useful primarily in the expansion of macros or
inline functions, where argument values are often constant in any
given call, but are in general non-constant expressions that must
be bound to preserve order of evaluation. Let variable optimization
eliminates the need for macros to carefully avoid spurious
bindings, and also makes inline functions just as efficient as
macros.<br>
<br>
A particularly interesting class of constant is a local function.
Substituting for lexical variables that are bound to a function can
substantially improve the efficiency of functional programming
styles, for example:
<blockquote class="lisp">
<pre>
(let ((a #'(lambda (x) (zow x))))
  (funcall a 3))
</pre></blockquote>
effectively transforms to:
<blockquote class="lisp">
<pre>
(zow 3)
</pre></blockquote>
This transformation is done even when the function is a closure, as
in:
<blockquote class="lisp">
<pre>
(let ((a (let ((y (zug)))
           #'(lambda (x) (zow x y)))))
  (funcall a 3))
</pre></blockquote>
becoming:
<blockquote class="lisp">
<pre>
(zow 3 (zug))
</pre></blockquote>
A constant variable is a lexical variable that is never assigned
to, always keeping its initial value. Whenever possible, avoid
setting lexical variables---instead bind a new variable to the new
value. Except for loop variables, it is almost always possible to
avoid setting lexical variables. This form:
<blockquote class="example">
<pre>
(let ((x (f x)))
  ...)
</pre></blockquote>
is <tt class="variable">more</tt> efficient than this form:
<blockquote class="example">
<pre>
(setq x (f x))
...
</pre></blockquote>
Setting variables makes the program more difficult to understand,
both to the compiler and to the programmer. Python compiles
assignments at least as efficiently as any other Common Lisp
compiler, but most let optimizations are only done on constant
variables.<br>
<br>
Constant variables with only a single use are also optimized away,
even when the initial value is not constant.<sup><a name="text11"
href="#note11" id="text11"><font size="2">1</font></a></sup> For
example, this expansion of <tt class="code">incf</tt>:
<blockquote class="lisp">
<pre>
(let ((#:g3 (+ x 1)))
  (setq x #:G3))
</pre></blockquote>
becomes:
<blockquote class="lisp">
<pre>
(setq x (+ x 1))
</pre></blockquote>
The type semantics of this transformation are more important than
the elimination of the variable itself. Consider what happens when
<tt class="code">x</tt> is declared to be a <tt class=
"code">fixnum</tt>; after the transformation, the compiler can
compile the addition knowing that the result is a <tt class=
"code">fixnum</tt>, whereas before the transformation the addition
would have to allow for fixnum overflow.<br>
<br>
Another variable optimization deletes any variable that is never
read. This causes the initial value and any assigned values to be
unused, allowing those expressions to be deleted if they have no
side-effects.<br>
<br>
Note that a let is actually a degenerate case of local call (see
section&nbsp;<a href="#let-calls">5.6.2</a>), and that let
optimization can be done on calls that weren't created by a let.
Also, local call allows an applicative style of iteration that is
totally assignment free.<br>
<br>
<!--TOC subsection Constant Folding-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc153" id="htoc153"><b><font size=
"4">5.4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Constant
Folding</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept170"></a> <a name="@concept171"></a><br>
Constant folding is an optimization that replaces a call of
constant arguments with the constant result of that call. Constant
folding is done on all standard functions for which it is legal.
Inline expansion allows folding of any constant parts of the
definition, and can be done even on functions that have
side-effects.<br>
<br>
It is convenient to rely on constant folding when programming, as
in this example:
<blockquote class="example">
<pre>
(defconstant limit 42)

(defun foo ()
  (... (1- limit) ...))
</pre></blockquote>
Constant folding is also helpful when writing macros or inline
functions, since it usually eliminates the need to write a macro
that special-cases constant arguments.<br>
<br>
<a name="@concept172"></a> Constant folding of a user defined
function is enabled by the <tt class=
"code">extensions:constant-function</tt> proclamation. In this
example:
<blockquote class="example">
<pre>
(declaim (ext:constant-function myfun))
(defun myexp (x y)
  (declare (single-float x y))
  (exp (* (log x) y)))

 ... (myexp 3.0 1.3) ...
</pre></blockquote>
The call to <tt class="code">myexp</tt> is constant-folded to
<tt class="code">4.1711674</tt>.<br>
<br>
<!--TOC subsection Unused Expression Elimination-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc154" id="htoc154"><b><font size=
"4">5.4.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Unused Expression
Elimination</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept173"></a> <a name="@concept174"></a><br>
If the value of any expression is not used, and the expression has
no side-effects, then it is deleted. As with constant folding, this
optimization applies most often when cleaning up after inline
expansion and other optimizations. Any function declared an
<tt class="code">extensions:constant-function</tt> is also subject
to unused expression elimination.<br>
<br>
Note that Python will eliminate parts of unused expressions known
to be side-effect free, even if there are other unknown parts. For
example:
<blockquote class="lisp">
<pre>
(let ((a (list (foo) (bar))))
  (if t
      (zow)
      (raz a)))
</pre></blockquote>
becomes:
<blockquote class="lisp">
<pre>
(progn (foo) (bar))
(zow)
</pre></blockquote>
<!--TOC subsection Control Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc155" id="htoc155"><b><font size=
"4">5.4.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Control
Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept175"></a> <a name="@concept176"></a><br>
The most important optimization of control is recognizing when an
<a name="@funs127"></a><tt class="code">if</tt> test is known at
compile time, then deleting the <tt class="code">if</tt>, the test
expression, and the unreachable branch of the <tt class=
"code">if</tt>. This can be considered a special case of constant
folding, although the test doesn't have to be truly constant as
long as it is definitely not <tt class="code">nil</tt>. Note also,
that type inference propagates the result of an <tt class=
"code">if</tt> test to the true and false branches, see
section&nbsp;<a href="#constraint-propagation">5.3.5</a>.<br>
<br>
A related <tt class="code">if</tt> optimization is this
transformation:<sup><a name="text12" href="#note12" id=
"text12"><font size="2">2</font></a></sup>
<blockquote class="lisp">
<pre>
(if (if a b c) x y)
</pre></blockquote>
into:
<blockquote class="lisp">
<pre>
(if a
    (if b x y)
    (if c x y))
</pre></blockquote>
The opportunity for this sort of optimization usually results from
a conditional macro. For example:
<blockquote class="lisp">
<pre>
(if (not a) x y)
</pre></blockquote>
is actually implemented as this:
<blockquote class="lisp">
<pre>
(if (if a nil t) x y)
</pre></blockquote>
which is transformed to this:
<blockquote class="lisp">
<pre>
(if a
    (if nil x y)
    (if t x y))
</pre></blockquote>
which is then optimized to this:
<blockquote class="lisp">
<pre>
(if a y x)
</pre></blockquote>
Note that due to Python's internal representations, the <tt class=
"code">if</tt>---<tt class="code">if</tt> situation will be
recognized even if other forms are wrapped around the inner
<tt class="code">if</tt>, like:
<blockquote class="example">
<pre>
(if (let ((g ...))
      (loop
        ...
        (return (not g))
        ...))
    x y)
</pre></blockquote>
In Python, all the Common Lisp macros really are macros, written in
terms of <tt class="code">if</tt>, <tt class="code">block</tt> and
<tt class="code">tagbody</tt>, so user-defined control macros can
be just as efficient as the standard ones. Python emits basic
blocks using a heuristic that minimizes the number of unconditional
branches. The code in a <tt class="code">tagbody</tt> will not be
emitted in the order it appeared in the source, so there is no
point in arranging the code to make control drop through to the
target.<br>
<br>
<!--TOC subsection Unreachable Code Deletion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc156" id="htoc156"><b><font size=
"4">5.4.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Unreachable Code
Deletion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="dead-code-notes" id="dead-code-notes"></a> <a name=
"@concept177"></a> <a name="@concept178"></a><br>
Python will delete code whenever it can prove that the code can
never be executed. Code becomes unreachable when:
<ul>
<li>An <tt class="code">if</tt> is optimized away, or<br>
<br></li>
<li>There is an explicit unconditional control transfer such as
<tt class="code">go</tt> or <tt class="code">return-from</tt>,
or<br>
<br></li>
<li>The last reference to a local function is deleted (or there
never was any reference.)</li>
</ul>
When code that appeared in the original source is deleted, the
compiler prints a note to indicate a possible problem (or at least
unnecessary code.) For example:
<blockquote class="lisp">
<pre>
(defun foo ()
  (if t
      (write-line "True.")
      (write-line "False.")))
</pre></blockquote>
will result in this note:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (WRITE-LINE "False.")
Note: Deleting unreachable code.
</pre></blockquote>
It is important to pay attention to unreachable code notes, since
they often indicate a subtle type error. For example:
<blockquote class="example">
<pre>
(defstruct foo a b)

(defun lose (x)
  (let ((a (foo-a x))
        (b (if x (foo-b x) :none)))
    ...))
</pre></blockquote>
results in this note:
<blockquote class="example">
<pre>
In: DEFUN LOSE
  (IF X (FOO-B X) :NONE)
==&gt;
  :NONE
Note: Deleting unreachable code.
</pre></blockquote>
The <tt class="code">:none</tt> is unreachable, because type
inference knows that the argument to <tt class="code">foo-a</tt>
must be a <tt class="code">foo</tt>, and thus can't be <tt class=
"code">nil</tt>. Presumably the programmer forgot that <tt class=
"code">x</tt> could be <tt class="code">nil</tt> when he wrote the
binding for <tt class="code">a</tt>.<br>
<br>
Here is an example with an incorrect declaration:
<blockquote class="lisp">
<pre>
(defun count-a (string)
  (do ((pos 0 (position #\a string :start (1+ pos)))
       (count 0 (1+ count)))
      ((null pos) count)
    (declare (fixnum pos))))
</pre></blockquote>
This time our note is:
<blockquote class="example">
<pre>
In: DEFUN COUNT-A
  (DO ((POS 0 #) (COUNT 0 #))
      ((NULL POS) COUNT)
    (DECLARE (FIXNUM POS)))
--&gt; BLOCK LET TAGBODY RETURN-FROM PROGN 
==&gt;
  COUNT
Note: Deleting unreachable code.
</pre></blockquote>
The problem here is that <tt class="code">pos</tt> can never be
null since it is declared a <tt class="code">fixnum</tt>.<br>
<br>
It takes some experience with unreachable code notes to be able to
tell what they are trying to say. In non-obvious cases, the best
thing to do is to call the function in a way that should cause the
unreachable code to be executed. Either you will get a type error,
or you will find that there truly is no way for the code to be
executed.<br>
<br>
Not all unreachable code results in a note:
<ul>
<li>A note is only given when the unreachable code textually
appears in the original source. This prevents spurious notes due to
the optimization of macros and inline functions, but sometimes also
foregoes a note that would have been useful.<br>
<br></li>
<li>Since accurate source information is not available for non-list
forms, there is an element of heuristic in determining whether or
not to give a note about an atom. Spurious notes may be given when
a macro or inline function defines a variable that is also present
in the calling function. Notes about <tt class="code">nil</tt> and
<tt class="code">t</tt> are never given, since it is too easy to
confuse these constants in expanded code with ones in the original
source.<br>
<br></li>
<li>Notes are only given about code unreachable due to control
flow. There is no note when an expression is deleted because its
value is unused, since this is a common consequence of other
optimizations.</li>
</ul>
Somewhat spurious unreachable code notes can also result when a
macro inserts multiple copies of its arguments in different
contexts, for example:
<blockquote class="lisp">
<pre>
(defmacro t-and-f (var form)
  `(if ,var ,form ,form))

(defun foo (x)
  (t-and-f x (if x "True." "False.")))
</pre></blockquote>
results in these notes:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (IF X "True." "False.")
==&gt;
  "False."
Note: Deleting unreachable code.

==&gt;
  "True."
Note: Deleting unreachable code.
</pre></blockquote>
It seems like it has deleted both branches of the <tt class=
"code">if</tt>, but it has really deleted one branch in one copy,
and the other branch in the other copy. Note that these messages
are only spurious in not satisfying the intent of the rule that
notes are only given when the deleted code appears in the original
source; there is always <tt class="variable">some</tt> code being
deleted when a unreachable code note is printed.<br>
<br>
<!--TOC subsection Multiple Values Optimization-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc157" id="htoc157"><b><font size=
"4">5.4.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Multiple Values
Optimization</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept179"></a> <a name="@concept180"></a><br>
Within a function, Python implements uses of multiple values
particularly efficiently. Multiple values can be kept in arbitrary
registers, so using multiple values doesn't imply stack
manipulation and representation conversion. For example, this code:
<blockquote class="example">
<pre>
(let ((a (if x (foo x) u))
      (b (if x (bar x) v)))
  ...)
</pre></blockquote>
is actually more efficient written this way:
<blockquote class="example">
<pre>
(multiple-value-bind
    (a b)
    (if x
        (values (foo x) (bar x))
        (values u v))
  ...)
</pre></blockquote>
Also, see section&nbsp;<a href="#local-call-return">5.6.5</a> for
information on how local call provides efficient support for
multiple function return values.<br>
<br>
<!--TOC subsection Source to Source Transformation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc158" id="htoc158"><b><font size=
"4">5.4.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Source to Source
Transformation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept181"></a> <a name="@concept182"></a><br>
The compiler implements a number of operation-specific
optimizations as source-to-source transformations. You will often
see unfamiliar code in error messages, for example:
<blockquote class="lisp">
<pre>
(defun my-zerop () (zerop x))
</pre></blockquote>
gives this warning:
<blockquote class="example">
<pre>
In: DEFUN MY-ZEROP
  (ZEROP X)
==&gt;
  (= X 0)
Warning: Undefined variable: X
</pre></blockquote>
The original <tt class="code">zerop</tt> has been transformed into
a call to <tt class="code">=</tt>. This transformation is indicated
with the same <tt class="code">==&gt;</tt> used to mark macro and
function inline expansion. Although it can be confusing, display of
the transformed source is important, since warnings are given with
respect to the transformed source. This a more obscure example:
<blockquote class="lisp">
<pre>
(defun foo (x) (logand 1 x))
</pre></blockquote>
gives this efficiency note:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (LOGAND 1 X)
==&gt;
  (LOGAND C::Y C::X)
Note: Forced to do static-function Two-arg-and (cost 53).
      Unable to do inline fixnum arithmetic (cost 1) because:
      The first argument is a INTEGER, not a FIXNUM.
      etc.
</pre></blockquote>
Here, the compiler commuted the call to <tt class=
"code">logand</tt>, introducing temporaries. The note complains
that the <tt class="variable">first</tt> argument is not a
<tt class="code">fixnum</tt>, when in the original call, it was the
second argument. To make things more confusing, the compiler
introduced temporaries called <tt class="code">c::x</tt> and
<tt class="code">c::y</tt> that are bound to <tt class=
"code">y</tt> and <tt class="code">1</tt>, respectively.<br>
<br>
You will also notice source-to-source optimizations when efficiency
notes are enabled (see section&nbsp;<a href=
"#efficiency-notes">5.13</a>.) When the compiler is unable to do a
transformation that might be possible if there was more
information, then an efficiency note is printed. For example,
<tt class="code">my-zerop</tt> above will also give this efficiency
note:
<blockquote class="example">
<pre>
In: DEFUN FOO
  (ZEROP X)
==&gt;
  (= X 0)
Note: Unable to optimize because:
      Operands might not be the same type, so can't open code.
</pre></blockquote>
<!--TOC subsection Style Recommendations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc159" id="htoc159"><b><font size=
"4">5.4.8</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Style
Recommendations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept183"></a><br>
Source level optimization makes possible a clearer and more relaxed
programming style:
<ul>
<li>Don't use macros purely to avoid function call. If you want an
inline function, write it as a function and declare it inline. It's
clearer, less error-prone, and works just as well.<br>
<br></li>
<li>Don't write macros that try to ``optimize'' their expansion in
trivial ways such as avoiding binding variables for simple
expressions. The compiler does these optimizations too, and is less
likely to make a mistake.<br>
<br></li>
<li>Make use of local functions (i.e., <tt class="code">labels</tt>
or <tt class="code">flet</tt>) and tail-recursion in places where
it is clearer. Local function call is faster than full call.<br>
<br></li>
<li>Avoid setting local variables when possible. Binding a new
<tt class="code">let</tt> variable is at least as efficient as
setting an existing variable, and is easier to understand, both for
the compiler and the programmer.<br>
<br></li>
<li>Instead of writing similar code over and over again so that it
can be hand customized for each use, define a macro or inline
function, and let the compiler do the work.</li>
</ul>
<!--TOC section Tail Recursion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc160" id="htoc160"><b><font size=
"5">5.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Tail
Recursion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="tail-recursion" id="tail-recursion"></a> <a name=
"@concept184"></a> <a name="@concept185"></a><br>
A call is tail-recursive if nothing has to be done after the the
call returns, i.e. when the call returns, the returned value is
immediately returned from the calling function. In this example,
the recursive call to <tt class="code">myfun</tt> is
tail-recursive:
<blockquote class="lisp">
<pre>
(defun myfun (x)
  (if (oddp (random x))
      (isqrt x)
      (myfun (1- x))))
</pre></blockquote>
Tail recursion is interesting because it is form of recursion that
can be implemented much more efficiently than general recursion. In
general, a recursive call requires the compiler to allocate storage
on the stack at run-time for every call that has not yet returned.
This memory consumption makes recursion unacceptably inefficient
for representing repetitive algorithms having large or unbounded
size. Tail recursion is the special case of recursion that is
semantically equivalent to the iteration constructs normally used
to represent repetition in programs. Because tail recursion is
equivalent to iteration, tail-recursive programs can be compiled as
efficiently as iterative programs.<br>
<br>
So why would you want to write a program recursively when you can
write it using a loop? Well, the main answer is that recursion is a
more general mechanism, so it can express some solutions simply
that are awkward to write as a loop. Some programmers also feel
that recursion is a stylistically preferable way to write loops
because it avoids assigning variables. For example, instead of
writing:
<blockquote class="lisp">
<pre>
(defun fun1 (x)
  something-that-uses-x)

(defun fun2 (y)
  something-that-uses-y)

(do ((x something (fun2 (fun1 x))))
    (nil))
</pre></blockquote>
You can write:
<blockquote class="lisp">
<pre>
(defun fun1 (x)
  (fun2 something-that-uses-x))

(defun fun2 (y)
  (fun1 something-that-uses-y))

(fun1 something)
</pre></blockquote>
The tail-recursive definition is actually more efficient, in
addition to being (arguably) clearer. As the number of functions
and the complexity of their call graph increases, the simplicity of
using recursion becomes compelling. Consider the advantages of
writing a large finite-state machine with separate tail-recursive
functions instead of using a single huge <tt class=
"code">prog</tt>.<br>
<br>
It helps to understand how to use tail recursion if you think of a
tail-recursive call as a <tt class="code">psetq</tt> that assigns
the argument values to the called function's variables, followed by
a <tt class="code">go</tt> to the start of the called function.
This makes clear an inherent efficiency advantage of tail-recursive
call: in addition to not having to allocate a stack frame, there is
no need to prepare for the call to return (e.g., by computing a
return PC.)<br>
<br>
Is there any disadvantage to tail recursion? Other than an increase
in efficiency, the only way you can tell that a call has been
compiled tail-recursively is if you use the debugger. Since a
tail-recursive call has no stack frame, there is no way the
debugger can print out the stack frame representing the call. The
effect is that backtrace will not show some calls that would have
been displayed in a non-tail-recursive implementation. In practice,
this is not as bad as it sounds---in fact it isn't really clearly
worse, just different. See section&nbsp;<a href=
"#debug-tail-recursion">3.3.5</a> for information about the
debugger implications of tail recursion, and how to turn it off for
the sake of more conservative backtrace information.<br>
<br>
In order to ensure that tail-recursion is preserved in arbitrarily
complex calling patterns across separately compiled functions, the
compiler must compile any call in a tail-recursive position as a
tail-recursive call. This is done regardless of whether the program
actually exhibits any sort of recursive calling pattern. In this
example, the call to <tt class="code">fun2</tt> will always be
compiled as a tail-recursive call:
<blockquote class="lisp">
<pre>
(defun fun1 (x)
  (fun2 x))
</pre></blockquote>
So tail recursion doesn't necessarily have anything to do with
recursion as it is normally thought of. See section&nbsp;<a href=
"#local-tail-recursion">5.6.4</a> for more discussion of using tail
recursion to implement loops.<br>
<br>
<!--TOC subsection Tail Recursion Exceptions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc161" id="htoc161"><b><font size=
"4">5.5.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Tail Recursion
Exceptions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Although Python is claimed to be ``properly'' tail-recursive, some
might dispute this, since there are situations where tail recursion
is inhibited:
<ul>
<li>When the call is enclosed by a special binding, or<br>
<br></li>
<li>When the call is enclosed by a <tt class="code">catch</tt> or
<tt class="code">unwind-protect</tt>, or<br>
<br></li>
<li>When the call is enclosed by a <tt class="code">block</tt> or
<tt class="code">tagbody</tt> and the block name or <tt class=
"code">go</tt> tag has been closed over.</li>
</ul>
These dynamic extent binding forms inhibit tail recursion because
they allocate stack space to represent the binding. Shallow-binding
implementations of dynamic scoping also require cleanup code to be
evaluated when the scope is exited.<br>
<br>
In addition, optimization of tail-recursive calls is inhibited when
the <tt class="code">debug</tt> optimization quality is greater
than <tt class="code">2</tt> (see section&nbsp;<a href=
"#debugger-policy">3.6</a>.)<br>
<br>
<!--TOC section Local Call-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc162" id="htoc162"><b><font size=
"5">5.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Local
Call</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="local-call" id="local-call"></a> <a name=
"@concept186"></a> <a name="@concept187"></a> <a name=
"@concept188"></a><br>
Python supports two kinds of function call: full call and local
call. Full call is the standard calling convention; its late
binding and generality make Common Lisp what it is, but create
unavoidable overheads. When the compiler can compile the calling
function and the called function simultaneously, it can use local
call to avoid some of the overhead of full call. Local call is
really a collection of compilation strategies. If some aspect of
call overhead is not needed in a particular local call, then it can
be omitted. In some cases, local call can be totally free. Local
call provides two main advantages to the user:
<ul>
<li>Local call makes the use of the lexical function binding forms
<a name="@funs128"></a><tt class="code">flet</tt> and <a name=
"@funs129"></a><tt class="code">labels</tt> much more efficient. A
local call is always faster than a full call, and in many cases is
much faster.<br>
<br></li>
<li>Local call is a natural approach to <i>block compilation</i>, a
compilation technique that resolves function references at compile
time. Block compilation speeds function call, but increases
compilation times and prevents function redefinition.</li>
</ul>
<!--TOC subsection Self-Recursive Calls-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc163" id="htoc163"><b><font size=
"4">5.6.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Self-Recursive
Calls</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept189"></a><br>
Local call is used when a function defined by <tt class=
"code">defun</tt> calls itself. For example:
<blockquote class="lisp">
<pre>
(defun fact (n)
  (if (zerop n)
      1
      (* n (fact (1- n)))))
</pre></blockquote>
This use of local call speeds recursion, but can also complicate
debugging, since <a name="@funs130"></a><tt class="code">trace</tt>
will only show the first call to <tt class="code">fact</tt>, and
not the recursive calls. This is because the recursive calls
directly jump to the start of the function, and don't indirect
through the <tt class="code">symbol-function</tt>. Self-recursive
local call is inhibited when the <tt class=
"code">:block-compile</tt> argument to <tt class=
"code">compile-file</tt> is <tt class="code">nil</tt> (see
section&nbsp;<a href="#compile-file-block">5.7.3</a>.)<br>
<br>
<!--TOC subsection Let Calls-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc164" id="htoc164"><b><font size=
"4">5.6.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Let
Calls</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="let-calls" id="let-calls"></a> Because local call avoids
unnecessary call overheads, the compiler internally uses local call
to implement some macros and special forms that are not normally
thought of as involving a function call. For example, this
<tt class="code">let</tt>:
<blockquote class="example">
<pre>
(let ((a (foo))
      (b (bar)))
  ...)
</pre></blockquote>
is internally represented as though it was macroexpanded into:
<blockquote class="example">
<pre>
(funcall #'(lambda (a b)
             ...)
         (foo)
         (bar))
</pre></blockquote>
This implementation is acceptable because the simple cases of local
call (equivalent to a <tt class="code">let</tt>) result in good
code. This doesn't make <tt class="code">let</tt> any more
efficient, but does make local calls that are semantically the same
as <tt class="code">let</tt> much more efficient than full calls.
For example, these definitions are all the same as far as the
compiler is concerned:
<blockquote class="example">
<pre>
(defun foo ()
  ...some other stuff...
  (let ((a something))
    ...some stuff...))

(defun foo ()
  (flet ((localfun (a)
           ...some stuff...))
    ...some other stuff...
    (localfun something)))

(defun foo ()
  (let ((funvar #'(lambda (a)
                    ...some stuff...)))
    ...some other stuff...
    (funcall funvar something)))
</pre></blockquote>
Although local call is most efficient when the function is called
only once, a call doesn't have to be equivalent to a <tt class=
"code">let</tt> to be more efficient than full call. All local
calls avoid the overhead of argument count checking and keyword
argument parsing, and there are a number of other advantages that
apply in many common situations. See section&nbsp;<a href=
"#let-optimization">5.4.1</a> for a discussion of the optimizations
done on let calls.<br>
<br>
<!--TOC subsection Closures-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc165" id="htoc165"><b><font size=
"4">5.6.3</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Closures</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept190"></a><br>
Local call allows for much more efficient use of closures, since
the closure environment doesn't need to be allocated on the heap,
or even stored in memory at all. In this example, there is no
penalty for <tt class="code">localfun</tt> referencing <tt class=
"code">a</tt> and <tt class="code">b</tt>:
<blockquote class="lisp">
<pre>
(defun foo (a b)
  (flet ((localfun (x)
           (1+ (* a b x))))
    (if (= a b)
        (localfun (- x))
        (localfun x))))
</pre></blockquote>
In local call, the compiler effectively passes closed-over values
as extra arguments, so there is no need for you to ``optimize''
local function use by explicitly passing in lexically visible
values. Closures may also be subject to let optimization (see
section&nbsp;<a href="#let-optimization">5.4.1</a>.)<br>
<br>
Note: indirect value cells are currently always allocated on the
heap when a variable is both assigned to (with <tt class=
"code">setq</tt> or <tt class="code">setf</tt>) and closed over,
regardless of whether the closure is a local function or not. This
is another reason to avoid setting variables when you don't have
to.<br>
<br>
<!--TOC subsection Local Tail Recursion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc166" id="htoc166"><b><font size=
"4">5.6.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Local Tail
Recursion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="local-tail-recursion" id="local-tail-recursion"></a>
<a name="@concept191"></a> <a name="@concept192"></a><br>
Tail-recursive local calls are particularly efficient, since they
are in effect an assignment plus a control transfer. Scheme
programmers write loops with tail-recursive local calls, instead of
using the imperative <tt class="code">go</tt> and <tt class=
"code">setq</tt>. This has not caught on in the Common Lisp
community, since conventional Common Lisp compilers don't implement
local call. In Python, users can choose to write loops such as:
<blockquote class="lisp">
<pre>
(defun ! (n)
  (labels ((loop (n total)
             (if (zerop n)
                 total
                 (loop (1- n) (* n total)))))
    (loop n 1)))
</pre></blockquote>
<br>
<a name="@funs131"></a><a name="FN:iterate" id="FN:iterate"></a>
<div align="left">[Macro]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">iterate</tt> <tt class="variable">name</tt>
(<tt class="code">{(<tt class="variable">var</tt> <tt class=
"variable">initial-value</tt>)}</tt><sup><font size=
"2">*</font></sup>) <tt class="code">{<tt class=
"variable">declaration</tt>}</tt><sup><font size="2">*</font></sup>
<tt class="code">{<tt class=
"variable">form</tt>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro provides syntactic sugar for using <a name=
"@funs132"></a><tt class="code">labels</tt> to do iteration. It
creates a local function <tt class="variable">name</tt> with the
specified <tt class="variable">var</tt>s as its arguments and the
<tt class="variable">declaration</tt>s and <tt class=
"variable">form</tt>s as its body. This function is then called
with the <tt class="variable">initial-values</tt>, and the result
of the call is return from the macro.<br>
<br>
Here is our factorial example rewritten using <tt class=
"code">iterate</tt>:
<blockquote class="lisp">
<pre>
    (defun ! (n)
      (iterate loop
               ((n n)
               (total 1))
        (if (zerop n)
          total
          (loop (1- n) (* n total)))))
  
</pre></blockquote>
The main advantage of using <tt class="code">iterate</tt> over
<tt class="code">do</tt> is that <tt class="code">iterate</tt>
naturally allows stepping to be done differently depending on
conditionals in the body of the loop. <tt class="code">iterate</tt>
can also be used to implement algorithms that aren't really
iterative by simply doing a non-tail call. For example, the
standard recursive definition of factorial can be written like
this:
<blockquote class="lisp">
<pre>
(iterate fact
         ((n n))
  (if (zerop n)
      1
      (* n (fact (1- n)))))
</pre></blockquote>
</blockquote>
<!--TOC subsection Return Values-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc167" id="htoc167"><b><font size=
"4">5.6.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Return
Values</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="local-call-return" id="local-call-return"></a> <a name=
"@concept193"></a> <a name="@concept194"></a><br>
One of the more subtle costs of full call comes from allowing
arbitrary numbers of return values. This overhead can be avoided in
local calls to functions that always return the same number of
values. For efficiency reasons (as well as stylistic ones), you
should write functions so that they always return the same number
of values. This may require passing extra <tt class="code">nil</tt>
arguments to <tt class="code">values</tt> in some cases, but the
result is more efficient, not less so.<br>
<br>
When efficiency notes are enabled (see section&nbsp;<a href=
"#efficiency-notes">5.13</a>), and the compiler wants to use known
values return, but can't prove that the function always returns the
same number of values, then it will print a note like this:
<blockquote class="example">
<pre>
In: DEFUN GRUE
  (DEFUN GRUE (X) (DECLARE (FIXNUM X)) (COND (# #) (# NIL) (T #)))
Note: Return type not fixed values, so can't use known return convention:
  (VALUES (OR (INTEGER -536870912 -1) NULL) &amp;REST T)
</pre></blockquote>
In order to implement proper tail recursion in the presence of
known values return (see section&nbsp;<a href=
"#tail-recursion">5.5</a>), the compiler sometimes must prove that
multiple functions all return the same number of values. When this
can't be proven, the compiler will print a note like this:
<blockquote class="example">
<pre>
In: DEFUN BLUE
  (DEFUN BLUE (X) (DECLARE (FIXNUM X)) (COND (# #) (# #) (# #) (T #)))
Note: Return value count mismatch prevents known return from
      these functions:
  BLUE
  SNOO
</pre></blockquote>
See section&nbsp;<a href="#number-local-call">5.11.10</a> for the
interaction between local call and the representation of numeric
types.<br>
<br>
<!--TOC section Block Compilation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc168" id="htoc168"><b><font size=
"5">5.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Block
Compilation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="block-compilation" id="block-compilation"></a> <a name=
"@concept195"></a> <a name="@concept196"></a><br>
Block compilation allows calls to global functions defined by
<a name="@funs133"></a><tt class="code">defun</tt> to be compiled
as local calls. The function call can be in a different top-level
form than the <tt class="code">defun</tt>, or even in a different
file.<br>
<br>
In addition, block compilation allows the declaration of the
<i>entry points</i> to the block compiled portion. An entry point
is any function that may be called from outside of the block
compilation. If a function is not an entry point, then it can be
compiled more efficiently, since all calls are known at compile
time. In particular, if a function is only called in one place,
then it will be let converted. This effectively inline expands the
function, but without the code duplication that results from
defining the function normally and then declaring it inline.<br>
<br>
The main advantage of block compilation is that it it preserves
efficiency in programs even when (for readability and syntactic
convenience) they are broken up into many small functions. There is
absolutely no overhead for calling a non-entry point function that
is defined purely for modularity (i.e. called only in one
place.)<br>
<br>
Block compilation also allows the use of non-descriptor arguments
and return values in non-trivial programs (see
section&nbsp;<a href="#number-local-call">5.11.10</a>).<br>
<br>
<!--TOC subsection Block Compilation Semantics-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc169" id="htoc169"><b><font size=
"4">5.7.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Block Compilation
Semantics</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The effect of block compilation can be envisioned as the compiler
turning all the <tt class="code">defun</tt>s in the block
compilation into a single <tt class="code">labels</tt> form:
<blockquote class="example">
<pre>
(declaim (start-block fun1 fun3))

(defun fun1 ()
  ...)

(defun fun2 ()
  ...
  (fun1)
  ...)

(defun fun3 (x)
  (if x
      (fun1)
      (fun2)))

(declaim (end-block))
</pre></blockquote>
becomes:
<blockquote class="example">
<pre>
(labels ((fun1 ()
           ...)
         (fun2 ()
           ...
           (fun1)
           ...)
         (fun3 (x)
           (if x
               (fun1)
               (fun2))))
  (setf (fdefinition 'fun1) #'fun1)
  (setf (fdefinition 'fun3) #'fun3))
</pre></blockquote>
Calls between the block compiled functions are local calls, so
changing the global definition of <tt class="code">fun1</tt> will
have no effect on what <tt class="code">fun2</tt> does; <tt class=
"code">fun2</tt> will keep calling the old <tt class=
"code">fun1</tt>.<br>
<br>
The entry points <tt class="code">fun1</tt> and <tt class=
"code">fun3</tt> are still installed in the <tt class=
"code">symbol-function</tt> as the global definitions of the
functions, so a full call to an entry point works just as before.
However, <tt class="code">fun2</tt> is not an entry point, so it is
not globally defined. In addition, <tt class="code">fun2</tt> is
only called in one place, so it will be let converted.<br>
<br>
<!--TOC subsection Block Compilation Declarations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc170" id="htoc170"><b><font size=
"4">5.7.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Block Compilation
Declarations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept197"></a> <a name="@concept198"></a> <a name=
"@concept199"></a><br>
The <tt class="code">extensions:start-block</tt> and <tt class=
"code">extensions:end-block</tt> declarations allow fine-grained
control of block compilation. These declarations are only legal as
a global declarations (<tt class="code">declaim</tt> or <tt class=
"code">proclaim</tt>).<br>
<br>
<br>
The <tt class="code">start-block</tt> declaration has this syntax:
<blockquote class="example">
<pre>
(start-block <tt class="code">{<tt class=
"variable">entry-point-name</tt>}</tt><sup><font size=
"2">*</font></sup>)
</pre></blockquote>
When processed by the compiler, this declaration marks the start of
block compilation, and specifies the entry points to that block. If
no entry points are specified, then <tt class="variable">all</tt>
functions are made into entry points. If already block compiling,
then the compiler ends the current block and starts a new one.<br>
<br>
<br>
The <tt class="code">end-block</tt> declaration has no arguments:
<blockquote class="lisp">
<pre>
(end-block)
</pre></blockquote>
The <tt class="code">end-block</tt> declaration ends a block
compilation unit without starting a new one. This is useful mainly
when only a portion of a file is worth block compiling.<br>
<br>
<!--TOC subsection Compiler Arguments-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc171" id="htoc171"><b><font size=
"4">5.7.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Compiler
Arguments</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="compile-file-block" id="compile-file-block"></a> <a name=
"@concept200"></a><br>
The <tt class="code">:block-compile</tt> and <tt class=
"code">:entry-points</tt> arguments to <tt class=
"code">extensions:compile-from-stream</tt> and <a name=
"@funs134"></a><tt class="code">compile-file</tt> provide overall
control of block compilation, and allow block compilation without
requiring modification of the program source.<br>
<br>
There are three possible values of the <tt class=
"code">:block-compile</tt> argument:
<dl compact="compact">
<dt><tt class="code">nil</tt><br></dt>
<dd>Do no compile-time resolution of global function names, not
even for self-recursive calls. This inhibits any <tt class=
"code">start-block</tt> declarations appearing in the file,
allowing all functions to be incrementally redefined.<br>
<br></dd>
<dt><tt class="code">t</tt><br></dt>
<dd>Start compiling in block compilation mode. This is mainly
useful for block compiling small files that contain no <tt class=
"code">start-block</tt> declarations. See also the <tt class=
"code">:entry-points</tt> argument.<br>
<br></dd>
<dt><tt class="code">:specified</tt><br></dt>
<dd>Start compiling in form-at-a-time mode, but exploit any
<tt class="code">start-block</tt> declarations and compile
self-recursive calls as local calls. Normally <tt class=
"code">:specified</tt> is the default for this argument (see
<a name="@vars48"></a><tt class=
"code">*block-compile-default*</tt>.)</dd>
</dl>
The <tt class="code">:entry-points</tt> argument can be used in
conjunction with <tt class="code">:block-compile</tt> <tt class=
"code">t</tt> to specify the entry-points to a block-compiled file.
If not specified or <tt class="code">nil</tt>, all global functions
will be compiled as entry points. When <tt class=
"code">:block-compile</tt> is not <tt class="code">t</tt>, this
argument is ignored.<br>
<br>
<br>
<a name="@vars49"></a><a name="VR:block-compile-default" id=
"VR:block-compile-default"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*block-compile-default*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable determines the default value for the <tt class=
"code">:block-compile</tt> argument to <tt class=
"code">compile-file</tt> and <tt class=
"code">compile-from-stream</tt>. The initial value of this variable
is <tt class="code">:specified</tt>, but <tt class="code">nil</tt>
is sometimes useful for totally inhibiting block
compilation.</blockquote>
<!--TOC subsection Practical Difficulties-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc172" id="htoc172"><b><font size=
"4">5.7.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Practical
Difficulties</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The main problem with block compilation is that the compiler uses
large amounts of memory when it is block compiling. This places an
upper limit on the amount of code that can be block compiled as a
unit. To make best use of block compilation, it is necessary to
locate the parts of the program containing many internal calls, and
then add the appropriate <tt class="code">start-block</tt>
declarations. When writing new code, it is a good idea to put in
block compilation declarations from the very beginning, since
writing block declarations correctly requires accurate knowledge of
the program's function call structure. If you want to initially
develop code with full incremental redefinition, you can compile
with <a name="@vars50"></a><tt class=
"code">*block-compile-default*</tt> set to <tt class=
"code">nil</tt>.<br>
<br>
Note if a <tt class="code">defun</tt> appears in a non-null lexical
environment, then calls to it cannot be block compiled.<br>
<br>
Unless files are very small, it is probably impractical to block
compile multiple files as a unit by specifying a list of files to
<tt class="code">compile-file</tt>. Semi-inline expansion (see
section&nbsp;<a href="#semi-inline">5.8.2</a>) provides another way
to extend block compilation across file boundaries.<br>
<br>
<!--TOC subsection Context Declarations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc173" id="htoc173"><b><font size=
"4">5.7.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Context
Declarations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="context-declarations" id="context-declarations"></a>
<a name="@concept201"></a> <a name="@concept202"></a><br>
CMUCL has a context-sensitive declaration mechanism which is useful
because it allows flexible control of the compilation policy in
large systems without requiring changes to the source files. The
primary use of this feature is to allow the exported interfaces of
a system to be compiled more safely than the system internals. The
context used is the name being defined and the kind of definition
(function, macro, etc.)<br>
<br>
The <tt class="code">:context-declarations</tt> option to <a name=
"@funs135"></a><tt class="code">with-compilation-unit</tt> has
dynamic scope, affecting all compilation done during the evaluation
of the body. The argument to this option should evaluate to a list
of lists of the form:
<blockquote class="example">
<pre>
(<tt class="variable">context-spec</tt> <tt class=
"code">{<tt class="variable">declare-form</tt>}</tt><sup><font size="2">+</font></sup>)
</pre></blockquote>
In the indicated context, the specified declare forms are inserted
at the head of each definition. The declare forms for all contexts
that match are appended together, with earlier declarations getting
precedence over later ones. A simple example:
<blockquote class="example">
<pre>
    :context-declarations
    '((:external (declare (optimize (safety 2)))))
</pre></blockquote>
This will cause all functions that are named by external symbols to
be compiled with <tt class="code">safety 2</tt>.<br>
<br>
The full syntax of context specs is:
<dl compact="compact">
<dt><tt class="code">:internal</tt>, <tt class=
"code">:external</tt><br></dt>
<dd>True if the symbol is internal (external) in its home
package.<br>
<br></dd>
<dt><tt class="code">:uninterned</tt><br></dt>
<dd>True if the symbol has no home package.<br>
<br></dd>
<dt><tt class="code">(:package <tt class="code">{<tt class=
"variable">package-name</tt>}</tt><sup><font size=
"2">*</font></sup>)</tt><br></dt>
<dd>True if the symbol's home package is in any of the named
packages (false if uninterned.)<br>
<br></dd>
<dt><tt class="code">:anonymous</tt><br></dt>
<dd>True if the function doesn't have any interesting name (not
<tt class="code">defmacro</tt>, <tt class="code">defun</tt>,
<tt class="code">labels</tt> or <tt class="code">flet</tt>).<br>
<br></dd>
<dt><tt class="code">:macro</tt>, <tt class=
"code">:function</tt><br></dt>
<dd><tt class="code">:macro</tt> is a global (<tt class=
"code">defmacro</tt>) macro. <tt class="code">:function</tt> is
anything else.<br>
<br></dd>
<dt><tt class="code">:local</tt>, <tt class=
"code">:global</tt><br></dt>
<dd><tt class="code">:local</tt> is a <tt class="code">labels</tt>
or <tt class="code">flet</tt>. <tt class="code">:global</tt> is
anything else.<br>
<br></dd>
<dt><tt class="code">(:or <tt class="code">{<tt class=
"variable">context-spec</tt>}</tt><sup><font size=
"2">*</font></sup>)</tt><br></dt>
<dd>True when any supplied <tt class="variable">context-spec</tt>
is true.<br>
<br></dd>
<dt><tt class="code">(:and <tt class="code">{<tt class=
"variable">context-spec</tt>}</tt><sup><font size=
"2">*</font></sup>)</tt><br></dt>
<dd>True only when all supplied <tt class=
"variable">context-spec</tt>s are true.<br>
<br></dd>
<dt><tt class="code">(:not <tt class="code">{<tt class=
"variable">context-spec</tt>}</tt><sup><font size=
"2">*</font></sup>)</tt><br></dt>
<dd>True when <tt class="variable">context-spec</tt> is false.<br>
<br></dd>
<dt><tt class="code">(:member <tt class="code">{<tt class=
"variable">name</tt>}</tt><sup><font size=
"2">*</font></sup>)</tt><br></dt>
<dd>True when the defined name is one of these names (<tt class=
"code">equal</tt> test.)<br>
<br></dd>
<dt><tt class="code">(:match <tt class="code">{<tt class=
"variable">pattern</tt>}</tt><sup><font size=
"2">*</font></sup>)</tt><br></dt>
<dd>True when any of the patterns is a substring of the name. The
name is wrapped with <tt class="code">$</tt>'s, so ``<tt class=
"code">$FOO</tt>'' matches names beginning with ``<tt class=
"code">FOO</tt>'', etc.</dd>
</dl>
<!--TOC subsection Context Declaration Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc174" id="htoc174"><b><font size=
"4">5.7.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Context
Declaration Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Here is a more complex example of <tt class=
"code">with-compilation-unit</tt> options:
<blockquote class="example">
<pre>
:optimize '(optimize (speed 2) (space 2) (inhibit-warnings 2)
                     (debug 1) (safety 0))
:optimize-interface '(optimize-interface (safety 1) (debug 1))
:context-declarations
'(((:or :external (:and (:match "%") (:match "SET")))
   (declare (optimize-interface (safety 2))))
  ((:or (:and :external :macro)
        (:match "$PARSE-"))
   (declare (optimize (safety 2)))))
</pre></blockquote>
The <tt class="code">optimize</tt> and <tt class=
"code">extensions:optimize-interface</tt> declarations (see
section&nbsp;<a href="#optimize-declaration">4.7.1</a>) set up the
global compilation policy. The bodies of functions are to be
compiled completely unsafe (<tt class="code">safety 0</tt>), but
argument count and weakened argument type checking is to be done
when a function is called (<tt class="code">speed 2 safety
1</tt>).<br>
<br>
The first declaration specifies that all functions that are
external or whose names contain both ``<tt class="code">%</tt>''
and ``<tt class="code">SET</tt>'' are to be compiled compiled with
completely safe interfaces (<tt class="code">safety 2</tt>). The
reason for this particular <tt class="code">:match</tt> rule is
that <tt class="code">setf</tt> inverse functions in this system
tend to have both strings in their name somewhere. We want
<tt class="code">setf</tt> inverses to be safe because they are
implicitly called by users even though their name is not
exported.<br>
<br>
The second declaration makes external macros or functions whose
names start with ``<tt class="code">PARSE-</tt>'' have safe bodies
(as well as interfaces). This is desirable because a syntax error
in a macro may cause a type error inside the body. The <tt class=
"code">:match</tt> rule is used because macros often have auxiliary
functions whose names begin with this string.<br>
<br>
This particular example is used to build part of the standard CMUCL
system. Note however, that context declarations must be set up
according to the needs and coding conventions of a particular
system; different parts of CMUCL are compiled with different
context declarations, and your system will probably need its own
declarations. In particular, any use of the <tt class=
"code">:match</tt> option depends on naming conventions used in
coding.<br>
<br>
<!--TOC section Inline Expansion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc175" id="htoc175"><b><font size=
"5">5.8</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Inline
Expansion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="inline-expansion" id="inline-expansion"></a> <a name=
"@concept203"></a> <a name="@concept204"></a> <a name=
"@concept205"></a> <a name="@concept206"></a> <a name=
"@concept207"></a><br>
Python can expand almost any function inline, including functions
with keyword arguments. The only restrictions are that keyword
argument keywords in the call must be constant, and that global
function definitions (<tt class="code">defun</tt>) must be done in
a null lexical environment (not nested in a <tt class=
"code">let</tt> or other binding form.) Local functions (<tt class=
"code">flet</tt>) can be inline expanded in any environment.
Combined with Python's source-level optimization, inline expansion
can be used for things that formerly required macros for efficient
implementation. In Python, macros don't have any efficiency
advantage, so they need only be used where a macro's syntactic
flexibility is required.<br>
<br>
Inline expansion is a compiler optimization technique that reduces
the overhead of a function call by simply not doing the call:
instead, the compiler effectively rewrites the program to appear as
though the definition of the called function was inserted at each
call site. In Common Lisp, this is straightforwardly expressed by
inserting the <tt class="code">lambda</tt> corresponding to the
original definition:
<blockquote class="lisp">
<pre>
(proclaim '(inline my-1+))
(defun my-1+ (x) (+ x 1))

(my-1+ someval) ==&gt; ((lambda (x) (+ x 1)) someval)
</pre></blockquote>
When the function expanded inline is large, the program after
inline expansion may be substantially larger than the original
program. If the program becomes too large, inline expansion hurts
speed rather than helping it, since hardware resources such as
physical memory and cache will be exhausted. Inline expansion is
called for:
<ul>
<li>When profiling has shown that a relatively simple function is
called so often that a large amount of time is being wasted in the
calling of that function (as opposed to running in that function.)
If a function is complex, it will take a long time to run relative
the time spent in call, so the speed advantage of inline expansion
is diminished at the same time the space cost of inline expansion
is increased. Of course, if a function is rarely called, then the
overhead of calling it is also insignificant.<br>
<br></li>
<li>With functions so simple that they take less space to inline
expand than would be taken to call the function (such as <tt class=
"code">my-1+</tt> above.) It would require intimate knowledge of
the compiler to be certain when inline expansion would reduce
space, but it is generally safe to inline expand functions whose
definition is a single function call, or a few calls to simple
Common Lisp functions.</li>
</ul>
In addition to this speed/space tradeoff from inline expansion's
avoidance of the call, inline expansion can also reveal
opportunities for optimization. Python's extensive source-level
optimization can make use of context information from the caller to
tremendously simplify the code resulting from the inline expansion
of a function.<br>
<br>
The main form of caller context is local information about the
actual argument values: what the argument types are and whether the
arguments are constant. Knowledge about argument types can
eliminate run-time type tests (e.g., for generic arithmetic.)
Constant arguments in a call provide opportunities for constant
folding optimization after inline expansion.<br>
<br>
A hidden way that constant arguments are often supplied to
functions is through the defaulting of unsupplied optional or
keyword arguments. There can be a huge efficiency advantage to
inline expanding functions that have complex keyword-based
interfaces, such as this definition of the <tt class=
"code">member</tt> function:
<blockquote class="lisp">
<pre>
(proclaim '(inline member))
(defun member (item list &amp;key
                    (key #'identity)
                    (test #'eql testp)
                    (test-not nil notp))
  (do ((list list (cdr list)))
      ((null list) nil)
    (let ((car (car list)))
      (if (cond (testp
                 (funcall test item (funcall key car)))
                (notp
                 (not (funcall test-not item (funcall key car))))
                (t
                 (funcall test item (funcall key car))))
          (return list)))))

</pre></blockquote>
After inline expansion, this call is simplified to the obvious
code:
<blockquote class="lisp">
<pre>
(member a l :key #'foo-a :test #'char=) ==&gt;

(do ((list list (cdr list)))
    ((null list) nil)
  (let ((car (car list)))
    (if (char= item (foo-a car))
        (return list))))
</pre></blockquote>
In this example, there could easily be more than an order of
magnitude improvement in speed. In addition to eliminating the
original call to <tt class="code">member</tt>, inline expansion
also allows the calls to <tt class="code">char=</tt> and <tt class=
"code">foo-a</tt> to be open-coded. We go from a loop with three
tests and two calls to a loop with one test and no calls.<br>
<br>
See section&nbsp;<a href="#source-optimization">5.4</a> for more
discussion of source level optimization.<br>
<br>
<!--TOC subsection Inline Expansion Recording-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc176" id="htoc176"><b><font size=
"4">5.8.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Inline Expansion
Recording</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept208"></a><br>
Inline expansion requires that the source for the inline expanded
function to be available when calls to the function are compiled.
The compiler doesn't remember the inline expansion for every
function, since that would take an excessive about of space.
Instead, the programmer must tell the compiler to record the inline
expansion before the definition of the inline expanded function is
compiled. This is done by globally declaring the function inline
before the function is defined, by using the <tt class=
"code">inline</tt> and <tt class=
"code">extensions:maybe-inline</tt> (see section&nbsp;<a href=
"#maybe-inline-declaration">5.8.3</a>) declarations.<br>
<br>
In addition to recording the inline expansion of inline functions
at the time the function is compiled, <tt class=
"code">compile-file</tt> also puts the inline expansion in the
output file. When the output file is loaded, the inline expansion
is made available for subsequent compilations; there is no need to
compile the definition again to record the inline expansion.<br>
<br>
If a function is declared inline, but no expansion is recorded,
then the compiler will give an efficiency note like:
<blockquote class="example">
<pre>
Note: MYFUN is declared inline, but has no expansion.
</pre></blockquote>
When you get this note, check that the <tt class="code">inline</tt>
declaration and the definition appear before the calls that are to
be inline expanded. This note will also be given if the inline
expansion for a <tt class="code">defun</tt> could not be recorded
because the <tt class="code">defun</tt> was in a non-null lexical
environment.<br>
<br>
<!--TOC subsection Semi-Inline Expansion-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc177" id="htoc177"><b><font size=
"4">5.8.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Semi-Inline
Expansion</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="semi-inline" id="semi-inline"></a><br>
Python supports <tt class="variable">semi-inline</tt> functions.
Semi-inline expansion shares a single copy of a function across all
the calls in a component by converting the inline expansion into a
local function (see section&nbsp;<a href="#local-call">5.6</a>.)
This takes up less space when there are multiple calls, but also
provides less opportunity for context dependent optimization. When
there is only one call, the result is identical to normal inline
expansion. Semi-inline expansion is done when the <tt class=
"code">space</tt> optimization quality is <tt class="code">0</tt>,
and the function has been declared <tt class=
"code">extensions:maybe-inline</tt>.<br>
<br>
This mechanism of inline expansion combined with local call also
allows recursive functions to be inline expanded. If a recursive
function is declared <tt class="code">inline</tt>, calls will
actually be compiled semi-inline. Although recursive functions are
often so complex that there is little advantage to semi-inline
expansion, it can still be useful in the same sort of cases where
normal inline expansion is especially advantageous, i.e. functions
where the calling context can help a lot.<br>
<br>
<!--TOC subsection The Maybe-Inline Declaration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc178" id="htoc178"><b><font size=
"4">5.8.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The Maybe-Inline
Declaration</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="maybe-inline-declaration" id=
"maybe-inline-declaration"></a> <a name="@concept209"></a><br>
The <tt class="code">extensions:maybe-inline</tt> declaration is a
CMUCL extension. It is similar to <tt class="code">inline</tt>, but
indicates that inline expansion may sometimes be desirable, rather
than saying that inline expansion should almost always be done.
When used in a global declaration, <tt class=
"code">extensions:maybe-inline</tt> causes the expansion for the
named functions to be recorded, but the functions aren't actually
inline expanded unless <tt class="code">space</tt> is <tt class=
"code">0</tt> or the function is eventually (perhaps locally)
declared <tt class="code">inline</tt>.<br>
<br>
Use of the <tt class="code">extensions:maybe-inline</tt>
declaration followed by the <tt class="code">defun</tt> is
preferable to the standard idiom of:
<blockquote class="lisp">
<pre>
(proclaim '(inline myfun))
(defun myfun () ...)
(proclaim '(notinline myfun))

;;; <i>Any calls to </i><tt class=
"code"><i>myfun</i></tt><i> here are not inline expanded.</i>

(defun somefun ()
  (declare (inline myfun))
  ;;
  ;; <i>Calls to </i><tt class=
"code"><i>myfun</i></tt><i> here are inline expanded.</i>
  ...)
</pre></blockquote>
The problem with using <tt class="code">notinline</tt> in this way
is that in Common Lisp it does more than just suppress inline
expansion, it also forbids the compiler to use any knowledge of
<tt class="code">myfun</tt> until a later <tt class=
"code">inline</tt> declaration overrides the <tt class=
"code">notinline</tt>. This prevents compiler warnings about
incorrect calls to the function, and also prevents block
compilation.<br>
<br>
The <tt class="code">extensions:maybe-inline</tt> declaration is
used like this:
<blockquote class="lisp">
<pre>
(proclaim '(extensions:maybe-inline myfun))
(defun myfun () ...)

;;; <i>Any calls to </i><tt class=
"code"><i>myfun</i></tt><i> here are not inline expanded.</i>

(defun somefun ()
  (declare (inline myfun))
  ;;
  ;; <i>Calls to </i><tt class=
"code"><i>myfun</i></tt><i> here are inline expanded.</i>
  ...)

(defun someotherfun ()
  (declare (optimize (space 0)))
  ;;
  ;; <i>Calls to </i><tt class=
"code"><i>myfun</i></tt><i> here are expanded semi-inline.</i>
  ...)
</pre></blockquote>
In this example, the use of <tt class=
"code">extensions:maybe-inline</tt> causes the expansion to be
recorded when the <tt class="code">defun</tt> for <tt class=
"code">somefun</tt> is compiled, and doesn't waste space through
doing inline expansion by default. Unlike <tt class=
"code">notinline</tt>, this declaration still allows the compiler
to assume that the known definition really is the one that will be
called when giving compiler warnings, and also allows the compiler
to do semi-inline expansion when the policy is appropriate.<br>
<br>
When the goal is merely to control whether inline expansion is done
by default, it is preferable to use <tt class=
"code">extensions:maybe-inline</tt> rather than <tt class=
"code">notinline</tt>. The <tt class="code">notinline</tt>
declaration should be reserved for those special occasions when a
function may be redefined at run-time, so the compiler must be told
that the obvious definition of a function is not necessarily the
one that will be in effect at the time of the call.<br>
<br>
<!--TOC section Byte Coded Compilation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc179" id="htoc179"><b><font size=
"5">5.9</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Byte Coded
Compilation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="byte-compile" id="byte-compile"></a> <a name=
"@concept210"></a> <a name="@concept211"></a><br>
Python supports byte compilation to reduce the size of Lisp
programs by allowing functions to be compiled more compactly. Byte
compilation provides an extreme speed/space tradeoff: byte code is
typically six times more compact than native code, but runs fifty
times (or more) slower. This is about ten times faster than the
standard interpreter, which is itself considered fast in comparison
to other Common Lisp interpreters.<br>
<br>
Large Lisp systems (such as CMUCL itself) often have large amounts
of user-interface code, compile-time (macro) code, debugging code,
or rarely executed special-case code. This code is a good target
for byte compilation: very little time is spent running in it, but
it can take up quite a bit of space. Straight-line code with many
function calls is much more suitable than inner loops.<br>
<br>
When byte-compiling, the compiler compiles about twice as fast, and
can produce a hardware independent object file (<tt class=
"filename">.bytef</tt> type.) This file can be loaded like a normal
fasl file on any implementation of CMUCL with the same
byte-ordering.<br>
<br>
The decision to byte compile or native compile can be done on a
per-file or per-code-object basis. The <tt class=
"code">:byte-compile</tt> argument to <a name=
"@funs136"></a><tt class="code">compile-file</tt> has these
possible values:<br>
<br>
<dl compact="compact">
<dt><tt class="code">nil</tt><br></dt>
<dd>Don't byte compile anything in this file.<br>
<br></dd>
<dt><tt class="code">t</tt><br></dt>
<dd>Byte compile everything in this file and produce a
processor-independent <tt class="filename">.bytef</tt> file.<br>
<br></dd>
<dt><tt class="code">:maybe</tt><br></dt>
<dd>Produce a normal fasl file, but byte compile any functions for
which the <tt class="code">speed</tt> optimization quality is
<tt class="code">0</tt> and the <tt class="code">debug</tt> quality
is not greater than <tt class="code">1</tt>.</dd>
</dl>
<br>
<a name="@vars51"></a><a name="VR:byte-compile-top-level" id=
"VR:byte-compile-top-level"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*byte-compile-top-level*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
If this variable is true (the default) and the <tt class=
"code">:byte-compile</tt> argument to <tt class=
"code">compile-file</tt> is <tt class="code">:maybe</tt>, then byte
compile top-level code (code outside of any <tt class=
"code">defun</tt>, <tt class="code">defmethod</tt>,
etc.)</blockquote>
<br>
<a name="@vars52"></a><a name="VR:byte-compile-default" id=
"VR:byte-compile-default"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*byte-compile-default*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable determines the default value for the <tt class=
"code">:byte-compile</tt> argument to <tt class=
"code">compile-file</tt>, initially <tt class=
"code">:maybe</tt>.</blockquote>
<!--TOC section Object Representation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc180" id="htoc180"><b><font size=
"5">5.10</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Object
Representation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="object-representation" id="object-representation"></a>
<a name="@concept212"></a> <a name="@concept213"></a> <a name=
"@concept214"></a><br>
A somewhat subtle aspect of writing efficient Common Lisp programs
is choosing the correct data structures so that the underlying
objects can be implemented efficiently. This is partly because of
the need for multiple representations for a given value (see
section&nbsp;<a href="#non-descriptor">5.11.2</a>), but is also due
to the sheer number of object types that Common Lisp has built in.
The number of possible representations complicates the choice of a
good representation because semantically similar objects may vary
in their efficiency depending on how the program operates on
them.<br>
<br>
<!--TOC subsection Think Before You Use a List-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc181" id="htoc181"><b><font size=
"4">5.10.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Think Before You
Use a List</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept215"></a><br>
Although Lisp's creator seemed to think that it was for LISt
Processing, the astute observer may have noticed that the chapter
on list manipulation makes up less that three percent of <i>Common
Lisp: The Language II</i>. The language has grown since Lisp
1.5---new data types supersede lists for many purposes.<br>
<br>
<!--TOC subsection Structure Representation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc182" id="htoc182"><b><font size=
"4">5.10.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Structure
Representation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept216"></a> One of the best ways of building complex
data structures is to define appropriate structure types using
<a name="@funs137"></a><tt class="code">defstruct</tt>. In Python,
access of structure slots is always at least as fast as list or
vector access, and is usually faster. In comparison to a list
representation of a tuple, structures also have a space
advantage.<br>
<br>
Even if structures weren't more efficient than other
representations, structure use would still be attractive because
programs that use structures in appropriate ways are much more
maintainable and robust than programs written using only lists. For
example:
<blockquote class="lisp">
<pre>
(rplaca (caddr (cadddr x)) (caddr y))
</pre></blockquote>
could have been written using structures in this way:
<blockquote class="lisp">
<pre>
(setf (beverage-flavor (astronaut-beverage x)) (beverage-flavor y))
</pre></blockquote>
The second version is more maintainable because it is easier to
understand what it is doing. It is more robust because structures
accesses are type checked. An <tt class="code">astronaut</tt> will
never be confused with a <tt class="code">beverage</tt>, and the
result of <tt class="code">beverage-flavor</tt> is always a flavor.
See sections <a href="#structure-types">5.2.8</a> and <a href=
"#freeze-type">5.2.9</a> for more information about structure
types. See section&nbsp;<a href="#type-inference">5.3</a> for a
number of examples that make clear the advantages of structure
typing.<br>
<br>
Note that the structure definition should be compiled before any
uses of its accessors or type predicate so that these function
calls can be efficiently open-coded.<br>
<br>
<!--TOC subsection Arrays-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc183" id="htoc183"><b><font size=
"4">5.10.3</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Arrays</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="array-types" id="array-types"></a> <a name=
"@concept217"></a><br>
Arrays are often the most efficient representation for collections
of objects because:
<ul>
<li>Array representations are often the most compact. An array is
always more compact than a list containing the same number of
elements.<br>
<br></li>
<li>Arrays allow fast constant-time access.<br>
<br></li>
<li>Arrays are easily destructively modified, which can reduce
consing.<br>
<br></li>
<li>Array element types can be specialized, which reduces both
overall size and consing (see section&nbsp;<a href=
"#specialized-array-types">5.11.8</a>.)</li>
</ul>
Access of arrays that are not of type <tt class=
"code">simple-array</tt> is less efficient, so declarations are
appropriate when an array is of a simple type like <tt class=
"code">simple-string</tt> or <tt class=
"code">simple-bit-vector</tt>. Arrays are almost always simple, but
the compiler may not be able to prove simpleness at every use. The
only way to get a non-simple array is to use the <tt class=
"code">:displaced-to</tt>, <tt class="code">:fill-pointer</tt> or
<tt class="code">adjustable</tt> arguments to <tt class=
"code">make-array</tt>. If you don't use these hairy options, then
arrays can always be declared to be simple.<br>
<br>
Because of the many specialized array types and the possibility of
non-simple arrays, array access is much like generic arithmetic
(see section&nbsp;<a href="#generic-arithmetic">5.11.4</a>). In
order for array accesses to be efficiently compiled, the element
type and simpleness of the array must be known at compile time. If
there is inadequate information, the compiler is forced to call a
generic array access routine. You can detect inefficient array
accesses by enabling efficiency notes, see section&nbsp;<a href=
"#efficiency-notes">5.13</a>.<br>
<br>
<!--TOC subsection Vectors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc184" id="htoc184"><b><font size=
"4">5.10.4</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Vectors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept218"></a><br>
Vectors (one dimensional arrays) are particularly useful, since in
addition to their obvious array-like applications, they are also
well suited to representing sequences. In comparison to a list
representation, vectors are faster to access and take up between
two and sixty-four times less space (depending on the element
type.) As with arbitrary arrays, the compiler needs to know that
vectors are not complex, so you should use <tt class=
"code">simple-string</tt> in preference to <tt class=
"code">string</tt>, etc.<br>
<br>
The only advantage that lists have over vectors for representing
sequences is that it is easy to change the length of a list, add to
it and remove items from it. Likely signs of archaic, slow lisp
code are <tt class="code">nth</tt> and <tt class=
"code">nthcdr</tt>. If you are using these functions you should
probably be using a vector.<br>
<br>
<!--TOC subsection Bit-Vectors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc185" id="htoc185"><b><font size=
"4">5.10.5</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Bit-Vectors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept219"></a><br>
Another thing that lists have been used for is set manipulation. In
applications where there is a known, reasonably small universe of
items bit-vectors can be used to improve performance. This is much
less convenient than using lists, because instead of symbols, each
element in the universe must be assigned a numeric index into the
bit vector. Using a bit-vector will nearly always be faster, and
can be tremendously faster if the number of elements in the set is
not small. The logical operations on <tt class=
"code">simple-bit-vector</tt>s are efficient, since they operate on
a word at a time.<br>
<br>
<!--TOC subsection Hashtables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc186" id="htoc186"><b><font size=
"4">5.10.6</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Hashtables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept220"></a><br>
Hashtables are an efficient and general mechanism for maintaining
associations such as the association between an object and its
name. Although hashtables are usually the best way to maintain
associations, efficiency and style considerations sometimes favor
the use of an association list (a-list).<br>
<br>
<tt class="code">assoc</tt> is fairly fast when the <tt class=
"variable">test</tt> argument is <tt class="code">eq</tt> or
<tt class="code">eql</tt> and there are only a few elements, but
the time goes up in proportion with the number of elements. In
contrast, the hash-table lookup has a somewhat higher overhead, but
the speed is largely unaffected by the number of entries in the
table. For an <tt class="code">equal</tt> hash-table or alist,
hash-tables have an even greater advantage, since the test is more
expensive. Whatever you do, be sure to use the most restrictive
test function possible.<br>
<br>
The style argument observes that although hash-tables and alists
overlap in function, they do not do all things equally well.
<ul>
<li>Alists are good for maintaining scoped environments. They were
originally invented to implement scoping in the Lisp interpreter,
and are still used for this in Python. With an alist one can
non-destructively change an association simply by consing a new
element on the front. This is something that cannot be done with
hash-tables.<br>
<br></li>
<li>Hashtables are good for maintaining a global association. The
value associated with an entry can easily be changed with
<tt class="code">setf</tt>. With an alist, one has to go through
contortions, either <tt class="code">rplacd</tt>'ing the cons if
the entry exists, or pushing a new one if it doesn't. The
side-effecting nature of hash-table operations is an advantage
here.</li>
</ul>
Historically, symbol property lists were often used for global name
associations. Property lists provide an awkward and error-prone
combination of name association and record structure. If you must
use the property list, please store all the related values in a
single structure under a single property, rather than using many
properties. This makes access more efficient, and also adds a
modicum of typing and abstraction. See section&nbsp;<a href=
"#advanced-type-stuff">5.2</a> for information on types in
CMUCL.<br>
<br>
<!--TOC section Numbers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc187" id="htoc187"><b><font size=
"5">5.11</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Numbers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="numeric-types" id="numeric-types"></a> <a name=
"@concept221"></a> <a name="@concept222"></a><br>
Numbers are interesting because numbers are one of the few Common
Lisp data types that have direct support in conventional hardware.
If a number can be represented in the way that the hardware expects
it, then there is a big efficiency advantage.<br>
<br>
Using hardware representations is problematical in Common Lisp due
to dynamic typing (where the type of a value may be unknown at
compile time.) It is possible to compile code for statically typed
portions of a Common Lisp program with efficiency comparable to
that obtained in statically typed languages such as C, but not all
Common Lisp implementations succeed. There are two main barriers to
efficient numerical code in Common Lisp:
<ul>
<li>The compiler must prove that the numerical expression is in
fact statically typed, and<br>
<br></li>
<li>The compiler must be able to somehow reconcile the conflicting
demands of the hardware mandated number representation with the
Common Lisp requirements of dynamic typing and garbage-collecting
dynamic storage allocation.</li>
</ul>
Because of its type inference (see section&nbsp;<a href=
"#type-inference">5.3</a>) and efficiency notes (see
section&nbsp;<a href="#efficiency-notes">5.13</a>), Python is
better than conventional Common Lisp compilers at ensuring that
numerical expressions are statically typed. Python also goes
somewhat farther than existing compilers in the area of allowing
native machine number representations in the presence of garbage
collection.<br>
<br>
<!--TOC subsection Descriptors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc188" id="htoc188"><b><font size=
"4">5.11.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Descriptors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept223"></a> <a name="@concept224"></a> <a name=
"@concept225"></a> <a name="@concept226"></a><br>
Common Lisp's dynamic typing requires that it be possible to
represent any value with a fixed length object, known as a
<tt class="variable">descriptor</tt>. This fixed-length requirement
is implicit in features such as:
<ul>
<li>Data types (like <tt class="code">simple-vector</tt>) that can
contain any type of object, and that can be destructively modified
to contain different objects (of possibly different types.)<br>
<br></li>
<li>Functions that can be called with any type of argument, and
that can be redefined at run time.</li>
</ul>
In order to save space, a descriptor is invariably represented as a
single word. Objects that can be directly represented in the
descriptor itself are said to be <tt class=
"variable">immediate</tt>. Descriptors for objects larger than one
word are in reality pointers to the memory actually containing the
object.<br>
<br>
Representing objects using pointers has two major disadvantages:
<ul>
<li>The memory pointed to must be allocated on the heap, so it must
eventually be freed by the garbage collector. Excessive heap
allocation of objects (or ``consing'') is inefficient in several
ways. See section&nbsp;<a href="#consing">5.12.2</a>.<br>
<br></li>
<li>Representing an object in memory requires the compiler to emit
additional instructions to read the actual value in from memory,
and then to write the value back after operating on it.</li>
</ul>
The introduction of garbage collection makes things even worse,
since the garbage collector must be able to determine whether a
descriptor is an immediate object or a pointer. This requires that
a few bits in each descriptor be dedicated to the garbage
collector. The loss of a few bits doesn't seem like much, but it
has a major efficiency implication---objects whose natural machine
representation is a full word (integers and single-floats) cannot
have an immediate representation. So the compiler is forced to use
an unnatural immediate representation (such as <tt class=
"code">fixnum</tt>) or a natural pointer representation (with the
attendant consing overhead.)<br>
<br>
<!--TOC subsection Non-Descriptor Representations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc189" id="htoc189"><b><font size=
"4">5.11.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Non-Descriptor
Representations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="non-descriptor" id="non-descriptor"></a> <a name=
"@concept227"></a> <a name="@concept228"></a><br>
From the discussion above, we can see that the standard descriptor
representation has many problems, the worst being number consing.
Common Lisp compilers try to avoid these descriptor efficiency
problems by using <tt class="variable">non-descriptor</tt>
representations. A compiler that uses non-descriptor
representations can compile this function so that it does no number
consing:
<blockquote class="lisp">
<pre>
(defun multby (vec n)
  (declare (type (simple-array single-float (*)) vec)
           (single-float n))
  (dotimes (i (length vec))
    (setf (aref vec i)
          (* n (aref vec i)))))
</pre></blockquote>
If a descriptor representation were used, each iteration of the
loop might cons two floats and do three times as many memory
references.<br>
<br>
As its negative definition suggests, the range of possible
non-descriptor representations is large. The performance
improvement from non-descriptor representation depends upon both
the number of types that have non-descriptor representations and
the number of contexts in which the compiler is forced to use a
descriptor representation.<br>
<br>
Many Common Lisp compilers support non-descriptor representations
for float types such as <tt class="code">single-float</tt> and
<tt class="code">double-float</tt> (section <a href=
"#float-efficiency">5.11.7</a>.) Python adds support for full word
integers (see section&nbsp;<a href="#word-integers">5.11.6</a>),
characters (see section&nbsp;<a href="#characters">5.11.11</a>) and
system-area pointers (unconstrained pointers, see
section&nbsp;<a href="#system-area-pointers">6.5</a>.) Many Common
Lisp compilers support non-descriptor representations for variables
(section <a href="#ND-variables">5.11.3</a>) and array elements
(section <a href="#specialized-array-types">5.11.8</a>.) Python
adds support for non-descriptor arguments and return values in
local call (see section&nbsp;<a href=
"#number-local-call">5.11.10</a>) and structure slots (see
section&nbsp;<a href="#raw-slots">5.11.9</a>).<br>
<br>
<!--TOC subsection Variables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc190" id="htoc190"><b><font size=
"4">5.11.3</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Variables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="ND-variables" id="ND-variables"></a> <a name=
"@concept229"></a> <a name="@concept230"></a> <a name=
"@concept231"></a><br>
In order to use a non-descriptor representation for a variable or
expression intermediate value, the compiler must be able to prove
that the value is always of a particular type having a
non-descriptor representation. Type inference (see
section&nbsp;<a href="#type-inference">5.3</a>) often needs some
help from user-supplied declarations. The best kind of type
declaration is a variable type declaration placed at the binding
point:
<blockquote class="lisp">
<pre>
(let ((x (car l)))
  (declare (single-float x))
  ...)
</pre></blockquote>
Use of <tt class="code">the</tt>, or of variable declarations not
at the binding form is insufficient to allow non-descriptor
representation of the variable---with these declarations it is not
certain that all values of the variable are of the right type. It
is sometimes useful to introduce a gratuitous binding that allows
the compiler to change to a non-descriptor representation, like:
<blockquote class="lisp">
<pre>
(etypecase x
  ((signed-byte 32)
   (let ((x x))
     (declare (type (signed-byte 32) x)) 
     ...))
  ...)
</pre></blockquote>
The declaration on the inner <tt class="code">x</tt> is necessary
here due to a phase ordering problem. Although the compiler will
eventually prove that the outer <tt class="code">x</tt> is a
<tt class="code">(signed-byte 32)</tt> within that <tt class=
"code">etypecase</tt> branch, the inner <tt class="code">x</tt>
would have been optimized away by that time. Declaring the type
makes let optimization more cautious.<br>
<br>
Note that storing a value into a global (or <tt class=
"code">special</tt>) variable always forces a descriptor
representation. Wherever possible, you should operate only on local
variables, binding any referenced globals to local variables at the
beginning of the function, and doing any global assignments at the
end.<br>
<br>
Efficiency notes signal use of inefficient representations, so
programmer's needn't continuously worry about the details of
representation selection (see section&nbsp;<a href=
"#representation-eff-note">5.13.3</a>.)<br>
<br>
<!--TOC subsection Generic Arithmetic-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc191" id="htoc191"><b><font size=
"4">5.11.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Generic
Arithmetic</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="generic-arithmetic" id="generic-arithmetic"></a> <a name=
"@concept232"></a> <a name="@concept233"></a> <a name=
"@concept234"></a><br>
In Common Lisp, arithmetic operations are <tt class=
"variable">generic</tt>.<sup><a name="text13" href="#note13" id=
"text13"><font size="2">3</font></a></sup> The <tt class=
"code">+</tt> function can be passed <tt class="code">fixnum</tt>s,
<tt class="code">bignum</tt>s, <tt class="code">ratio</tt>s, and
various kinds of <tt class="code">float</tt>s and <tt class=
"code">complex</tt>es, in any combination. In addition to the
inherent complexity of <tt class="code">bignum</tt> and <tt class=
"code">ratio</tt> operations, there is also a lot of overhead in
just figuring out which operation to do and what contagion and
canonicalization rules apply. The complexity of generic arithmetic
is so great that it is inconceivable to open code it. Instead, the
compiler does a function call to a generic arithmetic routine,
consuming many instructions before the actual computation even
starts.<br>
<br>
This is ridiculous, since even Common Lisp programs do a lot of
arithmetic, and the hardware is capable of doing operations on
small integers and floats with a single instruction. To get
acceptable efficiency, the compiler special-cases uses of generic
arithmetic that are directly implemented in the hardware. In order
to open code arithmetic, several constraints must be met:
<ul>
<li>All the arguments must be known to be a good type of
number.<br>
<br></li>
<li>The result must be known to be a good type of number.<br>
<br></li>
<li>Any intermediate values such as the result of <tt class=
"code">(+ a b)</tt> in the call <tt class="code">(+ a b c)</tt>
must be known to be a good type of number.<br>
<br></li>
<li>All the above numbers with good types must be of the <tt class=
"variable">same</tt> good type. Don't try to mix integers and
floats or different float formats.</li>
</ul>
The ``good types'' are <tt class="code">(signed-byte 32)</tt>,
<tt class="code">(unsigned-byte 32)</tt>, <tt class=
"code">single-float</tt>, <tt class="code">double-float</tt>,
<tt class="code">(complex single-float)</tt>, and <tt class=
"code">(complex double-float)</tt>. See sections <a href=
"#fixnums">5.11.5</a>, <a href="#word-integers">5.11.6</a> and
<a href="#float-efficiency">5.11.7</a> for more discussion of good
numeric types.<br>
<br>
<tt class="code">float</tt> is not a good type, since it might mean
either <tt class="code">single-float</tt> or <tt class=
"code">double-float</tt>. <tt class="code">integer</tt> is not a
good type, since it might mean <tt class="code">bignum</tt>.
<tt class="code">rational</tt> is not a good type, since it might
mean <tt class="code">ratio</tt>. Note however that these types are
still useful in declarations, since type inference may be able to
strengthen a weak declaration into a good one, when it would be at
a loss if there was no declaration at all (see
section&nbsp;<a href="#type-inference">5.3</a>). The <tt class=
"code">integer</tt> and <tt class="code">unsigned-byte</tt> (or
non-negative integer) types are especially useful in this regard,
since they can often be strengthened to a good integer type.<br>
<br>
As noted above, CMUCL has support for <tt class="code">(complex
single-float)</tt> and <tt class="code">(complex
double-float)</tt>. These can be unboxed and, thus, are quite
efficient. However, arithmetic with complex types such as:
<blockquote class="lisp">
<pre>
(complex float)
(complex fixnum)
</pre></blockquote>
will be significantly slower than the good complex types but is
still faster than <tt class="code">bignum</tt> or <tt class=
"code">ratio</tt> arithmetic, since the implementation is much
simpler.<br>
<br>
Note: don't use <tt class="code">/</tt> to divide integers unless
you want the overhead of rational arithmetic. Use <tt class=
"code">truncate</tt> even when you know that the arguments divide
evenly.<br>
<br>
You don't need to remember all the rules for how to get open-coded
arithmetic, since efficiency notes will tell you when and where
there is a problem---see section&nbsp;<a href=
"#efficiency-notes">5.13</a>.<br>
<br>
<!--TOC subsection Fixnums-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc192" id="htoc192"><b><font size=
"4">5.11.5</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Fixnums</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="fixnums" id="fixnums"></a> <a name="@concept235"></a>
<a name="@concept236"></a><br>
A fixnum is a ``FIXed precision NUMber''. In modern Common Lisp
implementations, fixnums can be represented with an immediate
descriptor, so operating on fixnums requires no consing or memory
references. Clever choice of representations also allows some
arithmetic operations to be done on fixnums using hardware
supported word-integer instructions, somewhat reducing the speed
penalty for using an unnatural integer representation.<br>
<br>
It is useful to distinguish the <tt class="code">fixnum</tt> type
from the fixnum representation of integers. In Python, there is
absolutely nothing magical about the <tt class="code">fixnum</tt>
type in comparison to other finite integer types. <tt class=
"code">fixnum</tt> is equivalent to (is defined with <tt class=
"code">deftype</tt> to be) <tt class="code">(signed-byte 30)</tt>.
<tt class="code">fixnum</tt> is simply the largest subset of
integers that <em>can be represented</em> using an immediate fixnum
descriptor.<br>
<br>
Unlike in other Common Lisp compilers, it is in no way desirable to
use the <tt class="code">fixnum</tt> type in declarations in
preference to more restrictive integer types such as <tt class=
"code">bit</tt>, <tt class="code">(integer -43 7)</tt> and
<tt class="code">(unsigned-byte 8)</tt>. Since Python does
understand these integer types, it is preferable to use the more
restrictive type, as it allows better type inference (see
section&nbsp;<a href="#operation-type-inference">5.3.4</a>.)<br>
<br>
The small, efficient fixnum is contrasted with bignum, or ``BIG
NUMber''. This is another descriptor representation for integers,
but this time a pointer representation that allows for arbitrarily
large integers. Bignum operations are less efficient than fixnum
operations, both because of the consing and memory reference
overheads of a pointer descriptor, and also because of the inherent
complexity of extended precision arithmetic. While fixnum
operations can often be done with a single instruction, bignum
operations are so complex that they are always done using generic
arithmetic.<br>
<br>
A crucial point is that the compiler will use generic arithmetic if
it can't <tt class="variable">prove</tt> that all the arguments,
intermediate values, and results are fixnums. With bounded integer
types such as <tt class="code">fixnum</tt>, the result type proves
to be especially problematical, since these types are not closed
under common arithmetic operations such as <tt class="code">+</tt>,
<tt class="code">-</tt>, <tt class="code">*</tt> and <tt class=
"code">/</tt>. For example, <tt class="code">(1+ (the fixnum
x))</tt> does not necessarily evaluate to a <tt class=
"code">fixnum</tt>. Bignums were added to Common Lisp to get around
this problem, but they really just transform the correctness
problem ``if this add overflows, you will get the wrong answer'' to
the efficiency problem ``if this add <tt class=
"variable">might</tt> overflow then your program will run slowly
(because of generic arithmetic.)''<br>
<br>
There is just no getting around the fact that the hardware only
directly supports short integers. To get the most efficient open
coding, the compiler must be able to prove that the result is a
good integer type. This is an argument in favor of using more
restrictive integer types: <tt class="code">(1+ (the fixnum
x))</tt> may not always be a <tt class="code">fixnum</tt>, but
<tt class="code">(1+ (the (unsigned-byte 8) x))</tt> always is. Of
course, you can also assert the result type by putting in lots of
<tt class="code">the</tt> declarations and then compiling with
<tt class="code">safety</tt> <tt class="code">0</tt>.<br>
<br>
<!--TOC subsection Word Integers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc193" id="htoc193"><b><font size=
"4">5.11.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Word
Integers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="word-integers" id="word-integers"></a> <a name=
"@concept237"></a><br>
Python is unique in its efficient implementation of arithmetic on
full-word integers through non-descriptor representations and open
coding. Arithmetic on any subtype of these types:
<blockquote class="lisp">
<pre>
(signed-byte 32)
(unsigned-byte 32)
</pre></blockquote>
is reasonably efficient, although subtypes of <tt class=
"code">fixnum</tt> remain somewhat more efficient.<br>
<br>
If a word integer must be represented as a descriptor, then the
<tt class="code">bignum</tt> representation is used, with its
associated consing overhead. The support for word integers in no
way changes the language semantics, it just makes arithmetic on
small bignums vastly more efficient. It is fine to do arithmetic
operations with mixed <tt class="code">fixnum</tt> and word integer
operands; just declare the most specific integer type you can, and
let the compiler decide what representation to use.<br>
<br>
In fact, to most users, the greatest advantage of word integer
arithmetic is that it effectively provides a few guard bits on the
fixnum representation. If there are missing assertions on
intermediate values in a fixnum expression, the intermediate
results can usually be proved to fit in a word. After the whole
expression is evaluated, there will often be a fixnum assertion on
the final result, allowing creation of a fixnum result without even
checking for overflow.<br>
<br>
The remarks in section <a href="#fixnums">5.11.5</a> about fixnum
result type also apply to word integers; you must be careful to
give the compiler enough information to prove that the result is
still a word integer. This time, though, when we blow out of word
integers we land in into generic bignum arithmetic, which is much
worse than sleazing from <tt class="code">fixnum</tt>s to word
integers. Note that mixing <tt class="code">(unsigned-byte 32)</tt>
arguments with arguments of any signed type (such as <tt class=
"code">fixnum</tt>) is a no-no, since the result might not be
unsigned.<br>
<br>
<!--TOC subsection Floating Point Efficiency-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc194" id="htoc194"><b><font size=
"4">5.11.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Floating Point
Efficiency</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="float-efficiency" id="float-efficiency"></a> <a name=
"@concept238"></a><br>
Arithmetic on objects of type <tt class="code">single-float</tt>
and <tt class="code">double-float</tt> is efficiently implemented
using non-descriptor representations and open coding. As for
integer arithmetic, the arguments must be known to be of the same
float type. Unlike for integer arithmetic, the results and
intermediate values usually take care of themselves due to the
rules of float contagion, i.e. <tt class="code">(1+ (the
single-float x))</tt> is always a <tt class=
"code">single-float</tt>.<br>
<br>
Although they are not specially implemented, <tt class=
"code">short-float</tt> and <tt class="code">long-float</tt> are
also acceptable in declarations, since they are synonyms for the
<tt class="code">single-float</tt> and <tt class=
"code">double-float</tt> types, respectively.<br>
<br>
In CMUCL, list-style float type specifiers such as <tt class=
"code">(single-float 0.0 1.0)</tt> will be used to good effect.<br>
<br>
For example, in this function,
<blockquote class="example">
<pre>
  (defun square (x)
    (declare (type (single-float 0f0 10f0)))
    (* x x))
</pre></blockquote>
Python can deduce that the return type of the function <tt class=
"code">square</tt> is <tt class="code">(single-float 0f0
100f0)</tt>.<br>
<br>
Many union types are also supported so that
<blockquote class="example">
<pre>
  (+ (the (or (integer 1 1) (integer 5 5)) x)
     (the (or (integer 10 10) (integer 20 20)) y))
</pre></blockquote>
has the inferred type <tt class="code">(or (integer 11 11) (integer
15 15) (integer 21 21) (integer 25 25))</tt>. This also works for
floating-point numbers. Member types are also supported.<br>
<br>
CMUCL can also infer types for many mathematical functions
including square root, exponential and logarithmic functions,
trignometric functions and their inverses, and hyperbolic functions
and their inverses. For numeric code, this can greatly enhance
efficiency by allowing the compiler to use specialized versions of
the functions instead of the generic versions. The greatest benefit
of this type inference is determining that the result of the
function is real-valued number instead of possibly being a
complex-valued number.<br>
<br>
For example, consider the function
<blockquote class="example">
<pre>
  (defun fun (x)
    (declare (type (single-float (0f0) 100f0) x))
    (values (sqrt x) (log x)))
</pre></blockquote>
With this declaration, the compiler can determine that the argument
to <tt class="code">sqrt</tt> and <tt class="code">log</tt> are
always non-negative so that the result is always a <tt class=
"code">single-float</tt>. In fact, the return type for this
function is derived to be <tt class="code">(values (single-float
0f0 10f0) (single-float * 2f0))</tt>.<br>
<br>
If the declaration were reduced to just <tt class="code">(declare
(single-float x))</tt>, the argument to <tt class="code">sqrt</tt>
and <tt class="code">log</tt> could be negative. This forces the
use of the generic versions of these functions because the result
could be a complex number.<br>
<br>
We note, however, that proper interval arithmetic is not fully
implemented in the compiler so the inferred types may be slightly
in error due to round-off errors. This round-off error could
accumulate to cause the compiler to erroneously deduce the result
type and cause code to be removed as being
unreachable.<sup><a name="text14" href="#note14" id=
"text14"><font size="2">4</font></a></sup>Thus, the declarations
should only be precise enough for the compiler to deduce that a
real-valued argument to a function would produce a real-valued
result. The efficiency notes (see section&nbsp;<a href=
"#representation-eff-note">5.13.3</a>) from the compiler will guide
you on what declarations might be useful.<br>
<br>
When a float must be represented as a descriptor, a pointer
representation is used, creating consing overhead. For this reason,
you should try to avoid situations (such as full call and
non-specialized data structures) that force a descriptor
representation. See sections <a href=
"#specialized-array-types">5.11.8</a>, <a href=
"#raw-slots">5.11.9</a> and <a href=
"#number-local-call">5.11.10</a>.<br>
<br>
See section&nbsp;<a href="#ieee-float">2.1.2</a> for information on
the extensions to support IEEE floating point.<br>
<br>
<!--TOC subsubsection Signed Zeroes and Special Functions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFED">
<div align="center">
<table>
<tr>
<td><b>5.11.7.1</b></td>
<td width="100%" align="center"><b>Signed Zeroes and Special
Functions</b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL supports IEEE signed zeroes. In typical usage, the signed
zeroes are not a problem and can be treated as an unsigned zero.
However, some of the special functions have branch points at zero,
so care must be taken.<br>
<br>
For example, suppose we have the function
<blockquote class="example">
<pre>
  (defun fun (x)
    (declare (type (single-float 0f0) x))
    (log x))
</pre></blockquote>
The derived result of the function is <tt class="code">(OR
SINGLE-FLOAT (COMPLEX SINGLE-FLOAT))</tt> because the declared
values for <tt class="code">x</tt> includes both -0.0 and 0.0 and
<tt class="code">(log -0.0)</tt> is actually a complex number.
Because of this, the generic complex log routine is used.<br>
<br>
If the declaration for <tt class="code">x</tt> were <tt class=
"code">(single-float (0f0))</tt> so +0.0 is not included or
<tt class="code">(or (single-float (0f0)) (member 0f0))</tt> so
+0.0 is include but not -0.0, the derived type would be <tt class=
"code">single-float</tt> for both cases. By declaring <tt class=
"code">x</tt> this way, the log can be implemented using a fast
real-valued log routine instead of the generic log routine.<br>
<br>
CMUCL implements the branch cuts and values given by
Kahan<sup><a name="text15" href="#note15" id="text15"><font size=
"2">5</font></a></sup>.<br>
<br>
<!--TOC subsection Specialized Arrays-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc195" id="htoc195"><b><font size=
"4">5.11.8</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Specialized
Arrays</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="specialized-array-types" id="specialized-array-types"></a>
<a name="@concept239"></a> <a name="@concept240"></a> <a name=
"@concept241"></a><br>
Common Lisp supports specialized array element types through the
<tt class="code">:element-type</tt> argument to <tt class=
"code">make-array</tt>. When an array has a specialized element
type, only elements of that type can be stored in the array. From
this restriction comes two major efficiency advantages:
<ul>
<li>A specialized array can save space by packing multiple elements
into a single word. For example, a <tt class="code">base-char</tt>
array can have 4 elements per word, and a <tt class="code">bit</tt>
array can have 32. This space-efficient representation is possible
because it is not necessary to separately indicate the type of each
element.<br>
<br></li>
<li>The elements in a specialized array can be given the same
non-descriptor representation as the one used in registers and on
the stack, eliminating the need for representation conversions when
reading and writing array elements. For objects with pointer
descriptor representations (such as floats and word integers) there
is also a substantial consing reduction because it is not necessary
to allocate a new object every time an array element is
modified.</li>
</ul>
These are the specialized element types currently supported:
<blockquote class="lisp">
<pre>
bit
(unsigned-byte 2)
(unsigned-byte 4)
(unsigned-byte 8)
(unsigned-byte 16)
(unsigned-byte 32)
(signed-byte 8)
(signed-byte 16)
(signed-byte 30)
(signed-byte 32)
base-character
single-float
double-float
(complex single-float)
(complex double-float)
</pre></blockquote>
Although a <tt class="code">simple-vector</tt> can hold any type of
object, <tt class="code">t</tt> should still be considered a
specialized array type, since arrays with element type <tt class=
"code">t</tt> are specialized to hold descriptors.<br>
<br>
When using non-descriptor representations, it is particularly
important to make sure that array accesses are open-coded, since in
addition to the generic operation overhead, efficiency is lost when
the array element is converted to a descriptor so that it can be
passed to (or from) the generic access routine. You can detect
inefficient array accesses by enabling efficiency notes, see
section&nbsp;<a href="#efficiency-notes">5.13</a>. See
section&nbsp;<a href="#array-types">5.10.3</a>.<br>
<br>
<!--TOC subsection Specialized Structure Slots-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc196" id="htoc196"><b><font size=
"4">5.11.9</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Specialized
Structure Slots</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="raw-slots" id="raw-slots"></a> <a name="@concept242"></a>
<a name="@concept243"></a><br>
Structure slots declared by the <tt class="code">:type</tt>
<tt class="code">defstruct</tt> slot option to have certain known
numeric types are also given non-descriptor representations. These
types (and subtypes of these types) are supported:
<blockquote class="lisp">
<pre>
(unsigned-byte 32)
single-float
double-float
(complex single-float)
(complex double-float)
</pre></blockquote>
The primary advantage of specialized slot representations is a
large reduction spurious memory allocation and access overhead of
programs that intensively use these types.<br>
<br>
<!--TOC subsection Interactions With Local Call-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc197" id="htoc197"><b><font size=
"4">5.11.10</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Interactions With
Local Call</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="number-local-call" id="number-local-call"></a> <a name=
"@concept244"></a> <a name="@concept245"></a> <a name=
"@concept246"></a><br>
Local call has many advantages (see section&nbsp;<a href=
"#local-call">5.6</a>); one relevant to our discussion here is that
local call extends the usefulness of non-descriptor
representations. If the compiler knows from the argument type that
an argument has a non-descriptor representation, then the argument
will be passed in that representation. The easiest way to ensure
that the argument type is known at compile time is to always
declare the argument type in the called function, like:
<blockquote class="lisp">
<pre>
(defun 2+f (x)
  (declare (single-float x))
  (+ x 2.0))
</pre></blockquote>
The advantages of passing arguments and return values in a
non-descriptor representation are the same as for non-descriptor
representations in general: reduced consing and memory access (see
section&nbsp;<a href="#non-descriptor">5.11.2</a>.) This extends
the applicative programming styles discussed in section <a href=
"#local-call">5.6</a> to numeric code. Also, if source files are
kept reasonably small, block compilation can be used to reduce
number consing to a minimum.<br>
<br>
Note that non-descriptor return values can only be used with the
known return convention (section <a href=
"#local-call-return">5.6.5</a>.) If the compiler can't prove that a
function always returns the same number of values, then it must use
the unknown values return convention, which requires a descriptor
representation. Pay attention to the known return efficiency notes
to avoid number consing.<br>
<br>
<!--TOC subsection Representation of Characters-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc198" id="htoc198"><b><font size=
"4">5.11.11</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Representation of
Characters</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="characters" id="characters"></a> <a name=
"@concept247"></a> <a name="@concept248"></a><br>
Python also uses a non-descriptor representation for characters
when convenient. This improves the efficiency of string
manipulation, but is otherwise pretty invisible; characters have an
immediate descriptor representation, so there is not a great
penalty for converting a character to a descriptor. Nonetheless, it
may sometimes be helpful to declare character-valued variables as
<tt class="code">base-character</tt>.<br>
<br>
<!--TOC section General Efficiency Hints-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc199" id="htoc199"><b><font size=
"5">5.12</font></b></a></td>
<td width="100%" align="center"><b><font size="5">General
Efficiency Hints</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="general-efficiency" id="general-efficiency"></a> <a name=
"@concept249"></a><br>
This section is a summary of various implementation costs and ways
to get around them. These hints are relatively unrelated to the use
of the Python compiler, and probably also apply to most other
Common Lisp implementations. In each section, there are references
to related in-depth discussion.<br>
<br>
<!--TOC subsection Compile Your Code-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc200" id="htoc200"><b><font size=
"4">5.12.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Compile Your
Code</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept250"></a><br>
At this point, the advantages of compiling code relative to running
it interpreted probably need not be emphasized too much, but
remember that in CMUCL, compiled code typically runs hundreds of
times faster than interpreted code. Also, compiled (<tt class=
"code">fasl</tt>) files load significantly faster than source
files, so it is worthwhile compiling files which are loaded many
times, even if the speed of the functions in the file is
unimportant.<br>
<br>
Even disregarding the efficiency advantages, compiled code is as
good or better than interpreted code. Compiled code can be debugged
at the source level (see chapter <a href="#debugger">3</a>), and
compiled code does more error checking. For these reasons, the
interpreter should be regarded mainly as an interactive command
interpreter, rather than as a programming language
implementation.<br>
<br>
Do not be concerned about the performance of your program until you
see its speed compiled. Some techniques that make compiled code run
faster make interpreted code run slower.<br>
<br>
<!--TOC subsection Avoid Unnecessary Consing-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc201" id="htoc201"><b><font size=
"4">5.12.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Avoid Unnecessary
Consing</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="consing" id="consing"></a> <a name="@concept251"></a>
<a name="@concept252"></a> <a name="@concept253"></a> <a name=
"@concept254"></a><br>
Consing is another name for allocation of storage, as done by the
<tt class="code">cons</tt> function (hence its name.) <tt class=
"code">cons</tt> is by no means the only function which conses---so
does <tt class="code">make-array</tt> and many other functions.
Arithmetic and function call can also have hidden consing
overheads. Consing hurts performance in the following ways:
<ul>
<li>Consing reduces memory access locality, increasing paging
activity.<br>
<br></li>
<li>Consing takes time just like anything else.<br>
<br></li>
<li>Any space allocated eventually needs to be reclaimed, either by
garbage collection or by starting a new <tt class="code">lisp</tt>
process.</li>
</ul>
Consing is not undiluted evil, since programs do things other than
consing, and appropriate consing can speed up the real work. It
would certainly save time to allocate a vector of intermediate
results that are reused hundreds of times. Also, if it is necessary
to copy a large data structure many times, it may be more efficient
to update the data structure non-destructively; this somewhat
increases update overhead, but makes copying trivial.<br>
<br>
Note that the remarks in section <a href=
"#efficiency-overview">5.1.5</a> about the importance of separating
tuning from coding also apply to consing overhead. The majority of
consing will be done by a small portion of the program. The consing
hot spots are even less predictable than the CPU hot spots, so
don't waste time and create bugs by doing unnecessary consing
optimization. During initial coding, avoid unnecessary side-effects
and cons where it is convenient. If profiling reveals a consing
problem, <tt class="variable">then</tt> go back and fix the hot
spots.<br>
<br>
See section&nbsp;<a href="#non-descriptor">5.11.2</a> for a
discussion of how to avoid number consing in Python.<br>
<br>
<!--TOC subsection Complex Argument Syntax-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc202" id="htoc202"><b><font size=
"4">5.12.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Complex Argument
Syntax</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept255"></a> <a name="@concept256"></a> <a name=
"@concept257"></a> <a name="@concept258"></a><br>
Common Lisp has very powerful argument passing mechanisms.
Unfortunately, two of the most powerful mechanisms, rest arguments
and keyword arguments, have a significant performance penalty:
<ul>
<li>With keyword arguments, the called function has to parse the
supplied keywords by iterating over them and checking them against
the desired keywords.<br>
<br></li>
<li>With rest arguments, the function must cons a list to hold the
arguments. If a function is called many times or with many
arguments, large amounts of memory will be allocated.</li>
</ul>
Although rest argument consing is worse than keyword parsing,
neither problem is serious unless thousands of calls are made to
such a function. The use of keyword arguments is strongly
encouraged in functions with many arguments or with interfaces that
are likely to be extended, and rest arguments are often natural in
user interface functions.<br>
<br>
Optional arguments have some efficiency advantage over keyword
arguments, but their syntactic clumsiness and lack of extensibility
has caused many Common Lisp programmers to abandon use of optionals
except in functions that have obviously simple and immutable
interfaces (such as <tt class="code">subseq</tt>), or in functions
that are only called in a few places. When defining an interface
function to be used by other programmers or users, use of only
required and keyword arguments is recommended.<br>
<br>
Parsing of <tt class="code">defmacro</tt> keyword and rest
arguments is done at compile time, so a macro can be used to
provide a convenient syntax with an efficient implementation. If
the macro-expanded form contains no keyword or rest arguments, then
it is perfectly acceptable in inner loops.<br>
<br>
Keyword argument parsing overhead can also be avoided by use of
inline expansion (see section&nbsp;<a href=
"#inline-expansion">5.8</a>) and block compilation (section
<a href="#block-compilation">5.7</a>.)<br>
<br>
Note: the compiler open-codes most heavily used system functions
which have keyword or rest arguments, so that no run-time overhead
is involved.<br>
<br>
<!--TOC subsection Mapping and Iteration-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc203" id="htoc203"><b><font size=
"4">5.12.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Mapping and
Iteration</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept259"></a><br>
One of the traditional Common Lisp programming styles is a highly
applicative one, involving the use of mapping functions and many
lists to store intermediate results. To compute the sum of the
square-roots of a list of numbers, one might say:
<blockquote class="lisp">
<pre>
(apply #'+ (mapcar #'sqrt list-of-numbers))
</pre></blockquote>
This programming style is clear and elegant, but unfortunately
results in slow code. There are two reasons why:
<ul>
<li>The creation of lists of intermediate results causes much
consing (see <a href="#consing">5.12.2</a>).<br>
<br></li>
<li>Each level of application requires another scan down the list.
Thus, disregarding other effects, the above code would probably
take twice as long as a straightforward iterative version.</li>
</ul>
An example of an iterative version of the same code:
<blockquote class="lisp">
<pre>
(do ((num list-of-numbers (cdr num))
     (sum 0 (+ (sqrt (car num)) sum)))
    ((null num) sum))
</pre></blockquote>
See sections <a href="#variable-type-inference">5.3.1</a> and
<a href="#let-optimization">5.4.1</a> for a discussion of the
interactions of iteration constructs with type inference and
variable optimization. Also, section <a href=
"#local-tail-recursion">5.6.4</a> discusses an applicative style of
iteration.<br>
<br>
<!--TOC subsection Trace Files and Disassembly-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc204" id="htoc204"><b><font size=
"4">5.12.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Trace Files and
Disassembly</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="trace-files" id="trace-files"></a> <a name=
"@concept260"></a> <a name="@concept261"></a> <a name=
"@concept262"></a> <a name="@concept263"></a> <a name=
"@concept264"></a> <a name="@concept265"></a><br>
In order to write efficient code, you need to know the relative
costs of different operations. The main reason why writing
efficient Common Lisp code is difficult is that there are so many
operations, and the costs of these operations vary in obscure
context-dependent ways. Although efficiency notes point out some
problem areas, the only way to ensure generation of the best code
is to look at the assembly code output.<br>
<br>
The <tt class="code">disassemble</tt> function is a convenient way
to get the assembly code for a function, but it can be very
difficult to interpret, since the correspondence with the original
source code is weak. A better (but more awkward) option is to use
the <tt class="code">:trace-file</tt> argument to <tt class=
"code">compile-file</tt> to generate a trace file.<br>
<br>
A trace file is a dump of the compiler's internal representations,
including annotated assembly code. Each component in the program
gets four pages in the trace file (separated by `` <tt class=
"code"><i>L</i></tt>''):
<ul>
<li>The implicit-continuation (or IR1) representation of the
optimized source. This is a dump of the flow graph representation
used for ``source level'' optimizations. As you will quickly
notice, it is not really very close to the source. This
representation is not very useful to even sophisticated users.<br>
<br></li>
<li>The Virtual Machine (VM, or IR2) representation of the program.
This dump represents the generated code as sequences of ``Virtual
OPerations'' (VOPs.) This representation is intermediate between
the source and the assembly code---each VOP corresponds fairly
directly to some primitive function or construct, but a given VOP
also has a fairly predictable instruction sequence. An operation
(such as <tt class="code">+</tt>) may have multiple implementations
with different cost and applicability. The choice of a particular
VOP such as <tt class="code">+/fixnum</tt> or <tt class=
"code">+/single-float</tt> represents this choice of
implementation. Once you are familiar with it, the VM
representation is probably the most useful for determining what
implementation has been used.<br>
<br></li>
<li>An assembly listing, annotated with the VOP responsible for
generating the instructions. This listing is useful for figuring
out what a VOP does and how it is implemented in a particular
context, but its large size makes it more difficult to read.<br>
<br></li>
<li>A disassembly of the generated code, which has all
pseudo-operations expanded out, but is not annotated with
VOPs.</li>
</ul>
Note that trace file generation takes much space and time, since
the trace file is tens of times larger than the source file. To
avoid huge confusing trace files and much wasted time, it is best
to separate the critical program portion into its own file and then
generate the trace file from this small file.<br>
<br>
<!--TOC section Efficiency Notes-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc205" id="htoc205"><b><font size=
"5">5.13</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Efficiency
Notes</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="efficiency-notes" id="efficiency-notes"></a> <a name=
"@concept266"></a> <a name="@concept267"></a> <a name=
"@concept268"></a><br>
Efficiency notes are messages that warn the user that the compiler
has chosen a relatively inefficient implementation for some
operation. Usually an efficiency note reflects the compiler's
desire for more type information. If the type of the values
concerned is known to the programmer, then additional declarations
can be used to get a more efficient implementation.<br>
<br>
Efficiency notes are controlled by the <tt class=
"code">extensions:inhibit-warnings</tt> (see section&nbsp;<a href=
"#optimize-declaration">4.7.1</a>) optimization quality. When
<tt class="code">speed</tt> is greater than <tt class=
"code">extensions:inhibit-warnings</tt>, efficiency notes are
enabled. Note that this implicitly enables efficiency notes
whenever <tt class="code">speed</tt> is increased from its default
of <tt class="code">1</tt>.<br>
<br>
Consider this program with an obscure missing declaration:
<blockquote class="lisp">
<pre>
(defun eff-note (x y z)
  (declare (fixnum x y z))
  (the fixnum (+ x y z)))
</pre></blockquote>
If compiled with <tt class="code">(speed 3) (safety 0)</tt>, this
note is given:
<blockquote class="example">
<pre>
In: DEFUN EFF-NOTE
  (+ X Y Z)
==&gt;
  (+ (+ X Y) Z)
Note: Forced to do inline (signed-byte 32) arithmetic (cost 3).
      Unable to do inline fixnum arithmetic (cost 2) because:
      The first argument is a (INTEGER -1073741824 1073741822),
      not a FIXNUM.
</pre></blockquote>
This efficiency note tells us that the result of the intermediate
computation <tt class="code">(+ x y)</tt> is not known to be a
<tt class="code">fixnum</tt>, so the addition of the intermediate
sum to <tt class="code">z</tt> must be done less efficiently. This
can be fixed by changing the definition of <tt class=
"code">eff-note</tt>:
<blockquote class="lisp">
<pre>
(defun eff-note (x y z)
  (declare (fixnum x y z))
  (the fixnum (+ (the fixnum (+ x y)) z)))
</pre></blockquote>
<!--TOC subsection Type Uncertainty-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc206" id="htoc206"><b><font size=
"4">5.13.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Type
Uncertainty</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept269"></a> <a name="@concept270"></a><br>
The main cause of inefficiency is the compiler's lack of adequate
information about the types of function argument and result values.
Many important operations (such as arithmetic) have an inefficient
general (generic) case, but have efficient implementations that can
usually be used if there is sufficient argument type
information.<br>
<br>
Type efficiency notes are given when a value's type is uncertain.
There is an important distinction between values that are <em>not
known</em> to be of a good type (uncertain) and values that are
<em>known not</em> to be of a good type. Efficiency notes are given
mainly for the first case (uncertain types.) If it is clear to the
compiler that that there is not an efficient implementation for a
particular function call, then an efficiency note will only be
given if the <tt class="code">extensions:inhibit-warnings</tt>
optimization quality is <tt class="code">0</tt> (see
section&nbsp;<a href="#optimize-declaration">4.7.1</a>.)<br>
<br>
In other words, the default efficiency notes only suggest that you
add declarations, not that you change the semantics of your program
so that an efficient implementation will apply. For example,
compilation of this form will not give an efficiency note:
<blockquote class="lisp">
<pre>
(elt (the list l) i)
</pre></blockquote>
even though a vector access is more efficient than indexing a
list.<br>
<br>
<!--TOC subsection Efficiency Notes and Type Checking-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc207" id="htoc207"><b><font size=
"4">5.13.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Efficiency Notes
and Type Checking</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept271"></a> <a name="@concept272"></a> <a name=
"@concept273"></a><br>
It is important that the <tt class="code">eff-note</tt> example
above used <tt class="code">(safety 0)</tt>. When type checking is
enabled, you may get apparently spurious efficiency notes. With
<tt class="code">(safety 1)</tt>, the note has this extra line on
the end:
<blockquote class="example">
<pre>
The result is a (INTEGER -1610612736 1610612733), not a FIXNUM.
</pre></blockquote>
This seems strange, since there is a <tt class="code">the</tt>
declaration on the result of that second addition.<br>
<br>
In fact, the inefficiency is real, and is a consequence of Python's
treating declarations as assertions to be verified. The compiler
can't assume that the result type declaration is true---it must
generate the result and then test whether it is of the appropriate
type.<br>
<br>
In practice, this means that when you are tuning a program to run
without type checks, you should work from the efficiency notes
generated by unsafe compilation. If you want code to run
efficiently with type checking, then you should pay attention to
all the efficiency notes that you get during safe compilation.
Since user supplied output type assertions (e.g., from <tt class=
"code">the</tt>) are disregarded when selecting operation
implementations for safe code, you must somehow give the compiler
information that allows it to prove that the result truly must be
of a good type. In our example, it could be done by constraining
the argument types more:
<blockquote class="lisp">
<pre>
(defun eff-note (x y z)
  (declare (type (unsigned-byte 18) x y z))
  (+ x y z))
</pre></blockquote>
Of course, this declaration is acceptable only if the arguments to
<tt class="code">eff-note</tt> always <tt class="variable">are</tt>
<tt class="code">(unsigned-byte 18)</tt> integers.<br>
<br>
<!--TOC subsection Representation Efficiency Notes-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc208" id="htoc208"><b><font size=
"4">5.13.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Representation
Efficiency Notes</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="representation-eff-note" id="representation-eff-note"></a>
<a name="@concept274"></a> <a name="@concept275"></a> <a name=
"@concept276"></a> <a name="@concept277"></a> <a name=
"@concept278"></a> <a name="@concept279"></a><br>
When operating on values that have non-descriptor representations
(see section&nbsp;<a href="#non-descriptor">5.11.2</a>), there can
be a substantial time and consing penalty for converting to and
from descriptor representations. For this reason, the compiler
gives an efficiency note whenever it is forced to do a
representation coercion more expensive than <a name=
"@vars53"></a><tt class=
"code">*efficiency-note-cost-threshold*</tt>.<br>
<br>
Inefficient representation coercions may be due to type
uncertainty, as in this example:
<blockquote class="lisp">
<pre>
(defun set-flo (x)
  (declare (single-float x))
  (prog ((var 0.0))
    (setq var (gorp))
    (setq var x)
    (return var)))
</pre></blockquote>
which produces this efficiency note:
<blockquote class="example">
<pre>
In: DEFUN SET-FLO
  (SETQ VAR X)
Note: Doing float to pointer coercion (cost 13) from X to VAR.
</pre></blockquote>
The variable <tt class="code">var</tt> is not known to always hold
values of type <tt class="code">single-float</tt>, so a descriptor
representation must be used for its value. In this sort of
situation, adding a declaration will eliminate the
inefficiency.<br>
<br>
Often inefficient representation conversions are not due to type
uncertainty---instead, they result from evaluating a non-descriptor
expression in a context that requires a descriptor result:
<ul>
<li>Assignment to or initialization of any data structure other
than a specialized array (see section&nbsp;<a href=
"#specialized-array-types">5.11.8</a>), or<br>
<br></li>
<li>Assignment to a <tt class="code">special</tt> variable, or<br>
<br></li>
<li>Passing as an argument or returning as a value in any function
call that is not a local call (see section&nbsp;<a href=
"#number-local-call">5.11.10</a>.)</li>
</ul>
If such inefficient coercions appear in a ``hot spot'' in the
program, data structures redesign or program reorganization may be
necessary to improve efficiency. See sections <a href=
"#block-compilation">5.7</a>, <a href="#numeric-types">5.11</a> and
<a href="#profiling">5.14</a>.<br>
<br>
Because representation selection is done rather late in
compilation, the source context in these efficiency notes is
somewhat vague, making interpretation more difficult. This is a
fairly straightforward example:
<blockquote class="lisp">
<pre>
(defun cf+ (x y)
  (declare (single-float x y))
  (cons (+ x y) t))
</pre></blockquote>
which gives this efficiency note:
<blockquote class="example">
<pre>
In: DEFUN CF+
  (CONS (+ X Y) T)
Note: Doing float to pointer coercion (cost 13), for:
      The first argument of CONS.
</pre></blockquote>
The source context form is almost always the form that receives the
value being coerced (as it is in the preceding example), but can
also be the source form which generates the coerced value.
Compiling this example:
<blockquote class="lisp">
<pre>
(defun if-cf+ (x y)
  (declare (single-float x y))
  (cons (if (grue) (+ x y) (snoc)) t))
</pre></blockquote>
produces this note:
<blockquote class="example">
<pre>
In: DEFUN IF-CF+
  (+ X Y)
Note: Doing float to pointer coercion (cost 13).
</pre></blockquote>
In either case, the note's text explanation attempts to include
additional information about what locations are the source and
destination of the coercion. Here are some example notes:
<blockquote class="example">
<pre>
  (IF (GRUE) X (SNOC))
Note: Doing float to pointer coercion (cost 13) from X.

  (SETQ VAR X)
Note: Doing float to pointer coercion (cost 13) from X to VAR.
</pre></blockquote>
Note that the return value of a function is also a place to which
coercions may have to be done:
<blockquote class="example">
<pre>
  (DEFUN F+ (X Y) (DECLARE (SINGLE-FLOAT X Y)) (+ X Y))
Note: Doing float to pointer coercion (cost 13) to "&lt;return value&gt;".
</pre></blockquote>
Sometimes the compiler is unable to determine a name for the source
or destination, in which case the source context is the only
clue.<br>
<br>
<!--TOC subsection Verbosity Control-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc209" id="htoc209"><b><font size=
"4">5.13.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Verbosity
Control</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept280"></a> <a name="@concept281"></a><br>
These variables control the verbosity of efficiency notes:<br>
<br>
<br>
<a name="@vars54"></a><a name="VR:efficiency-note-cost-threshold"
id="VR:efficiency-note-cost-threshold"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*efficiency-note-cost-threshold*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Before printing some efficiency notes, the compiler compares the
value of this variable to the difference in cost between the chosen
implementation and the best potential implementation. If the
difference is not greater than this limit, then no note is printed.
The units are implementation dependent; the initial value
suppresses notes about ``trivial'' inefficiencies. A value of
<tt class="code">1</tt> will note any inefficiency.</blockquote>
<br>
<a name="@vars55"></a><a name="VR:efficiency-note-limit" id=
"VR:efficiency-note-limit"></a>
<div align="left">[Variable]<br>
<tt class="function-name">*efficiency-note-limit*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
When printing some efficiency notes, the compiler reports possible
efficient implementations. The initial value of <tt class=
"code">2</tt> prevents excessively long efficiency notes in the
common case where there is no type information, so all
implementations are possible.</blockquote>
<!--TOC section Profiling-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc210" id="htoc210"><b><font size=
"5">5.14</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Profiling</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept282"></a> <a name="@concept283"></a> <a name=
"@concept284"></a> <a name="@concept285"></a> <a name="profiling"
id="profiling"></a><br>
The first step in improving a program's performance is to profile
the activity of the program to find where it spends its time. The
best way to do this is to use the profiling utility found in the
<tt class="code">profile</tt> package. This package provides a
macro <tt class="code">profile</tt> that encapsulates functions
with statistics gathering code.<br>
<br>
<!--TOC subsection Profile Interface-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc211" id="htoc211"><b><font size=
"4">5.14.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Profile
Interface</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@vars56"></a><a name="VR:timed-functions" id=
"VR:timed-functions"></a>
<div align="left">[Variable]<br>
<tt class="function-name">profile:</tt><tt class=
"function-name">*timed-functions*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable holds a list of all functions that are currently
being profiled.</blockquote>
<br>
<a name="@funs138"></a><a name="FN:profile" id="FN:profile"></a>
<div align="left">[Macro]<br>
<tt class="function-name">profile:</tt><tt class=
"function-name">profile</tt> <tt class="code">{<tt class=
"variable">name</tt> |<tt class="code">:callers</tt> <tt class=
"code">t</tt>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro wraps profiling code around the named functions. As in
<tt class="code">trace</tt>, the <tt class="variable">name</tt>s
are not evaluated. If a function is already profiled, then the
function is unprofiled and reprofiled (useful to notice function
redefinition.) A warning is printed for each name that is not a
defined function.<br>
<br>
If <tt class="code">:callers <tt class="variable">t</tt></tt> is
specified, then each function that calls this function is recorded
along with the number of calls made.</blockquote>
<br>
<a name="@funs139"></a><a name="FN:unprofile" id=
"FN:unprofile"></a>
<div align="left">[Macro]<br>
<tt class="function-name">profile:</tt><tt class=
"function-name">unprofile</tt> <tt class="code">{<tt class=
"variable">name</tt>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro removes profiling code from the named functions. If no
<tt class="variable">name</tt>s are supplied, all currently
profiled functions are unprofiled.</blockquote>
<br>
<a name="@funs140"></a><a name="FN:profile-all" id=
"FN:profile-all"></a>
<div align="left">[Macro]<br>
<tt class="function-name">profile:</tt><tt class=
"function-name">profile-all</tt> <tt class="code">&amp;key</tt>
<tt class="code">:package</tt> <tt class="code">:callers-p</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro in effect calls <tt class="code">profile:profile</tt>
for each function in the specified package which defaults to
<tt class="code">*package*</tt>. <tt class="code">:callers-p</tt>
has the same meaning as in <tt class=
"code">profile:profile</tt>.</blockquote>
<br>
<a name="@funs141"></a><a name="FN:report-time" id=
"FN:report-time"></a>
<div align="left">[Macro]<br>
<tt class="function-name">profile:</tt><tt class=
"function-name">report-time</tt> <tt class="code">{<tt class=
"variable">name</tt>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro prints a report for each <tt class="variable">name</tt>d
function of the following information:
<ul>
<li>The total CPU time used in that function for all calls,<br>
<br></li>
<li>the total number of bytes consed in that function for all
calls,<br>
<br></li>
<li>the total number of calls,<br>
<br></li>
<li>the average amount of CPU time per call.</li>
</ul>
Summary totals of the CPU time, consing and calls columns are
printed. An estimate of the profiling overhead is also printed (see
below). If no <tt class="variable">name</tt>s are supplied, then
the times for all currently profiled functions are
printed.</blockquote>
<br>
<a name="@funs142"></a><a name="FN:reset-time" id=
"FN:reset-time"></a>
<div align="left">[Macro]<br>
<tt class="function-name">reset-time</tt> <tt class=
"code">{<tt class="variable">name</tt>}</tt><sup><font size=
"2">*</font></sup> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro resets the profiling counters associated with the
<tt class="variable">name</tt>d functions. If no <tt class=
"variable">name</tt>s are supplied, then all currently profiled
functions are reset.</blockquote>
<!--TOC subsection Profiling Techniques-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc212" id="htoc212"><b><font size=
"4">5.14.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Profiling
Techniques</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Start by profiling big pieces of a program, then carefully choose
which functions close to, but not in, the inner loop are to be
profiled next. Avoid profiling functions that are called by other
profiled functions, since this opens the possibility of profiling
overhead being included in the reported times.<br>
<br>
If the per-call time reported is less than 1/10 second, then
consider the clock resolution and profiling overhead before you
believe the time. It may be that you will need to run your program
many times in order to average out to a higher resolution.<br>
<br>
<!--TOC subsection Nested or Recursive Calls-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc213" id="htoc213"><b><font size=
"4">5.14.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Nested or
Recursive Calls</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The profiler attempts to compensate for nested or recursive calls.
Time and consing overhead will be charged to the dynamically
innermost (most recent) call to a profiled function. So profiling a
subfunction of a profiled function will cause the reported time for
the outer function to decrease. However if an inner function has a
large number of calls, some of the profiling overhead may ``leak''
into the reported time for the outer function. In general, be wary
of profiling short functions that are called many times.<br>
<br>
<!--TOC subsection Clock resolution-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc214" id="htoc214"><b><font size=
"4">5.14.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Clock
resolution</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Unless you are very lucky, the length of your machine's clock
``tick'' is probably much longer than the time it takes simple
function to run. For example, on the IBM RT, the clock resolution
is 1/50 second. This means that if a function is only called a few
times, then only the first couple decimal places are really
meaningful.<br>
<br>
Note however, that if a function is called many times, then the
statistical averaging across all calls should result in increased
resolution. For example, on the IBM RT, if a function is called a
thousand times, then a resolution of tens of microseconds can be
expected.<br>
<br>
<!--TOC subsection Profiling overhead-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc215" id="htoc215"><b><font size=
"4">5.14.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Profiling
overhead</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The added profiling code takes time to run every time that the
profiled function is called, which can disrupt the attempt to
collect timing information. In order to avoid serious inflation of
the times for functions that take little time to run, an estimate
of the overhead due to profiling is subtracted from the times
reported for each function.<br>
<br>
Although this correction works fairly well, it is not totally
accurate, resulting in times that become increasingly meaningless
for functions with short runtimes. This is only a concern when the
estimated profiling overhead is many times larger than reported
total CPU time.<br>
<br>
The estimated profiling overhead is not represented in the reported
total CPU time. The sum of total CPU time and the estimated
profiling overhead should be close to the total CPU time for the
entire profiling run (as determined by the <tt class=
"code">time</tt> macro.) Time unaccounted for is probably being
used by functions that you forgot to profile.<br>
<br>
<!--TOC subsection Additional Timing Utilities-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc216" id="htoc216"><b><font size=
"4">5.14.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Additional Timing
Utilities</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs143"></a><a name="FN:time" id="FN:time"></a>
<div align="left">[Macro]<br>
<tt class="function-name">time</tt> <tt class="variable">form</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro evaluates <tt class="variable">form</tt>, prints some
timing and memory allocation information to <tt class=
"code">*trace-output*</tt>, and returns any values that <tt class=
"variable">form</tt> returns. The timing information includes real
time, user run time, and system run time. This macro executes a
form and reports the time and consing overhead. If the <tt class=
"code">time</tt> form is not compiled (e.g. it was typed at
top-level), then <tt class="code">compile</tt> will be called on
the form to give more accurate timing information. If you really
want to time interpreted speed, you can say:
<blockquote class="lisp">
<pre>
(time (eval '<tt class="variable">form</tt>))
</pre></blockquote>
Things that execute fairly quickly should be timed more than once,
since there may be more paging overhead in the first timing. To
increase the accuracy of very short times, you can time multiple
evaluations:
<blockquote class="lisp">
<pre>
(time (dotimes (i 100) <tt class="variable">form</tt>))
</pre></blockquote>
</blockquote>
<br>
<a name="@funs144"></a><a name="FN:get-bytes-consed" id=
"FN:get-bytes-consed"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">get-bytes-consed</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the number of bytes allocated since the first
time you called it. The first time it is called it returns zero.
The above profiling routines use this to report consing
information.</blockquote>
<br>
<a name="@vars57"></a><a name="VR:gc-run-time" id=
"VR:gc-run-time"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*gc-run-time*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This variable accumulates the run-time consumed by garbage
collection, in the units returned by <a name=
"@funs145"></a><tt class=
"code">get-internal-run-time</tt>.</blockquote>
<br>
<div align="left">[Constant]<br>
<tt class="function-name">internal-time-units-per-second</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>The value of internal-time-units-per-second is
100.</blockquote>
<!--TOC subsection A Note on Timing-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc217" id="htoc217"><b><font size=
"4">5.14.7</font></b></a></td>
<td width="100%" align="center"><b><font size="4">A Note on
Timing</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept286"></a> <a name="@concept287"></a> <a name=
"@concept288"></a><br>
There are two general kinds of timing information provided by the
<tt class="code">time</tt> macro and other profiling utilities:
real time and run time. Real time is elapsed, wall clock time. It
will be affected in a fairly obvious way by any other activity on
the machine. The more other processes contending for CPU and
memory, the more real time will increase. This means that real time
measurements are difficult to replicate, though this is less true
on a dedicated workstation. The advantage of real time is that it
is real. It tells you really how long the program took to run under
the benchmarking conditions. The problem is that you don't know
exactly what those conditions were.<br>
<br>
Run time is the amount of time that the processor supposedly spent
running the program, as opposed to waiting for I/O or running other
processes. ``User run time'' and ``system run time'' are numbers
reported by the Unix kernel. They are supposed to be a measure of
how much time the processor spent running your ``user'' program
(which will include GC overhead, etc.), and the amount of time that
the kernel spent running ``on your behalf.''<br>
<br>
Ideally, user time should be totally unaffected by benchmarking
conditions; in reality user time does depend on other system
activity, though in rather non-obvious ways.<br>
<br>
System time will clearly depend on benchmarking conditions. In Lisp
benchmarking, paging activity increases system run time (but not by
as much as it increases real time, since the kernel spends some
time waiting for the disk, and this is not run time, kernel or
otherwise.)<br>
<br>
In my experience, the biggest trap in interpreting kernel/user run
time is to look only at user time. In reality, it seems that the
<tt class="variable">sum</tt> of kernel and user time is more
reproducible. The problem is that as system activity increases,
there is a spurious <tt class="variable">decrease</tt> in user run
time. In effect, as paging, etc., increases, user time leaks into
system time.<br>
<br>
So, in practice, the only way to get truly reproducible results is
to run with the same competing activity on the system. Try to run
on a machine with nobody else logged in, and check with ``ps aux''
to see if there are any system processes munching large amounts of
CPU or memory. If the ratio between real time and the sum of user
and system time varies much between runs, then you have a
problem.<br>
<br>
<!--TOC subsection Benchmarking Techniques-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc218" id="htoc218"><b><font size=
"4">5.14.8</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Benchmarking
Techniques</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept289"></a><br>
Given these imperfect timing tools, how do should you do
benchmarking? The answer depends on whether you are trying to
measure improvements in the performance of a single program on the
same hardware, or if you are trying to compare the performance of
different programs and/or different hardware.<br>
<br>
For the first use (measuring the effect of program modifications
with constant hardware), you should look at <tt class=
"variable">both</tt> system+user and real time to understand what
effect the change had on CPU use, and on I/O (including paging.) If
you are working on a CPU intensive program, the change in
system+user time will give you a moderately reproducible measure of
performance across a fairly wide range of system conditions. For a
CPU intensive program, you can think of system+user as ``how long
it would have taken to run if I had my own machine.'' So in the
case of comparing CPU intensive programs, system+user time is
relatively real, and reasonable to use.<br>
<br>
For programs that spend a substantial amount of their time paging,
you really can't predict elapsed time under a given operating
condition without benchmarking in that condition. User or
system+user time may be fairly reproducible, but it is also
relatively meaningless, since in a paging or I/O intensive program,
the program is spending its time waiting, not running, and system
time and user time are both measures of run time. A change that
reduces run time might increase real time by increasing paging.<br>
<br>
Another common use for benchmarking is comparing the performance of
the same program on different hardware. You want to know which
machine to run your program on. For comparing different machines
(operating systems, etc.), the only way to compare that makes sense
is to set up the machines in <tt class="variable">exactly</tt> the
way that they will <tt class="variable">normally</tt> be run, and
then measure <tt class="variable">real</tt> time. If the program
will normally be run along with X, then run X. If the program will
normally be run on a dedicated workstation, then be sure nobody
else is on the benchmarking machine. If the program will normally
be run on a machine with three other Lisp jobs, then run three
other Lisp jobs. If the program will normally be run on a machine
with 64MB of memory, then run with 64MB. Here, ``normal'' means
``normal for that machine''.<br>
<br>
If you have a program you believe to be CPU intensive, then you
might be tempted to compare ``run'' times across systems, hoping to
get a meaningful result even if the benchmarking isn't done under
the expected running condition. Don't to this, for two reasons:
<ul>
<li>The operating systems might not compute run time in the same
way.<br>
<br></li>
<li>Under the real running condition, the program might not be CPU
intensive after all.</li>
</ul>
In the end, only real time means anything---it is the amount of
time you have to wait for the result. The only valid uses for run
time are:
<ul>
<li>To develop insight into the program. For example, if run time
is much less than elapsed time, then you are probably spending lots
of time paging.<br>
<br></li>
<li>To evaluate the relative performance of CPU intensive programs
in the same environment.</li>
</ul>
<!--NAME compiler-hint.html-->
<!--BEGIN NOTES chapter-->
<hr width="50%" size="1">
<dl>
<dt><a name="note11" href="#text11" id="note11"><font size=
"5">1</font></a></dt>
<dd>The source transformation in this example doesn't represent the
preservation of evaluation order implicit in the compiler's
internal representation. Where necessary, the back end will
reintroduce temporaries to preserve the semantics.</dd>
<dt><a name="note12" href="#text12" id="note12"><font size=
"5">2</font></a></dt>
<dd>Note that the code for <tt class="code">x</tt> and <tt class=
"code">y</tt> isn't actually replicated.</dd>
<dt><a name="note13" href="#text13" id="note13"><font size=
"5">3</font></a></dt>
<dd>As Steele notes in CLTL II, this is a generic conception of
generic, and is not to be confused with the CLOS concept of a
generic function.</dd>
<dt><a name="note14" href="#text14" id="note14"><font size=
"5">4</font></a></dt>
<dd>This, however, has not actually happened, but it is a
possibility.</dd>
<dt><a name="note15" href="#text15" id="note15"><font size=
"5">5</font></a></dt>
<dd>Kahan, W., ``Branch Cuts for Complex Elementary Functions, or
Much Ado About Nothing's Sign Bit'' in Iserles and Powell (eds.)
<i>The State of the Art in Numerical Analysis</i>, pp. 165-211,
Clarendon Press, 1987</dd>
</dl>
<!--END NOTES-->
<!--TOC chapter UNIX Interface-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc219" id="htoc219"><b><font size=
"6">Chapter&nbsp;6</font></b></a></td>
<td width="100%" align="center"><b><font size="6">UNIX
Interface</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="unix-interface" id="unix-interface"></a><br>
<div align="center"><b>by Robert MacLachlan, Skef Wholey, Bill
Chiles and William Lott</b></div>
<br>
CMUCL attempts to make the full power of the underlying environment
available to the Lisp programmer. This is done using combination of
hand-coded interfaces and foreign function calls to C libraries.
Although the techniques differ, the style of interface is similar.
This chapter provides an overview of the facilities available and
general rules for using them, as well as describing specific
features in detail. It is assumed that the reader has a working
familiarity with Unix and X11, as well as access to the standard
system documentation.<br>
<br>
<!--TOC section Reading the Command Line-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc220" id="htoc220"><b><font size=
"5">6.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Reading the
Command Line</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The shell parses the command line with which Lisp is invoked, and
passes a data structure containing the parsed information to Lisp.
This information is then extracted from that data structure and put
into a set of Lisp data structures.<br>
<br>
<br>
<a name="@vars58"></a><a name="VR:command-line-strings" id=
"VR:command-line-strings"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*command-line-strings*</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars59"></a><a name="VR:command-line-utility-name" id=
"VR:command-line-utility-name"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*command-line-utility-name*</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@vars60"></a><a name="VR:command-line-words" id=
"VR:command-line-words"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*command-line-words*</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@vars61"></a><a name="VR:command-line-switches" id=
"VR:command-line-switches"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*command-line-switches*</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
The value of <tt class="code">*command-line-words*</tt> is a list
of strings that make up the command line, one word per string. The
first word on the command line, i.e. the name of the program
invoked (usually <tt class="code">lisp</tt>) is stored in
<tt class="code">*command-line-utility-name*</tt>. The value of
<tt class="code">*command-line-switches*</tt> is a list of
<tt class="code">command-line-switch</tt> structures, with a
structure for each word on the command line starting with a hyphen.
All the command line words between the program name and the first
switch are stored in <tt class=
"code">*command-line-words*</tt>.</blockquote>
The following functions may be used to examine <tt class=
"code">command-line-switch</tt> structures.<br>
<br>
<br>
<a name="@funs146"></a><a name="FN:cmd-switch-name" id=
"FN:cmd-switch-name"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">cmd-switch-name</tt> <tt class=
"variable">switch</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Returns the name of the switch, less the preceding hyphen and
trailing equal sign (if any).</blockquote>
<br>
<a name="@funs147"></a><a name="FN:cmd-switch-value" id=
"FN:cmd-switch-value"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">cmd-switch-value</tt> <tt class=
"variable">switch</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Returns the value designated using an embedded equal sign, if any.
If the switch has no equal sign, then this is null.</blockquote>
<br>
<a name="@funs148"></a><a name="FN:cmd-switch-words" id=
"FN:cmd-switch-words"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">cmd-switch-words</tt> <tt class=
"variable">switch</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Returns a list of the words between this switch and the next switch
or the end of the command line.</blockquote>
<br>
<a name="@funs149"></a><a name="FN:cmd-switch-arg" id=
"FN:cmd-switch-arg"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">cmd-switch-arg</tt> <tt class=
"variable">switch</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Returns the first non-null value from <tt class=
"code">cmd-switch-value</tt>, the first element in <tt class=
"code">cmd-switch-words</tt>, or the first word in <tt class=
"variable">command-line-words</tt>.</blockquote>
<br>
<a name="@funs150"></a><a name="FN:get-command-line-switch" id=
"FN:get-command-line-switch"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">get-command-line-switch</tt> <tt class=
"variable">sname</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function takes the name of a switch as a string and returns
the value of the switch given on the command line. If no value was
specified, then any following words are returned. If there are no
following words, then <tt class="code">t</tt> is returned. If the
switch was not specified, then <tt class="code">nil</tt> is
returned.</blockquote>
<br>
<a name="@funs151"></a><a name="FN:defswitch" id=
"FN:defswitch"></a>
<div align="left">[Macro]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">defswitch</tt> <tt class="variable">name</tt>
<tt class="code">&amp;optional</tt> <tt class=
"variable">function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro causes <tt class="variable">function</tt> to be called
when the switch <tt class="variable">name</tt> appears in the
command line. Name is a simple-string that does not begin with a
hyphen (unless the switch name really does begin with one.)<br>
<br>
If <tt class="variable">function</tt> is not supplied, then the
switch is parsed into <tt class=
"variable">command-line-switches</tt>, but otherwise ignored. This
suppresses the undefined switch warning which would otherwise take
place. The warning can also be globally suppressed by <tt class=
"variable">complain-about-illegal-switches</tt>.</blockquote>
<!--TOC section Useful Variables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc221" id="htoc221"><b><font size=
"5">6.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Useful
Variables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@vars62"></a><a name="VR:stdin" id="VR:stdin"></a>
<div align="left">[Variable]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">*stdin*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@vars63"></a><a name="VR:stdout" id="VR:stdout"></a>
<div align="left">[Variable]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">*stdout*</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@vars64"></a><a name="VR:stderr" id="VR:stderr"></a>
<div align="left">[Variable]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">*stderr*</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
Streams connected to the standard input, output and error file
descriptors.</blockquote>
<br>
<a name="@vars65"></a><a name="VR:tty" id="VR:tty"></a>
<div align="left">[Variable]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">*tty*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
A stream connected to <tt class=
"filename">/dev/tty</tt>.</blockquote>
<br>
<a name="@vars66"></a><a name="VR:environment-list" id=
"VR:environment-list"></a>
<div align="left">[Variable]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">*environment-list*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>The environment variables inherited by the current
process, as a keyword-indexed alist. For example, to access the
DISPLAY environment variable, you could use
<blockquote class="lisp">
<pre>
   (cdr (assoc :display ext:*environment-list*))
</pre></blockquote>
Note that the case of the variable name is preserved when
converting to a keyword. Therefore, you need to specify the keyword
properly for variable names containing lower-case
letters,</blockquote>
<!--TOC section Lisp Equivalents for C Routines-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc222" id="htoc222"><b><font size=
"5">6.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Lisp Equivalents
for C Routines</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The UNIX documentation describes the system interface in terms of C
procedure headers. The corresponding Lisp function will have a
somewhat different interface, since Lisp argument passing
conventions and datatypes are different.<br>
<br>
The main difference in the argument passing conventions is that
Lisp does not support passing values by reference. In Lisp, all
argument and results are passed by value. Interface functions take
some fixed number of arguments and return some fixed number of
values. A given ``parameter'' in the C specification will appear as
an argument, return value, or both, depending on whether it is an
In parameter, Out parameter, or In/Out parameter. The basic
transformation one makes to come up with the Lisp equivalent of a C
routine is to remove the Out parameters from the call, and treat
them as extra return values. In/Out parameters appear both as
arguments and return values. Since Out and In/Out parameters are
only conventions in C, you must determine the usage from the
documentation.<br>
<br>
Thus, the C routine declared as
<blockquote class="example">
<pre>
kern_return_t lookup(servport, portsname, portsid)
        port        servport;
        char        *portsname;
        int        *portsid;        /* out */
 
  ...
  *portsid = &lt;expression to compute portsid field&gt;
  return(KERN_SUCCESS);
 
</pre></blockquote>
has as its Lisp equivalent something like
<blockquote class="lisp">
<pre>
(defun lookup (ServPort PortsName)
  ...
  (values
   success
   &lt;expression to compute portsid field&gt;))
</pre></blockquote>
If there are multiple out or in-out arguments, then there are
multiple additional returns values.<br>
<br>
Fortunately, CMUCL programmers rarely have to worry about the
nuances of this translation process, since the names of the
arguments and return values are documented in a way so that the
<tt class="code">describe</tt> function (and the Hemlock <tt class=
"code">Describe Function Call</tt> command, invoked with
C-M-Shift-A) will list this information. Since the names of
arguments and return values are usually descriptive, the
information that <tt class="code">describe</tt> prints is usually
all one needs to write a call. Most programmers use this on-line
documentation nearly all of the time, and thereby avoid the need to
handle bulky manuals and perform the translation from barbarous
tongues.<br>
<br>
<!--TOC section Type Translations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc223" id="htoc223"><b><font size=
"5">6.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Type
Translations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept290"></a> <a name="@concept291"></a> <a name=
"@concept292"></a><br>
Lisp data types have very different representations from those used
by conventional languages such as C. Since the system interfaces
are designed for conventional languages, Lisp must translate
objects to and from the Lisp representations. Many simple objects
have a direct translation: integers, characters, strings and
floating point numbers are translated to the corresponding Lisp
object. A number of types, however, are implemented differently in
Lisp for reasons of clarity and efficiency.<br>
<br>
Instances of enumerated types are expressed as keywords in Lisp.
Records, arrays, and pointer types are implemented with the Alien
facility (see section&nbsp;<a href="#aliens">8</a>). Access
functions are defined for these types which convert fields of
records, elements of arrays, or data referenced by pointers into
Lisp objects (possibly another object to be referenced with another
access function).<br>
<br>
One should dispose of Alien objects created by constructor
functions or returned from remote procedure calls when they are no
longer of any use, freeing the virtual memory associated with that
object. Since Aliens contain pointers to non-Lisp data, the garbage
collector cannot do this itself. If the memory was obtained from
<a name="@funs152"></a><tt class="code">make-alien</tt> or from a
foreign function call to a routine that used <tt class=
"code">malloc</tt>, then <a name="@funs153"></a><tt class=
"code">free-alien</tt> should be used.<br>
<br>
<!--TOC section System Area Pointers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc224" id="htoc224"><b><font size=
"5">6.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">System Area
Pointers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="system-area-pointers" id="system-area-pointers"></a><br>
<a name="@concept293"></a><a name="@concept294"></a><a name=
"@concept295"></a> Note that in some cases an address is
represented by a Lisp integer, and in other cases it is represented
by a real pointer. Pointers are usually used when an object in the
current address space is being referred to. The MACH virtual memory
manipulation calls must use integers, since in principle the
address could be in any process, and Lisp cannot abide random
pointers. Because these types are represented differently in Lisp,
one must explicitly coerce between these representations.<br>
<br>
System Area Pointers (SAPs) provide a mechanism that bypasses the
Alien type system and accesses virtual memory directly. A SAP is a
raw byte pointer into the <tt class="code">lisp</tt> process
address space. SAPs are represented with a pointer descriptor, so
SAP creation can cause consing. However, the compiler uses a
non-descriptor representation for SAPs when possible, so the
consing overhead is generally minimal. See section&nbsp;<a href=
"#non-descriptor">5.11.2</a>.<br>
<br>
<br>
<a name="@funs154"></a><a name="FN:sap-int" id="FN:sap-int"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">sap-int</tt> <tt class="variable">sap</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs155"></a><a name="FN:int-sap" id="FN:int-sap"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">int-sap</tt> <tt class="variable">int</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
The function <tt class="code">sap-int</tt> is used to generate an
integer corresponding to the system area pointer, suitable for
passing to the kernel interfaces (which want all addresses
specified as integers). The function <tt class="code">int-sap</tt>
is used to do the opposite conversion. The integer representation
of a SAP is the byte offset of the SAP from the start of the
address space.</blockquote>
<br>
<a name="@funs156"></a><a name="FN:sap+"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">sap+</tt> <tt class="variable">sap</tt> <tt class=
"variable">offset</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function adds a byte <tt class="variable">offset</tt> to
<tt class="variable">sap</tt>, returning a new SAP.</blockquote>
<br>
<a name="@funs157"></a><a name="FN:sap-ref-8" id=
"FN:sap-ref-8"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">sap-ref-8</tt> <tt class="variable">sap</tt>
<tt class="variable">offset</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs158"></a><a name="FN:sap-ref-16" id=
"FN:sap-ref-16"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">sap-ref-16</tt> <tt class="variable">sap</tt>
<tt class="variable">offset</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs159"></a><a name="FN:sap-ref-32" id=
"FN:sap-ref-32"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">sap-ref-32</tt> <tt class="variable">sap</tt>
<tt class="variable">offset</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
These functions return the 8, 16 or 32 bit unsigned integer at
<tt class="variable">offset</tt> from <tt class=
"variable">sap</tt>. The <tt class="variable">offset</tt> is always
a byte offset, regardless of the number of bits accessed.
<tt class="code">setf</tt> may be used with the these functions to
deposit values into virtual memory.</blockquote>
<br>
<a name="@funs160"></a><a name="FN:signed-sap-ref-8" id=
"FN:signed-sap-ref-8"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">signed-sap-ref-8</tt> <tt class="variable">sap</tt>
<tt class="variable">offset</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs161"></a><a name="FN:signed-sap-ref-16" id=
"FN:signed-sap-ref-16"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">signed-sap-ref-16</tt> <tt class=
"variable">sap</tt> <tt class="variable">offset</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs162"></a><a name="FN:signed-sap-ref-32" id=
"FN:signed-sap-ref-32"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">signed-sap-ref-32</tt> <tt class=
"variable">sap</tt> <tt class="variable">offset</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
These functions are the same as the above unsigned operations,
except that they sign-extend, returning a negative number if the
high bit is set.</blockquote>
<!--TOC section Unix System Calls-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc225" id="htoc225"><b><font size=
"5">6.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Unix System
Calls</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
You probably won't have much cause to use them, but all the Unix
system calls are available. The Unix system call functions are in
the <tt class="code">Unix</tt> package. The name of the interface
for a particular system call is the name of the system call
prepended with <tt class="code">unix-</tt>. The system usually
defines the associated constants without any prefix name. To find
out how to use a particular system call, try using <tt class=
"code">describe</tt> on it. If that is unhelpful, look at the
source in <tt class="filename">unix.lisp</tt> or consult your
system maintainer.<br>
<br>
The Unix system calls indicate an error by returning <tt class=
"code">nil</tt> as the first value and the Unix error number as the
second value. If the call succeeds, then the first value will
always be non-<tt class="code">nil</tt>, often <tt class=
"code">t</tt>.<br>
<br>
For example, to use the <tt class="code">chdir</tt> syscall:
<blockquote class="lisp">
<pre>
(multiple-value-bind (success errno)
    (unix:unix-chdir "/tmp")
  (unless success
     (error "Can't change working directory: ~a"
            (unix:get-unix-error-msg errno))))
</pre></blockquote>
<br>
<a name="@funs163"></a><a name="FN:get-unix-error-msg" id=
"FN:get-unix-error-msg"></a>
<div align="left">[Function]<br>
<tt class="function-name">Unix:</tt><tt class=
"function-name">get-unix-error-msg</tt> <tt class=
"variable">error</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a string describing the Unix error number
<tt class="variable">error</tt> (this is similar to the Unix
function <tt class="code">perror</tt>).</blockquote>
<!--TOC section File Descriptor Streams-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc226" id="htoc226"><b><font size=
"5">6.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">File Descriptor
Streams</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="sec:fds" id="sec:fds"></a><br>
Many of the UNIX system calls return file descriptors. Instead of
using other UNIX system calls to perform I/O on them, you can
create a stream around them. For this purpose, fd-streams exist.
See also <a name="@funs164"></a><tt class=
"code">read-n-bytes</tt>.<br>
<br>
<br>
<a name="@funs165"></a><a name="FN:make-fd-stream" id=
"FN:make-fd-stream"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">make-fd-stream</tt> <tt class=
"variable">descriptor</tt> <tt class="code">&amp;key</tt>
<tt class="code">:input</tt> <tt class="code">:output</tt>
<tt class="code">:element-type</tt><br>
<tt class="code">:buffering</tt> <tt class="code">:name</tt>
<tt class="code">:file</tt> <tt class="code">:original</tt><br>
<tt class="code">:delete-original</tt> <tt class=
"code">:auto-close</tt><br>
<tt class="code">:timeout</tt> <tt class="code">:pathname</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function creates a file descriptor stream using <tt class=
"variable">descriptor</tt>. If <tt class="code">:input</tt> is
non-<tt class="code">nil</tt>, input operations are allowed. If
<tt class="code">:output</tt> is non-<tt class="code">nil</tt>,
output operations are allowed. The default is input only. These
keywords are defined:
<dl compact="compact">
<dt><tt class="code">:element-type</tt><br></dt>
<dd>is the type of the unit of transaction for the stream, which
defaults to <tt class="code">string-char</tt>. See the Common Lisp
description of <tt class="code">open</tt> for valid values.<br>
<br></dd>
<dt><tt class="code">:buffering</tt><br></dt>
<dd>is the kind of output buffering desired for the stream. Legal
values are <tt class="code">:none</tt> for no buffering, <tt class=
"code">:line</tt> for buffering up to each newline, and <tt class=
"code">:full</tt> for full buffering.<br>
<br></dd>
<dt><tt class="code">:name</tt><br></dt>
<dd>is a simple-string name to use for descriptive purposes when
the system prints an fd-stream. When printing fd-streams, the
system prepends the streams name with <tt class="code">Stream
for</tt> . If <tt class="variable">name</tt> is unspecified, it
defaults to a string containing <tt class="variable">file</tt> or
<tt class="variable">descriptor</tt>, in order of preference.<br>
<br></dd>
<dt><tt class="code">:file</tt>, <tt class=
"code">:original</tt><br></dt>
<dd><tt class="variable">file</tt> specifies the defaulted
namestring of the associated file when creating a file stream (must
be a <tt class="code">simple-string</tt>). <tt class=
"variable">original</tt> is the <tt class="code">simple-string</tt>
name of a backup file containing the original contents of
<tt class="variable">file</tt> while writing <tt class=
"variable">file</tt>.<br>
<br>
When you abort the stream by passing <tt class="code">t</tt> to
<tt class="code">close</tt> as the second argument, if you supplied
both <tt class="variable">file</tt> and <tt class=
"variable">original</tt>, <tt class="code">close</tt> will rename
the <tt class="variable">original</tt> name to the <tt class=
"variable">file</tt> name. When you <tt class="code">close</tt> the
stream normally, if you supplied <tt class=
"variable">original</tt>, and <tt class=
"variable">delete-original</tt> is non-<tt class="code">nil</tt>,
<tt class="code">close</tt> deletes <tt class=
"variable">original</tt>. If <tt class="variable">auto-close</tt>
is true (the default), then <tt class="variable">descriptor</tt>
will be closed when the stream is garbage collected.<br>
<br></dd>
<dt><tt class="code">:pathname</tt><br></dt>
<dd>: The original pathname passed to open and returned by
<tt class="code">pathname</tt>; not defaulted or translated.<br>
<br></dd>
<dt><tt class="code">:timeout</tt><br></dt>
<dd>if non-null, then <tt class="variable">timeout</tt> is an
integer number of seconds after which an input wait should time
out. If a read does time out, then the <tt class=
"code">system:io-timeout</tt> condition is signalled.</dd>
</dl>
</blockquote>
<br>
<a name="@funs166"></a><a name="FN:fd-stream-p" id=
"FN:fd-stream-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">fd-stream-p</tt> <tt class="variable">object</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="code">t</tt> if <tt class=
"variable">object</tt> is an fd-stream, and <tt class=
"code">nil</tt> if not. Obsolete: use the portable <tt class=
"code">(typep x 'file-stream)</tt>.</blockquote>
<br>
<a name="@funs167"></a><a name="FN:fd-stream-fd" id=
"FN:fd-stream-fd"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">fd-stream-fd</tt> <tt class="variable">stream</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This returns the file descriptor associated with <tt class=
"variable">stream</tt>.</blockquote>
<!--TOC section Unix Signals-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc227" id="htoc227"><b><font size=
"5">6.8</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Unix
Signals</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="@concept296"></a> <a name="@concept297"></a><br>
CMUCL allows access to all the Unix signals that can be generated
under Unix. It should be noted that if this capability is abused,
it is possible to completely destroy the running Lisp. The
following macros and functions allow access to the Unix interrupt
system. The signal names as specified in section 2 of the <em>Unix
Programmer's Manual</em> are exported from the Unix package.<br>
<br>
<!--TOC subsection Changing Signal Handlers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc228" id="htoc228"><b><font size=
"4">6.8.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Changing Signal
Handlers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="signal-handlers" id="signal-handlers"></a><br>
<br>
<a name="@funs168"></a><a name="FN:with-enabled-interrupts" id=
"FN:with-enabled-interrupts"></a>
<div align="left">[Macro]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">with-enabled-interrupts</tt> <tt class=
"variable">specs</tt> <tt class="code">&amp;rest</tt> <tt class=
"variable">body</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro should be called with a list of signal specifications,
<tt class="variable">specs</tt>. Each element of <tt class=
"variable">specs</tt> should be a list of two elements: the first
should be the Unix signal for which a handler should be
established, the second should be a function to be called when the
signal is received One or more signal handlers can be established
in this way. <tt class="code">with-enabled-interrupts</tt>
establishes the correct signal handlers and then executes the forms
in <tt class="variable">body</tt>. The forms are executed in an
unwind-protect so that the state of the signal handlers will be
restored to what it was before the <tt class=
"code">with-enabled-interrupts</tt> was entered. A signal handler
function specified as NIL will set the Unix signal handler to the
default which is normally either to ignore the signal or to cause a
core dump depending on the particular signal.</blockquote>
<br>
<a name="@funs169"></a><a name="FN:without-interrupts" id=
"FN:without-interrupts"></a>
<div align="left">[Macro]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">without-interrupts</tt> <tt class=
"code">&amp;rest</tt> <tt class="variable">body</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
It is sometimes necessary to execute a piece a code that can not be
interrupted. This macro the forms in <tt class="variable">body</tt>
with interrupts disabled. Note that the Unix interrupts are not
actually disabled, rather they are queued until after <tt class=
"variable">body</tt> has finished executing.</blockquote>
<br>
<a name="@funs170"></a><a name="FN:with-interrupts" id=
"FN:with-interrupts"></a>
<div align="left">[Macro]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">with-interrupts</tt> <tt class=
"code">&amp;rest</tt> <tt class="variable">body</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
When executing an interrupt handler, the system disables
interrupts, as if the handler was wrapped in in a <tt class=
"code">without-interrupts</tt>. The macro <tt class=
"code">with-interrupts</tt> can be used to enable interrupts while
the forms in <tt class="variable">body</tt> are evaluated. This is
useful if <tt class="variable">body</tt> is going to enter a break
loop or do some long computation that might need to be
interrupted.</blockquote>
<br>
<a name="@funs171"></a><a name="FN:without-hemlock" id=
"FN:without-hemlock"></a>
<div align="left">[Macro]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">without-hemlock</tt> <tt class=
"code">&amp;rest</tt> <tt class="variable">body</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
For some interrupts, such as SIGTSTP (suspend the Lisp process and
return to the Unix shell) it is necessary to leave Hemlock and then
return to it. This macro executes the forms in <tt class=
"variable">body</tt> after exiting Hemlock. When <tt class=
"variable">body</tt> has been executed, control is returned to
Hemlock.</blockquote>
<br>
<a name="@funs172"></a><a name="FN:enable-interrupt" id=
"FN:enable-interrupt"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">enable-interrupt</tt> <tt class=
"variable">signal</tt> <tt class="variable">function</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function establishes <tt class="variable">function</tt> as the
handler for <tt class="variable">signal</tt>. Unless you want to
establish a global signal handler, you should use the macro
<tt class="code">with-enabled-interrupts</tt> to temporarily
establish a signal handler. <tt class="code">enable-interrupt</tt>
returns the old function associated with the signal.</blockquote>
<br>
<a name="@funs173"></a><a name="FN:ignore-interrupt" id=
"FN:ignore-interrupt"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">ignore-interrupt</tt> <tt class=
"variable">signal</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Ignore-interrupt sets the Unix signal mechanism to ignore
<tt class="variable">signal</tt> which means that the Lisp process
will never see the signal. Ignore-interrupt returns the old
function associated with the signal or <tt class="code">nil</tt> if
none is currently defined.</blockquote>
<br>
<a name="@funs174"></a><a name="FN:default-interrupt" id=
"FN:default-interrupt"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">default-interrupt</tt> <tt class=
"variable">signal</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Default-interrupt can be used to tell the Unix signal mechanism to
perform the default action for <tt class="variable">signal</tt>.
For details on what the default action for a signal is, see section
2 of the <em>Unix Programmer's Manual</em>. In general, it is
likely to ignore the signal or to cause a core dump.</blockquote>
<!--TOC subsection Examples of Signal Handlers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc229" id="htoc229"><b><font size=
"4">6.8.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Examples of
Signal Handlers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The following code is the signal handler used by the Lisp system
for the SIGINT signal.
<blockquote class="lisp">
<pre>
(defun ih-sigint (signal code scp)
  (declare (ignore signal code scp))
  (without-hemlock
   (with-interrupts
    (break "Software Interrupt" t))))
</pre></blockquote>
The <tt class="code">without-hemlock</tt> form is used to make sure
that Hemlock is exited before a break loop is entered. The
<tt class="code">with-interrupts</tt> form is used to enable
interrupts because the user may want to generate an interrupt while
in the break loop. Finally, break is called to enter a break loop,
so the user can look at the current state of the computation. If
the user proceeds from the break loop, the computation will be
restarted from where it was interrupted.<br>
<br>
The following function is the Lisp signal handler for the SIGTSTP
signal which suspends a process and returns to the Unix shell.
<blockquote class="lisp">
<pre>
(defun ih-sigtstp (signal code scp)
  (declare (ignore signal code scp))
  (without-hemlock
   (Unix:unix-kill (Unix:unix-getpid) Unix:sigstop)))
</pre></blockquote>
Lisp uses this interrupt handler to catch the SIGTSTP signal
because it is necessary to get out of Hemlock in a clean way before
returning to the shell.<br>
<br>
To set up these interrupt handlers, the following is recommended:
<blockquote class="lisp">
<pre>
(with-enabled-interrupts ((Unix:SIGINT #'ih-sigint)
                          (Unix:SIGTSTP #'ih-sigtstp))
  &lt;user code to execute with the above signal handlers enabled.&gt;
)
</pre></blockquote>
<!--NAME unix.html-->
<!--TOC chapter Event Dispatching with SERVE-EVENT-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc230" id="htoc230"><b><font size=
"6">Chapter&nbsp;7</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Event Dispatching
with SERVE-EVENT</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="serve-event" id="serve-event"></a><br>
<div align="center"><b>by Bill Chiles and Robert
MacLachlan</b></div>
<br>
It is common to have multiple activities simultaneously operating
in the same Lisp process. Furthermore, Lisp programmers tend to
expect a flexible development environment. It must be possible to
load and modify application programs without requiring
modifications to other running programs. CMUCL achieves this by
having a central scheduling mechanism based on an event-driven,
object-oriented paradigm.<br>
<br>
An <tt class="variable">event</tt> is some interesting happening
that should cause the Lisp process to wake up and do something.
These events include X events and activity on Unix file
descriptors. The object-oriented mechanism is only available with
the first two, and it is optional with X events as described later
in this chapter. In an X event, the window ID is the object
capability and the X event type is the operation code. The Unix
file descriptor input mechanism simply consists of an association
list of a handler to call when input shows up on a particular file
descriptor.<br>
<br>
<!--TOC section Object Sets-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc231" id="htoc231"><b><font size=
"5">7.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Object
Sets</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="object-sets" id="object-sets"></a> <a name=
"@concept298"></a><br>
An <em>object set</em> is a collection of objects that have the
same implementation for each operation. Externally the object is
represented by the object capability and the operation is
represented by the operation code. Within Lisp, the object is
represented by an arbitrary Lisp object, and the implementation for
the operation is represented by an arbitrary Lisp function. The
object set mechanism maintains this translation from the external
to the internal representation.<br>
<br>
<br>
<a name="@funs175"></a><a name="FN:make-object-set" id=
"FN:make-object-set"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">make-object-set</tt> <tt class="variable">name</tt>
<tt class="code">&amp;optional</tt> <tt class=
"variable">default-handler</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function makes a new object set. <tt class=
"variable">Name</tt> is a string used only for purposes of
identifying the object set when it is printed. <tt class=
"variable">Default-handler</tt> is the function used as a handler
when an undefined operation occurs on an object in the set. You can
define operations with the <tt class="code">serve-</tt><tt class=
"variable">operation</tt> functions exported the <tt class=
"code">extensions</tt> package for X events (see
section&nbsp;<a href="#x-serve-mumbles">7.4</a>). Objects are added
with <tt class="code">system:add-xwindow-object</tt>. Initially the
object set has no objects and no defined operations.</blockquote>
<br>
<a name="@funs176"></a><a name="FN:object-set-operation" id=
"FN:object-set-operation"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">object-set-operation</tt> <tt class=
"variable">object-set</tt> <tt class="variable">operation-code</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the handler function that is the
implementation of the operation corresponding to <tt class=
"variable">operation-code</tt> in <tt class=
"variable">object-set</tt>. When set with <tt class=
"code">setf</tt>, the setter function establishes the new handler.
The <tt class="code">serve-</tt><tt class="variable">operation</tt>
functions exported from the <tt class="code">extensions</tt>
package for X events (see section&nbsp;<a href=
"#x-serve-mumbles">7.4</a>) call this on behalf of the user when
announcing a new operation for an object set.</blockquote>
<br>
<a name="@funs177"></a><a name="FN:add-xwindow-object" id=
"FN:add-xwindow-object"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">add-xwindow-object</tt> <tt class=
"variable">window</tt> <tt class="variable">object</tt> <tt class=
"variable">object-set</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
These functions add <tt class="variable">port</tt> or <tt class=
"variable">window</tt> to <tt class="variable">object-set</tt>.
<tt class="variable">Object</tt> is an arbitrary Lisp object that
is associated with the <tt class="variable">port</tt> or <tt class=
"variable">window</tt> capability. <tt class="variable">Window</tt>
is a CLX window. When an event occurs, <tt class=
"code">system:serve-event</tt> passes <tt class=
"variable">object</tt> as an argument to the handler
function.</blockquote>
<!--TOC section The SERVE-EVENT Function-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc232" id="htoc232"><b><font size=
"5">7.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The SERVE-EVENT
Function</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <tt class="code">system:serve-event</tt> function is the
standard way for an application to wait for something to happen.
For example, the Lisp system calls <tt class=
"code">system:serve-event</tt> when it wants input from X or a
terminal stream. The idea behind <tt class=
"code">system:serve-event</tt> is that it knows the appropriate
action to take when any interesting event happens. If an
application calls <tt class="code">system:serve-event</tt> when it
is idle, then any other applications with pending events can run.
This allows several applications to run ``at the same time''
without interference, even though there is only one thread of
control. Note that if an application is waiting for input of any
kind, then other applications will get events.<br>
<br>
<br>
<a name="@funs178"></a><a name="FN:serve-event" id=
"FN:serve-event"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">serve-event</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">timeout</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function waits for an event to happen and then dispatches to
the correct handler function. If specified, <tt class=
"variable">timeout</tt> is the number of seconds to wait before
timing out. A time out of zero seconds is legal and causes
<tt class="code">system:serve-event</tt> to poll for any events
immediately available for processing. <tt class=
"code">system:serve-event</tt> returns <tt class="code">t</tt> if
it serviced at least one event, and <tt class="code">nil</tt>
otherwise. Depending on the application, when <tt class=
"code">system:serve-event</tt> returns <tt class="code">t</tt>, you
might want to call it repeatedly with a timeout of zero until it
returns <tt class="code">nil</tt>.<br>
<br>
If input is available on any designated file descriptor, then this
calls the appropriate handler function supplied by <tt class=
"code">system:add-fd-handler</tt>.<br>
<br>
Since events for many different applications may arrive
simultaneously, an application waiting for a specific event must
loop on <tt class="code">system:serve-event</tt> until the desired
event happens. Since programs such as Hemlock call <tt class=
"code">system:serve-event</tt> for input, applications usually do
not need to call <tt class="code">system:serve-event</tt> at all;
Hemlock allows other application's handlers to run when it goes
into an input wait.</blockquote>
<br>
<a name="@funs179"></a><a name="FN:serve-all-events" id=
"FN:serve-all-events"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">serve-all-events</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">timeout</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function is similar to <tt class=
"code">system:serve-event</tt>, except it serves all the pending
events rather than just one. It returns <tt class="code">t</tt> if
it serviced at least one event, and <tt class="code">nil</tt>
otherwise.</blockquote>
<!--TOC section Using SERVE-EVENT with Unix File Descriptors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc233" id="htoc233"><b><font size=
"5">7.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Using SERVE-EVENT
with Unix File Descriptors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Object sets are not available for use with file descriptors, as
there are only two operations possible on file descriptors: input
and output. Instead, a handler for either input or output can be
registered with <tt class="code">system:serve-event</tt> for a
specific file descriptor. Whenever any input shows up, or output is
possible on this file descriptor, the function associated with the
handler for that descriptor is funcalled with the descriptor as
it's single argument.<br>
<br>
<br>
<a name="@funs180"></a><a name="FN:add-fd-handler" id=
"FN:add-fd-handler"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">add-fd-handler</tt> <tt class="variable">fd</tt>
<tt class="variable">direction</tt> <tt class=
"variable">function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function installs and returns a new handler for the file
descriptor <tt class="variable">fd</tt>. <tt class=
"variable">direction</tt> can be either <tt class=
"code">:input</tt> if the system should invoke the handler when
input is available or <tt class="code">:output</tt> if the system
should invoke the handler when output is possible. This returns a
unique object representing the handler, and this is a suitable
argument for <tt class="code">system:remove-fd-handler</tt>
<tt class="variable">function</tt> must take one argument, the file
descriptor.</blockquote>
<br>
<a name="@funs181"></a><a name="FN:remove-fd-handler" id=
"FN:remove-fd-handler"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">remove-fd-handler</tt> <tt class=
"variable">handler</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function removes <tt class="variable">handler</tt>, that
<tt class="code">add-fd-handler</tt> must have previously
returned.</blockquote>
<br>
<a name="@funs182"></a><a name="FN:with-fd-handler" id=
"FN:with-fd-handler"></a>
<div align="left">[Macro]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">with-fd-handler</tt> (<tt class="variable">fd</tt>
<tt class="variable">direction</tt> <tt class=
"variable">function</tt>) <tt class="code">{<tt class=
"variable">form</tt>}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro executes the supplied forms with a handler installed
using <tt class="variable">fd</tt>, <tt class=
"variable">direction</tt>, and <tt class="variable">function</tt>.
See <tt class="code">system:add-fd-handler</tt>. The given forms
are wrapped in an <tt class="code">unwind-protect</tt>; the handler
is removed (see <tt class="code">system:remove-fd-handler</tt>)
when done.</blockquote>
<br>
<a name="@funs183"></a><a name="FN:wait-until-fd-usable" id=
"FN:wait-until-fd-usable"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">wait-until-fd-usable</tt> <tt class=
"variable">fd</tt> <tt class="variable">direction</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">timeout</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function waits for up to <tt class="variable">timeout</tt>
seconds for <tt class="variable">fd</tt> to become usable for
<tt class="variable">direction</tt> (either <tt class=
"code">:input</tt> or <tt class="code">:output</tt>). If <tt class=
"variable">timeout</tt> is <tt class="code">nil</tt> or
unspecified, this waits forever.</blockquote>
<br>
<a name="@funs184"></a><a name="FN:invalidate-descriptor" id=
"FN:invalidate-descriptor"></a>
<div align="left">[Function]<br>
<tt class="function-name">system:</tt><tt class=
"function-name">invalidate-descriptor</tt> <tt class=
"variable">fd</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function removes all handlers associated with <tt class=
"variable">fd</tt>. This should only be used in drastic cases (such
as I/O errors, but not necessarily EOF). Normally, you should use
<tt class="code">remove-fd-handler</tt> to remove the specific
handler.</blockquote>
<!--TOC section Using SERVE-EVENT with the CLX Interface to X-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc234" id="htoc234"><b><font size=
"5">7.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Using SERVE-EVENT
with the CLX Interface to X</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="x-serve-mumbles" id="x-serve-mumbles"></a><br>
Remember from section <a href="#object-sets">7.1</a>, an object set
is a collection of objects, CLX windows in this case, with some set
of operations, event keywords, with corresponding implementations,
the same handler functions. Since X allows multiple display
connections from a given process, you can avoid using object sets
if every window in an application or display connection behaves the
same. If a particular X application on a single display connection
has windows that want to handle certain events differently, then
using object sets is a convenient way to organize this since you
need some way to map the window/event combination to the
appropriate functionality.<br>
<br>
The following is a discussion of functions exported from the
<tt class="code">extensions</tt> package that facilitate handling
CLX events through <tt class="code">system:serve-event</tt>. The
first two routines are useful regardless of whether you use
<tt class="code">system:serve-event</tt>:<br>
<br>
<br>
<a name="@funs185"></a><a name="FN:open-clx-display" id=
"FN:open-clx-display"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">open-clx-display</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">string</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function parses <tt class="variable">string</tt> for an X
display specification including display and screen numbers.
<tt class="variable">String</tt> defaults to the following:
<blockquote class="example">
<pre>
    (cdr (assoc :display ext:*environment-list* :test #'eq))
  
</pre></blockquote>
If any field in the display specification is missing, this signals
an error. <tt class="code">ext:open-clx-display</tt> returns the
CLX display and screen.</blockquote>
<br>
<a name="@funs186"></a><a name="FN:flush-display-events" id=
"FN:flush-display-events"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">flush-display-events</tt> <tt class=
"variable">display</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function flushes all the events in <tt class=
"variable">display</tt>'s event queue including the current event,
in case the user calls this from within an event
handler.</blockquote>
<!--TOC subsection Without Object Sets-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc235" id="htoc235"><b><font size=
"4">7.4.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Without Object
Sets</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Since most applications that use CLX, can avoid the complexity of
object sets, these routines are described in a separate section.
The routines described in the next section that use the object set
mechanism are based on these interfaces.<br>
<br>
<br>
<a name="@funs187"></a><a name="FN:enable-clx-event-handling" id=
"FN:enable-clx-event-handling"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">enable-clx-event-handling</tt> <tt class=
"variable">display</tt> <tt class="variable">handler</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function causes <tt class="code">system:serve-event</tt> to
notice when there is input on <tt class="variable">display</tt>'s
connection to the X11 server. When this happens, <tt class=
"code">system:serve-event</tt> invokes <tt class=
"variable">handler</tt> on <tt class="variable">display</tt> in a
dynamic context with an error handler bound that flushes all events
from <tt class="variable">display</tt> and returns. By returning,
the error handler declines to handle the error, but it will have
cleared all events; thus, entering the debugger will not result in
infinite errors due to streams that wait via <tt class=
"code">system:serve-event</tt> for input. Calling this repeatedly
on the same <tt class="variable">display</tt> establishes
<tt class="variable">handler</tt> as a new handler, replacing any
previous one for <tt class="variable">display</tt>.</blockquote>
<br>
<a name="@funs188"></a><a name="FN:disable-clx-event-handling" id=
"FN:disable-clx-event-handling"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">disable-clx-event-handling</tt> <tt class=
"variable">display</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function undoes the effect of <tt class=
"code">ext:enable-clx-event-handling</tt>.</blockquote>
<br>
<a name="@funs189"></a><a name="FN:with-clx-event-handling" id=
"FN:with-clx-event-handling"></a>
<div align="left">[Macro]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">with-clx-event-handling</tt> (<tt class=
"variable">display</tt> <tt class="variable">handler</tt>)
<tt class="code">{form}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro evaluates each <tt class="variable">form</tt> in a
context where <tt class="code">system:serve-event</tt> invokes
<tt class="variable">handler</tt> on <tt class=
"variable">display</tt> whenever there is input on <tt class=
"variable">display</tt>'s connection to the X server. This destroys
any previously established handler for <tt class=
"variable">display</tt>.</blockquote>
<!--TOC subsection With Object Sets-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc236" id="htoc236"><b><font size=
"4">7.4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">With Object
Sets</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This section discusses the use of object sets and <tt class=
"code">system:serve-event</tt> to handle CLX events. This is
necessary when a single X application has distinct windows that
want to handle the same events in different ways. Basically, you
need some way of asking for a given window which way you want to
handle some event because this event is handled differently
depending on the window. Object sets provide this feature.<br>
<br>
For each CLX event-key symbol-name iXXX (for example, <tt class=
"variable">key-press</tt>), there is a function <tt class=
"code">serve-</tt>iXXX of two arguments, an object set and a
function. The <tt class="code">serve-</tt>iXXX function establishes
the function as the handler for the <tt class="code">:XXX</tt>
event in the object set. Recall from section <a href=
"#object-sets">7.1</a>, <tt class=
"code">system:add-xwindow-object</tt> associates some Lisp object
with a CLX window in an object set. When <tt class=
"code">system:serve-event</tt> notices activity on a window, it
calls the function given to <tt class=
"code">ext:enable-clx-event-handling</tt>. If this function is
<tt class="code">ext:object-set-event-handler</tt>, it calls the
function given to <tt class="code">serve-</tt>iXXX, passing the
object given to <tt class="code">system:add-xwindow-object</tt> and
the event's slots as well as a couple other arguments described
below.<br>
<br>
To use object sets in this way:
<ul>
<li>Create an object set.<br>
<br></li>
<li>Define some operations on it using the <tt class=
"code">serve-</tt>iXXX functions.<br>
<br></li>
<li>Add an object for every window on which you receive requests.
This can be the CLX window itself or some structure more meaningful
to your application.<br>
<br></li>
<li>Call <tt class="code">system:serve-event</tt> to service an X
event.</li>
</ul>
<br>
<a name="@funs190"></a><a name="FN:object-set-event-handler" id=
"FN:object-set-event-handler"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">object-set-event-handler</tt> <tt class=
"variable">display</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function is a suitable argument to <tt class=
"code">ext:enable-clx-event-handling</tt>. The actual event
handlers defined for particular events within a given object set
must take an argument for every slot in the appropriate event. In
addition to the event slots, <tt class=
"code">ext:object-set-event-handler</tt> passes the following
arguments:
<ul>
<li>The object, as established by <tt class=
"code">system:add-xwindow-object</tt>, on which the event
occurred.</li>
<li>event-key, see <tt class="code">xlib:event-case</tt>.</li>
<li>send-event-p, see <tt class="code">xlib:event-case</tt>.</li>
</ul>
Describing any <tt class="code">ext:serve-</tt><tt class=
"variable">event-key-name</tt> function, where <tt class=
"variable">event-key-name</tt> is an event-key symbol-name (for
example, <tt class="code">ext:serve-key-press</tt>), indicates
exactly what all the arguments are in their correct order.<br>
<br>
When creating an object set for use with <tt class=
"code">ext:object-set-event-handler</tt>, specify <tt class=
"code">ext:default-clx-event-handler</tt> as the default handler
for events in that object set. If no default handler is specified,
and the system invokes the default default handler, it will cause
an error since this function takes arguments suitable for handling
port messages.</blockquote>
<!--TOC section A SERVE-EVENT Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc237" id="htoc237"><b><font size=
"5">7.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">A SERVE-EVENT
Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This section contains two examples using <tt class=
"code">system:serve-event</tt>. The first one does not use object
sets, and the second, slightly more complicated one does.<br>
<br>
<!--TOC subsection Without Object Sets Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc238" id="htoc238"><b><font size=
"4">7.5.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Without Object
Sets Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This example defines an input handler for a CLX display connection.
It only recognizes <tt class="code">:key-press</tt> events. The
body of the example loops over <tt class=
"code">system:serve-event</tt> to get input.
<blockquote class="lisp">
<pre>
(in-package "SERVER-EXAMPLE")

(defun my-input-handler (display)
  (xlib:event-case (display :timeout 0)
    (:key-press (event-window code state)
     (format t "KEY-PRESSED (Window = ~D) = ~S.~%"
                  (xlib:window-id event-window)
             ;; See Hemlock Command Implementor's Manual for convenient
             ;; input mapping function.
             (ext:translate-character display code state))
      ;; Make XLIB:EVENT-CASE discard the event.
      t)))
</pre></blockquote>
<blockquote class="lisp">
<pre>
(defun server-example ()
  "An example of using the SYSTEM:SERVE-EVENT function and object sets to
   handle CLX events."
  (let* ((display (ext:open-clx-display))
         (screen (display-default-screen display))
         (black (screen-black-pixel screen))
         (white (screen-white-pixel screen))
         (window (create-window :parent (screen-root screen)
                                :x 0 :y 0 :width 200 :height 200
                                :background white :border black
                                :border-width 2
                                :event-mask
                                (xlib:make-event-mask :key-press))))
    ;; Wrap code in UNWIND-PROTECT, so we clean up after ourselves.
    (unwind-protect
        (progn
          ;; Enable event handling on the display.
          (ext:enable-clx-event-handling display #'my-input-handler)
          ;; Map the windows to the screen.
          (map-window window)
          ;; Make sure we send all our requests.
          (display-force-output display)
          ;; Call serve-event for 100,000 events or immediate timeouts.
          (dotimes (i 100000) (system:serve-event)))
      ;; Disable event handling on this display.
      (ext:disable-clx-event-handling display)
      ;; Get rid of the window.
      (destroy-window window)
      ;; Pick off any events the X server has already queued for our
      ;; windows, so we don't choke since SYSTEM:SERVE-EVENT is no longer
      ;; prepared to handle events for us.
      (loop
       (unless (deleting-window-drop-event *display* window)
        (return)))
      ;; Close the display.
      (xlib:close-display display))))

(defun deleting-window-drop-event (display win)
  "Check for any events on win.  If there is one, remove it from the
   event queue and return t; otherwise, return nil."
  (xlib:display-finish-output display)
  (let ((result nil))
    (xlib:process-event
     display :timeout 0
     :handler #'(lambda (&amp;key event-window &amp;allow-other-keys)
                  (if (eq event-window win)
                      (setf result t)
                      nil)))
    result))
</pre></blockquote>
<!--TOC subsection With Object Sets Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc239" id="htoc239"><b><font size=
"4">7.5.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">With Object Sets
Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This example involves more work, but you get a little more for your
effort. It defines two objects, <tt class="code">input-box</tt> and
<tt class="code">slider</tt>, and establishes a <tt class=
"code">:key-press</tt> handler for each object, <tt class=
"code">key-pressed</tt> and <tt class="code">slider-pressed</tt>.
We have two object sets because we handle events on the windows
manifesting these objects differently, but the events come over the
same display connection.
<blockquote class="lisp">
<pre>
(in-package "SERVER-EXAMPLE")

(defstruct (input-box (:print-function print-input-box)
                      (:constructor make-input-box (display window)))
  "Our program knows about input-boxes, and it doesn't care how they
   are implemented."
  display        ; The CLX display on which my input-box is displayed.
  window)        ; The CLX window in which the user types.
;;;
(defun print-input-box (object stream n)
  (declare (ignore n))
  (format stream "#&lt;Input-Box ~S&gt;" (input-box-display object)))

(defvar *input-box-windows*
        (system:make-object-set "Input Box Windows"
                                #'ext:default-clx-event-handler))

(defun key-pressed (input-box event-key event-window root child
                    same-screen-p x y root-x root-y modifiers time
                    key-code send-event-p)
  "This is our :key-press event handler."
  (declare (ignore event-key root child same-screen-p x y
                   root-x root-y time send-event-p))
  (format t "KEY-PRESSED (Window = ~D) = ~S.~%"
          (xlib:window-id event-window)
          ;; See Hemlock Command Implementor's Manual for convenient
          ;; input mapping function.
          (ext:translate-character (input-box-display input-box)
                                     key-code modifiers)))
;;;
(ext:serve-key-press *input-box-windows* #'key-pressed)
</pre></blockquote>
<blockquote class="lisp">
<pre>
(defstruct (slider (:print-function print-slider)
                   (:include input-box)
                   (:constructor %make-slider
                                    (display window window-width max)))
  "Our program knows about sliders too, and these provide input values
   zero to max."
  bits-per-value  ; bits per discrete value up to max.
  max)            ; End value for slider.
;;;
(defun print-slider (object stream n)
  (declare (ignore n))
  (format stream "#&lt;Slider ~S  0..~D&gt;"
          (input-box-display object)
          (1- (slider-max object))))
;;;
(defun make-slider (display window max)
  (%make-slider display window
                  (truncate (xlib:drawable-width window) max)
                max))

(defvar *slider-windows*
        (system:make-object-set "Slider Windows"
                                #'ext:default-clx-event-handler))

(defun slider-pressed (slider event-key event-window root child
                       same-screen-p x y root-x root-y modifiers time
                       key-code send-event-p)
  "This is our :key-press event handler for sliders.  Probably this is
   a mouse thing, but for simplicity here we take a character typed."
  (declare (ignore event-key root child same-screen-p x y
                   root-x root-y time send-event-p))
  (format t "KEY-PRESSED (Window = ~D) = ~S  --&gt;  ~D.~%"
          (xlib:window-id event-window)
          ;; See Hemlock Command Implementor's Manual for convenient
          ;; input mapping function.
          (ext:translate-character (input-box-display slider)
                                     key-code modifiers)
          (truncate x (slider-bits-per-value slider))))
;;;
(ext:serve-key-press *slider-windows* #'slider-pressed)
</pre></blockquote>
<blockquote class="lisp">
<pre>
(defun server-example ()
  "An example of using the SYSTEM:SERVE-EVENT function and object sets to
   handle CLX events."
  (let* ((display (ext:open-clx-display))
         (screen (display-default-screen display))
         (black (screen-black-pixel screen))
         (white (screen-white-pixel screen))
         (iwindow (create-window :parent (screen-root screen)
                                 :x 0 :y 0 :width 200 :height 200
                                 :background white :border black
                                 :border-width 2
                                 :event-mask
                                 (xlib:make-event-mask :key-press)))
         (swindow (create-window :parent (screen-root screen)
                                 :x 0 :y 300 :width 200 :height 50
                                 :background white :border black
                                 :border-width 2
                                 :event-mask
                                 (xlib:make-event-mask :key-press)))
         (input-box (make-input-box display iwindow))
         (slider (make-slider display swindow 15)))
    ;; Wrap code in UNWIND-PROTECT, so we clean up after ourselves.
    (unwind-protect
        (progn
          ;; Enable event handling on the display.
          (ext:enable-clx-event-handling display
                                         #'ext:object-set-event-handler)
          ;; Add the windows to the appropriate object sets.
          (system:add-xwindow-object iwindow input-box
                                       *input-box-windows*)
          (system:add-xwindow-object swindow slider
                                       *slider-windows*)
          ;; Map the windows to the screen.
          (map-window iwindow)
          (map-window swindow)
          ;; Make sure we send all our requests.
          (display-force-output display)
          ;; Call server for 100,000 events or immediate timeouts.
          (dotimes (i 100000) (system:serve-event)))
      ;; Disable event handling on this display.
      (ext:disable-clx-event-handling display)
      (delete-window iwindow display)
      (delete-window swindow display)
      ;; Close the display.
      (xlib:close-display display))))
</pre></blockquote>
<blockquote class="lisp">
<pre>
(defun delete-window (window display)
  ;; Remove the windows from the object sets before destroying them.
  (system:remove-xwindow-object window)
  ;; Destroy the window.
  (destroy-window window)
  ;; Pick off any events the X server has already queued for our
  ;; windows, so we don't choke since SYSTEM:SERVE-EVENT is no longer
  ;; prepared to handle events for us.
  (loop
   (unless (deleting-window-drop-event display window)
     (return))))

(defun deleting-window-drop-event (display win)
  "Check for any events on win.  If there is one, remove it from the
   event queue and return t; otherwise, return nil."
  (xlib:display-finish-output display)
  (let ((result nil))
    (xlib:process-event
     display :timeout 0
     :handler #'(lambda (&amp;key event-window &amp;allow-other-keys)
                  (if (eq event-window win)
                      (setf result t)
                      nil)))
    result))
</pre></blockquote>
<!--NAME serve-event.html-->
<!--TOC chapter Alien Objects-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc240" id="htoc240"><b><font size=
"6">Chapter&nbsp;8</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Alien
Objects</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="aliens" id="aliens"></a><br>
<div align="center"><b>by Robert MacLachlan and William
Lott</b></div>
<br>
<!--TOC section Introduction to Aliens-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc241" id="htoc241"><b><font size=
"5">8.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Introduction to
Aliens</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Because of Lisp's emphasis on dynamic memory allocation and garbage
collection, Lisp implementations use unconventional memory
representations for objects. This representation mismatch creates
problems when a Lisp program must share objects with programs
written in another language. There are three different approaches
to establishing communication:
<ul>
<li>The burden can be placed on the foreign program (and
programmer) by requiring the use of Lisp object representations.
The main difficulty with this approach is that either the foreign
program must be written with Lisp interaction in mind, or a
substantial amount of foreign ``glue'' code must be written to
perform the translation.<br>
<br></li>
<li>The Lisp system can automatically convert objects back and
forth between the Lisp and foreign representations. This is
convenient, but translation becomes prohibitively slow when large
or complex data structures must be shared.<br>
<br></li>
<li>The Lisp program can directly manipulate foreign objects
through the use of extensions to the Lisp language. Most Lisp
systems make use of this approach, but the language for describing
types and expressing accesses is often not powerful enough for
complex objects to be easily manipulated.</li>
</ul>
CMUCL relies primarily on the automatic conversion and direct
manipulation approaches: Aliens of simple scalar types are
automatically converted, while complex types are directly
manipulated in their foreign representation. Any foreign objects
that can't automatically be converted into Lisp values are
represented by objects of type <tt class="code">alien-value</tt>.
Since Lisp is a dynamically typed language, even foreign objects
must have a run-time type; this type information is provided by
encapsulating the raw pointer to the foreign data within an
<tt class="code">alien-value</tt> object.<br>
<br>
The Alien type language and operations are most similar to those of
the C language, but Aliens can also be used when communicating with
most other languages that can be linked with C.<br>
<br>
<!--TOC section Alien Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc242" id="htoc242"><b><font size=
"5">8.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Alien
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Alien types have a description language based on nested list
structure. For example:
<blockquote class="example">
<pre>
struct foo {
    int a;
    struct foo *b[100];
};
</pre></blockquote>
has the corresponding Alien type:
<blockquote class="lisp">
<pre>
(struct foo
  (a int)
  (b (array (* (struct foo)) 100)))
</pre></blockquote>
<!--TOC subsection Defining Alien Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc243" id="htoc243"><b><font size=
"4">8.2.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Defining Alien
Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Types may be either named or anonymous. With structure and union
types, the name is part of the type specifier, allowing recursively
defined types such as:
<blockquote class="lisp">
<pre>
(struct foo (a (* (struct foo))))
</pre></blockquote>
An anonymous structure or union type is specified by using the name
<tt class="code">nil</tt>. The <a name="@funs191"></a><tt class=
"code">with-alien</tt> macro defines a local scope which
``captures'' any named type definitions. Other types are not
inherently named, but can be given named abbreviations using
<tt class="code">def-alien-type</tt>.<br>
<br>
<br>
<a name="@funs192"></a><a name="FN:def-alien-type" id=
"FN:def-alien-type"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">def-alien-type</tt> name type
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This macro globally defines <tt class=
"variable">name</tt> as a shorthand for the Alien type <tt class=
"variable">type</tt>. When introducing global structure and union
type definitions, <tt class="variable">name</tt> may be <tt class=
"code">nil</tt>, in which case the name to define is taken from the
type's name.</blockquote>
<!--TOC subsection Alien Types and Lisp Types-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc244" id="htoc244"><b><font size=
"4">8.2.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Alien Types and
Lisp Types</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The Alien types form a subsystem of the CMUCL type system. An
<tt class="code">alien</tt> type specifier provides a way to use
any Alien type as a Lisp type specifier. For example
<blockquote class="lisp">
<pre>
(typep foo '(alien (* int)))
</pre></blockquote>
can be used to determine whether <tt class="code">foo</tt> is a
pointer to an <tt class="code">int</tt>. <tt class=
"code">alien</tt> type specifiers can be used in the same ways as
ordinary type specifiers (like <tt class="code">string</tt>.) Alien
type declarations are subject to the same precise type checking as
any other declaration (see section&nbsp;<a href=
"#precise-type-checks">4.5.2</a>.)<br>
<br>
Note that the Alien type system overlaps with normal Lisp type
specifiers in some cases. For example, the type specifier
<tt class="code">(alien single-float)</tt> is identical to
<tt class="code">single-float</tt>, since Alien floats are
automatically converted to Lisp floats. When <tt class=
"code">type-of</tt> is called on an Alien value that is not
automatically converted to a Lisp value, then it will return an
<tt class="code">alien</tt> type specifier.<br>
<br>
<!--TOC subsection Alien Type Specifiers-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc245" id="htoc245"><b><font size=
"4">8.2.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Alien Type
Specifiers</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Some Alien type names are Common Lisp symbols, but the names are
still exported from the <tt class="code">alien</tt> package, so it
is legal to say <tt class="code">alien:single-float</tt>. These are
the basic Alien type specifiers:<br>
<br>
<br>
<br>
<a name="@types31"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">*</tt> <tt class="variable"><tt class=
"variable">type</tt></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
A pointer to an object of the specified <tt class=
"variable">type</tt>. If <tt class="variable">type</tt> is
<tt class="code">t</tt>, then it means a pointer to anything,
similar to ``<tt class="code">void *</tt>'' in ANSI C. Currently,
the only way to detect a null pointer is:
<blockquote class="lisp">
<pre>
  (zerop (sap-int (alien-sap <tt class="variable">ptr</tt>)))
</pre></blockquote>
See section&nbsp;<a href=
"#system-area-pointers">6.5</a></blockquote>
<br>
<br>
<a name="@types32"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">array</tt> <tt class=
"variable"><tt class="variable">type</tt> <tt class=
"code">{<tt class="variable">dimension</tt>}</tt><sup><font size=
"2">*</font></sup></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
An array of the specified <tt class="variable">dimensions</tt>,
holding elements of type <tt class="variable">type</tt>. Note that
<tt class="code">(* int)</tt> and <tt class="code">(array int)</tt>
are considered to be different types when type checking is done;
pointer and array types must be explicitly coerced using <tt class=
"code">cast</tt>.<br>
<br>
Arrays are accessed using <tt class="code">deref</tt>, passing the
indices as additional arguments. Elements are stored in
column-major order (as in C), so the first dimension determines
only the size of the memory block, and not the layout of the higher
dimensions. An array whose first dimension is variable may be
specified by using <tt class="code">nil</tt> as the first
dimension. Fixed-size arrays can be allocated as array elements,
structure slots or <tt class="code">with-alien</tt> variables.
Dynamic arrays can only be allocated using <a name=
"@funs193"></a><tt class="code">make-alien</tt>.</blockquote>
<br>
<br>
<a name="@types33"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">struct</tt> <tt class=
"variable"><tt class="variable">name</tt> <tt class=
"code">{(<tt class="variable">field</tt> <tt class=
"variable">type</tt> <tt class="code">{<tt class=
"variable">bits</tt>}</tt>)}</tt><sup><font size=
"2">*</font></sup></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
A structure type with the specified <tt class="variable">name</tt>
and <tt class="variable">fields</tt>. Fields are allocated at the
same positions used by the implementation's C compiler. <tt class=
"variable">bits</tt> is intended for C-like bit field support, but
is currently unused. If <tt class="variable">name</tt> is
<tt class="code">nil</tt>, then the type is anonymous.<br>
<br>
If a named Alien <tt class="code">struct</tt> specifier is passed
to <a name="@funs194"></a><tt class="code">def-alien-type</tt> or
<a name="@funs195"></a><tt class="code">with-alien</tt>, then this
defines, respectively, a new global or local Alien structure type.
If no <tt class="variable">fields</tt> are specified, then the
fields are taken from the current (local or global) Alien structure
type definition of <tt class="variable">name</tt>.</blockquote>
<br>
<br>
<a name="@types34"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">union</tt> <tt class=
"variable"><tt class="variable">name</tt> <tt class=
"code">{(<tt class="variable">field</tt> <tt class=
"variable">type</tt> <tt class="code">{<tt class=
"variable">bits</tt>}</tt>)}</tt><sup><font size=
"2">*</font></sup></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Similar to <tt class="code">struct</tt>, but defines a union type.
All fields are allocated at the same offset, and the size of the
union is the size of the largest field. The programmer must
determine which field is active from context.</blockquote>
<br>
<br>
<a name="@types35"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">enum</tt> <tt class="variable"><tt class=
"variable">name</tt> <tt class="code">{<tt class=
"variable">spec</tt>}</tt><sup><font size="2">*</font></sup></tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
An enumeration type that maps between integer values and keywords.
If <tt class="variable">name</tt> is <tt class="code">nil</tt>,
then the type is anonymous. Each <tt class="variable">spec</tt> is
either a keyword, or a list <tt class="code">(<tt class=
"variable">keyword</tt> <tt class="variable">value</tt>)</tt>. If
<tt class="variable">integer</tt> is not supplied, then it defaults
to one greater than the value for the preceding spec (or to zero if
it is the first spec.)</blockquote>
<br>
<br>
<a name="@types36"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">signed</tt> <tt class=
"variable"><tt class="code">{<tt class=
"variable">bits</tt>}</tt></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>A signed integer with the specified number of bits
precision. The upper limit on integer precision is determined by
the machine's word size. If no size is specified, the maximum size
will be used.</blockquote>
<br>
<br>
<a name="@types37"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">integer</tt> <tt class=
"variable"><tt class="code">{<tt class=
"variable">bits</tt>}</tt></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Identical to <tt class="code">signed</tt>---the
distinction between <tt class="code">signed</tt> and <tt class=
"code">integer</tt> is purely stylistic.</blockquote>
<br>
<br>
<a name="@types38"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">unsigned</tt> <tt class=
"variable"><tt class="code">{<tt class=
"variable">bits</tt>}</tt></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Like <tt class="code">signed</tt>, but specifies an
unsigned integer.</blockquote>
<br>
<br>
<a name="@types39"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">boolean</tt> <tt class=
"variable"><tt class="code">{<tt class=
"variable">bits</tt>}</tt></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Similar to an enumeration type that maps <tt class=
"code">0</tt> to <tt class="code">nil</tt> and all other values to
<tt class="code">t</tt>. <tt class="variable">bits</tt> determines
the amount of storage allocated to hold the truth
value.</blockquote>
<br>
<br>
<a name="@types40"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">single-float</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>A floating-point number in IEEE single
format.</blockquote>
<br>
<br>
<a name="@types41"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">double-float</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>A floating-point number in IEEE double
format.</blockquote>
<br>
<br>
<a name="@types42"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">function</tt> <tt class=
"variable"><tt class="variable">result-type</tt> <tt class=
"code">{<tt class="variable">arg-type</tt>}</tt><sup><font size=
"2">*</font></sup></tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><a name="alien-function-types" id=
"alien-function-types"></a> A Alien function that takes arguments
of the specified <tt class="variable">arg-types</tt> and returns a
result of type <tt class="variable">result-type</tt>. Note that the
only context where a <tt class="code">function</tt> type is
directly specified is in the argument to <tt class=
"code">alien-funcall</tt> (see section <a name=
"@funs196"></a><tt class="code">alien-funcall</tt>.) In all other
contexts, functions are represented by function pointer types:
<tt class="code">(* (function ...))</tt>.</blockquote>
<br>
<br>
<a name="@types43"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">system-area-pointer</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>A pointer which is represented in Lisp as a <tt class=
"code">system-area-pointer</tt> object (see section&nbsp;<a href=
"#system-area-pointers">6.5</a>.)</blockquote>
<!--TOC subsection The C-Call Package-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc246" id="htoc246"><b><font size=
"4">8.2.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The C-Call
Package</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <tt class="code">c-call</tt> package exports these
type-equivalents to the C type of the same name: <tt class=
"code">char</tt>, <tt class="code">short</tt>, <tt class=
"code">int</tt>, <tt class="code">long</tt>, <tt class=
"code">unsigned-char</tt>, <tt class="code">unsigned-short</tt>,
<tt class="code">unsigned-int</tt>, <tt class=
"code">unsigned-long</tt>, <tt class="code">float</tt>, <tt class=
"code">double</tt>. <tt class="code">c-call</tt> also exports these
types:<br>
<br>
<br>
<br>
<a name="@types44"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">void</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>This type is used in function types to declare that no
useful value is returned. Evaluation of an <tt class=
"code">alien-funcall</tt> form will return zero
values.</blockquote>
<br>
<br>
<a name="@types45"></a>
<div align="left">[Alien type]<br>
<tt class="function-name">c-string</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>This type is similar to <tt class="code">(* char)</tt>,
but is interpreted as a null-terminated string, and is
automatically converted into a Lisp string when accessed. If the
pointer is C <tt class="code">NULL</tt> (or 0), then accessing
gives Lisp <tt class="code">nil</tt>.<br>
<br>
Assigning a Lisp string to a <tt class="code">c-string</tt>
structure field or variable stores the contents of the string to
the memory already pointed to by that variable. When an Alien of
type <tt class="code">(* char)</tt> is assigned to a <tt class=
"code">c-string</tt>, then the <tt class="code">c-string</tt>
pointer is assigned to. This allows <tt class="code">c-string</tt>
pointers to be initialized. For example:
<blockquote class="lisp">
<pre>
  (def-alien-type nil (struct foo (str c-string)))
  
  (defun make-foo (str) (let ((my-foo (make-alien (struct foo))))
  (setf (slot my-foo 'str) (make-alien char (length str))) (setf (slot
  my-foo 'str) str) my-foo))
</pre></blockquote>
Storing Lisp <tt class="code">nil</tt> writes C <tt class=
"code">NULL</tt> to the <tt class="code">c-string</tt>
pointer.</blockquote>
<!--TOC section Alien Operations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc247" id="htoc247"><b><font size=
"5">8.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Alien
Operations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This section describes the basic operations on Alien values.<br>
<br>
<!--TOC subsection Alien Access Operations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc248" id="htoc248"><b><font size=
"4">8.3.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Alien Access
Operations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs197"></a><a name="FN:deref" id="FN:deref"></a>
<div align="left">[Function]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">deref</tt> <tt class=
"variable">pointer-or-array</tt> <tt class=
"code">&amp;rest</tt><tt class="variable">indices</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the value pointed to by an Alien pointer or
the value of an Alien array element. If a pointer, an optional
single index can be specified to give the equivalent of C pointer
arithmetic; this index is scaled by the size of the type pointed
to. If an array, the number of indices must be the same as the
number of dimensions in the array type. <tt class="code">deref</tt>
can be set with <tt class="code">setf</tt> to assign a new
value.</blockquote>
<br>
<a name="@funs198"></a><a name="FN:slot" id="FN:slot"></a>
<div align="left">[Function]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">slot</tt> <tt class="variable">struct-or-union</tt>
<tt class="variable">slot-name</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function extracts the value of slot <tt class=
"variable">slot-name</tt> from the an Alien <tt class=
"code">struct</tt> or <tt class="code">union</tt>. If <tt class=
"variable">struct-or-union</tt> is a pointer to a structure or
union, then it is automatically dereferenced. This can be set with
<tt class="code">setf</tt> to assign a new value. Note that
<tt class="variable">slot-name</tt> is evaluated, and need not be a
compile-time constant (but only constant slot accesses are
efficiently compiled.)</blockquote>
<!--TOC subsection Alien Coercion Operations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc249" id="htoc249"><b><font size=
"4">8.3.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Alien Coercion
Operations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs199"></a><a name="FN:addr" id="FN:addr"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">addr</tt> <tt class="variable">alien-expr</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro returns a pointer to the location specified by
<tt class="variable">alien-expr</tt>, which must be either an Alien
variable, a use of <tt class="code">deref</tt>, a use of <tt class=
"code">slot</tt>, or a use of <a name="@funs200"></a><tt class=
"code">extern-alien</tt>.</blockquote>
<br>
<a name="@funs201"></a><a name="FN:cast" id="FN:cast"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">cast</tt> <tt class="variable">alien</tt>
<tt class="variable">new-type</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro converts <tt class="variable">alien</tt> to a new Alien
with the specified <tt class="variable">new-type</tt>. Both types
must be an Alien pointer, array or function type. Note that the
result is not <tt class="code">eq</tt> to the argument, but does
refer to the same data bits.</blockquote>
<br>
<a name="@funs202"></a><a name="FN:sap-alien" id=
"FN:sap-alien"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">sap-alien</tt> <tt class="variable">sap</tt>
<tt class="variable">type</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs203"></a><a name="FN:alien-sap" id=
"FN:alien-sap"></a>
<div align="left">[Function]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">alien-sap</tt> <tt class=
"variable">alien-value</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<br>
<tt class="code">sap-alien</tt> converts <tt class=
"variable">sap</tt> (a system area pointer see
section&nbsp;<a href="#system-area-pointers">6.5</a>) to an Alien
value with the specified <tt class="variable">type</tt>. <tt class=
"variable">type</tt> is not evaluated.<br>
<br>
<tt class="code">alien-sap</tt> returns the SAP which points to
<tt class="variable">alien-value</tt>'s data.<br>
<br>
The <tt class="variable">type</tt> to <tt class=
"code">sap-alien</tt> and the type of the <tt class=
"variable">alien-value</tt> to <tt class="code">alien-sap</tt> must
some Alien pointer, array or record type.</blockquote>
<!--TOC subsection Alien Dynamic Allocation-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc250" id="htoc250"><b><font size=
"4">8.3.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Alien Dynamic
Allocation</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Dynamic Aliens are allocated using the <tt class="code">malloc</tt>
library, so foreign code can call <tt class="code">free</tt> on the
result of <tt class="code">make-alien</tt>, and Lisp code can call
<tt class="code">free-alien</tt> on objects allocated by foreign
code.<br>
<br>
<br>
<a name="@funs204"></a><a name="FN:make-alien" id=
"FN:make-alien"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">make-alien</tt> <tt class="variable">type</tt>
<tt class="code">{<tt class="variable">size</tt>}</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro returns a dynamically allocated Alien of the specified
<tt class="variable">type</tt> (which is not evaluated.) The
allocated memory is not initialized, and may contain arbitrary
junk. If supplied, <tt class="variable">size</tt> is an expression
to evaluate to compute the size of the allocated object. There are
two major cases:
<ul>
<li>When <tt class="variable">type</tt> is an array type, an array
of that type is allocated and a <tt class="variable">pointer</tt>
to it is returned. Note that you must use <tt class=
"code">deref</tt> to change the result to an array before you can
use <tt class="code">deref</tt> to read or write elements:
<blockquote class="lisp">
<pre>
(defvar *foo* (make-alien (array char 10)))

(type-of *foo*) ==&gt; (alien (* (array (signed 8) 10)))

(setf (deref (deref foo) 0) 10) ==&gt; 10
</pre></blockquote>
If supplied, <tt class="variable">size</tt> is used as the first
dimension for the array.<br>
<br></li>
<li>When <tt class="variable">type</tt> is any other type, then
then an object for that type is allocated, and a <tt class=
"variable">pointer</tt> to it is returned. So <tt class=
"code">(make-alien int)</tt> returns a <tt class="code">(*
int)</tt>. If <tt class="variable">size</tt> is specified, then a
block of that many objects is allocated, with the result pointing
to the first one.</li>
</ul>
</blockquote>
<br>
<a name="@funs205"></a><a name="FN:free-alien" id=
"FN:free-alien"></a>
<div align="left">[Function]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">free-alien</tt> <tt class="variable">alien</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function frees the storage for <tt class="variable">alien</tt>
(which must have been allocated with <tt class=
"code">make-alien</tt> or <tt class=
"code">malloc</tt>.)</blockquote>
See also <a name="@funs206"></a><tt class="code">with-alien</tt>,
which stack-allocates Aliens.<br>
<br>
<!--TOC section Alien Variables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc251" id="htoc251"><b><font size=
"5">8.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Alien
Variables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Both local (stack allocated) and external (C global) Alien
variables are supported.<br>
<br>
<!--TOC subsection Local Alien Variables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc252" id="htoc252"><b><font size=
"4">8.4.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Local Alien
Variables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs207"></a><a name="FN:with-alien" id=
"FN:with-alien"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">with-alien</tt> <tt class="code">{(<tt class=
"variable">name</tt> <tt class="variable">type</tt> <tt class=
"code">{<tt class=
"variable">initial-value</tt>}</tt>)}</tt><sup><font size=
"2">*</font></sup> <tt class="code">{form}</tt><sup><font size=
"2">*</font></sup> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro establishes local alien variables with the specified
Alien types and names for dynamic extent of the body. The variable
<tt class="variable">names</tt> are established as symbol-macros;
the bindings have lexical scope, and may be assigned with
<tt class="code">setq</tt> or <tt class="code">setf</tt>. This form
is analogous to defining a local variable in C: additional storage
is allocated, and the initial value is copied.<br>
<br>
<tt class="code">with-alien</tt> also establishes a new scope for
named structures and unions. Any <tt class="variable">type</tt>
specified for a variable may contain name structure or union types
with the slots specified. Within the lexical scope of the binding
specifiers and body, a locally defined structure type <tt class=
"variable">foo</tt> can be referenced by its name using:
<blockquote class="lisp">
<pre>
  (struct foo)
</pre></blockquote>
</blockquote>
<!--TOC subsection External Alien Variables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc253" id="htoc253"><b><font size=
"4">8.4.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">External Alien
Variables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="external-aliens" id="external-aliens"></a><br>
External Alien names are strings, and Lisp names are symbols. When
an external Alien is represented using a Lisp variable, there must
be a way to convert from one name syntax into the other. The macros
<tt class="code">extern-alien</tt>, <tt class=
"code">def-alien-variable</tt> and <a name=
"@funs208"></a><tt class="code">def-alien-routine</tt> use this
conversion heuristic:
<ul>
<li>Alien names are converted to Lisp names by uppercasing and
replacing underscores with hyphens.<br>
<br></li>
<li>Conversely, Lisp names are converted to Alien names by
lowercasing and replacing hyphens with underscores.<br>
<br></li>
<li>Both the Lisp symbol and Alien string names may be separately
specified by using a list of the form:
<blockquote class="lisp">
<pre>
  (<tt class="variable">alien-string</tt> <tt class=
"variable">lisp-symbol</tt>)
</pre></blockquote>
</li>
</ul>
<br>
<a name="@funs209"></a><a name="FN:def-alien-variable" id=
"FN:def-alien-variable"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">def-alien-variable</tt> <tt class=
"variable">name</tt> <tt class="variable">type</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro defines <tt class="variable">name</tt> as an external
Alien variable of the specified Alien <tt class=
"variable">type</tt>. <tt class="variable">name</tt> and <tt class=
"variable">type</tt> are not evaluated. The Lisp name of the
variable (see above) becomes a global Alien variable in the Lisp
namespace. Global Alien variables are effectively ``global symbol
macros''; a reference to the variable fetches the contents of the
external variable. Similarly, setting the variable stores new
contents---the new contents must be of the declared <tt class=
"variable">type</tt>.<br>
<br>
For example, it is often necessary to read the global C variable
<tt class="code">errno</tt> to determine why a particular function
call failed. It is possible to define errno and make it accessible
from Lisp by the following:
<blockquote class="lisp">
<pre>
(def-alien-variable "errno" int)

;; Now it is possible to get the value of the C variable errno simply by
;; referencing that Lisp variable:
;;
(print errno)
</pre></blockquote>
</blockquote>
<br>
<a name="@funs210"></a><a name="FN:extern-alien" id=
"FN:extern-alien"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">extern-alien</tt> <tt class="variable">name</tt>
<tt class="variable">type</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro returns an Alien with the specified <tt class=
"variable">type</tt> which points to an externally defined value.
<tt class="variable">name</tt> is not evaluated, and may be
specified either as a string or a symbol. <tt class=
"variable">type</tt> is an unevaluated Alien type
specifier.</blockquote>
<!--TOC section Alien Data Structure Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc254" id="htoc254"><b><font size=
"5">8.5</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Alien Data
Structure Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Now that we have Alien types, operations and variables, we can
manipulate foreign data structures. This C declaration can be
translated into the following Alien type:
<blockquote class="lisp">
<pre>
struct foo {
    int a;
    struct foo *b[100];
};

 &lt;==&gt;

(def-alien-type nil
  (struct foo
    (a int)
    (b (array (* (struct foo)) 100))))
</pre></blockquote>
With this definition, the following C expression can be translated
in this way:
<blockquote class="example">
<pre>
struct foo f;
f.b[7].a

 &lt;==&gt;

(with-alien ((f (struct foo)))
  (slot (deref (slot f 'b) 7) 'a)
  ;;
  ;; Do something with f...
  )
</pre></blockquote>
Or consider this example of an external C variable and some
accesses:
<blockquote class="example">
<pre>
struct c_struct {
        short x, y;
        char a, b;
        int z;
        c_struct *n;
};

extern struct c_struct *my_struct;

my_struct-&gt;x++;
my_struct-&gt;a = 5;
my_struct = my_struct-&gt;n;
</pre></blockquote>
which can be made be manipulated in Lisp like this:
<blockquote class="lisp">
<pre>
(def-alien-type nil
  (struct c-struct
          (x short)
          (y short)
          (a char)
          (b char)
          (z int)
          (n (* c-struct))))

(def-alien-variable "my_struct" (* c-struct))

(incf (slot my-struct 'x))
(setf (slot my-struct 'a) 5)
(setq my-struct (slot my-struct 'n))
</pre></blockquote>
<!--TOC section Loading Unix Object Files-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc255" id="htoc255"><b><font size=
"5">8.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Loading Unix
Object Files</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL is able to load foreign object files at runtime, using the
function <tt class="code">load-foreign</tt>. This function is able
to load shared libraries (that are typically named
<code>.so</code>) via the dlopen mechanism. It can also load
<code>.a</code> or <code>.o</code> object files by calling the
linker on the files and libraries to create a loadable object file.
Once loaded, the external symbols that define routines and
variables are made available for future external references (e.g.
by <tt class="code">extern-alien</tt>.) <tt class=
"code">load-foreign</tt> must be run before any of the defined
symbols are referenced.<br>
<br>
Note that if a Lisp core image is saved (using <a name=
"@funs211"></a><tt class="code">save-lisp</tt>), all loaded foreign
code is lost when the image is restarted.<br>
<br>
<br>
<a name="@funs212"></a><a name="FN:load-foreign" id=
"FN:load-foreign"></a>
<div align="left">[Function]<br>
<tt class="function-name">ext:</tt><tt class=
"function-name">load-foreign</tt> <tt class="variable">files</tt>
<tt class="code">&amp;key</tt> <tt class="code">:libraries</tt>
<tt class="code">:base-file</tt> <tt class="code">:env</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="variable">files</tt> is a <tt class=
"code">simple-string</tt> or list of <tt class=
"code">simple-string</tt>s specifying the names of the object
files. If <tt class="variable">files</tt> is a simple-string, the
file that it designates is loaded using the platform's dlopen
mechanism. If it is a list of strings, the platform linker
<tt class="code">ld</tt> is invoked to transform the object files
into a loadable object file. <tt class="variable">libraries</tt> is
a list of <tt class="code">simple-string</tt>s specifying libraries
in a format that the platform linker expects. The default value for
<tt class="variable">libraries</tt> is <tt class=
"code">("-lc")</tt> (i.e., the standard C library). <tt class=
"variable">base-file</tt> is the file to use for the initial symbol
table information. The default is the Lisp start up code:
<tt class="filename">path:lisp</tt>. <tt class="variable">env</tt>
should be a list of simple strings in the format of Unix
environment variables (i.e., <tt class="code"><tt class=
"variable">A</tt>=<tt class="variable">B</tt></tt>, where
<tt class="variable">A</tt> is an environment variable and
<tt class="variable">B</tt> is its value). The default value for
<tt class="variable">env</tt> is the environment information
available at the time Lisp was invoked. Unless you are certain that
you want to change this, you should just use the
default.</blockquote>
<!--TOC section Alien Function Calls-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc256" id="htoc256"><b><font size=
"5">8.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Alien Function
Calls</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The foreign function call interface allows a Lisp program to call
functions written in other languages. The current implementation of
the foreign function call interface assumes a C calling convention
and thus routines written in any language that adheres to this
convention may be called from Lisp.<br>
<br>
Lisp sets up various interrupt handling routines and other
environment information when it first starts up, and expects these
to be in place at all times. The C functions called by Lisp should
either not change the environment, especially the interrupt entry
points, or should make sure that these entry points are restored
when the C function returns to Lisp. If a C function makes changes
without restoring things to the way they were when the C function
was entered, there is no telling what will happen.<br>
<br>
<!--TOC subsection The alien-funcall Primitive-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc257" id="htoc257"><b><font size=
"4">8.7.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The alien-funcall
Primitive</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs213"></a><a name="FN:alien-funcall" id=
"FN:alien-funcall"></a>
<div align="left">[Function]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">alien-funcall</tt> <tt class=
"variable">alien-function</tt> <tt class="code">&amp;rest</tt>
<tt class="variable">arguments</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function is the foreign function call primitive: <tt class=
"variable">alien-function</tt> is called with the supplied
<tt class="variable">arguments</tt> and its value is returned. The
<tt class="variable">alien-function</tt> is an arbitrary run-time
expression; to call a constant function, use <a name=
"@funs214"></a><tt class="code">extern-alien</tt> or <tt class=
"code">def-alien-routine</tt>.<br>
<br>
The type of <tt class="variable">alien-function</tt> must be
<tt class="code">(alien (function ...))</tt> or <tt class=
"code">(alien (* (function ...)))</tt>, See section&nbsp;<a href=
"#alien-function-types">8.2.3</a>. The function type is used to
determine how to call the function (as though it was declared with
a prototype.) The type need not be known at compile time, but only
known-type calls are efficiently compiled. Limitations:
<ul>
<li>Structure type return values are not implemented.</li>
<li>Passing of structures by value is not implemented.</li>
</ul>
</blockquote>
Here is an example which allocates a <tt class="code">(struct
foo)</tt>, calls a foreign function to initialize it, then returns
a Lisp vector of all the <tt class="code">(* (struct foo))</tt>
objects filled in by the foreign call:
<blockquote class="lisp">
<pre>
;; Allocate a foo on the stack.
(with-alien ((f (struct foo)))
  ;;
  ;; Call some C function to fill in foo fields.
  (alien-funcall (extern-alien "mangle_foo" (function void (* foo)))
                 (addr f))
  ;;
  ;; Find how many foos to use by getting the A field.
  (let* ((num (slot f 'a))
         (result (make-array num)))
    ;;
    ;; Get a pointer to the array so that we don't have to keep
    ;; extracting it:
    (with-alien ((a (* (array (* (struct foo)) 100)) (addr (slot f 'b))))
      ;;
      ;; Loop over the first N elements and stash them in the
      ;; result vector.
      (dotimes (i num)
        (setf (svref result i) (deref (deref a) i)))
      result)))
</pre></blockquote>
<!--TOC subsection The def-alien-routine Macro-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc258" id="htoc258"><b><font size=
"4">8.7.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">The
def-alien-routine Macro</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@funs215"></a><a name="FN:def-alien-routine" id=
"FN:def-alien-routine"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">def-alien-routine</tt> <tt class=
"variable">name</tt> <tt class="variable">result-type</tt>
<tt class="code">{(<tt class="variable">aname</tt> <tt class=
"variable">atype</tt> <tt class=
"code">{style}</tt>)}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro is a convenience for automatically generating Lisp
interfaces to simple foreign functions. The primary feature is the
parameter style specification, which translates the C
pass-by-reference idiom into additional return values.<br>
<br>
<tt class="variable">name</tt> is usually a string external symbol,
but may also be a symbol Lisp name or a list of the foreign name
and the Lisp name. If only one name is specified, the other is
automatically derived, (see section&nbsp;<a href=
"#external-aliens">8.4.2</a>.)<br>
<br>
<tt class="variable">result-type</tt> is the Alien type of the
return value. Each remaining subform specifies an argument to the
foreign function. <tt class="variable">aname</tt> is the symbol
name of the argument to the constructed function (for
documentation) and <tt class="variable">atype</tt> is the Alien
type of corresponding foreign argument. The semantics of the actual
call are the same as for <a name="@funs216"></a><tt class=
"code">alien-funcall</tt>. <tt class="variable">style</tt> should
be one of the following:
<dl compact="compact">
<dt><tt class="code">:in</tt><br></dt>
<dd>specifies that the argument is passed by value. This is the
default. <tt class="code">:in</tt> arguments have no corresponding
return value from the Lisp function.<br>
<br></dd>
<dt><tt class="code">:out</tt><br></dt>
<dd>specifies a pass-by-reference output value. The type of the
argument must be a pointer to a fixed sized object (such as an
integer or pointer). <tt class="code">:out</tt> and <tt class=
"code">:in-out</tt> cannot be used with pointers to arrays, records
or functions. An object of the correct size is allocated, and its
address is passed to the foreign function. When the function
returns, the contents of this location are returned as one of the
values of the Lisp function.<br>
<br></dd>
<dt><tt class="code">:copy</tt><br></dt>
<dd>is similar to <tt class="code">:in</tt>, but the argument is
copied to a pre-allocated object and a pointer to this object is
passed to the foreign routine.<br>
<br></dd>
<dt><tt class="code">:in-out</tt><br></dt>
<dd>is a combination of <tt class="code">:copy</tt> and <tt class=
"code">:out</tt>. The argument is copied to a pre-allocated object
and a pointer to this object is passed to the foreign routine. On
return, the contents of this location is returned as an additional
value.</dd>
</dl>
Any efficiency-critical foreign interface function should be inline
expanded by preceding <tt class="code">def-alien-routine</tt> with:
<blockquote class="lisp">
<pre>
(declaim (inline <tt class="variable">lisp-name</tt>))
</pre></blockquote>
In addition to avoiding the Lisp call overhead, this allows
pointers, word-integers and floats to be passed using
non-descriptor representations, avoiding consing (see
section&nbsp;<a href="#non-descriptor">5.11.2</a>.)</blockquote>
<!--TOC subsection def-alien-routine Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc259" id="htoc259"><b><font size=
"4">8.7.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">def-alien-routine
Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Consider the C function <tt class="code">cfoo</tt> with the
following calling convention:
<blockquote class="example">
<pre>
/* a for update
 * i out
 */
void cfoo (char *str, char *a, int *i);
</pre></blockquote>
which can be described by the following call to <tt class=
"code">def-alien-routine</tt>:
<blockquote class="lisp">
<pre>
(def-alien-routine "cfoo" void
  (str c-string)
  (a char :in-out)
  (i int :out))
</pre></blockquote>
The Lisp function <tt class="code">cfoo</tt> will have two
arguments (<tt class="variable">str</tt> and <tt class=
"variable">a</tt>) and two return values (<tt class=
"variable">a</tt> and <tt class="variable">i</tt>).<br>
<br>
<!--TOC subsection Calling Lisp from C-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc260" id="htoc260"><b><font size=
"4">8.7.4</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Calling Lisp from
C</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL supports calling Lisp from C via the <a name=
"@funs217"></a><tt class="code">def-callback</tt> macro:<br>
<br>
<br>
<a name="@funs218"></a><a name="FN:def-callback" id=
"FN:def-callback"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">def-callback</tt> <tt class="variable">name</tt>
(<tt class="variable">return-type</tt> <tt class="code">{(arg-name
arg-type)}</tt><sup><font size="2">*</font></sup>) <tt class=
"code">&amp;body</tt> body &nbsp;&nbsp;&nbsp;</div>
<blockquote>This macro defines a Lisp function that can be called
from C and a Lisp variable. The arguments to the function must be
alien types, and the return type must also be an alien type. This
Lisp function can be accessed via the <a name=
"@funs219"></a><tt class="code">callback</tt> macro.<br>
<br>
<tt class="variable">name</tt> is the name of the Lisp function. It
is also the name of a variable to be used by the <tt class=
"code">callback</tt> macro.<br>
<br>
<tt class="variable">return-type</tt> is the return type of the
function. This must be a recognized alien type.<br>
<br>
<tt class="variable">arg-name</tt> specifies the name of the
argument to the function, and the argument has type <tt class=
"variable">arg-type</tt>, which must be an alien type.</blockquote>
<br>
<a name="@funs220"></a><a name="FN:callback" id="FN:callback"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">callback</tt> <tt class=
"variable">callback-symbol</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>This macro extracts the appropriate information for the
function named <tt class="variable">callback-symbol</tt> so that it
can be called by a C function. <tt class=
"variable">callback-symbol</tt> must be a symbol created by the
<tt class="code">def-callback</tt> macro.</blockquote>
<br>
<a name="@funs221"></a><a name="FN:callback-funcall" id=
"FN:callback-funcall"></a>
<div align="left">[Macro]<br>
<tt class="function-name">alien:</tt><tt class=
"function-name">callback-funcall</tt> <tt class=
"variable">callback-name</tt> <tt class=
"code">&amp;rest</tt><tt class="variable">args</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This macro does the necessary stuff to call the
callback named <tt class="variable">callback-name</tt> with the
given arguments.</blockquote>
<!--TOC subsection Callback Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc261" id="htoc261"><b><font size=
"4">8.7.5</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Callback
Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Here is a simple example of using callbacks.
<blockquote class="lisp">
<pre>
(use-package :alien)
(use-package :c-call)

(def-callback foo (int (arg1 int) (arg2 int))
  (format t "~&amp;foo: ~S, ~S~%" arg1 arg2)
  (+ arg1 arg2))

(defun test-foo ()
  (callback-funcall foo 555 444444))
</pre></blockquote>
In this example, the callback function <tt class="code">foo</tt> is
defined which takes two C <tt class="code">int</tt> parameters and
returns a <tt class="code">int</tt>. As this shows, we can use
arbitrary Lisp inside the function.<br>
<br>
The function <tt class="code">test-foo</tt> shows how we can call
this callback function from Lisp. The macro <tt class=
"code">callback</tt> extracts the necessary information for the
callback function <tt class="code">foo</tt> which can be converted
into a pointer which we can call via <tt class=
"code">alien-funcall</tt>.<br>
<br>
The following code is a more complete example where a foreign
routine calls our Lisp routine.
<blockquote class="lisp">
<pre>
(use-package :alien)
(use-package :c-call)

(def-alien-routine qsort void
  (base (* t))
  (nmemb int)
  (size int)
  (compar (* (function int (* t) (* t)))))

(def-callback my&lt; (int (arg1 (* double))
                       (arg2 (* double)))
  (let ((a1 (deref arg1))
        (a2 (deref arg2)))
    (cond ((= a1 a2)  0)
          ((&lt; a1 a2) -1)
          (t         +1))))

(defun test-qsort ()
  (let ((a (make-array 10 :element-type 'double-float
                       :initial-contents '(0.1d0 0.5d0 0.2d0 1.2d0 1.5d0
                                           2.5d0 0.0d0 0.1d0 0.2d0 0.3d0))))
    (print a)
    (qsort (sys:vector-sap a)
           (length a)
           (alien-size double :bytes)
           (alien:callback my&lt;))
    (print a)))
</pre></blockquote>
We define the alien routine, <tt class="code">qsort</tt>, and a
callback, <tt class="code">my&lt;</tt>, to determine whether two
<tt class="code">double</tt>'s are less than, greater than or equal
to each other.<br>
<br>
The test function <tt class="code">test-qsort</tt> shows how we can
call the alien sort routine with our Lisp comparison routine to
produce a sorted array.<br>
<br>
<!--TOC subsection Accessing Lisp Arrays-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc262" id="htoc262"><b><font size=
"4">8.7.6</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Accessing Lisp
Arrays</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Due to the way CMUCL manages memory, the amount of memory that can
be dynamically allocated by <tt class="code">malloc</tt> or
<a name="@funs222"></a><tt class="code">make-alien</tt> is
limited<sup><a name="text16" href="#note16" id="text16"><font size=
"2">1</font></a></sup>.<br>
<br>
To overcome this limitation, it is possible to access the content
of Lisp arrays which are limited only by the amount of physical
memory and swap space available. However, this technique is only
useful if the foreign function takes pointers to memory instead of
allocating memory for itself. In latter case, you will have to
modify the foreign functions.<br>
<br>
This technique takes advantage of the fact that CMUCL has
specialized array types (see section&nbsp;<a href=
"#specialized-array-types">5.11.8</a>) that match a typical C
array. For example, a <tt class="code">(simple-array double-float
(100))</tt> is stored in memory in essentially the same way as the
C array <tt class="code">double x[100]</tt> would be. The following
function allows us to get the physical address of such a Lisp
array:
<blockquote class="example">
<pre>
(defun array-data-address (array)
  "Return the physical address of where the actual data of an array is
stored.

ARRAY must be a specialized array type in CMUCL.  This means ARRAY
must be an array of one of the following types:

                  double-float
                  single-float
                  (unsigned-byte 32)
                  (unsigned-byte 16)
                  (unsigned-byte  8)
                  (signed-byte 32)
                  (signed-byte 16)
                  (signed-byte  8)
"
  (declare (type (or (simple-array (signed-byte 8))
                     (simple-array (signed-byte 16))
                     (simple-array (signed-byte 32))
                     (simple-array (unsigned-byte 8))
                     (simple-array (unsigned-byte 16))
                     (simple-array (unsigned-byte 32))
                     (simple-array single-float)
                     (simple-array double-float)
                     (simple-array (complex single-float))
                     (simple-array (complex double-float)))
                 array)
           (optimize (speed 3) (safety 0))
           (ext:optimize-interface (safety 3)))
  ;; with-array-data will get us to the actual data.  However, because
  ;; the array could have been displaced, we need to know where the
  ;; data starts.
  (lisp::with-array-data ((data array)
                          (start)
                          (end))
    (declare (ignore end))
    ;; DATA is a specialized simple-array.  Memory is laid out like this:
    ;;
    ;;   byte offset    Value
    ;;        0         type code (should be 70 for double-float vector)
    ;;        4         4 * number of elements in vector
    ;;        8         1st element of vector
    ;;      ...         ...
    ;;
    (let ((addr (+ 8 (logandc1 7 (kernel:get-lisp-obj-address data))))
          (type-size
           (let ((type (array-element-type data)))
             (cond ((or (equal type '(signed-byte 8))
                        (equal type '(unsigned-byte 8)))
                    1)
                   ((or (equal type '(signed-byte 16))
                        (equal type '(unsigned-byte 16)))
                    2)
                   ((or (equal type '(signed-byte 32))
                        (equal type '(unsigned-byte 32)))
                    4)
                   ((equal type 'single-float)
                    4)
                   ((equal type 'double-float)
                    8)
                   (t
                    (error "Unknown specialized array element type"))))))
      (declare (type (unsigned-byte 32) addr)
               (optimize (speed 3) (safety 0) (ext:inhibit-warnings 3)))
      (system:int-sap (the (unsigned-byte 32)
                        (+ addr (* type-size start)))))))
</pre></blockquote>
We note, however, that the system function <a name=
"@funs223"></a><tt class="code">system:vector-sap</tt> will do the
same thing as above does.<br>
<br>
Assume we have the C function below that we wish to use:
<blockquote class="example">
<pre>
  double dotprod(double* x, double* y, int n)
  {
    int k;
    double sum = 0;

    for (k = 0; k &lt; n; ++k) {
      sum += x[k] * y[k];
    }
    return sum;
  }
</pre></blockquote>
The following example generates two large arrays in Lisp, and calls
the C function to do the desired computation. This would not have
been possible using <tt class="code">malloc</tt> or <tt class=
"code">make-alien</tt> since we need about 16 MB of memory to hold
the two arrays.
<blockquote class="example">
<pre>
  (alien:def-alien-routine "dotprod" c-call:double
    (x (* double-float) :in)
    (y (* double-float) :in)
    (n c-call:int :in))
    
  (defun test-dotprod ()
    (let ((x (make-array 10000 :element-type 'double-float 
                         :initial-element 2d0))
          (y (make-array 10000 :element-type 'double-float
                         :initial-element 10d0)))
        (sys:without-gcing
          (let ((x-addr (sys:vector-sap x))
                (y-addr (sys:vector-sap y)))
            (dotprod x-addr y-addr 10000)))))
</pre></blockquote>
In this example, we have used <tt class="code">sys:vector-sap</tt>
instead of <tt class="code">array-data-address</tt>, but we could
have used <tt class="code">(sys:int-sap (array-data-address
x))</tt> as well.<br>
<br>
Also, we have wrapped the inner <tt class="code">let</tt>
expression in a <tt class="code">sys:without-gcing</tt> that
disables garbage collection for the duration of the body. This will
prevent garbage collection from moving <tt class="code">x</tt> and
<tt class="code">y</tt> arrays after we have obtained the (now
erroneous) addresses but before the call to <tt class=
"code">dotprod</tt> is made.<br>
<br>
<!--TOC section Step-by-Step Alien Example-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc263" id="htoc263"><b><font size=
"5">8.8</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Step-by-Step
Alien Example</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
This section presents a complete example of an interface to a
somewhat complicated C function. This example should give a fairly
good idea of how to get the effect you want for almost any kind of
C function. Suppose you have the following C function which you
want to be able to call from Lisp in the file <tt class=
"filename">test.c</tt>:
<pre>
                
struct c_struct
{
  int x;
  char *s;
};
 
struct c_struct *c_function (i, s, r, a)
    int i;
    char *s;
    struct c_struct *r;
    int a[10];
{
  int j;
  struct c_struct *r2;
 
  printf("i = %d\n", i);
  printf("s = %s\n", s);
  printf("r-&gt;x = %d\n", r-&gt;x);
  printf("r-&gt;s = %s\n", r-&gt;s);
  for (j = 0; j &lt; 10; j++) printf("a[%d] = %d.\n", j, a[j]);
  r2 = (struct c_struct *) malloc (sizeof(struct c_struct));
  r2-&gt;x = i + 5;
  r2-&gt;s = "A C string";
  return(r2);
};
</pre>
It is possible to call this function from Lisp using the file
<tt class="filename">test.lisp</tt> whose contents is:
<blockquote class="lisp">
<pre>
;;; -*- Package: test-c-call -*-
(in-package "TEST-C-CALL")
(use-package "ALIEN")
(use-package "C-CALL")

;;; Define the record c-struct in Lisp.
(def-alien-type nil
    (struct c-struct
            (x int)
            (s c-string)))

;;; Define the Lisp function interface to the C routine.  It returns a
;;; pointer to a record of type c-struct.  It accepts four parameters:
;;; i, an int; s, a pointer to a string; r, a pointer to a c-struct
;;; record; and a, a pointer to the array of 10 ints.
;;;
;;; The INLINE declaration eliminates some efficiency notes about heap
;;; allocation of Alien values.
(declaim (inline c-function))
(def-alien-routine c-function
    (* (struct c-struct))
  (i int)
  (s c-string)
  (r (* (struct c-struct)))
  (a (array int 10)))

;;; A function which sets up the parameters to the C function and
;;; actually calls it.
(defun call-cfun ()
  (with-alien ((ar (array int 10))
               (c-struct (struct c-struct)))
    (dotimes (i 10)                     ; Fill array.
      (setf (deref ar i) i))
    (setf (slot c-struct 'x) 20)
    (setf (slot c-struct 's) "A Lisp String")

    (with-alien ((res (* (struct c-struct))
                 (c-function 5 "Another Lisp String" (addr c-struct) ar)))
      (format t "Returned from C function.~%")
      (multiple-value-prog1
          (values (slot res 'x)
                  (slot res 's))
        ;;              
        ;; Deallocate result <em> after</em> we are done using it.
        (free-alien res)))))
</pre></blockquote>
To execute the above example, it is necessary to compile the C
routine as follows:
<blockquote class="example">
<pre>
cc -c test.c
</pre></blockquote>
In order to enable incremental loading with some linkers, you may
need to say:
<blockquote class="example">
<pre>
cc -G 0 -c test.c
</pre></blockquote>
Once the C code has been compiled, you can start up Lisp and load
it in:
<blockquote class="example">
<pre>
% lisp
;;; Lisp should start up with its normal prompt.

;;; Compile the Lisp file.  This step can be done separately.  You don't have
;;; to recompile every time.
* (compile-file "test.lisp")

;;; Load the foreign object file to define the necessary symbols.  This must
;;; be done before loading any code that refers to these symbols.  next block
;;; of comments are actually the output of LOAD-FOREIGN.  Different linkers
;;; will give different warnings, but some warning about redefining the code
;;; size is typical.
* (load-foreign "test.o")

;;; Running library:load-foreign.csh...
;;; Loading object file...
;;; Parsing symbol table...
Warning:  "_gp" moved from #x00C082C0 to #x00C08460.
Warning:  "end" moved from #x00C00340 to #x00C004E0.

;;; o.k. now load the compiled Lisp object file.
* (load "test")

;;; Now we can call the routine that sets up the parameters and calls the C
;;; function.
* (test-c-call::call-cfun)

;;; The C routine prints the following information to standard output.
i = 5
s = Another Lisp string
r-&gt;x = 20
r-&gt;s = A Lisp string
a[0] = 0.
a[1] = 1.
a[2] = 2.
a[3] = 3.
a[4] = 4.
a[5] = 5.
a[6] = 6.
a[7] = 7.
a[8] = 8.
a[9] = 9.
;;; Lisp prints out the following information.
Returned from C function.
;;; Return values from the call to test-c-call::call-cfun.
10
"A C string"
*
</pre></blockquote>
If any of the foreign functions do output, they should not be
called from within Hemlock. Depending on the situation, various
strange behavior occurs. Under X, the output goes to the window in
which Lisp was started; on a terminal, the output will overwrite
the Hemlock screen image; in a Hemlock slave, standard output is
<tt class="filename">/dev/null</tt> by default, so any output is
discarded. <!--NAME aliens.html-->
 <!--BEGIN NOTES chapter-->
<hr width="50%" size="1">
<dl>
<dt><a name="note16" href="#text16" id="note16"><font size=
"5">1</font></a></dt>
<dd>CMUCL mmaps a large piece of memory for its own use and this
memory is typically about 256&nbsp;MB above the start of the C
heap. Thus, only about 256&nbsp;MB of memory can be dynamically
allocated. In earlier versions, this limit was closer to
8&nbsp;MB.</dd>
</dl>
<!--END NOTES-->
<!--TOC chapter Interprocess Communication under LISP-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc264" id="htoc264"><b><font size=
"6">Chapter&nbsp;9</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Interprocess
Communication under LISP</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="remote" id="remote"></a><br>
<div align="center"><b>by William Lott and Bill Chiles</b></div>
<br>
CMUCL offers a facility for interprocess communication (IPC) on top
of using Unix system calls and the complications of that level of
IPC. There is a simple remote-procedure-call (RPC) package build on
top of TCP/IP sockets.<br>
<br>
<!--TOC section The REMOTE Package-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc265" id="htoc265"><b><font size=
"5">9.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The REMOTE
Package</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <tt class="code">remote</tt> package provides simple RPC
facility including interfaces for creating servers, connecting to
already existing servers, and calling functions in other Lisp
processes. The routines for establishing a connection between two
processes, <tt class="code">create-request-server</tt> and
<tt class="code">connect-to-remote-server</tt>, return <tt class=
"variable">wire</tt> structures. A wire maintains the current state
of a connection, and all the RPC forms require a wire to indicate
where to send requests.<br>
<br>
<!--TOC subsection Connecting Servers and Clients-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc266" id="htoc266"><b><font size=
"4">9.1.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Connecting
Servers and Clients</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Before a client can connect to a server, it must know the network
address on which the server accepts connections. Network addresses
consist of a host address or name, and a port number. Host
addresses are either a string of the form <tt class=
"code">VANCOUVER.SLISP.CS.CMU.EDU</tt> or a 32 bit unsigned
integer. Port numbers are 16 bit unsigned integers. Note:
<tt class="variable">port</tt> in this context has nothing to do
with Mach ports and message passing.<br>
<br>
When a process wants to receive connection requests (that is,
become a server), it first picks an integer to use as the port.
Only one server (Lisp or otherwise) can use a given port number on
a given machine at any particular time. This can be an iterative
process to find a free port: picking an integer and calling
<tt class="code">create-request-server</tt>. This function signals
an error if the chosen port is unusable. You will probably want to
write a loop using <tt class="code">handler-case</tt>, catching
conditions of type error, since this function does not signal more
specific conditions.<br>
<br>
<br>
<a name="@funs224"></a><a name="FN:create-request-server" id=
"FN:create-request-server"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">create-request-server</tt> <tt class=
"variable">port</tt> <tt class="code">&amp;optional</tt> <tt class=
"variable">on-connect</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">create-request-server</tt> sets up the current
Lisp to accept connections on the given port. If port is
unavailable for any reason, this signals an error. When a client
connects to this port, the acceptance mechanism makes a wire
structure and invokes the <tt class="variable">on-connect</tt>
function. Invoking this function has a couple of purposes, and
<tt class="variable">on-connect</tt> may be <tt class=
"code">nil</tt> in which case the system foregoes invoking any
function at connect time.<br>
<br>
The <tt class="variable">on-connect</tt> function is both a hook
that allows you access to the wire created by the acceptance
mechanism, and it confirms the connection. This function takes two
arguments, the wire and the host address of the connecting process.
See the section on host addresses below. When <tt class=
"variable">on-connect</tt> is <tt class="code">nil</tt>, the
request server allows all connections. When it is non-<tt class=
"code">nil</tt>, the function returns two values, whether to accept
the connection and a function the system should call when the
connection terminates. Either value may be <tt class=
"code">nil</tt>, but when the first value is <tt class=
"code">nil</tt>, the acceptance mechanism destroys the wire.<br>
<br>
<tt class="code">create-request-server</tt> returns an object that
<tt class="code">destroy-request-server</tt> uses to terminate a
connection.</blockquote>
<br>
<a name="@funs225"></a><a name="FN:destroy-request-server" id=
"FN:destroy-request-server"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">destroy-request-server</tt> <tt class=
"variable">server</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">destroy-request-server</tt> takes the result of
<tt class="code">create-request-server</tt> and terminates that
server. Any existing connections remain intact, but all additional
connection attempts will fail.</blockquote>
<br>
<a name="@funs226"></a><a name="FN:connect-to-remote-server" id=
"FN:connect-to-remote-server"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">connect-to-remote-server</tt> <tt class=
"variable">host</tt> <tt class="variable">port</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">on-death</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">connect-to-remote-server</tt> attempts to connect
to a remote server at the given <tt class="variable">port</tt> on
<tt class="variable">host</tt> and returns a wire structure if it
is successful. If <tt class="variable">on-death</tt> is
non-<tt class="code">nil</tt>, it is a function the system invokes
when this connection terminates.</blockquote>
<!--TOC subsection Remote Evaluations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc267" id="htoc267"><b><font size=
"4">9.1.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Remote
Evaluations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
After the server and client have connected, they each have a wire
allowing function evaluation in the other process. This RPC
mechanism has three flavors: for side-effect only, for a single
value, and for multiple values.<br>
<br>
Only a limited number of data types can be sent across wires as
arguments for remote function calls and as return values: integers
inclusively less than 32 bits in length, symbols, lists, and
<tt class="variable">remote-objects</tt> (see section&nbsp;<a href=
"#remote-objs">9.1.3</a>). The system sends symbols as two strings,
the package name and the symbol name, and if the package doesn't
exist remotely, the remote process signals an error. The system
ignores other slots of symbols. Lists may be any tree of the above
valid data types. To send other data types you must represent them
in terms of these supported types. For example, you could use
<tt class="code">prin1-to-string</tt> locally, send the string, and
use <tt class="code">read-from-string</tt> remotely.<br>
<br>
<br>
<a name="@funs227"></a><a name="FN:remote" id="FN:remote"></a>
<div align="left">[Macro]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote</tt> <tt class="variable">wire</tt>
<tt class="code">{call-specs}</tt><sup><font size=
"2">*</font></sup> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The <tt class="code">remote</tt> macro arranges for the process at
the other end of <tt class="variable">wire</tt> to invoke each of
the functions in the <tt class="variable">call-specs</tt>. To make
sure the system sends the remote evaluation requests over the wire,
you must call <tt class="code">wire-force-output</tt>.<br>
<br>
Each of <tt class="variable">call-specs</tt> looks like a function
call textually, but it has some odd constraints and semantics. The
function position of the form must be the symbolic name of a
function. <tt class="code">remote</tt> evaluates each of the
argument subforms for each of the <tt class=
"variable">call-specs</tt> locally in the current context, sending
these values as the arguments for the functions.<br>
<br>
Consider the following example:
<pre>
(defun write-remote-string (str)
  (declare (simple-string str))
  (wire:remote wire
    (write-string str)))
</pre>
The value of <tt class="code">str</tt> in the local process is
passed over the wire with a request to invoke <tt class=
"code">write-string</tt> on the value. The system does not expect
to remotely evaluate <tt class="code">str</tt> for a value in the
remote process.</blockquote>
<br>
<a name="@funs228"></a><a name="FN:wire-force-output" id=
"FN:wire-force-output"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-force-output</tt> <tt class=
"variable">wire</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">wire-force-output</tt> flushes all internal
buffers associated with <tt class="variable">wire</tt>, sending the
remote requests. This is necessary after a call to <tt class=
"code">remote</tt>.</blockquote>
<br>
<a name="@funs229"></a><a name="FN:remote-value" id=
"FN:remote-value"></a>
<div align="left">[Macro]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote-value</tt> <tt class="variable">wire</tt>
<tt class="variable">call-spec</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The <tt class="code">remote-value</tt> macro is similar to the
<tt class="code">remote</tt> macro. <tt class=
"code">remote-value</tt> only takes one <tt class=
"variable">call-spec</tt>, and it returns the value returned by the
function call in the remote process. The value must be a valid type
the system can send over a wire, and there is no need to call
<tt class="code">wire-force-output</tt> in conjunction with this
interface.<br>
<br>
If client unwinds past the call to <tt class=
"code">remote-value</tt>, the server continues running, but the
system ignores the value the server sends back.<br>
<br>
If the server unwinds past the remotely requested call, instead of
returning normally, <tt class="code">remote-value</tt> returns two
values, <tt class="code">nil</tt> and <tt class="code">t</tt>.
Otherwise this returns the result of the remote evaluation and
<tt class="code">nil</tt>.</blockquote>
<br>
<a name="@funs230"></a><a name="FN:remote-value-bind" id=
"FN:remote-value-bind"></a>
<div align="left">[Macro]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote-value-bind</tt> <tt class=
"variable">wire</tt> (<tt class=
"code">{variable}</tt><sup><font size="2">*</font></sup>)
remote-form <tt class="code">{local-forms}</tt><sup><font size=
"2">*</font></sup> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">remote-value-bind</tt> is similar to <tt class=
"code">multiple-value-bind</tt> except the values bound come from
<tt class="variable">remote-form</tt>'s evaluation in the remote
process. The <tt class="variable">local-forms</tt> execute in an
implicit <tt class="code">progn</tt>.<br>
<br>
If the client unwinds past the call to <tt class=
"code">remote-value-bind</tt>, the server continues running, but
the system ignores the values the server sends back.<br>
<br>
If the server unwinds past the remotely requested call, instead of
returning normally, the <tt class="variable">local-forms</tt> never
execute, and <tt class="code">remote-value-bind</tt> returns
<tt class="code">nil</tt>.</blockquote>
<!--TOC subsection Remote Objects-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc268" id="htoc268"><b><font size=
"4">9.1.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Remote
Objects</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="remote-objs" id="remote-objs"></a><br>
The wire mechanism only directly supports a limited number of data
types for transmission as arguments for remote function calls and
as return values: integers inclusively less than 32 bits in length,
symbols, lists. Sometimes it is useful to allow remote processes to
refer to local data structures without allowing the remote process
to operate on the data. We have <tt class=
"variable">remote-objects</tt> to support this without the need to
represent the data structure in terms of the above data types, to
send the representation to the remote process, to decode the
representation, to later encode it again, and to send it back along
the wire.<br>
<br>
You can convert any Lisp object into a remote-object. When you send
a remote-object along a wire, the system simply sends a unique
token for it. In the remote process, the system looks up the token
and returns a remote-object for the token. When the remote process
needs to refer to the original Lisp object as an argument to a
remote call back or as a return value, it uses the remote-object it
has which the system converts to the unique token, sending that
along the wire to the originating process. Upon receipt in the
first process, the system converts the token back to the same
(<tt class="code">eq</tt>) remote-object.<br>
<br>
<br>
<a name="@funs231"></a><a name="FN:make-remote-object" id=
"FN:make-remote-object"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">make-remote-object</tt> <tt class=
"variable">object</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<br>
<tt class="code">make-remote-object</tt> returns a remote-object
that has <tt class="variable">object</tt> as its value. The
remote-object can be passed across wires just like the directly
supported wire data types.</blockquote>
<br>
<a name="@funs232"></a><a name="FN:remote-object-p" id=
"FN:remote-object-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote-object-p</tt> <tt class=
"variable">object</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The function <tt class="code">remote-object-p</tt> returns
<tt class="code">t</tt> if <tt class="variable">object</tt> is a
remote object and <tt class="code">nil</tt> otherwise.</blockquote>
<br>
<a name="@funs233"></a><a name="FN:remote-object-local-p" id=
"FN:remote-object-local-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote-object-local-p</tt> <tt class=
"variable">remote</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The function <tt class="code">remote-object-local-p</tt> returns
<tt class="code">t</tt> if <tt class="variable">remote</tt> refers
to an object in the local process. This is can only occur if the
local process created <tt class="variable">remote</tt> with
<tt class="code">make-remote-object</tt>.</blockquote>
<br>
<a name="@funs234"></a><a name="FN:remote-object-eq" id=
"FN:remote-object-eq"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote-object-eq</tt> <tt class=
"variable">obj1</tt> <tt class="variable">obj2</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The function <tt class="code">remote-object-eq</tt> returns
<tt class="code">t</tt> if <tt class="variable">obj1</tt> and
<tt class="variable">obj2</tt> refer to the same (<tt class=
"code">eq</tt>) lisp object, regardless of which process created
the remote-objects.</blockquote>
<br>
<a name="@funs235"></a><a name="FN:remote-object-value" id=
"FN:remote-object-value"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">remote-object-value</tt> <tt class=
"variable">remote</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the original object used to create the given
remote object. It is an error if some other process originally
created the remote-object.</blockquote>
<br>
<a name="@funs236"></a><a name="FN:forget-remote-translation" id=
"FN:forget-remote-translation"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">forget-remote-translation</tt> <tt class=
"variable">object</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function removes the information and storage necessary to
translate remote-objects back into <tt class=
"variable">object</tt>, so the next <tt class="code">gc</tt> can
reclaim the memory. You should use this when you no longer expect
to receive references to <tt class="variable">object</tt>. If some
remote process does send a reference to <tt class=
"variable">object</tt>, <tt class="code">remote-object-value</tt>
signals an error.</blockquote>
<!--TOC section The WIRE Package-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc269" id="htoc269"><b><font size=
"5">9.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">The WIRE
Package</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The <tt class="code">wire</tt> package provides for sending data
along wires. The <tt class="code">remote</tt> package sits on top
of this package. All data sent with a given output routine must be
read in the remote process with the complementary fetching routine.
For example, if you send so a string with <tt class=
"code">wire-output-string</tt>, the remote process must know to use
<tt class="code">wire-get-string</tt>. To avoid rigid data
transfers and complicated code, the interface supports sending
<tt class="variable">tagged</tt> data. With tagged data, the system
sends a tag announcing the type of the next data, and the remote
system takes care of fetching the appropriate type.<br>
<br>
When using interfaces at the wire level instead of the RPC level,
the remote process must read everything sent by these routines. If
the remote process leaves any input on the wire, it will later
mistake the data for an RPC request causing unknown lossage.<br>
<br>
<!--TOC subsection Untagged Data-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc270" id="htoc270"><b><font size=
"4">9.2.1</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Untagged
Data</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
When using these routines both ends of the wire know exactly what
types are coming and going and in what order. This data is
restricted to the following types:
<ul>
<li>8 bit unsigned bytes.<br>
<br></li>
<li>32 bit unsigned bytes.<br>
<br></li>
<li>32 bit integers.<br>
<br></li>
<li>simple-strings less than 65535 in length.</li>
</ul>
<br>
<a name="@funs237"></a><a name="FN:wire-output-byte" id=
"FN:wire-output-byte"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-output-byte</tt> <tt class=
"variable">wire</tt> <tt class="variable">byte</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs238"></a><a name="FN:wire-get-byte" id=
"FN:wire-get-byte"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-get-byte</tt> <tt class="variable">wire</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs239"></a><a name="FN:wire-output-number" id=
"FN:wire-output-number"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-output-number</tt> <tt class=
"variable">wire</tt> <tt class="variable">number</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs240"></a><a name="FN:wire-get-number" id=
"FN:wire-get-number"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-get-number</tt> <tt class="variable">wire</tt>
<tt class="code">&amp;optional</tt> <tt class=
"variable">signed</tt> &nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs241"></a><a name="FN:wire-output-string" id=
"FN:wire-output-string"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-output-string</tt> <tt class=
"variable">wire</tt> <tt class="variable">string</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
<a name="@funs242"></a><a name="FN:wire-get-string" id=
"FN:wire-get-string"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-get-string</tt> <tt class="variable">wire</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
These functions either output or input an object of the specified
data type. When you use any of these output routines to send data
across the wire, you must use the corresponding input routine
interpret the data.</blockquote>
<!--TOC subsection Tagged Data-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc271" id="htoc271"><b><font size=
"4">9.2.2</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Tagged
Data</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
When using these routines, the system automatically transmits and
interprets the tags for you, so both ends can figure out what kind
of data transfers occur. Sending tagged data allows a greater
variety of data types: integers inclusively less than 32 bits in
length, symbols, lists, and <tt class=
"variable">remote-objects</tt> (see section&nbsp;<a href=
"#remote-objs">9.1.3</a>). The system sends symbols as two strings,
the package name and the symbol name, and if the package doesn't
exist remotely, the remote process signals an error. The system
ignores other slots of symbols. Lists may be any tree of the above
valid data types. To send other data types you must represent them
in terms of these supported types. For example, you could use
<tt class="code">prin1-to-string</tt> locally, send the string, and
use <tt class="code">read-from-string</tt> remotely.<br>
<br>
<br>
<a name="@funs243"></a><a name="FN:wire-output-object" id=
"FN:wire-output-object"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-output-object</tt> <tt class=
"variable">wire</tt> <tt class="variable">object</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">cache-it</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
<a name="@funs244"></a><a name="FN:wire-get-object" id=
"FN:wire-get-object"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-get-object</tt> <tt class="variable">wire</tt>
&nbsp;&nbsp;&nbsp;</div>
<br>
The function <tt class="code">wire-output-object</tt> sends
<tt class="variable">object</tt> over <tt class=
"variable">wire</tt> preceded by a tag indicating its type.<br>
<br>
If <tt class="variable">cache-it</tt> is non-<tt class=
"code">nil</tt>, this function only sends <tt class=
"variable">object</tt> the first time it gets <tt class=
"variable">object</tt>. Each end of the wire associates a token
with <tt class="variable">object</tt>, similar to remote-objects,
allowing you to send the object more efficiently on successive
transmissions. <tt class="variable">cache-it</tt> defaults to
<tt class="code">t</tt> for symbols and <tt class="code">nil</tt>
for other types. Since the RPC level requires function names, a
high-level protocol based on a set of function calls saves time in
sending the functions' names repeatedly.<br>
<br>
The function <tt class="code">wire-get-object</tt> reads the
results of <tt class="code">wire-output-object</tt> and returns
that object.</blockquote>
<!--TOC subsection Making Your Own Wires-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc272" id="htoc272"><b><font size=
"4">9.2.3</font></b></a></td>
<td width="100%" align="center"><b><font size="4">Making Your Own
Wires</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
You can create wires manually in addition to the <tt class=
"code">remote</tt> package's interface creating them for you. To
create a wire, you need a Unix <em>file descriptor</em>. If you are
unfamiliar with Unix file descriptors, see section 2 of the Unix
manual pages.<br>
<br>
<br>
<a name="@funs245"></a><a name="FN:make-wire" id=
"FN:make-wire"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">make-wire</tt> <tt class="variable">descriptor</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
The function <tt class="code">make-wire</tt> creates a new wire
when supplied with the file descriptor to use for the underlying
I/O operations.</blockquote>
<br>
<a name="@funs246"></a><a name="FN:wire-p" id="FN:wire-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-p</tt> <tt class="variable">object</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="code">t</tt> if <tt class=
"variable">object</tt> is indeed a wire, <tt class="code">nil</tt>
otherwise.</blockquote>
<br>
<a name="@funs247"></a><a name="FN:wire-fd" id="FN:wire-fd"></a>
<div align="left">[Function]<br>
<tt class="function-name">wire:</tt><tt class=
"function-name">wire-fd</tt> <tt class="variable">wire</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the file descriptor used by the <tt class=
"variable">wire</tt>.</blockquote>
<!--TOC section Out-Of-Band Data-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc273" id="htoc273"><b><font size=
"5">9.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Out-Of-Band
Data</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The TCP/IP protocol allows users to send data asynchronously,
otherwise known as <tt class="variable">out-of-band</tt> data. When
using this feature, the operating system interrupts the receiving
process if this process has chosen to be notified about out-of-band
data. The receiver can grab this input without affecting any
information currently queued on the socket. Therefore, you can use
this without interfering with any current activity due to other
wire and remote interfaces.<br>
<br>
Unfortunately, most implementations of TCP/IP are broken, so use of
out-of-band data is limited for safety reasons. You can only
reliably send one character at a time.<br>
<br>
The Wire package is built on top of CMUCLs networking support. In
view of this, it is possible to use the routines described in
section <a href="#internet-oob">10.6</a> for handling and sending
out-of-band data. These all take a Unix file descriptor instead of
a wire, but you can fetch a wire's file descriptor with <tt class=
"code">wire-fd</tt>. <!--NAME ipc.html-->
 <!--TOC chapter Networking Support-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc274" id="htoc274"><b><font size=
"6">Chapter&nbsp;10</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Networking
Support</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="internet" id="internet"></a><br>
<div align="center"><b>by Mario S. Mommer</b></div>
<br>
This chapter documents the IPv4 networking and local sockets
support offered by CMUCL. It covers most of the basic sockets
interface functionality in a convenient and transparent way.<br>
<br>
For reasons of space it would be impossible to include a thorough
introduction to network programming, so we assume some basic
knowledge of the matter.<br>
<br>
<!--TOC section Byte Order Converters-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc275" id="htoc275"><b><font size=
"5">10.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Byte Order
Converters</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These are the functions that convert integers from host byte order
to network byte order (big-endian).<br>
<br>
<br>
<a name="@funs248"></a><a name="FN:htonl" id="FN:htonl"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">htonl</tt> <tt class="variable">integer</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Converts a 32 bit integer from host byte order to network byte
order.</blockquote>
<br>
<a name="@funs249"></a><a name="FN:htons" id="FN:htons"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">htons</tt> <tt class="variable">integer</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Converts a 16 bit integer from host byte order to network byte
order.</blockquote>
<br>
<a name="@funs250"></a><a name="FN:ntohs" id="FN:ntohs"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">ntohs</tt> <tt class="variable">integer</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Converts a 32 bit integer from network byte order to host byte
order.</blockquote>
<br>
<a name="@funs251"></a><a name="FN:ntohl" id="FN:ntohl"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">ntohl</tt> <tt class="variable">integer</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Converts a 32 bit integer from network byte order to host byte
order.</blockquote>
<!--TOC section Domain Name Services (DNS)-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc276" id="htoc276"><b><font size=
"5">10.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Domain Name
Services (DNS)</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The networking support of CMUCL includes the possibility of doing
DNS lookups. The function<br>
<br>
<br>
<a name="@funs252"></a><a name="FN:lookup-host-entry" id=
"FN:lookup-host-entry"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">lookup-host-entry</tt> <tt class=
"variable">host</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
returns a structure of type <tt class="variable">host-entry</tt>
(explained below) for the given <tt class="variable">host</tt>. If
<tt class="variable">host</tt> is an integer, it will be assumed to
be the IP address in host (byte-)order. If it is a string, it can
contain either the host name or the IP address in dotted
format.<br>
<br>
This function works by completing the structure <tt class=
"variable">host-entry</tt>. That is, if the user provides the IP
address, then the structure will contain that information and also
the domain names. If the user provides the domain name, the
structure will be complemented with the IP addresses along with the
any aliases the host might have.</blockquote>
<br>
<br>
<a name="@types46"></a>
<div align="left">[structure]<br>
<tt class="function-name">host-entry</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><tt class="variable">name</tt> <tt class=
"variable">aliases</tt> <tt class="variable">addr-type</tt>
<tt class="variable">addr-list</tt><br>
<br>
This structure holds all information available at request time on a
given host. The entries are self-explanatory. Aliases is a list of
strings containing alternative names of the host, and addr-list a
list of addresses stored in host byte order. The field <tt class=
"variable">addr-type</tt> contains the number of the address
family, as specified in <tt>socket.h</tt>, to which the addresses
belong. Since only addresses of the IPv4 family are currently
supported, this slot always has the value 2.</blockquote>
<br>
<a name="@funs253"></a><a name="FN:ip-string" id=
"FN:ip-string"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">ip-string</tt> <tt class="variable">addr</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function takes an IP address in host order and returns a
string containing it in dotted format.</blockquote>
<!--TOC section Binding to Interfaces-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc277" id="htoc277"><b><font size=
"5">10.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Binding to
Interfaces</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
In this section, functions for creating sockets bound to an
interface are documented.<br>
<br>
<br>
<a name="@funs254"></a><a name="FN:create-inet-listener" id=
"FN:create-inet-listener"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">create-inet-listener</tt> <tt class=
"variable">port</tt> <tt class="code">&amp;optional</tt> <tt class=
"variable">kind</tt> <tt class="code">&amp;key</tt> <tt class=
"code">:reuse-address</tt> <tt class="code">:backlog</tt>
<tt class="code">:host</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Creates a socket and binds it to a port, prepared to receive
connections of kind <tt class="variable">kind</tt> (which defaults
to <tt class="code">:stream</tt>), queuing up to <tt class=
"variable">backlog</tt> of them. If <tt class=
"code">:reuse-address</tt> <tt class="variable">T</tt> is used, the
option SO_REUSEADDR is used in the call to <tt class=
"variable">bind</tt>. If no value is given for <tt class=
"code">:host</tt>, it will try to bind to the default IP address of
the machine where the Lisp process is running.</blockquote>
<br>
<a name="@funs255"></a><a name="FN:create-unix-listener" id=
"FN:create-unix-listener"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">create-unix-listener</tt> <tt class=
"variable">path</tt> <tt class="code">&amp;optional</tt> <tt class=
"variable">kind</tt> <tt class="code">:reuse-address</tt>
<tt class="code">:backlog</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Creates a socket and binds it to the file name given by <tt class=
"variable">path</tt>, prepared to receive connections of kind
<tt class="variable">kind</tt> (which defaults to <tt class=
"code">:stream</tt>), queuing up to <tt class=
"variable">backlog</tt> of them. If <tt class=
"code">:reuse-address</tt> <tt class="variable">T</tt> is used,
then the file given by <tt class="variable">path</tt> is unlinked
first.</blockquote>
<!--TOC section Accepting Connections-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc278" id="htoc278"><b><font size=
"5">10.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Accepting
Connections</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Once a socket is bound to its interface, we have to explicitly
accept connections. This task is performed by the functions we
document here.<br>
<br>
<br>
<a name="@funs256"></a><a name="FN:accept-tcp-connection" id=
"FN:accept-tcp-connection"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">accept-tcp-connection</tt> <tt class=
"variable">unconnected</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Waits until a connection arrives on the (internet family) socket
<tt class="variable">unconnected</tt>. Returns the file descriptor
of the connection. These can be conveniently encapsulated using
file descriptor streams; see <a href=
"#sec:fds">6.7</a>.</blockquote>
<br>
<a name="@funs257"></a><a name="FN:accept-unix-connection" id=
"FN:accept-unix-connection"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">accept-unix-connection</tt> <tt class=
"variable">unconnected</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Waits until a connection arrives on the (unix family) socket
<tt class="variable">unconnected</tt>. Returns the file descriptor
of the connection. These can be conveniently encapsulated using
file descriptor streams; see <a href=
"#sec:fds">6.7</a>.</blockquote>
<!--TOC section Connecting-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc279" id="htoc279"><b><font size=
"5">10.5</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Connecting</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The task performed by the functions we present next is connecting
to remote hosts.<br>
<br>
<br>
<a name="@funs258"></a><a name="FN:connect-to-inet-socket" id=
"FN:connect-to-inet-socket"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">connect-to-inet-socket</tt> <tt class=
"variable">host</tt> <tt class="variable">port</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">kind</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Tries to open a connection to the remote host <tt class=
"variable">host</tt> (which may be an IP address in host order, or
a string with either a host name or an IP address in dotted format)
on port <tt class="variable">port</tt>. Returns the file descriptor
of the connection. The optional parameter <tt class=
"variable">kind</tt> can be either <tt class="code">:stream</tt>
(the default) or <tt class="code">:datagram</tt>.</blockquote>
<br>
<a name="@funs259"></a><a name="FN:connect-to-unix-socket" id=
"FN:connect-to-unix-socket"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">connect-to-unix-socket</tt> <tt class=
"variable">path</tt> <tt class="code">&amp;optional</tt> <tt class=
"variable">kind</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Opens a connection to the unix ``adress'' given by <tt class=
"variable">path</tt>. Returns the file descriptor of the
connection. The type of connection is given by <tt class=
"variable">kind</tt>, which can be either <tt class=
"code">:stream</tt> (the default) or <tt class=
"code">:datagram</tt>.</blockquote>
<!--TOC section Out-of-Band Data-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc280" id="htoc280"><b><font size=
"5">10.6</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Out-of-Band
Data</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="internet-oob" id="internet-oob"></a><br>
Out-of-band data is data transmitted with a higher priority than
ordinary data. This is usually used by either side of the
connection to signal exceptional conditions. Due to the fact that
most TCP/IP implementations are broken in this respect, only single
characters can reliably be sent this way.<br>
<br>
<br>
<a name="@funs260"></a><a name="FN:add-oob-handler" id=
"FN:add-oob-handler"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">add-oob-handler</tt> <tt class="variable">fd</tt>
<tt class="variable">char</tt> <tt class="variable">handler</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Sets the function passed in <tt class="variable">handler</tt> as a
handler for the character <tt class="variable">char</tt> on the
connection whose descriptor is <tt class="variable">fd</tt>. In
case this character arrives, the function in <tt class=
"variable">handler</tt> is called without any
argument.</blockquote>
<br>
<a name="@funs261"></a><a name="FN:remove-oob-handler" id=
"FN:remove-oob-handler"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">remove-oob-handler</tt> <tt class=
"variable">fd</tt> <tt class="variable">char</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Removes the handler for the character <tt class=
"variable">char</tt> from the connection with the file descriptor
<tt class="variable">fd</tt></blockquote>
<br>
<a name="@funs262"></a><a name="FN:remove-all-oob-handlers" id=
"FN:remove-all-oob-handlers"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">remove-all-oob-handlers</tt> <tt class=
"variable">fd</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
After calling this function, the connection whose descriptor is
<tt class="variable">fd</tt> will ignore any out-of-band character
it receives.</blockquote>
<br>
<a name="@funs263"></a><a name="FN:send-character-out-of-band" id=
"FN:send-character-out-of-band"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">send-character-out-of-band</tt> <tt class=
"variable">fd</tt> <tt class="variable">char</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Sends the character <tt class="variable">char</tt> through the
connection <tt class="variable">fd</tt> out of band.</blockquote>
<!--TOC section Unbound Sockets, Socket Options, and Closing Sockets-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc281" id="htoc281"><b><font size=
"5">10.7</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Unbound Sockets,
Socket Options, and Closing Sockets</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These functions create unbound sockets. This is usually not
necessary, since connectors and listeners create their own.<br>
<br>
<br>
<a name="@funs264"></a><a name="FN:create-unix-socket" id=
"FN:create-unix-socket"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">create-unix-socket</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">type</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Creates a unix socket for the unix address family, of type
<tt class="variable">:stream</tt> and (on success) returns its file
descriptor.</blockquote>
<br>
<a name="@funs265"></a><a name="FN:create-inet-socket" id=
"FN:create-inet-socket"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">create-inet-socket</tt> <tt class=
"code">&amp;optional</tt> <tt class="variable">type</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Creates a unix socket for the internet address family, of type
<tt class="variable">:stream</tt> and (on success) returns its file
descriptor.</blockquote>
Further, it is desirable to be able to change socket options. This
is performed by the following two functions, which are essentially
wrappers for system calls to <tt>getsockopt</tt> and
<tt>setsockopt</tt>.<br>
<br>
<br>
<a name="@funs266"></a><a name="FN:get-socket-option" id=
"FN:get-socket-option"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">get-socket-option</tt> <tt class=
"variable">socket</tt> <tt class="variable">level</tt> <tt class=
"variable">optname</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Gets the value of option <tt class="variable">optname</tt> from the
socket <tt class="variable">socket</tt>.</blockquote>
<br>
<a name="@funs267"></a><a name="FN:set-socket-option" id=
"FN:set-socket-option"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">set-socket-option</tt> <tt class=
"variable">socket</tt> <tt class="variable">level</tt> <tt class=
"variable">optname</tt> <tt class="variable">optval</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Sets the value of option <tt class="variable">optname</tt> from the
socket <tt class="variable">socket</tt> to the value <tt class=
"variable">optval</tt>.</blockquote>
For information on possible options and values we refer to the
manpages of <tt>getsockopt</tt> and <tt>setsockopt</tt>, and to
<tt>socket.h</tt><br>
<br>
Finally, the function<br>
<br>
<br>
<a name="@funs268"></a><a name="FN:close-socket" id=
"FN:close-socket"></a>
<div align="left">[Function]<br>
<tt class="function-name">extensions:</tt><tt class=
"function-name">close-socket</tt> <tt class="variable">socket</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
Closes the socket given by the file descriptor <tt class=
"variable">socket</tt>.</blockquote>
<!--TOC section Unix Datagrams-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc282" id="htoc282"><b><font size=
"5">10.8</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Unix
Datagrams</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Datagram network is supported with the following functions.<br>
<br>
<br>
<a name="@funs269"></a><a name="FN:inet-recvfrom" id=
"FN:inet-recvfrom"></a>
<div align="left">[Function]<br>
<tt class="function-name">unix:</tt><tt class=
"function-name">inet-recvfrom</tt> <tt class="variable">fd</tt>
<tt class="variable">buffer</tt> <tt class="variable">size</tt>
<tt class="code">&amp;key</tt> <tt class="variable">flags</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>A simple interface to the Unix <tt class=
"code">recvfrom</tt> function.</blockquote>
<br>
<a name="@funs270"></a><a name="FN:inet-sendto" id=
"FN:inet-sendto"></a>
<div align="left">[Function]<br>
<tt class="function-name">unix:</tt><tt class=
"function-name">inet-sendto</tt> <tt class="variable">fd</tt>
<tt class="variable">buffer</tt> <tt class="variable">size</tt>
<tt class="variable">port</tt> <tt class="code">&amp;key</tt>
<tt class="variable">flags</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>A simple interface to the Unix <tt class=
"code">sendto</tt> function.</blockquote>
<br>
<a name="@funs271"></a><a name="FN:inet-shutdown" id=
"FN:inet-shutdown"></a>
<div align="left">[Function]<br>
<tt class="function-name">unix:</tt><tt class=
"function-name">inet-shutdown</tt> <tt class="variable">fd</tt>
<tt class="variable">level</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
A simple interface to the Unix <tt class="code">shutdown</tt>
function. For <tt class="code">level</tt>, you may use the
following symbols to close one or both ends of a socket: <tt class=
"code">shut-rd</tt>, <tt class="code">shut-wr</tt>, <tt class=
"code">shut-rdwr</tt>.</blockquote>
<!--TOC section Errors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc283" id="htoc283"><b><font size=
"5">10.9</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Errors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Errors that occur during socket operations signal a <tt class=
"code">socket-error</tt> condition, a subtype of the <tt class=
"code">error</tt> condition. Currently this condition includes just
the Unix <tt class="code">errno</tt> associated with the error. 
<!--NAME internet.html-->
 <!--TOC chapter Debugger Programmer's Interface-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc284" id="htoc284"><b><font size=
"6">Chapter&nbsp;11</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Debugger
Programmer's Interface</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="debug-internals" id="debug-internals"></a><br>
The debugger programmers interface is exported from from the
<tt class="code">DEBUG-INTERNALS</tt> or <tt class="code">DI</tt>
package. This is a CMU extension that allows debugging tools to be
written without detailed knowledge of the compiler or run-time
system.<br>
<br>
Some of the interface routines take a code-location as an argument.
As described in the section on code-locations, some code-locations
are unknown. When a function calls for a <tt class=
"variable">basic-code-location</tt>, it takes either type, but when
it specifically names the argument <tt class=
"variable">code-location</tt>, the routine will signal an error if
you give it an unknown code-location.<br>
<br>
<!--TOC section DI Exceptional Conditions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc285" id="htoc285"><b><font size=
"5">11.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">DI Exceptional
Conditions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Some of these operations fail depending on the availability
debugging information. In the most severe case, when someone saved
a Lisp image stripping all debugging data structures, no operations
are valid. In this case, even backtracing and finding frames is
impossible. Some interfaces can simply return values indicating the
lack of information, or their return values are naturally
meaningful in light missing data. Other routines, as documented
below, will signal <tt class="code">serious-condition</tt>s when
they discover awkward situations. This interface does not provide
for programs to detect these situations other than by calling a
routine that detects them and signals a condition. These are
serious-conditions because the program using the interface must
handle them before it can correctly continue execution. These
debugging conditions are not errors since it is no fault of the
programmers that the conditions occur.<br>
<br>
<!--TOC subsection Debug-conditions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc286" id="htoc286"><b><font size=
"4">11.1.1</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Debug-conditions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
The debug internals interface signals conditions when it can't
adhere to its contract. These are serious-conditions because the
program using the interface must handle them before it can
correctly continue execution. These debugging conditions are not
errors since it is no fault of the programmers that the conditions
occur. The interface does not provide for programs to detect these
situations other than calling a routine that detects them and
signals a condition.<br>
<br>
<br>
<br>
<a name="@types47"></a>
<div align="left">[Condition]<br>
<tt class="function-name">debug-condition</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This condition inherits from serious-condition, and all
debug-conditions inherit from this. These must be handled, but they
are not programmer errors.</blockquote>
<br>
<br>
<a name="@types48"></a>
<div align="left">[Condition]<br>
<tt class="function-name">no-debug-info</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This condition indicates there is absolutely no debugging
information available.</blockquote>
<br>
<br>
<a name="@types49"></a>
<div align="left">[Condition]<br>
<tt class="function-name">no-debug-function-returns</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This condition indicates the system cannot return values from a
frame since its debug-function lacks debug information details
about returning values.</blockquote>
<br>
<br>
<a name="@types50"></a>
<div align="left">[Condition]<br>
<tt class="function-name">no-debug-blocks</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This condition indicates that a function was not
compiled with debug-block information, but this information is
necessary necessary for some requested operation.</blockquote>
<br>
<br>
<a name="@types51"></a>
<div align="left">[Condition]<br>
<tt class="function-name">no-debug-variables</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Similar to <tt class="code">no-debug-blocks</tt>,
except that variable information was requested.</blockquote>
<br>
<br>
<a name="@types52"></a>
<div align="left">[Condition]<br>
<tt class="function-name">lambda-list-unavailable</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Similar to <tt class="code">no-debug-blocks</tt>,
except that lambda list information was requested.</blockquote>
<br>
<br>
<a name="@types53"></a>
<div align="left">[Condition]<br>
<tt class="function-name">invalid-value</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This condition indicates a debug-variable has <tt class=
"code">:invalid</tt> or <tt class="code">:unknown</tt> value in a
particular frame.</blockquote>
<br>
<br>
<a name="@types54"></a>
<div align="left">[Condition]<br>
<tt class="function-name">ambiguous-variable-name</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This condition indicates a user supplied debug-variable name
identifies more than one valid variable in a particular
frame.</blockquote>
<!--TOC subsection Debug-errors-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFE2">
<div align="center">
<table>
<tr>
<td><a name="htoc287" id="htoc287"><b><font size=
"4">11.1.2</font></b></a></td>
<td width="100%" align="center"><b><font size=
"4">Debug-errors</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These are programmer errors resulting from misuse of the debugging
tools' programmers' interface. You could have avoided an occurrence
of one of these by using some routine to check the use of the
routine generating the error.<br>
<br>
<br>
<br>
<a name="@types55"></a>
<div align="left">[Condition]<br>
<tt class="function-name">debug-error</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>This condition inherits from error, and all user
programming errors inherit from this condition.</blockquote>
<br>
<br>
<a name="@types56"></a>
<div align="left">[Condition]<br>
<tt class="function-name">unhandled-condition</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This error results from a signalled <tt class=
"code">debug-condition</tt> occurring without anyone handling
it.</blockquote>
<br>
<br>
<a name="@types57"></a>
<div align="left">[Condition]<br>
<tt class="function-name">unknown-code-location</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>This error indicates the invalid use of an
unknown-code-location.</blockquote>
<br>
<br>
<a name="@types58"></a>
<div align="left">[Condition]<br>
<tt class="function-name">unknown-debug-variable</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This error indicates an attempt to use a debug-variable in
conjunction with an inappropriate debug-function; for example,
checking the variable's validity using a code-location in the wrong
debug-function will signal this error.</blockquote>
<br>
<br>
<a name="@types59"></a>
<div align="left">[Condition]<br>
<tt class="function-name">frame-function-mismatch</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This error indicates you called a function returned by <tt class=
"code">preprocess-for-eval</tt> on a frame other than the one for
which the function had been prepared.</blockquote>
<!--TOC section Debug-variables-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc288" id="htoc288"><b><font size=
"5">11.2</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Debug-variables</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Debug-variables represent the constant information about where the
system stores argument and local variable values. The system
uniquely identifies with an integer every instance of a variable
with a particular name and package. To access a value, you must
supply the frame along with the debug-variable since these are
particular to a function, not every instance of a variable on the
stack.<br>
<br>
<br>
<a name="@funs272"></a><a name="FN:debug-variable-name" id=
"FN:debug-variable-name"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-name</tt> <tt class=
"variable">debug-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the name of the <tt class=
"variable">debug-variable</tt>. The name is the name of the symbol
used as an identifier when writing the code.</blockquote>
<br>
<a name="@funs273"></a><a name="FN:debug-variable-package" id=
"FN:debug-variable-package"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-package</tt> <tt class=
"variable">debug-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the package name of the <tt class=
"variable">debug-variable</tt>. This is the package name of the
symbol used as an identifier when writing the code.</blockquote>
<br>
<a name="@funs274"></a><a name="FN:debug-variable-symbol" id=
"FN:debug-variable-symbol"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-symbol</tt> <tt class=
"variable">debug-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the symbol from interning <tt class=
"code">debug-variable-name</tt> in the package named by <tt class=
"code">debug-variable-package</tt>.</blockquote>
<br>
<a name="@funs275"></a><a name="FN:debug-variable-id" id=
"FN:debug-variable-id"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-id</tt> <tt class=
"variable">debug-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the integer that makes <tt class=
"variable">debug-variable</tt>'s name and package name unique with
respect to other <tt class="variable">debug-variable</tt>'s in the
same function.</blockquote>
<br>
<a name="@funs276"></a><a name="FN:debug-variable-validity" id=
"FN:debug-variable-validity"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-validity</tt> <tt class=
"variable">debug-variable</tt> <tt class=
"variable">basic-code-location</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns three values reflecting the validity of
<tt class="variable">debug-variable</tt>'s value at <tt class=
"variable">basic-code-location</tt>:
<dl compact="compact">
<dt><tt class="code">:valid</tt><br></dt>
<dd>The value is known to be available.</dd>
<dt><tt class="code">:invalid</tt><br></dt>
<dd>The value is known to be unavailable.</dd>
<dt><tt class="code">:unknown</tt><br></dt>
<dd>The value's availability is unknown.</dd>
</dl>
</blockquote>
<br>
<a name="@funs277"></a><a name="FN:debug-variable-value" id=
"FN:debug-variable-value"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-value</tt> <tt class=
"variable">debug-variable</tt> <tt class="variable">frame</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the value stored for <tt class=
"variable">debug-variable</tt> in <tt class="variable">frame</tt>.
The value may be invalid. This is <tt class=
"code">SETF</tt>'able.</blockquote>
<br>
<a name="@funs278"></a><a name="FN:debug-variable-valid-value" id=
"FN:debug-variable-valid-value"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-valid-value</tt>
<tt class="variable">debug-variable</tt> <tt class=
"variable">frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the value stored for <tt class=
"variable">debug-variable</tt> in <tt class="variable">frame</tt>.
If the value is not <tt class="code">:valid</tt>, then this signals
an <tt class="code">invalid-value</tt> error.</blockquote>
<!--TOC section Frames-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc289" id="htoc289"><b><font size=
"5">11.3</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Frames</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Frames describe a particular call on the stack for a particular
thread. This is the environment for name resolution, getting
arguments and locals, and returning values. The stack conceptually
grows up, so the top of the stack is the most recently called
function.<br>
<br>
<tt class="code">top-frame</tt>, <tt class="code">frame-down</tt>,
<tt class="code">frame-up</tt>, and <tt class=
"code">frame-debug-function</tt> can only fail when there is
absolutely no debug information available. This can only happen
when someone saved a Lisp image specifying that the system dump all
debugging data.<br>
<br>
<br>
<a name="@funs279"></a><a name="FN:top-frame" id=
"FN:top-frame"></a>
<div align="left">[Function]<br>
<tt class="function-name">top-frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function never returns the frame for itself, always the frame
before calling <tt class="code">top-frame</tt>.</blockquote>
<br>
<a name="@funs280"></a><a name="FN:frame-down" id=
"FN:frame-down"></a>
<div align="left">[Function]<br>
<tt class="function-name">frame-down</tt> <tt class=
"variable">frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This returns the frame immediately below <tt class=
"variable">frame</tt> on the stack. When <tt class=
"variable">frame</tt> is the bottom of the stack, this returns
<tt class="code">nil</tt>.</blockquote>
<br>
<a name="@funs281"></a><a name="FN:frame-up" id="FN:frame-up"></a>
<div align="left">[Function]<br>
<tt class="function-name">frame-up</tt> <tt class=
"variable">frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This returns the frame immediately above <tt class=
"variable">frame</tt> on the stack. When <tt class=
"variable">frame</tt> is the top of the stack, this returns
<tt class="code">nil</tt>.</blockquote>
<br>
<a name="@funs282"></a><a name="FN:frame-debug-function" id=
"FN:frame-debug-function"></a>
<div align="left">[Function]<br>
<tt class="function-name">frame-debug-function</tt> <tt class=
"variable">frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the debug-function for the function whose
call <tt class="variable">frame</tt> represents.</blockquote>
<br>
<a name="@funs283"></a><a name="FN:frame-code-location" id=
"FN:frame-code-location"></a>
<div align="left">[Function]<br>
<tt class="function-name">frame-code-location</tt> <tt class=
"variable">frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the code-location where <tt class=
"variable">frame</tt>'s debug-function will continue running when
program execution returns to <tt class="variable">frame</tt>. If
someone interrupted this frame, the result could be an unknown
code-location.</blockquote>
<br>
<a name="@funs284"></a><a name="FN:frame-catches" id=
"FN:frame-catches"></a>
<div align="left">[Function]<br>
<tt class="function-name">frame-catches</tt> <tt class=
"variable">frame</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns an a-list for all active catches in
<tt class="variable">frame</tt> mapping catch tags to the
code-locations at which the catch re-enters.</blockquote>
<br>
<a name="@funs285"></a><a name="FN:eval-in-frame" id=
"FN:eval-in-frame"></a>
<div align="left">[Function]<br>
<tt class="function-name">eval-in-frame</tt> <tt class=
"variable">frame</tt> <tt class="variable">form</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This evaluates <tt class="variable">form</tt> in <tt class=
"variable">frame</tt>'s environment. This can signal several
different debug-conditions since its success relies on a variety of
inexact debug information: <tt class="code">invalid-value</tt>,
<tt class="code">ambiguous-variable-name</tt>, <tt class=
"code">frame-function-mismatch</tt>. See also <a name=
"@funs286"></a><tt class=
"code">preprocess-for-eval</tt>.</blockquote>
<!--TOC section Debug-functions-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc290" id="htoc290"><b><font size=
"5">11.4</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Debug-functions</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Debug-functions represent the static information about a function
determined at compile time---argument and variable storage, their
lifetime information, etc. The debug-function also contains all the
debug-blocks representing basic-blocks of code, and these contains
information about specific code-locations in a debug-function.<br>
<br>
<br>
<a name="@funs287"></a><a name="FN:do-debug-function-blocks" id=
"FN:do-debug-function-blocks"></a>
<div align="left">[Macro]<br>
<tt class="function-name">do-debug-function-blocks</tt> (<tt class=
"variable">block-var</tt> <tt class="variable">debug-function</tt>
<tt class="code">{result-form}</tt>) <tt class=
"code">{form}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This executes the forms in a context with <tt class=
"variable">block-var</tt> bound to each debug-block in <tt class=
"variable">debug-function</tt> successively. <tt class=
"variable">Result-form</tt> is an optional form to execute for a
return value, and <tt class="code">do-debug-function-blocks</tt>
returns <tt class="code">nil</tt>if there is no <tt class=
"variable">result-form</tt>. This signals a <tt class=
"code">no-debug-blocks</tt> condition when the <tt class=
"variable">debug-function</tt> lacks debug-block
information.</blockquote>
<br>
<a name="@funs288"></a><a name="FN:debug-function-lambda-list" id=
"FN:debug-function-lambda-list"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-function-lambda-list</tt>
<tt class="variable">debug-function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a list representing the lambda-list for
<tt class="variable">debug-function</tt>. The list has the
following structure:
<blockquote class="example">
<pre>
    (required-var1 required-var2
    ...
    (:optional var3 suppliedp-var4)
    (:optional var5)
    ...
    (:rest var6) (:rest var7)
    ...
    (:keyword keyword-symbol var8 suppliedp-var9)
    (:keyword keyword-symbol var10)
    ...
    )
  
</pre></blockquote>
Each <tt class="code">var</tt><tt class="variable">n</tt> is a
debug-variable; however, the symbol <tt class="code">:deleted</tt>
appears instead whenever the argument remains unreferenced
throughout <tt class="variable">debug-function</tt>.<br>
<br>
If there is no lambda-list information, this signals a <tt class=
"code">lambda-list-unavailable</tt> condition.</blockquote>
<br>
<a name="@funs289"></a><a name="FN:do-debug-function-variables" id=
"FN:do-debug-function-variables"></a>
<div align="left">[Macro]<br>
<tt class="function-name">do-debug-function-variables</tt>
(<tt class="variable">var</tt> <tt class=
"variable">debug-function</tt> <tt class="code">{result}</tt>)
<tt class="code">{form}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro executes each <tt class="variable">form</tt> in a
context with <tt class="variable">var</tt> bound to each
debug-variable in <tt class="variable">debug-function</tt>. This
returns the value of executing <tt class="variable">result</tt>
(defaults to <tt class="code">nil</tt>). This may iterate over only
some of <tt class="variable">debug-function</tt>'s variables or
none depending on debug policy; for example, possibly the
compilation only preserved argument information.</blockquote>
<br>
<a name="@funs290"></a><a name="FN:debug-variable-info-available"
id="FN:debug-variable-info-available"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-variable-info-available</tt>
<tt class="variable">debug-function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns whether there is any variable information for
<tt class="variable">debug-function</tt>. This is useful for
distinguishing whether there were no locals in a function or
whether there was no variable information. For example, if
<tt class="code">do-debug-function-variables</tt> executes its
forms zero times, then you can use this function to determine the
reason.</blockquote>
<br>
<a name="@funs291"></a><a name="FN:debug-function-symbol-variables"
id="FN:debug-function-symbol-variables"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-function-symbol-variables</tt>
<tt class="variable">debug-function</tt> <tt class=
"variable">symbol</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a list of debug-variables in <tt class=
"variable">debug-function</tt> having the same name and package as
<tt class="variable">symbol</tt>. If <tt class=
"variable">symbol</tt> is uninterned, then this returns a list of
debug-variables without package names and with the same name as
<tt class="variable">symbol</tt>. The result of this function is
limited to the availability of variable information in <tt class=
"variable">debug-function</tt>; for example, possibly <tt class=
"variable">debug-function</tt> only knows about its
arguments.</blockquote>
<br>
<a name="@funs292"></a><a name="FN:ambiguous-debug-variables" id=
"FN:ambiguous-debug-variables"></a>
<div align="left">[Function]<br>
<tt class="function-name">ambiguous-debug-variables</tt> <tt class=
"variable">debug-function</tt> <tt class=
"variable">name-prefix-string</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a list of debug-variables in <tt class=
"variable">debug-function</tt> whose names contain <tt class=
"variable">name-prefix-string</tt> as an initial substring. The
result of this function is limited to the availability of variable
information in <tt class="variable">debug-function</tt>; for
example, possibly <tt class="variable">debug-function</tt> only
knows about its arguments.</blockquote>
<br>
<a name="@funs293"></a><a name="FN:preprocess-for-eval" id=
"FN:preprocess-for-eval"></a>
<div align="left">[Function]<br>
<tt class="function-name">preprocess-for-eval</tt> <tt class=
"variable">form</tt> <tt class="variable">basic-code-location</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a function of one argument that evaluates
<tt class="variable">form</tt> in the lexical context of <tt class=
"variable">basic-code-location</tt>. This allows efficient repeated
evaluation of <tt class="variable">form</tt> at a certain place in
a function which could be useful for conditional breaking. This
signals a <tt class="code">no-debug-variables</tt> condition when
the code-location's debug-function has no debug-variable
information available. The returned function takes a frame as an
argument. See also <a name="@funs294"></a><tt class=
"code">eval-in-frame</tt>.</blockquote>
<br>
<a name="@funs295"></a><a name="FN:function-debug-function" id=
"FN:function-debug-function"></a>
<div align="left">[Function]<br>
<tt class="function-name">function-debug-function</tt> <tt class=
"variable">function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a debug-function that represents debug
information for <tt class="variable">function</tt>.</blockquote>
<br>
<a name="@funs296"></a><a name="FN:debug-function-kind" id=
"FN:debug-function-kind"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-function-kind</tt> <tt class=
"variable">debug-function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the kind of function <tt class=
"variable">debug-function</tt> represents. The value is one of the
following:
<dl compact="compact">
<dt><tt class="code">:optional</tt><br></dt>
<dd>This kind of function is an entry point to an ordinary
function. It handles optional defaulting, parsing keywords,
etc.</dd>
<dt><tt class="code">:external</tt><br></dt>
<dd>This kind of function is an entry point to an ordinary
function. It checks argument values and count and calls the defined
function.</dd>
<dt><tt class="code">:top-level</tt><br></dt>
<dd>This kind of function executes one or more random top-level
forms from a file.</dd>
<dt><tt class="code">:cleanup</tt><br></dt>
<dd>This kind of function represents the cleanup forms in an
<tt class="code">unwind-protect</tt>.</dd>
<dt><tt class="code">nil</tt><br></dt>
<dd>This kind of function is not one of the above; that is, it is
not specially marked in any way.</dd>
</dl>
</blockquote>
<br>
<a name="@funs297"></a><a name="FN:debug-function-function" id=
"FN:debug-function-function"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-function-function</tt> <tt class=
"variable">debug-function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the Common Lisp function associated with the
<tt class="variable">debug-function</tt>. This returns <tt class=
"code">nil</tt> if the function is unavailable or is non-existent
as a user callable function object.</blockquote>
<br>
<a name="@funs298"></a><a name="FN:debug-function-name" id=
"FN:debug-function-name"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-function-name</tt> <tt class=
"variable">debug-function</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the name of the function represented by
<tt class="variable">debug-function</tt>. This may be a string or a
cons; do not assume it is a symbol.</blockquote>
<!--TOC section Debug-blocks-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc291" id="htoc291"><b><font size=
"5">11.5</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Debug-blocks</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Debug-blocks contain information pertinent to a specific range of
code in a debug-function.<br>
<br>
<br>
<a name="@funs299"></a><a name="FN:do-debug-block-locations" id=
"FN:do-debug-block-locations"></a>
<div align="left">[Macro]<br>
<tt class="function-name">do-debug-block-locations</tt> (<tt class=
"variable">code-var</tt> <tt class="variable">debug-block</tt>
<tt class="code">{result}</tt>) <tt class=
"code">{form}</tt><sup><font size="2">*</font></sup>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This macro executes each <tt class="variable">form</tt> in a
context with <tt class="variable">code-var</tt> bound to each
code-location in <tt class="variable">debug-block</tt>. This
returns the value of executing <tt class="variable">result</tt>
(defaults to <tt class="code">nil</tt>).</blockquote>
<br>
<a name="@funs300"></a><a name="FN:debug-block-successors" id=
"FN:debug-block-successors"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-block-successors</tt> <tt class=
"variable">debug-block</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the list of possible code-locations where
execution may continue when the basic-block represented by
<tt class="variable">debug-block</tt> completes its
execution.</blockquote>
<br>
<a name="@funs301"></a><a name="FN:debug-block-elsewhere-p" id=
"FN:debug-block-elsewhere-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-block-elsewhere-p</tt> <tt class=
"variable">debug-block</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns whether <tt class="variable">debug-block</tt>
represents elsewhere code. This is code the compiler has moved out
of a function's code sequence for optimization reasons.
Code-locations in these blocks are unsuitable for stepping tools,
and the first code-location has nothing to do with a normal
starting location for the block.</blockquote>
<!--TOC section Breakpoints-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc292" id="htoc292"><b><font size=
"5">11.6</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Breakpoints</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
A breakpoint represents a function the system calls with the
current frame when execution passes a certain code-location. A
break point is active or inactive independent of its existence.
They also have an extra slot for users to tag the breakpoint with
information.<br>
<br>
<br>
<a name="@funs302"></a><a name="FN:make-breakpoint" id=
"FN:make-breakpoint"></a>
<div align="left">[Function]<br>
<tt class="function-name">make-breakpoint</tt> <tt class=
"variable">hook-function</tt> <tt class="variable">what</tt>
<tt class="code">&amp;key</tt> <tt class="code">:kind</tt>
<tt class="code">:info</tt> <tt class=
"code">:function-end-cookie</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function creates and returns a breakpoint. When program
execution encounters the breakpoint, the system calls <tt class=
"variable">hook-function</tt>. <tt class=
"variable">hook-function</tt> takes the current frame for the
function in which the program is running and the breakpoint
object.<br>
<br>
<tt class="variable">what</tt> and <tt class="variable">kind</tt>
determine where in a function the system invokes <tt class=
"variable">hook-function</tt>. <tt class="variable">what</tt> is
either a code-location or a debug-function. <tt class=
"variable">kind</tt> is one of <tt class=
"code">:code-location</tt>, <tt class="code">:function-start</tt>,
or <tt class="code">:function-end</tt>. Since the starts and ends
of functions may not have code-locations representing them,
designate these places by supplying <tt class="variable">what</tt>
as a debug-function and <tt class="variable">kind</tt> indicating
the <tt class="code">:function-start</tt> or <tt class=
"code">:function-end</tt>. When <tt class="variable">what</tt> is a
debug-function and <tt class="variable">kind</tt> is <tt class=
"code">:function-end</tt>, then hook-function must take two
additional arguments, a list of values returned by the function and
a function-end-cookie.<br>
<br>
<tt class="variable">info</tt> is information supplied by and used
by the user.<br>
<br>
<tt class="variable">function-end-cookie</tt> is a function. To
implement function-end breakpoints, the system uses starter
breakpoints to establish the function-end breakpoint for each
invocation of the function. Upon each entry, the system creates a
unique cookie to identify the invocation, and when the user
supplies a function for this argument, the system invokes it on the
cookie. The system later invokes the function-end breakpoint hook
on the same cookie. The user may save the cookie when passed to the
function-end-cookie function for later comparison in the hook
function.<br>
<br>
This signals an error if <tt class="variable">what</tt> is an
unknown code-location.<br>
<br>
<em>Note: Breakpoints in interpreted code or byte-compiled code are
not implemented. Function-end breakpoints are not implemented for
compiled functions that use the known local return convention (e.g.
for block-compiled or self-recursive functions.)</em></blockquote>
<br>
<a name="@funs303"></a><a name="FN:activate-breakpoint" id=
"FN:activate-breakpoint"></a>
<div align="left">[Function]<br>
<tt class="function-name">activate-breakpoint</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function causes the system to invoke the <tt class=
"variable">breakpoint</tt>'s hook-function until the next call to
<tt class="code">deactivate-breakpoint</tt> or <tt class=
"code">delete-breakpoint</tt>. The system invokes breakpoint hook
functions in the opposite order that you activate
them.</blockquote>
<br>
<a name="@funs304"></a><a name="FN:deactivate-breakpoint" id=
"FN:deactivate-breakpoint"></a>
<div align="left">[Function]<br>
<tt class="function-name">deactivate-breakpoint</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function stops the system from invoking the <tt class=
"variable">breakpoint</tt>'s hook-function.</blockquote>
<br>
<a name="@funs305"></a><a name="FN:breakpoint-active-p" id=
"FN:breakpoint-active-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">breakpoint-active-p</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This returns whether <tt class="variable">breakpoint</tt> is
currently active.</blockquote>
<br>
<a name="@funs306"></a><a name="FN:breakpoint-hook-function" id=
"FN:breakpoint-hook-function"></a>
<div align="left">[Function]<br>
<tt class="function-name">breakpoint-hook-function</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the <tt class="variable">breakpoint</tt>'s
function the system calls when execution encounters <tt class=
"variable">breakpoint</tt>, and it is active. This is <tt class=
"code">SETF</tt>'able.</blockquote>
<br>
<a name="@funs307"></a><a name="FN:breakpoint-info" id=
"FN:breakpoint-info"></a>
<div align="left">[Function]<br>
<tt class="function-name">breakpoint-info</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="variable">breakpoint</tt>'s
information supplied by the user. This is <tt class=
"code">SETF</tt>'able.</blockquote>
<br>
<a name="@funs308"></a><a name="FN:breakpoint-kind" id=
"FN:breakpoint-kind"></a>
<div align="left">[Function]<br>
<tt class="function-name">breakpoint-kind</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the <tt class="variable">breakpoint</tt>'s
kind specification.</blockquote>
<br>
<a name="@funs309"></a><a name="FN:breakpoint-what" id=
"FN:breakpoint-what"></a>
<div align="left">[Function]<br>
<tt class="function-name">breakpoint-what</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the <tt class="variable">breakpoint</tt>'s
what specification.</blockquote>
<br>
<a name="@funs310"></a><a name="FN:delete-breakpoint" id=
"FN:delete-breakpoint"></a>
<div align="left">[Function]<br>
<tt class="function-name">delete-breakpoint</tt> <tt class=
"variable">breakpoint</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function frees system storage and removes computational
overhead associated with <tt class="variable">breakpoint</tt>.
After calling this, <tt class="variable">breakpoint</tt> is useless
and can never become active again.</blockquote>
<!--TOC section Code-locations-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc293" id="htoc293"><b><font size=
"5">11.7</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Code-locations</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Code-locations represent places in functions where the system has
correct information about the function's environment and where
interesting operations can occur---asking for a local variable's
value, setting breakpoints, evaluating forms within the function's
environment, etc.<br>
<br>
Sometimes the interface returns unknown code-locations. These
represent places in functions, but there is no debug information
associated with them. Some operations accept these since they may
succeed even with missing debug data. These operations' argument is
named <tt class="variable">basic-code-location</tt> indicating they
take known and unknown code-locations. If an operation names its
argument <tt class="variable">code-location</tt>, and you supply an
unknown one, it will signal an error. For example, <tt class=
"code">frame-code-location</tt> may return an unknown code-location
if someone interrupted Lisp in the given frame. The system knows
where execution will continue, but this place in the code may not
be a place for which the compiler dumped debug information.<br>
<br>
<br>
<a name="@funs311"></a><a name="FN:code-location-debug-function"
id="FN:code-location-debug-function"></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location-debug-function</tt>
<tt class="variable">basic-code-location</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the debug-function representing information
about the function corresponding to the code-location.</blockquote>
<br>
<a name="@funs312"></a><a name="FN:code-location-debug-block" id=
"FN:code-location-debug-block"></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location-debug-block</tt> <tt class=
"variable">basic-code-location</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the debug-block containing code-location if
it is available. Some debug policies inhibit debug-block
information, and if none is available, then this signals a
<tt class="code">no-debug-blocks</tt> condition.</blockquote>
<br>
<a name="@funs313"></a><a name=
"FN:code-location-top-level-form-offset" id=
"FN:code-location-top-level-form-offset"></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location-top-level-form-offset</tt>
<tt class="variable">code-location</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the number of top-level forms before the one
containing <tt class="variable">code-location</tt> as seen by the
compiler in some compilation unit. A compilation unit is not
necessarily a single file, see the section on
debug-sources.</blockquote>
<br>
<a name="@funs314"></a><a name="FN:code-location-form-number" id=
"FN:code-location-form-number"></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location-form-number</tt> <tt class=
"variable">code-location</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the number of the form corresponding to
<tt class="variable">code-location</tt>. The form number is derived
by walking the subforms of a top-level form in depth-first order.
While walking the top-level form, count one in depth-first order
for each subform that is a cons. See <a name=
"@funs315"></a><tt class=
"code">form-number-translations</tt>.</blockquote>
<br>
<a name="@funs316"></a><a name="FN:code-location-debug-source" id=
"FN:code-location-debug-source"></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location-debug-source</tt>
<tt class="variable">code-location</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns <tt class="variable">code-location</tt>'s
debug-source.</blockquote>
<br>
<a name="@funs317"></a><a name="FN:code-location-unknown-p" id=
"FN:code-location-unknown-p"></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location-unknown-p</tt> <tt class=
"variable">basic-code-location</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns whether <tt class=
"variable">basic-code-location</tt> is unknown. It returns
<tt class="code">nil</tt> when the code-location is
known.</blockquote>
<br>
<a name="@funs318"></a><a name="FN:code-location="></a>
<div align="left">[Function]<br>
<tt class="function-name">code-location=</tt> <tt class=
"variable">code-location1</tt> <tt class=
"variable">code-location2</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns whether the two code-locations are the
same.</blockquote>
<!--TOC section Debug-sources-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc294" id="htoc294"><b><font size=
"5">11.8</font></b></a></td>
<td width="100%" align="center"><b><font size=
"5">Debug-sources</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
Debug-sources represent how to get back the source for some code.
The source is either a file (<tt class="code">compile-file</tt> or
<tt class="code">load</tt>), a lambda-expression (<tt class=
"code">compile</tt>, <tt class="code">defun</tt>, <tt class=
"code">defmacro</tt>), or a stream (something particular to CMUCL,
<tt class="code">compile-from-stream</tt>).<br>
<br>
When compiling a source, the compiler counts each top-level form it
processes, but when the compiler handles multiple files as one
block compilation, the top-level form count continues past file
boundaries. Therefore <tt class=
"code">code-location-top-level-form-offset</tt> returns an offset
that does not always start at zero for the code-location's
debug-source. The offset into a particular source is <tt class=
"code">code-location-top-level-form-offset</tt> minus <tt class=
"code">debug-source-root-number</tt>.<br>
<br>
Inside a top-level form, a code-location's form number indicates
the subform corresponding to the code-location.<br>
<br>
<br>
<a name="@funs319"></a><a name="FN:debug-source-from" id=
"FN:debug-source-from"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-source-from</tt> <tt class=
"variable">debug-source</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns an indication of the type of source. The
following are the possible values:
<dl compact="compact">
<dt><tt class="code">:file</tt><br></dt>
<dd>from a file (obtained by <tt class="code">compile-file</tt> if
compiled).</dd>
<dt><tt class="code">:lisp</tt><br></dt>
<dd>from Lisp (obtained by <tt class="code">compile</tt> if
compiled).</dd>
<dt><tt class="code">:stream</tt><br></dt>
<dd>from a non-file stream (CMUCL supports <tt class=
"code">compile-from-stream</tt>).</dd>
</dl>
</blockquote>
<br>
<a name="@funs320"></a><a name="FN:debug-source-name" id=
"FN:debug-source-name"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-source-name</tt> <tt class=
"variable">debug-source</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the actual source in some sense represented
by debug-source, which is related to <tt class=
"code">debug-source-from</tt>:
<dl compact="compact">
<dt><tt class="code">:file</tt><br></dt>
<dd>the pathname of the file.</dd>
<dt><tt class="code">:lisp</tt><br></dt>
<dd>a lambda-expression.</dd>
<dt><tt class="code">:stream</tt><br></dt>
<dd>some descriptive string that's otherwise useless.</dd>
</dl>
</blockquote>
<br>
<a name="@funs321"></a><a name="FN:debug-source-created" id=
"FN:debug-source-created"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-source-created</tt> <tt class=
"variable">debug-source</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the universal time someone created the
source. This may be <tt class="code">nil</tt> if it is
unavailable.</blockquote>
<br>
<a name="@funs322"></a><a name="FN:debug-source-compiled" id=
"FN:debug-source-compiled"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-source-compiled</tt> <tt class=
"variable">debug-source</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the time someone compiled the source. This is
<tt class="code">nil</tt> if the source is uncompiled.</blockquote>
<br>
<a name="@funs323"></a><a name="FN:debug-source-root-number" id=
"FN:debug-source-root-number"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-source-root-number</tt> <tt class=
"variable">debug-source</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This returns the number of top-level forms processed by the
compiler before compiling this source. If this source is
uncompiled, this is zero. This may be zero even if the source is
compiled since the first form in the first file compiled in one
compilation, for example, must have a root number of zero---the
compiler saw no other top-level forms before it.</blockquote>
<!--TOC section Source Translation Utilities-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc295" id="htoc295"><b><font size=
"5">11.9</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Source
Translation Utilities</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
These two functions provide a mechanism for converting the rather
obscure (but highly compact) representation of source locations
into an actual source form:<br>
<br>
<br>
<a name="@funs324"></a><a name="FN:debug-source-start-positions"
id="FN:debug-source-start-positions"></a>
<div align="left">[Function]<br>
<tt class="function-name">debug-source-start-positions</tt>
<tt class="variable">debug-source</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the file position of each top-level form as a
vector if <tt class="variable">debug-source</tt> is from a
<tt class="code">:file</tt>. If <tt class=
"code">debug-source-from</tt> is <tt class="code">:lisp</tt> or
<tt class="code">:stream</tt>, or the file is byte-compiled, then
the result is <tt class="code">nil</tt>.</blockquote>
<br>
<a name="@funs325"></a><a name="FN:form-number-translations" id=
"FN:form-number-translations"></a>
<div align="left">[Function]<br>
<tt class="function-name">form-number-translations</tt> <tt class=
"variable">form</tt> <tt class="variable">tlf-number</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns a table mapping form numbers (see <tt class=
"code">code-location-form-number</tt>) to source-paths. A
source-path indicates a descent into the top-level-form <tt class=
"variable">form</tt>, going directly to the subform corresponding
to a form number. <tt class="variable">tlf-number</tt> is the
top-level-form number of <tt class=
"variable">form</tt>.</blockquote>
<br>
<a name="@funs326"></a><a name="FN:source-path-context" id=
"FN:source-path-context"></a>
<div align="left">[Function]<br>
<tt class="function-name">source-path-context</tt> <tt class=
"variable">form</tt> <tt class="variable">path</tt> <tt class=
"variable">context</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote><br>
This function returns the subform of <tt class="variable">form</tt>
indicated by the source-path. <tt class="variable">Form</tt> is a
top-level form, and <tt class="variable">path</tt> is a source-path
into it. <tt class="variable">Context</tt> is the number of
enclosing forms to return instead of directly returning the
source-path form. When <tt class="variable">context</tt> is
non-zero, the form returned contains a marker, <tt class=
"code">#:****HERE****</tt>, immediately before the form indicated
by <tt class="variable">path</tt>.</blockquote>
<!--NAME debug-internals.html-->
<!--TOC chapter Cross-Referencing Facility-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><a name="htoc296" id="htoc296"><b><font size=
"6">Chapter&nbsp;12</font></b></a></td>
<td width="100%" align="center"><b><font size="6">Cross-Referencing
Facility</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<a name="xref" id="xref"></a> <a name="@concept299"></a>
<div align="center"><b>by Eric Marsden</b></div>
<br>
The CMUCL cross-referencing facility (abbreviated XREF) assists in
the analysis of static dependency relationships in a program. It
provides introspection capabilities such as the ability to know
which functions may call a given function, and the program contexts
in which a particular global variable is used. The compiler
populates a database of cross-reference information, which can be
queried by the user to know:
<ul>
<li>the list of program contexts (functions, macros, top-level
forms) where a given function may be called at runtime, either
directly or indirectly (via its function-object);<br>
<br></li>
<li>the list of program contexts where a given global variable may
be read;<br>
<br></li>
<li>the list of program contexts that bind a global variable;<br>
<br></li>
<li>the list of program contexts where a given global variable may
be modified during the execution of the program.</li>
</ul>
A global variable is either a dynamic variable or a constant
variable, for instance declared using <tt class="code">defvar</tt>
or <tt class="code">defparameter</tt> or <tt class=
"code">defconstant</tt>.<br>
<br>
<!--TOC section Populating the cross-reference database-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc297" id="htoc297"><b><font size=
"5">12.1</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Populating the
cross-reference database</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
<br>
<a name="@vars67"></a><a name="VR:record-xref-info" id=
"VR:record-xref-info"></a>
<div align="left">[Variable]<br>
<tt class="function-name">c:</tt><tt class=
"function-name">*record-xref-info*</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>When non-NIL, code that is compiled (either using
<tt class="code">compile-file</tt>, or by calling <tt class=
"code">compile</tt> from the listener), will be analyzed for
cross-references. Defaults to <tt class=
"code">nil</tt>.</blockquote>
Cross-referencing information is only generated by the compiler;
the interpreter does not populate the cross-reference database.
XREF analysis is independent of whether the compiler is generating
native code or byte code, and of whether it is compiling from a
file, from a stream, or is invoked interactively from the
listener.<br>
<br>
<br>
<a name="@funs327"></a><a name="FN:init-xref-database" id=
"FN:init-xref-database"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">init-xref-database</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Reinitializes the database of cross-references. This
can be used to reclaim the space occupied by the database contents,
or to discard stale cross-reference information.</blockquote>
<!--TOC section Querying the cross-reference database-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc298" id="htoc298"><b><font size=
"5">12.2</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Querying the
cross-reference database</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
CMUCL provides a number of functions in the XREF package that may
be used to query the cross-reference database:<br>
<br>
<br>
<a name="@funs328"></a><a name="FN:who-calls" id=
"FN:who-calls"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">who-calls</tt> <tt class="variable">function</tt>
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns the list of xref-contexts where <tt class=
"variable">function</tt> (either a symbol that names a function, or
a function object) may be called at runtime. XREF does not record
calls to macro-functions (such as <tt class="code">defun</tt>) or
to special forms (such as <tt class=
"code">eval-when</tt>).</blockquote>
<br>
<a name="@funs329"></a><a name="FN:who-references" id=
"FN:who-references"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">who-references</tt> <tt class=
"variable">global-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns the list of program contexts that may reference
<tt class="variable">global-variable</tt>.</blockquote>
<br>
<a name="@funs330"></a><a name="FN:who-binds" id=
"FN:who-binds"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">who-binds</tt> <tt class=
"variable">global-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns a list of program contexts where the specified
global variable may be bound at runtime (for example using
<tt class="code">LET</tt>).</blockquote>
<br>
<a name="@funs331"></a><a name="FN:who-sets" id="FN:who-sets"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">who-sets</tt> <tt class=
"variable">global-variable</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns a list of program contexts where the given
global variable may be modified at runtime (for example using
<tt class="code">SETQ</tt>).</blockquote>
An <i>xref-context</i> is the originating site of a
cross-reference. It identifies a portion of a program, and is
defined by an <tt class="code">xref-context</tt> structure, that
comprises a name, a source file and a source-path.<br>
<br>
<br>
<a name="@funs332"></a><a name="FN:xref-context-name" id=
"FN:xref-context-name"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">xref-context-name</tt> <tt class=
"variable">context</tt> &nbsp;&nbsp;&nbsp;</div>
<blockquote>Returns the name slot of an xref-context, which is one
of:
<ul>
<li>a global function, which is named by a symbol or by a list of
the form <tt class="code">(setf foo)</tt>.<br>
<br></li>
<li>a macro, named by a list <code>(:macro foo)</code>.<br>
<br></li>
<li>an inner function (<tt class="code">flet</tt>, <tt class=
"code">labels</tt>, or anonymous lambdas) that is named by a list
of the form <tt class="code">(:internal outer inner)</tt>.<br>
<br></li>
<li>a method, named by a list of the form <code>(:method foo
(specializer1 specializer2)</code>.<br>
<br></li>
<li>a string <code>"Top-Level Form"</code> that identifies a
reference from a top-level form. Note that multiple references from
top-level forms will only be listed once.<br>
<br></li>
<li>a compiler-macro, named by a string of the form
<code>(:compiler-macro foo)</code>.<br>
<br></li>
<li>a string such as <code>"DEFSTRUCT FOO"</code>, identifying a
reference from within a structure accessor or constructor or
copier.<br>
<br></li>
<li>a string such as
<pre>
  "Creation Form for #&lt;KERNEL::CLASS-CELL STRUCT-FOO&gt;"
</pre>
<br>
<br></li>
<li>a string such as <code>"defun foo"</code>, or <code>"defmethod
bar (t)"</code>, that identifies a reference from within code that
has been generated by the compiler for that form. For example, the
compilation of a <tt class="code">defclass</tt> form causes
accessor functions to be generated by the compiler; this code is
compiler-generated (it does not appear in the source file), and so
is identified by the XREF facility by a string.</li>
</ul>
</blockquote>
<br>
<a name="@funs333"></a><a name="FN:xref-context-file" id=
"FN:xref-context-file"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">xref-context-file</tt> context
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Return the truename (in the sense of the variable
<a name="@vars68"></a><tt class=
"code">*compile-file-truename*</tt>) of the source file from which
the referencing forms were compiled. This slot will be <tt class=
"code">nil</tt> if the code was compiled from a stream, or
interactively from the listener.</blockquote>
<br>
<a name="@funs334"></a><a name="FN:xref-context-source-path" id=
"FN:xref-context-source-path"></a>
<div align="left">[Function]<br>
<tt class="function-name">xref:</tt><tt class=
"function-name">xref-context-source-path</tt> context
&nbsp;&nbsp;&nbsp;</div>
<blockquote>Return a list of positive integers identifying the form
that contains the cross-reference. The first integer in the
source-path is the number of the top-level form containing the
cross-reference (for example, 2 identifies the second top-level
form in the source file). The second integer in the source-path
identifies the form within this top-level form that contains the
cross-reference, and so on. This function will always return
<tt class="code">nil</tt> if the file slot of an xref-context is
<tt class="code">nil</tt>.</blockquote>
<!--TOC section Example usage-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc299" id="htoc299"><b><font size=
"5">12.3</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Example
usage</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
In this section, we will illustrate use of the XREF facility on a
number of simple examples.<br>
<br>
Consider the following program fragment, that defines a global
variable and a function.
<pre>
  (defvar *variable-one* 42)
  
  (defun function-one (x)
     (princ (* x *variable-one*)))
</pre>
We save this code in a file named <tt class=
"code">example.lisp</tt>, enable cross-referencing, clear any
previous cross-reference information, compile the file, and can
then query the cross-reference database (output has been modified
for readability).
<pre>
  USER&gt; (setf c:*record-xref-info* t)
  USER&gt; (xref:init-xref-database)
  USER&gt; (compile-file "example")
  USER&gt; (xref:who-calls 'princ)
  (#&lt;xref-context function-one in #p"example.lisp"&gt;)
  USER&gt; (xref:who-references '*variable-one*)
  (#&lt;xref-context function-one in #p"example.lisp"&gt;)
</pre>
From this example, we see that the compiler has noted the call to
the global function <tt class="code">princ</tt> in <tt class=
"code">function-one</tt>, and the reference to the global variable
<tt class="code">*variable-one*</tt>.<br>
<br>
Suppose that we add the following code to the previous file.
<pre>
(defconstant +constant-one+ 1)
  
(defstruct struct-one
  slot-one
  (slot-two +constant-one+ :type integer)
  (slot-three 42 :read-only t))

(defmacro with-different-one (&amp;body body)
  `(let ((*variable-one* 666))
      ,@body))

(defun get-variable-one () *variable-one*)

(defun (setf get-variable-one) (new-value)
  (setq *variable-one* new-value))
</pre>
In the following example, we detect references x and y.<br>
<br>
The following function illustrates the effect that various forms of
optimization carried out by the CMUCL compiler can have on the
cross-references that are reported for a particular program. The
compiler is able to detect that the evaluated condition is always
false, and that the first clause of the <tt class="code">if</tt>
will never be taken (this optimization is called dead-code
elimination). XREF will therefore not register a call to the
function <tt class="code">sin</tt> from the function <tt class=
"code">foo</tt>. Likewise, no calls to the functions <tt class=
"code">sqrt</tt> and are registered, because the compiler has
eliminated the code that evaluates the condition. Finally, no call
to the function <tt class="code">expt</tt> is generated, because
the compiler was able to evaluate the result of the expression
<tt class="code">(expt 3 2)</tt> at compile-time (though a process
called constant-folding).
<pre>
;; zero call references are registered for this function!
(defun constantly-nine (x)
  (if (&lt; (sqrt x) 0)
      (sin x)
      (expt 3 2)))
</pre>
<!--TOC section Limitations of the cross-referencing facility-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFD3">
<div align="center">
<table>
<tr>
<td><a name="htoc300" id="htoc300"><b><font size=
"5">12.4</font></b></a></td>
<td width="100%" align="center"><b><font size="5">Limitations of
the cross-referencing facility</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<br>
No cross-reference information is available for interpreted
functions. The cross-referencing database is not persistent: unless
you save an image using <tt class="code">save-lisp</tt>, the
database will be empty each time CMUCL is restarted. There is no
mechanism that saves cross-reference information in FASL files, so
loading a system from compiled code will not populate the
cross-reference database. The XREF database currently accumulates
``stale'' information: when compiling a file, it does not delete
any cross-references that may have previously been generated for
that file. This latter limitation will be removed in a future
release.<br>
<br>
The cross-referencing facility is only able to analyze the static
dependencies in a program; it does not provide any information
about runtime (dynamic) dependencies. For instance, XREF is able to
identify the list of program contexts where a given function may be
called, but is not able to determine which contexts will be
activated when the program is executed with a specific set of input
parameters. However, the static analysis that is performed by the
CMUCL compiler does allow XREF to provide more information than
would be available from a mere syntactic analysis of a program.
References that occur from within unreachable code will not be
displayed by XREF, because the CMUCL compiler deletes dead code
before cross-references are analyzed. Certain ``trivial'' function
calls (where the result of the function call can be evaluated at
compile-time) may be eliminated by optimizations carried out by the
compiler; see the example below.<br>
<br>
If you examine the entire database of cross-reference information
(by accessing undocumented internals of the XREF package), you will
note that XREF notes ``bogus'' cross-references to function calls
that are inserted by the compiler. For example, in safe code, the
CMUCL compiler inserts a call to an internal function called
<tt class="code">c::%verify-argument-count</tt>, so that the number
of arguments passed to the function is checked each time it is
called. The XREF facility does not distinguish between user code
and these forms that are introduced during compilation. This
limitation should not be visible if you use the documented
functions in the XREF package.<br>
<br>
As of the 18e release of CMUCL, the cross-referencing facility is
experimental; expect details of its implementation to change in
future releases. In particular, the names given to CLOS methods and
to inner functions will change in future releases.<br>
<br>
<!--NAME cross-referencing.html-->
<br>
<br>
<a name="@concept300"></a> <!--TOC chapter Function Index-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><b><font size="6">Function Index</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<table cellspacing="2" cellpadding="0">
<tr>
<td valign="top" align="left">
<ul>
<li>-, <a href="#@funs23"><b>2.7</b></a>, <a href=
"#@funs26"><b>2.7.2</b></a><br>
<br></li>
<li>accept-tcp-connection, <a href="#@funs256"><b>10.4</b></a></li>
<li>accept-unix-connection, <a href=
"#@funs257"><b>10.4</b></a></li>
<li>activate-breakpoint, <a href="#@funs303"><b>11.6</b></a></li>
<li>add-fd-handler, <a href="#@funs180"><b>7.3</b></a></li>
<li>add-oob-handler, <a href="#@funs260"><b>10.6</b></a></li>
<li>add-xwindow-object, <a href="#@funs177"><b>7.1</b></a></li>
<li>addr, <a href="#@funs199"><b>8.3.2</b></a></li>
<li>alien-funcall, <a href="#@funs196">8.2.3</a>, <a href=
"#@funs213"><b>8.7.1</b></a>, <a href="#@funs216">8.7.2</a></li>
<li>alien-sap, <a href="#@funs203"><b>8.3.2</b></a></li>
<li>ambiguous-debug-variables, <a href=
"#@funs292"><b>11.4</b></a></li>
<li>ambiguous-files, <a href="#@funs70"><b>2.17.2</b></a><br>
<br></li>
<li>break, <a href="#@funs100">3.1</a></li>
<li>breakpoint-active-p, <a href="#@funs305"><b>11.6</b></a></li>
<li>breakpoint-hook-function, <a href=
"#@funs306"><b>11.6</b></a></li>
<li>breakpoint-info, <a href="#@funs307"><b>11.6</b></a></li>
<li>breakpoint-kind, <a href="#@funs308"><b>11.6</b></a></li>
<li>breakpoint-what, <a href="#@funs309"><b>11.6</b></a><br>
<br></li>
<li>callback, <a href="#@funs219">8.7.4</a>, <a href=
"#@funs220"><b>8.7.4</b></a></li>
<li>callback-funcall, <a href="#@funs221"><b>8.7.4</b></a></li>
<li>cancel-finalization, <a href="#@funs34"><b>2.7.4</b></a></li>
<li>cast, <a href="#@funs201"><b>8.3.2</b></a></li>
<li>ceiling, <a href="#@funs9">2.1.2.5</a></li>
<li>clear-search-list, <a href="#@funs65"><b>2.16.6</b></a></li>
<li>close-socket, <a href="#@funs268"><b>10.7</b></a></li>
<li>cmd-switch-arg, <a href="#@funs149"><b>6.1</b></a></li>
<li>cmd-switch-name, <a href="#@funs146"><b>6.1</b></a></li>
<li>cmd-switch-value, <a href="#@funs147"><b>6.1</b></a></li>
<li>cmd-switch-words, <a href="#@funs148"><b>6.1</b></a></li>
<li>code-location-debug-block, <a href=
"#@funs312"><b>11.7</b></a></li>
<li>code-location-debug-function, <a href=
"#@funs311"><b>11.7</b></a></li>
<li>code-location-debug-source, <a href=
"#@funs316"><b>11.7</b></a></li>
<li>code-location-form-number, <a href=
"#@funs314"><b>11.7</b></a></li>
<li>code-location-top-level-form-offset, <a href=
"#@funs313"><b>11.7</b></a></li>
<li>code-location-unknown-p, <a href=
"#@funs317"><b>11.7</b></a></li>
<li>code-location=, <a href="#@funs318"><b>11.7</b></a></li>
<li>compile, <a href="#@funs111"><b>4.2</b></a></li>
<li>compile-file, <a href="#@funs103">3.5.1</a>, <a href=
"#@funs112"><b>4.2</b></a>, <a href="#@funs134">5.7.3</a>, <a href=
"#@funs136">5.9</a></li>
<li>compile-from-stream, <a href="#@funs113"><b>4.2</b></a></li>
<li>complete-file, <a href="#@funs69"><b>2.17.2</b></a></li>
<li>connect-to-inet-socket, <a href=
"#@funs258"><b>10.5</b></a></li>
<li>connect-to-remote-server, <a href=
"#@funs226"><b>9.1.1</b></a></li>
<li>connect-to-unix-socket, <a href=
"#@funs259"><b>10.5</b></a></li>
<li>constantly, <a href="#@funs84"><b>2.24.1</b></a></li>
<li>create-inet-listener, <a href="#@funs254"><b>10.3</b></a></li>
<li>create-inet-socket, <a href="#@funs265"><b>10.7</b></a></li>
<li>create-request-server, <a href=
"#@funs224"><b>9.1.1</b></a></li>
<li>create-unix-listener, <a href="#@funs255"><b>10.3</b></a></li>
<li>create-unix-socket, <a href="#@funs264"><b>10.7</b></a><br>
<br></li>
<li>deactivate-breakpoint, <a href="#@funs304"><b>11.6</b></a></li>
<li>debug, <a href="#@funs101">3.1</a></li>
<li>debug-block-elsewhere-p, <a href=
"#@funs301"><b>11.5</b></a></li>
<li>debug-block-successors, <a href=
"#@funs300"><b>11.5</b></a></li>
<li>debug-function-function, <a href=
"#@funs297"><b>11.4</b></a></li>
<li>debug-function-kind, <a href="#@funs296"><b>11.4</b></a></li>
<li>debug-function-lambda-list, <a href=
"#@funs288"><b>11.4</b></a></li>
<li>debug-function-name, <a href="#@funs298"><b>11.4</b></a></li>
<li>debug-function-symbol-variables, <a href=
"#@funs291"><b>11.4</b></a></li>
<li>debug-source-compiled, <a href="#@funs322"><b>11.8</b></a></li>
<li>debug-source-created, <a href="#@funs321"><b>11.8</b></a></li>
<li>debug-source-from, <a href="#@funs319"><b>11.8</b></a></li>
<li>debug-source-name, <a href="#@funs320"><b>11.8</b></a></li>
<li>debug-source-root-number, <a href=
"#@funs323"><b>11.8</b></a></li>
<li>debug-source-start-positions, <a href=
"#@funs324"><b>11.9</b></a></li>
<li>debug-variable-id, <a href="#@funs275"><b>11.2</b></a></li>
<li>debug-variable-info-available, <a href=
"#@funs290"><b>11.4</b></a></li>
<li>debug-variable-name, <a href="#@funs272"><b>11.2</b></a></li>
<li>debug-variable-package, <a href=
"#@funs273"><b>11.2</b></a></li>
<li>debug-variable-symbol, <a href="#@funs274"><b>11.2</b></a></li>
<li>debug-variable-valid-value, <a href=
"#@funs278"><b>11.2</b></a></li>
<li>debug-variable-validity, <a href=
"#@funs276"><b>11.2</b></a></li>
<li>debug-variable-value, <a href="#@funs277"><b>11.2</b></a></li>
<li>def-alien-routine, <a href="#@funs208">8.4.2</a>, <a href=
"#@funs215"><b>8.7.2</b></a></li>
<li>def-alien-type, <a href="#@funs192"><b>8.2.1</b></a>, <a href=
"#@funs194">8.2.3</a></li>
<li>def-alien-variable, <a href="#@funs209"><b>8.4.2</b></a></li>
<li>def-callback, <a href="#@funs217">8.7.4</a>, <a href=
"#@funs218"><b>8.7.4</b></a></li>
<li>def-source-context, <a href="#@funs115"><b>4.4.7</b></a></li>
<li>default-directory, <a href="#@funs71"><b>2.17.3</b></a></li>
<li>default-interrupt, <a href="#@funs174"><b>6.8.1</b></a></li>
<li>define-function-name-syntax, <a href=
"#@funs77"><b>2.22</b></a></li>
<li>define-fwrapper, <a href="#@funs85"><b>2.25</b></a></li>
<li>define-hash-table-test, <a href=
"#@funs15"><b>2.1.6</b></a></li>
<li>defmodule, <a href="#@funs96"><b>2.28</b></a></li>
<li>defstruct, <a href="#@funs122">5.2.11</a>, <a href=
"#@funs137">5.10.2</a></li>
<li>defswitch, <a href="#@funs151"><b>6.1</b></a></li>
<li>deftype, <a href="#@funs121">5.2.11</a></li>
<li>defun, <a href="#@funs133">5.7</a></li>
<li>delete-breakpoint, <a href="#@funs310"><b>11.6</b></a></li>
<li>delete-fwrapper, <a href="#@funs94"><b>2.25</b></a></li>
<li>deref, <a href="#@funs197"><b>8.3.1</b></a></li>
<li>describe, <a href="#@funs35"><b>2.8</b></a>, <a href=
"#@funs104">3.6</a></li>
<li>destroy-request-server, <a href=
"#@funs225"><b>9.1.1</b></a></li>
<li>directory, <a href="#@funs67"><b>2.17.1</b></a></li>
<li>disable-clx-event-handling, <a href=
"#@funs188"><b>7.4.1</b></a></li>
<li>do-debug-block-locations, <a href=
"#@funs299"><b>11.5</b></a></li>
<li>do-debug-function-blocks, <a href=
"#@funs287"><b>11.4</b></a></li>
<li>do-debug-function-variables, <a href=
"#@funs289"><b>11.4</b></a></li>
<li>do-fwrappers, <a href="#@funs95"><b>2.25</b></a><br>
<br></li>
<li>ed, <a href="#@funs0">1.2</a></li>
<li>enable-clx-event-handling, <a href=
"#@funs187"><b>7.4.1</b></a></li>
<li>enable-interrupt, <a href="#@funs172"><b>6.8.1</b></a></li>
<li>encapsulate, <a href="#@funs108"><b>3.10.1</b></a></li>
<li>encapsulated-p, <a href="#@funs110"><b>3.10.1</b></a></li>
<li>enumerate-search-list, <a href=
"#@funs66"><b>2.16.6</b></a></li>
<li>error, <a href="#@funs99">3.1</a></li>
<li>eval-in-frame, <a href="#@funs285"><b>11.3</b></a>, <a href=
"#@funs294">11.4</a></li>
<li>extern-alien, <a href="#@funs200">8.3.2</a>, <a href=
"#@funs210"><b>8.4.2</b></a>, <a href="#@funs214">8.7.1</a><br>
<br></li>
<li>fd-stream-fd, <a href="#@funs167"><b>6.7</b></a></li>
<li>fd-stream-p, <a href="#@funs166"><b>6.7</b></a></li>
<li>fdefinition, <a href="#@funs107">3.10.1</a></li>
<li>file-writable, <a href="#@funs72"><b>2.17.3</b></a></li>
<li>finalize, <a href="#@funs33"><b>2.7.4</b></a></li>
<li>find-fwrapper, <a href="#@funs88"><b>2.25</b></a></li>
<li>flet, <a href="#@funs128">5.6</a></li>
<li>float-denormalized-p, <a href="#@funs7"><b>2.1.2.3</b></a></li>
<li>float-digits, <a href="#@funs6">2.1.2.3</a></li>
<li>float-infinity-p, <a href="#@funs1"><b>2.1.2.1</b></a></li>
<li>float-nan-p, <a href="#@funs2"><b>2.1.2.1</b></a></li>
<li>float-precision, <a href="#@funs5">2.1.2.3</a></li>
<li>float-sign, <a href="#@funs4">2.1.2.2</a></li>
<li>float-trapping-nan-p, <a href="#@funs3"><b>2.1.2.1</b></a></li>
<li>floor, <a href="#@funs10">2.1.2.5</a></li>
<li>flush-display-events, <a href="#@funs186"><b>7.4</b></a></li>
<li>flush-emf-cache, <a href="#@funs81"><b>2.23.4</b></a></li>
<li>forget-remote-translation, <a href=
"#@funs236"><b>9.1.3</b></a></li>
<li>form-number-translations, <a href="#@funs315">11.7</a>,
<a href="#@funs325"><b>11.9</b></a></li>
<li>format-decoded-time, <a href="#@funs76"><b>2.18</b></a></li>
<li>format-universal-time, <a href="#@funs75"><b>2.18</b></a></li>
<li>frame-catches, <a href="#@funs284"><b>11.3</b></a></li>
<li>frame-code-location, <a href="#@funs283"><b>11.3</b></a></li>
<li>frame-debug-function, <a href="#@funs282"><b>11.3</b></a></li>
<li>frame-down, <a href="#@funs280"><b>11.3</b></a></li>
<li>frame-up, <a href="#@funs281"><b>11.3</b></a></li>
<li>free-alien, <a href="#@funs153">6.4</a>, <a href=
"#@funs205"><b>8.3.3</b></a></li>
<li>function, <a href="#@funs119">5.2.6</a></li>
<li>function-debug-function, <a href=
"#@funs295"><b>11.4</b></a></li>
<li>funwrap, <a href="#@funs87"><b>2.25</b></a></li>
<li>fwrap, <a href="#@funs86"><b>2.25</b></a><br>
<br></li>
<li>gc-off, <a href="#@funs24"><b>2.7</b></a></li>
<li>gc-on, <a href="#@funs25"><b>2.7</b></a></li>
<li>gencgc-stats, <a href="#@funs27"><b>2.7.2</b></a></li>
<li>get-bytes-consed, <a href="#@funs144"><b>5.14.6</b></a></li>
<li>get-command-line-switch, <a href=
"#@funs150"><b>6.1</b></a></li>
<li>get-floating-point-modes, <a href=
"#@funs13"><b>2.1.2.6</b></a></li>
<li>get-internal-run-time, <a href="#@funs145">5.14.6</a></li>
<li>get-socket-option, <a href="#@funs266"><b>10.7</b></a></li>
<li>get-unix-error-msg, <a href="#@funs163"><b>6.6</b></a><br>
<br></li>
<li>hash-table-test, <a href="#@funs17">2.1.6</a></li>
<li>htonl, <a href="#@funs248"><b>10.1</b></a></li>
<li>htons, <a href="#@funs249"><b>10.1</b></a><br>
<br></li>
</ul>
</td>
<td valign="top" align="left">
<ul>
<li>if, <a href="#@funs126">5.3.5</a>, <a href=
"#@funs127">5.4.4</a></li>
<li>ignore-interrupt, <a href="#@funs173"><b>6.8.1</b></a></li>
<li>inet-recvfrom, <a href="#@funs269"><b>10.8</b></a></li>
<li>inet-sendto, <a href="#@funs270"><b>10.8</b></a></li>
<li>inet-shutdown, <a href="#@funs271"><b>10.8</b></a></li>
<li>init-xref-database, <a href="#@funs327"><b>12.1</b></a></li>
<li>inspect, <a href="#@funs36"><b>2.9</b></a>, <a href=
"#@funs38">2.9.1</a></li>
<li>int-sap, <a href="#@funs155"><b>6.5</b></a></li>
<li>invalidate-descriptor, <a href="#@funs184"><b>7.3</b></a></li>
<li>ip-string, <a href="#@funs253"><b>10.2</b></a></li>
<li>iterate, <a href="#@funs131"><b>5.6.4</b></a><br>
<br></li>
<li>labels, <a href="#@funs129">5.6</a>, <a href=
"#@funs132">5.6.4</a></li>
<li>let, <a href="#@funs124">5.2.11</a></li>
<li>lisp-control-panel, <a href="#@funs37"><b>2.9.1</b></a></li>
<li>list-fwrappers, <a href="#@funs92"><b>2.25</b></a></li>
<li>load, <a href="#@funs39"><b>2.10</b></a></li>
<li>load-foreign, <a href="#@funs212"><b>8.6</b></a></li>
<li>load-logical-pathname-translations, <a href=
"#@funs62">2.16.3</a></li>
<li>lookup-host-entry, <a href="#@funs252"><b>10.2</b></a><br>
<br></li>
<li>make-alien, <a href="#@funs152">6.4</a>, <a href=
"#@funs193">8.2.3</a>, <a href="#@funs204"><b>8.3.3</b></a>,
<a href="#@funs222">8.7.6</a></li>
<li>make-breakpoint, <a href="#@funs302"><b>11.6</b></a></li>
<li>make-fd-stream, <a href="#@funs41">2.12</a>, <a href=
"#@funs165"><b>6.7</b></a></li>
<li>make-hash-table, <a href="#@funs16">2.1.6</a>, <a href=
"#@funs18"><b>2.1.6</b></a></li>
<li>make-object-set, <a href="#@funs175"><b>7.1</b></a></li>
<li>make-remote-object, <a href="#@funs231"><b>9.1.3</b></a></li>
<li>make-weak-pointer, <a href="#@funs31"><b>2.7.3</b></a></li>
<li>make-wire, <a href="#@funs245"><b>9.2.3</b></a></li>
<li>module-provide-cmucl-defmodule, <a href=
"#@funs97"><b>2.28</b></a></li>
<li>module-provide-cmucl-library, <a href=
"#@funs98"><b>2.28</b></a></li>
<li>multiple-value-bind, <a href="#@funs125">5.3.1</a><br>
<br></li>
<li>no-primary-method, <a href="#@funs79"><b>2.23.1</b></a>,
<a href="#@funs80"><b>2.23.1</b></a></li>
<li>ntohl, <a href="#@funs251"><b>10.1</b></a></li>
<li>ntohs, <a href="#@funs250"><b>10.1</b></a><br>
<br></li>
<li>object-set-event-handler, <a href=
"#@funs190"><b>7.4.2</b></a></li>
<li>object-set-operation, <a href="#@funs176"><b>7.1</b></a></li>
<li>open-clx-display, <a href="#@funs185"><b>7.4</b></a><br>
<br></li>
<li>package-definition-lock, <a href=
"#@funs20"><b>2.5.2</b></a></li>
<li>package-lock, <a href="#@funs19"><b>2.5.2</b></a></li>
<li>parse-time, <a href="#@funs74"><b>2.18</b></a></li>
<li>preprocess-for-eval, <a href="#@funs286">11.3</a>, <a href=
"#@funs293"><b>11.4</b></a></li>
<li>print-directory, <a href="#@funs68"><b>2.17.1</b></a></li>
<li>process-alive-p, <a href="#@funs56"><b>2.14.1</b></a></li>
<li>process-close, <a href="#@funs57"><b>2.14.1</b></a></li>
<li>process-core-dumped, <a href="#@funs47"><b>2.14.1</b></a></li>
<li>process-error, <a href="#@funs51"><b>2.14.1</b></a></li>
<li>process-exit-code, <a href="#@funs46"><b>2.14.1</b></a></li>
<li>process-input, <a href="#@funs49"><b>2.14.1</b></a></li>
<li>process-kill, <a href="#@funs55"><b>2.14.1</b></a></li>
<li>process-output, <a href="#@funs50"><b>2.14.1</b></a></li>
<li>process-p, <a href="#@funs43"><b>2.14.1</b></a></li>
<li>process-pid, <a href="#@funs44"><b>2.14.1</b></a></li>
<li>process-plist, <a href="#@funs53"><b>2.14.1</b></a></li>
<li>process-pty, <a href="#@funs48"><b>2.14.1</b></a></li>
<li>process-status, <a href="#@funs45"><b>2.14.1</b></a></li>
<li>process-status-hook, <a href="#@funs52"><b>2.14.1</b></a></li>
<li>process-wait, <a href="#@funs54"><b>2.14.1</b></a></li>
<li>profile, <a href="#@funs138"><b>5.14.1</b></a></li>
<li>profile-all, <a href="#@funs140"><b>5.14.1</b></a></li>
<li>purify, <a href="#@funs59">2.15</a>, <a href=
"#@funs60">2.15</a>, <a href="#@funs61"><b>2.15</b></a></li>
<li>push-fwrapper, <a href="#@funs93"><b>2.25</b></a><br>
<br></li>
<li>read-n-bytes, <a href="#@funs40"><b>2.12</b></a>, <a href=
"#@funs164">6.7</a></li>
<li>remote, <a href="#@funs227"><b>9.1.2</b></a></li>
<li>remote-object-eq, <a href="#@funs234"><b>9.1.3</b></a></li>
<li>remote-object-local-p, <a href=
"#@funs233"><b>9.1.3</b></a></li>
<li>remote-object-p, <a href="#@funs232"><b>9.1.3</b></a></li>
<li>remote-object-value, <a href="#@funs235"><b>9.1.3</b></a></li>
<li>remote-value, <a href="#@funs229"><b>9.1.2</b></a></li>
<li>remote-value-bind, <a href="#@funs230"><b>9.1.2</b></a></li>
<li>remove-all-oob-handlers, <a href=
"#@funs262"><b>10.6</b></a></li>
<li>remove-fd-handler, <a href="#@funs181"><b>7.3</b></a></li>
<li>remove-oob-handler, <a href="#@funs261"><b>10.6</b></a></li>
<li>report-time, <a href="#@funs141"><b>5.14.1</b></a></li>
<li>required-argument, <a href="#@funs116"><b>4.5.1</b></a>,
<a href="#@funs118">5.2.5</a></li>
<li>reset-time, <a href="#@funs142"><b>5.14.1</b></a></li>
<li>round, <a href="#@funs8">2.1.2.5</a></li>
<li>run-program, <a href="#@funs42"><b>2.14</b></a><br>
<br></li>
<li>sap+, <a href="#@funs156"><b>6.5</b></a></li>
<li>sap-alien, <a href="#@funs202"><b>8.3.2</b></a></li>
<li>sap-int, <a href="#@funs154"><b>6.5</b></a></li>
<li>sap-ref-16, <a href="#@funs158"><b>6.5</b></a></li>
<li>sap-ref-32, <a href="#@funs159"><b>6.5</b></a></li>
<li>sap-ref-8, <a href="#@funs157"><b>6.5</b></a></li>
<li>save-lisp, <a href="#@funs58"><b>2.15</b></a>, <a href=
"#@funs211">8.6</a></li>
<li>seal, <a href="#@funs82"><b>2.23.6</b></a></li>
<li>search-list, <a href="#@funs63"><b>2.16.6</b></a></li>
<li>search-list-defined-p, <a href=
"#@funs64"><b>2.16.6</b></a></li>
<li>send-character-out-of-band, <a href=
"#@funs263"><b>10.6</b></a></li>
<li>serve-all-events, <a href="#@funs179"><b>7.2</b></a></li>
<li>serve-event, <a href="#@funs178"><b>7.2</b></a></li>
<li>set-floating-point-modes, <a href=
"#@funs12"><b>2.1.2.6</b></a></li>
<li>set-fwrappers, <a href="#@funs91"><b>2.25</b></a></li>
<li>set-gc-trigger, <a href="#@funs28"><b>2.7.2</b></a></li>
<li>set-min-mem-age, <a href="#@funs30"><b>2.7.2</b></a></li>
<li>set-socket-option, <a href="#@funs267"><b>10.7</b></a></li>
<li>set-trigger-age, <a href="#@funs29"><b>2.7.2</b></a></li>
<li>signed-sap-ref-16, <a href="#@funs161"><b>6.5</b></a></li>
<li>signed-sap-ref-32, <a href="#@funs162"><b>6.5</b></a></li>
<li>signed-sap-ref-8, <a href="#@funs160"><b>6.5</b></a></li>
<li>slot, <a href="#@funs198"><b>8.3.1</b></a></li>
<li>source-path-context, <a href="#@funs326"><b>11.9</b></a></li>
<li>system:vector-sap, <a href="#@funs223">8.7.6</a><br>
<br></li>
<li>the, <a href="#@funs120">5.2.7</a>, <a href=
"#@funs123">5.2.11</a></li>
<li>time, <a href="#@funs143"><b>5.14.6</b></a></li>
<li>top-frame, <a href="#@funs279"><b>11.3</b></a></li>
<li>trace, <a href="#@funs105"><b>3.10</b></a>, <a href=
"#@funs130">5.6.1</a></li>
<li>truncate, <a href="#@funs11">2.1.2.5</a><br>
<br></li>
<li>unencapsulate, <a href="#@funs109"><b>3.10.1</b></a></li>
<li>unix-namestring, <a href="#@funs73"><b>2.17.3</b></a></li>
<li>unlock-all-packages, <a href="#@funs22"><b>2.5.2</b></a></li>
<li>unprofile, <a href="#@funs139"><b>5.14.1</b></a></li>
<li>unseal, <a href="#@funs83"><b>2.23.6</b></a></li>
<li>untrace, <a href="#@funs106"><b>3.10</b></a></li>
<li>update-fwrapper, <a href="#@funs89"><b>2.25</b></a></li>
<li>update-fwrappers, <a href="#@funs90"><b>2.25</b></a><br>
<br></li>
<li>valid-function-name-p, <a href="#@funs78"><b>2.22</b></a></li>
<li>var, <a href="#@funs102"><b>3.4</b></a><br>
<br></li>
<li>wait-until-fd-usable, <a href="#@funs183"><b>7.3</b></a></li>
<li>weak-pointer-value, <a href="#@funs32"><b>2.7.3</b></a></li>
<li>who-binds, <a href="#@funs330"><b>12.2</b></a></li>
<li>who-calls, <a href="#@funs328"><b>12.2</b></a></li>
<li>who-references, <a href="#@funs329"><b>12.2</b></a></li>
<li>who-sets, <a href="#@funs331"><b>12.2</b></a></li>
<li>wire-fd, <a href="#@funs247"><b>9.2.3</b></a></li>
<li>wire-force-output, <a href="#@funs228"><b>9.1.2</b></a></li>
<li>wire-get-byte, <a href="#@funs238"><b>9.2.1</b></a></li>
<li>wire-get-number, <a href="#@funs240"><b>9.2.1</b></a></li>
<li>wire-get-object, <a href="#@funs244"><b>9.2.2</b></a></li>
<li>wire-get-string, <a href="#@funs242"><b>9.2.1</b></a></li>
<li>wire-output-byte, <a href="#@funs237"><b>9.2.1</b></a></li>
<li>wire-output-number, <a href="#@funs239"><b>9.2.1</b></a></li>
<li>wire-output-object, <a href="#@funs243"><b>9.2.2</b></a></li>
<li>wire-output-string, <a href="#@funs241"><b>9.2.1</b></a></li>
<li>wire-p, <a href="#@funs246"><b>9.2.3</b></a></li>
<li>with-alien, <a href="#@funs191">8.2.1</a>, <a href=
"#@funs195">8.2.3</a>, <a href="#@funs206">8.3.3</a>, <a href=
"#@funs207"><b>8.4.1</b></a></li>
<li>with-clx-event-handling, <a href=
"#@funs189"><b>7.4.1</b></a></li>
<li>with-compilation-unit, <a href="#@funs114"><b>4.3</b></a>,
<a href="#@funs117">4.7.2</a>, <a href="#@funs135">5.7.5</a></li>
<li>with-enabled-interrupts, <a href=
"#@funs168"><b>6.8.1</b></a></li>
<li>with-fd-handler, <a href="#@funs182"><b>7.3</b></a></li>
<li>with-float-traps-masked, <a href=
"#@funs14"><b>2.1.2.6</b></a></li>
<li>with-interrupts, <a href="#@funs170"><b>6.8.1</b></a></li>
<li>without-hemlock, <a href="#@funs171"><b>6.8.1</b></a></li>
<li>without-interrupts, <a href="#@funs169"><b>6.8.1</b></a></li>
<li>without-package-locks, <a href="#@funs21"><b>2.5.2</b></a><br>
<br></li>
<li>xref-context-file, <a href="#@funs333"><b>12.2</b></a></li>
<li>xref-context-name, <a href="#@funs332"><b>12.2</b></a></li>
<li>xref-context-source-path, <a href=
"#@funs334"><b>12.2</b></a></li>
</ul>
</td>
</tr>
</table>
<!--NAME cmu-user.hfnd.html-->
<br>
<br>
<a name="@concept301"></a> <!--TOC chapter Variable Index-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><b><font size="6">Variable Index</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<table cellspacing="2" cellpadding="0">
<tr>
<td valign="top" align="left">
<ul>
<li>*max-emf-precomputation-methods*, <a href=
"#@vars21"><b>2.23.5</b></a><br>
<br></li>
<li>after-gc-hooks, <a href="#@vars8"><b>2.7.1</b></a><br>
<br></li>
<li>before-gc-hooks, <a href="#@vars7"><b>2.7.1</b></a></li>
<li>block-compile-default, <a href="#@vars48">5.7.3</a>, <a href=
"#@vars49"><b>5.7.3</b></a>, <a href="#@vars50">5.7.4</a></li>
<li>byte-compile-default, <a href="#@vars37">4.2</a>, <a href=
"#@vars52"><b>5.9</b></a></li>
<li>byte-compile-top-level, <a href="#@vars51"><b>5.9</b></a></li>
<li>bytes-consed-between-gcs, <a href=
"#@vars2"><b>2.7.1</b></a><br>
<br></li>
<li>command-line-strings, <a href="#@vars58"><b>6.1</b></a></li>
<li>command-line-switches, <a href="#@vars61"><b>6.1</b></a></li>
<li>command-line-utility-name, <a href=
"#@vars59"><b>6.1</b></a></li>
<li>command-line-words, <a href="#@vars60"><b>6.1</b></a></li>
<li>compile-file-truename, <a href="#@vars68">12.2</a></li>
<li>compile-interpreted-methods-p, <a href=
"#@vars22"><b>2.23.8</b></a></li>
<li>compile-print, <a href="#@vars35">4.2</a>, <a href=
"#@vars39"><b>4.2</b></a></li>
<li>compile-progress, <a href="#@vars36">4.2</a>, <a href=
"#@vars40"><b>4.2</b></a></li>
<li>compile-verbose, <a href="#@vars34">4.2</a>, <a href=
"#@vars38"><b>4.2</b></a><br>
<br></li>
<li>debug-print-length, <a href="#@vars25">3.3.2</a>, <a href=
"#@vars28">3.10</a>, <a href="#@vars33"><b>3.11</b></a></li>
<li>debug-print-level, <a href="#@vars27">3.10</a>, <a href=
"#@vars32"><b>3.11</b></a></li>
<li>derive-function-types, <a href="#@vars47"><b>5.3.3</b></a></li>
<li>describe-indentation, <a href="#@vars10"><b>2.8</b></a></li>
<li>describe-level, <a href="#@vars9"><b>2.8</b></a></li>
<li>describe-print-length, <a href="#@vars12"><b>2.8</b></a></li>
<li>describe-print-level, <a href="#@vars11"><b>2.8</b></a><br>
<br></li>
<li>efficiency-note-cost-threshold, <a href="#@vars43">4.4.7</a>,
<a href="#@vars53">5.13.3</a>, <a href=
"#@vars54"><b>5.13.4</b></a></li>
<li>efficiency-note-limit, <a href=
"#@vars55"><b>5.13.4</b></a></li>
<li>enclosing-source-cutoff, <a href=
"#@vars44"><b>4.4.7</b></a></li>
<li>environment-list, <a href="#@vars66"><b>6.2</b></a></li>
<li>error-print-length, <a href="#@vars45"><b>4.4.7</b></a></li>
<li>error-print-level, <a href="#@vars46"><b>4.4.7</b></a><br>
<br></li>
<li>gc-inhibit-hook, <a href="#@vars6"><b>2.7.1</b></a></li>
</ul>
</td>
<td valign="top" align="left">
<ul>
<li>gc-notify-after, <a href="#@vars5"><b>2.7.1</b></a></li>
<li>gc-notify-before, <a href="#@vars4"><b>2.7.1</b></a></li>
<li>gc-run-time, <a href="#@vars57"><b>5.14.6</b></a></li>
<li>gc-verbose, <a href="#@vars3"><b>2.7.1</b></a><br>
<br></li>
<li>hash-table-tests, <a href="#@vars1">2.1.6</a><br>
<br></li>
<li>ignore-extra-close-parentheses, <a href=
"#@vars17"><b>2.11.2</b></a></li>
<li>inline-methods-in-emfs, <a href=
"#@vars20"><b>2.23.4</b></a></li>
<li>interface-style, <a href="#@vars13"><b>2.9.1</b></a><br>
<br></li>
<li>load-if-source-newer, <a href="#@vars16"><b>2.10</b></a></li>
<li>load-object-types, <a href="#@vars15"><b>2.10</b></a></li>
<li>load-source-types, <a href="#@vars14"><b>2.10</b></a><br>
<br></li>
<li>max-trace-indentation, <a href="#@vars30"><b>3.10</b></a></li>
<li>module-provider-functions, <a href=
"#@vars24"><b>2.28</b></a><br>
<br></li>
<li>optimize-inline-slot-access-p, <a href=
"#@vars19"><b>2.23.3.2</b></a><br>
<br></li>
<li>read-default-float-format, <a href="#@vars0">2.1.2</a></li>
<li>record-xref-info, <a href="#@vars67"><b>12.1</b></a><br>
<br></li>
<li>stderr, <a href="#@vars64"><b>6.2</b></a></li>
<li>stdin, <a href="#@vars62"><b>6.2</b></a></li>
<li>stdout, <a href="#@vars63"><b>6.2</b></a><br>
<br></li>
<li>timed-functions, <a href="#@vars56"><b>5.14.1</b></a></li>
<li>trace-encapsulate-package-names, <a href=
"#@vars31"><b>3.10</b></a></li>
<li>trace-output, <a href="#@vars26">3.10</a></li>
<li>traced-function-list, <a href="#@vars29"><b>3.10</b></a></li>
<li>trust-dynamic-extent-declarations, <a href=
"#@vars23"><b>2.26</b></a></li>
<li>tty, <a href="#@vars65"><b>6.2</b></a><br>
<br></li>
<li>undefined-warning-limit, <a href="#@vars41"><b>4.3.1</b></a>,
<a href="#@vars42">4.4.7</a></li>
<li>use-slot-types-p, <a href="#@vars18"><b>2.23.2</b></a></li>
</ul>
</td>
</tr>
</table>
<!--NAME cmu-user.hvnd.html-->
<br>
<br>
<a name="@concept302"></a> <!--TOC chapter Type Index-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><b><font size="6">Type Index</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<table cellspacing="2" cellpadding="0">
<tr>
<td valign="top" align="left">
<ul>
<li>*, <a href="#@types31"><b>8.2.3</b></a><br>
<br></li>
<li>ambiguous-variable-name, <a href=
"#@types54"><b>11.1.1</b></a></li>
<li>and, <a href="#@types29">5.3.1</a></li>
<li>array, <a href="#@types32"><b>8.2.3</b></a><br>
<br></li>
<li>base-character, <a href="#@types9">2.1.4</a></li>
<li>bignum, <a href="#@types1">2.1.1</a></li>
<li>boolean, <a href="#@types39"><b>8.2.3</b></a><br>
<br></li>
<li>c-string, <a href="#@types45"><b>8.2.4</b></a><br>
<br></li>
<li>debug-condition, <a href="#@types47"><b>11.1.1</b></a></li>
<li>debug-error, <a href="#@types55"><b>11.1.2</b></a></li>
<li>divide-by-zero, <a href="#@types7">2.1.2.4</a></li>
<li>double-double-float, <a href="#@types4">2.1.2</a></li>
<li>double-float, <a href="#@types3">2.1.2</a>, <a href=
"#@types41"><b>8.2.3</b></a><br>
<br></li>
<li>end-of-file, <a href="#@types16">2.12</a></li>
<li>enum, <a href="#@types35"><b>8.2.3</b></a></li>
<li>error, <a href="#@types19">4.2</a></li>
<li>extensions:double-double-float, <a href=
"#@types8"><b>2.1.3</b></a><br>
<br></li>
<li>fixnum, <a href="#@types0">2.1.1</a>, <a href=
"#@types14">2.8</a>, <a href="#@types24">5.2.2</a></li>
<li>floating-point-overflow, <a href="#@types6">2.1.2.4</a></li>
<li>floating-point-underflow, <a href="#@types5">2.1.2.4</a></li>
<li>frame-function-mismatch, <a href=
"#@types59"><b>11.1.2</b></a></li>
<li>ftype, <a href="#@types30">5.3.3</a></li>
<li>function, <a href="#@types13">2.8</a>, <a href=
"#@types42"><b>8.2.3</b></a><br>
<br></li>
<li>hash-table, <a href="#@types12">2.8</a></li>
<li>hash-tables, <a href="#@types11">2.1.6</a></li>
<li>host-entry, <a href="#@types46"><b>10.2</b></a><br>
<br></li>
<li>integer, <a href="#@types37"><b>8.2.3</b></a></li>
</ul>
</td>
<td valign="top" align="left">
<ul>
<li>invalid-value, <a href="#@types53"><b>11.1.1</b></a><br>
<br></li>
<li>lambda-list-unavailable, <a href=
"#@types52"><b>11.1.1</b></a></li>
<li>list, <a href="#@types23">5.2.2</a><br>
<br></li>
<li>member, <a href="#@types25">5.2.3</a>, <a href=
"#@types27">5.2.11</a><br>
<br></li>
<li>no-debug-blocks, <a href="#@types50"><b>11.1.1</b></a></li>
<li>no-debug-function-returns, <a href=
"#@types49"><b>11.1.1</b></a></li>
<li>no-debug-info, <a href="#@types48"><b>11.1.1</b></a></li>
<li>no-debug-variables, <a href="#@types51"><b>11.1.1</b></a></li>
<li>null, <a href="#@types22">5.2.2</a><br>
<br></li>
<li>or, <a href="#@types26">5.2.4</a>, <a href=
"#@types28">5.2.11</a><br>
<br></li>
<li>pathname, <a href="#@types17">2.16</a><br>
<br></li>
<li>serious-condition, <a href="#@types18">3.1</a></li>
<li>signed, <a href="#@types36"><b>8.2.3</b></a></li>
<li>single-float, <a href="#@types2">2.1.2</a>, <a href=
"#@types40"><b>8.2.3</b></a></li>
<li>string-char, <a href="#@types10">2.1.4</a></li>
<li>struct, <a href="#@types33"><b>8.2.3</b></a></li>
<li>style-warning, <a href="#@types21">4.2</a></li>
<li>symbol, <a href="#@types15">2.8</a></li>
<li>system-area-pointer, <a href="#@types43"><b>8.2.3</b></a><br>
<br></li>
<li>unhandled-condition, <a href="#@types56"><b>11.1.2</b></a></li>
<li>union, <a href="#@types34"><b>8.2.3</b></a></li>
<li>unknown-code-location, <a href=
"#@types57"><b>11.1.2</b></a></li>
<li>unknown-debug-variable, <a href=
"#@types58"><b>11.1.2</b></a></li>
<li>unsigned, <a href="#@types38"><b>8.2.3</b></a><br>
<br></li>
<li>void, <a href="#@types44"><b>8.2.4</b></a><br>
<br></li>
<li>warning, <a href="#@types20">4.2</a></li>
</ul>
</td>
</tr>
</table>
<!--NAME cmu-user.htnd.html-->
<br>
<br>
<a name="@concept303"></a> <!--TOC chapter Concept Index-->
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="#FFFFBC">
<div align="center">
<table>
<tr>
<td><b><font size="6">Concept Index</font></b></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<!--SEC END -->
<table cellspacing="2" cellpadding="0">
<tr>
<td valign="top" align="left">
<ul>
<li>actual source, <a href="#@concept99">4.4.2</a></li>
<li>advising, <a href="#@concept92">3.10.1</a></li>
<li>aliens, <a href="#@concept290">6.4</a></li>
<li>argument syntax
<ul>
<li>efficiency, <a href="#@concept255">5.12.3</a></li>
</ul>
</li>
<li>arithmetic
<ul>
<li>generic, <a href="#@concept233">5.11.4</a></li>
</ul>
</li>
<li>arithmetic type inference, <a href=
"#@concept159">5.3.4</a></li>
<li>array types
<ul>
<li>specialized, <a href="#@concept240">5.11.8</a></li>
</ul>
</li>
<li>arrays
<ul>
<li>efficiency of, <a href="#@concept217">5.10.3</a></li>
</ul>
</li>
<li>assembly listing, <a href="#@concept261">5.12.5</a></li>
<li>availability of debug variables, <a href=
"#@concept70">3.4.1</a><br>
<br></li>
<li>benchmarking techniques, <a href="#@concept289">5.14.8</a></li>
<li>bignums, <a href="#@concept236">5.11.5</a></li>
<li>bit-vectors
<ul>
<li>efficiency of, <a href="#@concept219">5.10.5</a></li>
</ul>
</li>
<li>block
<ul>
<li>basic, <a href="#@concept76">3.5.2</a></li>
<li>start location, <a href="#@concept77">3.5.2</a></li>
</ul>
</li>
<li>block compilation, <a href="#@concept195">5.7</a>
<ul>
<li>debugger implications, <a href="#@concept58">3.3.4</a></li>
</ul>
</li>
<li>breakpoints, <a href="#@concept83">3.9</a>
<ul>
<li>errors, <a href="#@concept87">3.10</a></li>
<li>function-end, <a href="#@concept90">3.10</a></li>
</ul>
</li>
<li>byte coded compilation, <a href="#@concept210">5.9</a><br>
<br></li>
<li>Concept Index, <a href="#@concept303">12.4</a></li>
<li>CPU time
<ul>
<li>interpretation of, <a href="#@concept286">5.14.7</a></li>
</ul>
</li>
<li>call
<ul>
<li>inline, <a href="#@concept205">5.8</a></li>
<li>local, <a href="#@concept187">5.6</a></li>
<li>numeric operands, <a href="#@concept245">5.11.10</a></li>
</ul>
</li>
<li>canonicalization of types, <a href=
"#@concept136">5.2.2</a></li>
<li>characters, <a href="#@concept247">5.11.11</a></li>
<li>cleanup
<ul>
<li>stack frame kind, <a href="#@concept61">3.3.4</a></li>
</ul>
</li>
<li>closures, <a href="#@concept190">5.6.3</a></li>
<li>command line options, <a href="#@concept0">1.2</a></li>
<li>compatibility with other Lisps, <a href=
"#@concept118">4.6</a></li>
<li>compilation
<ul>
<li>block, <a href="#@concept196">5.7</a></li>
<li>units, <a href="#@concept94">4.3</a></li>
<li>why to, <a href="#@concept250">5.12.1</a></li>
</ul>
</li>
<li>compilation-speed optimization quality, <a href=
"#@concept124">4.7.1</a></li>
<li>compile time type errors, <a href="#@concept110">4.5.1</a></li>
<li>compile-file
<ul>
<li>block compilation arguments, <a href=
"#@concept200">5.7.3</a></li>
</ul>
</li>
<li>compiler error messages, <a href="#@concept97">4.4</a></li>
<li>compiler error severity, <a href="#@concept104">4.4.4</a></li>
<li>compiler policy, <a href="#@concept120">4.7</a></li>
<li>compiling, <a href="#@concept93">4.2</a></li>
<li>complemented type checks, <a href="#@concept166">5.3.6</a></li>
<li>conditional type inference, <a href=
"#@concept162">5.3.5</a></li>
<li>consing, <a href="#@concept251">5.12.2</a>, <a href=
"#@concept284">5.14</a>
<ul>
<li>overhead of, <a href="#@concept226">5.11.1</a></li>
</ul>
</li>
<li>constant folding, <a href="#@concept170">5.4.2</a></li>
<li>constant-function declaration, <a href=
"#@concept172">5.4.2</a></li>
<li>context sensitive declarations, <a href=
"#@concept201">5.7.5</a></li>
<li>continuations
<ul>
<li>implicit representation, <a href="#@concept265">5.12.5</a></li>
</ul>
</li>
<li>control optimization, <a href="#@concept175">5.4.4</a></li>
<li>cross-referencing, <a href="#@concept299">12</a><br>
<br></li>
<li>dead code elimination, <a href="#@concept174">5.4.3</a>,
<a href="#@concept178">5.4.5</a></li>
<li>debug optimization quality, <a href="#@concept72">3.4.1</a>,
<a href="#@concept75">3.5.2</a>, <a href="#@concept79">3.6</a>,
<a href="#@concept126">4.7.1</a></li>
<li>debug variables, <a href="#@concept69">3.4</a></li>
<li>debugger, <a href="#@concept50">3</a></li>
<li>declarations
<ul>
<li><tt class="code">optimize-interface</tt>, <a href=
"#@concept130">4.7.2</a></li>
<li><tt class="code">optimize</tt>, <a href=
"#@concept122">4.7.1</a></li>
<li>block compilation, <a href="#@concept197">5.7.2</a></li>
<li>context-sensitive, <a href="#@concept202">5.7.5</a></li>
</ul>
</li>
<li>defstruct types, <a href="#@concept148">5.2.8</a></li>
<li>derivation of types, <a href="#@concept155">5.3</a></li>
<li>descriptor representations
<ul>
<li>forcing of, <a href="#@concept279">5.13.3</a></li>
</ul>
</li>
<li>descriptors
<ul>
<li>object, <a href="#@concept223">5.11.1</a></li>
</ul>
</li>
<li>dynamic type inference, <a href="#@concept161">5.3.5</a></li>
<li>dynamic-extent, <a href="#@concept43">2.26</a>
<ul>
<li>closures, <a href="#@concept45">2.26.2</a></li>
<li>known CL functions, <a href="#@concept46">2.26.2</a></li>
<li>list, list*, cons, <a href="#@concept47">2.26.3</a></li>
<li>rest lists, <a href="#@concept44">2.26.1</a></li>
</ul>
<br>
<br></li>
<li>effective method, <a href="#@concept23">2.23.4</a>
<ul>
<li>inlining of methods, <a href="#@concept25">2.23.4</a></li>
<li>precomputation, <a href="#@concept27">2.23.5</a></li>
</ul>
</li>
<li>efficiency
<ul>
<li>general hints, <a href="#@concept249">5.12</a></li>
<li>of argument syntax, <a href="#@concept256">5.12.3</a></li>
<li>of memory use, <a href="#@concept254">5.12.2</a></li>
<li>of numeric variables, <a href="#@concept231">5.11.3</a></li>
<li>of objects, <a href="#@concept214">5.10</a></li>
<li>of type checking, <a href="#@concept272">5.13.2</a></li>
</ul>
</li>
<li>efficiency notes, <a href="#@concept266">5.13</a>
<ul>
<li>for representation, <a href="#@concept275">5.13.3</a></li>
<li>verbosity, <a href="#@concept281">5.13.4</a></li>
</ul>
</li>
<li>empty type
<ul>
<li>the, <a href="#@concept142">5.2.5</a></li>
</ul>
</li>
<li>encapsulation, <a href="#@concept91">3.10.1</a></li>
<li>end-block declaration, <a href="#@concept199">5.7.2</a></li>
<li>entry points
<ul>
<li>external, <a href="#@concept57">3.3.4</a></li>
</ul>
</li>
<li>equivalence of types, <a href="#@concept137">5.2.2</a></li>
<li>error messages
<ul>
<li>compiler, <a href="#@concept96">4.4</a></li>
<li>verbosity, <a href="#@concept107">4.4.7</a></li>
</ul>
</li>
<li>errors
<ul>
<li>breakpoints, <a href="#@concept88">3.10</a></li>
<li>result type of, <a href="#@concept143">5.2.5</a></li>
<li>run-time, <a href="#@concept67">3.3.6</a></li>
</ul>
</li>
<li>evaluation
<ul>
<li>debugger, <a href="#@concept51">3.2</a>, <a href=
"#@concept73">3.4.2</a></li>
</ul>
</li>
<li>existing programs
<ul>
<li>to run, <a href="#@concept116">4.6</a></li>
</ul>
</li>
<li>expansion
<ul>
<li>inline, <a href="#@concept204">5.8</a></li>
</ul>
</li>
<li>external
<ul>
<li>stack frame kind, <a href="#@concept59">3.3.4</a></li>
</ul>
</li>
<li>external entry points, <a href="#@concept56">3.3.4</a><br>
<br></li>
<li>Function Index, <a href="#@concept300">12.4</a></li>
<li>fixnums, <a href="#@concept235">5.11.5</a></li>
<li>floating point efficiency, <a href=
"#@concept238">5.11.7</a></li>
<li>folding
<ul>
<li>constant, <a href="#@concept171">5.4.2</a></li>
</ul>
</li>
<li>frames
<ul>
<li>stack, <a href="#@concept53">3.3</a></li>
</ul>
</li>
<li>free
<ul>
<li>C function, <a href="#@concept295">6.5</a></li>
</ul>
</li>
<li>freeze-type declaration, <a href="#@concept150">5.2.9</a></li>
<li>function
<ul>
<li>names, <a href="#@concept54">3.3.3</a></li>
<li>tracing, <a href="#@concept85">3.10</a></li>
<li>type inference, <a href="#@concept157">5.3.3</a></li>
<li>types, <a href="#@concept144">5.2.6</a></li>
</ul>
</li>
<li>function call
<ul>
<li>inline, <a href="#@concept206">5.8</a></li>
<li>local, <a href="#@concept188">5.6</a></li>
</ul>
</li>
<li>function wrappers, <a href="#@concept41">2.25</a></li>
<li>function-end breakpoints, <a href="#@concept89">3.10</a></li>
<li>fwrappers, <a href="#@concept42">2.25</a><br>
<br></li>
<li>garbage collection, <a href="#@concept252">5.12.2</a></li>
<li>generic arithmetic, <a href="#@concept232">5.11.4</a><br>
<br></li>
<li>hash-tables
<ul>
<li>efficiency of, <a href="#@concept220">5.10.6</a></li>
</ul>
</li>
<li>hierarchical packages, <a href="#@concept1">2.4</a><br>
<br></li>
<li>implicit continuation representation (IR1), <a href=
"#@concept264">5.12.5</a></li>
<li>inference of types, <a href="#@concept154">5.3</a></li>
<li>inhibit-warnings optimization quality, <a href=
"#@concept128">4.7.1</a></li>
<li>inline, <a href="#@concept26">2.23.4</a></li>
<li>inline expansion, <a href="#@concept81">3.6</a>, <a href=
"#@concept132">4.8</a>, <a href="#@concept203">5.8</a></li>
<li>interpretation of run time, <a href=
"#@concept288">5.14.7</a></li>
<li>interrupts, <a href="#@concept66">3.3.6</a><br>
<br></li>
<li>keyword argument efficiency, <a href=
"#@concept257">5.12.3</a><br>
<br></li>
<li>let optimization, <a href="#@concept168">5.4.1</a></li>
<li>lisp threads, <a href="#@concept13">2.20</a></li>
<li>listing files
<ul>
<li>trace, <a href="#@concept262">5.12.5</a></li>
</ul>
</li>
<li>lists
<ul>
<li>efficiency of, <a href="#@concept215">5.10.1</a></li>
</ul>
</li>
<li>local call, <a href="#@concept186">5.6</a>
<ul>
<li>numeric operands, <a href="#@concept244">5.11.10</a></li>
<li>return values, <a href="#@concept194">5.6.5</a></li>
<li>type inference, <a href="#@concept156">5.3.2</a></li>
</ul>
</li>
<li>locations
<ul>
<li>unknown, <a href="#@concept65">3.3.6</a></li>
</ul>
</li>
<li>logical pathnames, <a href="#@concept5">2.16.3</a></li>
</ul>
</td>
<td valign="top" align="left">
<ul>
<li>macroexpansion, <a href="#@concept101">4.4.3</a>
<ul>
<li>errors during, <a href="#@concept105">4.4.5</a></li>
</ul>
</li>
<li>malloc
<ul>
<li>C function, <a href="#@concept294">6.5</a></li>
</ul>
</li>
<li>mapping
<ul>
<li>efficiency of, <a href="#@concept259">5.12.4</a></li>
</ul>
</li>
<li>maybe-inline declaration, <a href="#@concept209">5.8.3</a></li>
<li>member types, <a href="#@concept138">5.2.3</a></li>
<li>memory allocation, <a href="#@concept253">5.12.2</a></li>
<li>methods, <a href="#@concept20">2.23.3.3</a>
<ul>
<li>auto-compilation, <a href="#@concept21">2.23.3.3</a></li>
<li>emf precomputation, <a href="#@concept29">2.23.5</a></li>
<li>inlining in effective methods, <a href=
"#@concept24">2.23.4</a></li>
<li>interpreted, <a href="#@concept40">2.23.8</a></li>
<li>load time, <a href="#@concept28">2.23.5</a></li>
<li>profiling, <a href="#@concept39">2.23.7</a></li>
<li>sealing, <a href="#@concept33">2.23.6</a></li>
<li>tracing, <a href="#@concept38">2.23.7</a></li>
</ul>
</li>
<li>modular-arith, <a href="#@concept48">2.27</a></li>
<li>multiple value optimization, <a href=
"#@concept179">5.4.6</a><br>
<br></li>
<li>NIL type, <a href="#@concept141">5.2.5</a></li>
<li>names
<ul>
<li>function, <a href="#@concept55">3.3.3</a></li>
</ul>
</li>
<li>non-descriptor representations, <a href=
"#@concept227">5.11.2</a>, <a href="#@concept278">5.13.3</a></li>
<li>notes
<ul>
<li>efficiency, <a href="#@concept267">5.13</a></li>
</ul>
</li>
<li>numbers in local call, <a href="#@concept246">5.11.10</a></li>
<li>numeric
<ul>
<li>operation efficiency, <a href="#@concept234">5.11.4</a></li>
<li>type inference, <a href="#@concept160">5.3.4</a></li>
<li>types, <a href="#@concept221">5.11</a></li>
</ul>
<br>
<br></li>
<li>object representation, <a href="#@concept212">5.10</a>,
<a href="#@concept224">5.11.1</a></li>
<li>object representation efficiency notes, <a href=
"#@concept276">5.13.3</a></li>
<li>object sets, <a href="#@concept298">7.1</a></li>
<li>open-coding, <a href="#@concept131">4.8</a></li>
<li>operation specific type inference, <a href=
"#@concept158">5.3.4</a></li>
<li>optimization, <a href="#@concept167">5.4</a>
<ul>
<li>control, <a href="#@concept176">5.4.4</a></li>
<li>function call, <a href="#@concept207">5.8</a></li>
<li>let, <a href="#@concept169">5.4.1</a></li>
<li>multiple value, <a href="#@concept180">5.4.6</a></li>
<li>type check, <a href="#@concept165">5.3.6</a>, <a href=
"#@concept273">5.13.2</a></li>
</ul>
</li>
<li>optimize declaration, <a href="#@concept80">3.6</a>, <a href=
"#@concept121">4.7.1</a></li>
<li>optimize-interface declaration, <a href=
"#@concept129">4.7.2</a></li>
<li>optional
<ul>
<li>stack frame kind, <a href="#@concept60">3.3.4</a></li>
</ul>
</li>
<li>or (union) types, <a href="#@concept140">5.2.4</a></li>
<li>original source, <a href="#@concept98">4.4.2</a><br>
<br></li>
<li>package locks, <a href="#@concept2">2.5</a></li>
<li>pointers, <a href="#@concept293">6.5</a></li>
<li>policy
<ul>
<li>compiler, <a href="#@concept119">4.7</a></li>
<li>debugger, <a href="#@concept78">3.6</a></li>
</ul>
</li>
<li>precise type checking, <a href="#@concept112">4.5.2</a></li>
<li>primary method, <a href="#@concept14">2.23.1</a></li>
<li>processing path, <a href="#@concept100">4.4.3</a></li>
<li>profiling, <a href="#@concept36">2.23.7</a>, <a href=
"#@concept282">5.14</a>
<ul>
<li>methods, <a href="#@concept37">2.23.7</a></li>
</ul>
<br>
<br></li>
<li>random number generation, <a href="#@concept9">2.19</a>
<ul>
<li>MT-19987 generator, <a href="#@concept12">2.19.3</a></li>
<li>new generator, <a href="#@concept11">2.19.2</a></li>
<li>original generator, <a href="#@concept10">2.19.1</a></li>
</ul>
</li>
<li>read errors
<ul>
<li>compiler, <a href="#@concept106">4.4.6</a></li>
</ul>
</li>
<li>recording of inline expansions, <a href=
"#@concept208">5.8.1</a></li>
<li>recursion, <a href="#@concept185">5.5</a>
<ul>
<li>self, <a href="#@concept189">5.6.1</a></li>
<li>tail, <a href="#@concept63">3.3.5</a>, <a href=
"#@concept192">5.6.4</a></li>
</ul>
</li>
<li>representation
<ul>
<li>object, <a href="#@concept213">5.10</a>, <a href=
"#@concept225">5.11.1</a></li>
</ul>
</li>
<li>representation efficiency notes, <a href=
"#@concept274">5.13.3</a></li>
<li>require, <a href="#@concept49">2.28</a></li>
<li>rest argument efficiency, <a href=
"#@concept258">5.12.3</a></li>
<li>return values
<ul>
<li>local call, <a href="#@concept193">5.6.5</a></li>
</ul>
</li>
<li>run time
<ul>
<li>interpretation of, <a href="#@concept287">5.14.7</a></li>
</ul>
<br>
<br></li>
<li>safety optimization quality, <a href=
"#@concept127">4.7.1</a></li>
<li>sealing, <a href="#@concept30">2.23.6</a>
<ul>
<li>methods, <a href="#@concept32">2.23.6</a></li>
<li>subclasses, <a href="#@concept31">2.23.6</a></li>
</ul>
</li>
<li>search lists, <a href="#@concept6">2.16.4</a></li>
<li>semi-inline expansion, <a href="#@concept82">3.6</a></li>
<li>severity of compiler errors, <a href=
"#@concept103">4.4.4</a></li>
<li>signals, <a href="#@concept297">6.8</a></li>
<li>simple-streams, <a href="#@concept3">2.13</a></li>
<li>slot access optimization, <a href="#@concept16">2.23.3</a></li>
<li>slot declaration
<ul>
<li>inline, <a href="#@concept19">2.23.3.2</a></li>
<li>method recompilation, <a href="#@concept22">2.23.3.3</a></li>
<li>slot-boundp, <a href="#@concept18">2.23.3.1</a></li>
</ul>
</li>
<li>slot declarations, <a href="#@concept17">2.23.3</a></li>
<li>slot type checking, <a href="#@concept15">2.23.2</a></li>
<li>source location printing
<ul>
<li>debugger, <a href="#@concept74">3.5</a></li>
</ul>
</li>
<li>source-to-source transformation, <a href=
"#@concept102">4.4.3</a>, <a href="#@concept181">5.4.7</a></li>
<li>space optimization, <a href="#@concept211">5.9</a></li>
<li>space optimization quality, <a href=
"#@concept125">4.7.1</a></li>
<li>specialized array types, <a href="#@concept239">5.11.8</a></li>
<li>specialized structure slots, <a href=
"#@concept243">5.11.9</a></li>
<li>speed optimization quality, <a href=
"#@concept123">4.7.1</a></li>
<li>stack frames, <a href="#@concept52">3.3</a></li>
<li>stack numbers, <a href="#@concept228">5.11.2</a>, <a href=
"#@concept277">5.13.3</a></li>
<li>start-block declaration, <a href="#@concept198">5.7.2</a></li>
<li>static functions, <a href="#@concept133">4.8</a></li>
<li>strings, <a href="#@concept248">5.11.11</a></li>
<li>structure types, <a href="#@concept147">5.2.8</a>
<ul>
<li>efficiency of, <a href="#@concept216">5.10.2</a></li>
<li>numeric slots, <a href="#@concept242">5.11.9</a></li>
</ul>
</li>
<li>style recommendations, <a href="#@concept152">5.2.11</a>,
<a href="#@concept183">5.4.8</a><br>
<br></li>
<li>Type Index, <a href="#@concept302">12.4</a></li>
<li>tail recursion, <a href="#@concept62">3.3.5</a>, <a href=
"#@concept184">5.5</a>, <a href="#@concept191">5.6.4</a></li>
<li>time formatting, <a href="#@concept8">2.18</a></li>
<li>time parsing, <a href="#@concept7">2.18</a></li>
<li>timing, <a href="#@concept283">5.14</a></li>
<li>trace files, <a href="#@concept260">5.12.5</a></li>
<li>tracing, <a href="#@concept34">2.23.7</a>, <a href=
"#@concept84">3.10</a>
<ul>
<li>errors, <a href="#@concept86">3.10</a></li>
<li>methods, <a href="#@concept35">2.23.7</a></li>
</ul>
</li>
<li>transformation
<ul>
<li>source-to-source, <a href="#@concept182">5.4.7</a></li>
</ul>
</li>
<li>tuning, <a href="#@concept268">5.13</a>, <a href=
"#@concept285">5.14</a></li>
<li>type checking
<ul>
<li>at compile time, <a href="#@concept111">4.5.1</a></li>
<li>efficiency of, <a href="#@concept271">5.13.2</a></li>
<li>optimization, <a href="#@concept164">5.3.6</a></li>
<li>precise, <a href="#@concept113">4.5.2</a></li>
<li>weakened, <a href="#@concept115">4.5.3</a></li>
</ul>
</li>
<li>type declarations
<ul>
<li>variable, <a href="#@concept230">5.11.3</a></li>
</ul>
</li>
<li>type inference, <a href="#@concept153">5.3</a>
<ul>
<li>dynamic, <a href="#@concept163">5.3.5</a></li>
</ul>
</li>
<li>types
<ul>
<li>alien, <a href="#@concept291">6.4</a></li>
<li>equivalence, <a href="#@concept135">5.2.2</a></li>
<li>foreign language, <a href="#@concept292">6.4</a></li>
<li>function, <a href="#@concept145">5.2.6</a></li>
<li>in python, <a href="#@concept109">4.5</a>, <a href=
"#@concept134">5.2</a></li>
<li>numeric, <a href="#@concept222">5.11</a></li>
<li>portability, <a href="#@concept117">4.6</a></li>
<li>restrictions on, <a href="#@concept151">5.2.10</a></li>
<li>specialized array, <a href="#@concept241">5.11.8</a></li>
<li>structure, <a href="#@concept149">5.2.8</a></li>
<li>uncertainty, <a href="#@concept269">5.13.1</a></li>
</ul>
<br>
<br></li>
<li>uncertainty of types, <a href="#@concept270">5.13.1</a></li>
<li>undefined warnings, <a href="#@concept95">4.3.1</a></li>
<li>union (<tt class="code">or</tt>) types, <a href=
"#@concept139">5.2.4</a></li>
<li>unix
<ul>
<li>pathnames, <a href="#@concept4">2.16.1</a></li>
</ul>
</li>
<li>unix signals, <a href="#@concept296">6.8</a></li>
<li>unknown code locations, <a href="#@concept64">3.3.6</a></li>
<li>unreachable code deletion, <a href=
"#@concept177">5.4.5</a></li>
<li>unused expression elimination, <a href=
"#@concept173">5.4.3</a><br>
<br></li>
<li>Variable Index, <a href="#@concept301">12.4</a></li>
<li>Virtual Machine (VM, or IR2) representation, <a href=
"#@concept263">5.12.5</a></li>
<li>validity of debug variables, <a href=
"#@concept71">3.4.1</a></li>
<li>values declaration, <a href="#@concept146">5.2.7</a></li>
<li>variables
<ul>
<li>debugger access, <a href="#@concept68">3.4</a></li>
<li>non-descriptor, <a href="#@concept229">5.11.3</a></li>
</ul>
</li>
<li>vectors
<ul>
<li>efficiency of, <a href="#@concept218">5.10.4</a></li>
</ul>
</li>
<li>verbosity
<ul>
<li>of efficiency notes, <a href="#@concept280">5.13.4</a></li>
<li>of error messages, <a href="#@concept108">4.4.7</a></li>
</ul>
<br>
<br></li>
<li>weakened type checking, <a href="#@concept114">4.5.3</a></li>
<li>word integers, <a href="#@concept237">5.11.6</a></li>
</ul>
</td>
</tr>
</table>
<!--NAME cmu-user.hcnd.html-->
<br>
<br>
<!--HTMLFOOT-->
<!--ENDHTML-->
<!--FOOTER-->
<hr size="2">
<blockquote><em>This document was translated from
L<sup>A</sup>T<sub>E</sub>X by</em> <a href=
"http://pauillac.inria.fr/~maranget/hevea/index.html"><em>H<font size="2"><sup>E</sup></font>V<font size="2"><sup>E</sup></font>A</em></a><em>.</em></blockquote>
<!--NAME footer.tex.html-->
</body>
</html>
